<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–í–∏–±—ñ—Ä –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –≤–∏–∫–ª–∞–¥–∞—á–∞</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --card-radius: 20px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.08);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.7);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.35), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.35), transparent 60%),
          linear-gradient(135deg, #eef2ff 0%, #f0f9ff 50%, #fdf4ff 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(139, 92, 246, 0.3), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(59, 130, 246, 0.25), transparent 60%),
          linear-gradient(160deg, #050508 0%, #12061a 45%, #1b0f26 100%);
        color: #f8fafc;
      }
      .glass {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--card-radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .glass {
        background: var(--glass-bg-dark);
        border: 1px solid var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.7) inset;
      }
      .subject-card {
        padding: 16px;
        border-radius: 16px;
      }
      .subject-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }
      .subject-info {
        flex: 1 1 220px;
        min-width: 0;
      }
      .subject-name {
        font-weight: 600;
        word-break: break-word;
      }
      .subject-course {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
      }
      body.theme-light .subject-course {
        color: rgba(15, 23, 42, 0.6);
      }
      .subject-toggle {
        flex: 0 0 auto;
        margin-left: auto;
        white-space: nowrap;
      }
      .form-check-input {
        width: 1.15rem;
        height: 1.15rem;
      }
      .theme-toggle-min {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .theme-toggle-min:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.35);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      }
      body.theme-light .theme-toggle-min {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
        color: #0f172a;
      }
      body.theme-light .theme-toggle-min:hover {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
      }
      select.form-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border-radius: 14px;
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: inherit;
        font-size: 0.95rem;
        transition: box-shadow 0.2s ease, background 0.2s ease;
      }
      body.theme-dark select.form-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select:disabled {
        background: rgba(255, 255, 255, 0.6);
        border-color: rgba(15, 23, 42, 0.1);
        color: rgba(15, 23, 42, 0.55);
        opacity: 1;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      body.theme-dark select.form-select option {
        background: #0f172a;
        color: #f8fafc;
      }
      body.theme-dark select.form-select:disabled {
        background: rgba(15, 23, 42, 0.55);
        border-color: rgba(255, 255, 255, 0.18);
        color: rgba(248, 250, 252, 0.6);
        opacity: 1;
        box-shadow: none;
      }
      body.theme-light select.form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      .btn-primary {
        background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%);
        border: none;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-weight: 600;
      }
      .app-footer {
        font-size: 0.8rem;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
    </style>
      <link rel="stylesheet" href="/css/design-system.css" />
  </head>
  <body class="theme-dark">
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">–í–∏–±—ñ—Ä –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –≤–∏–∫–ª–∞–¥–∞—á–∞</h1>
          <div class="text-muted">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–¥–º–µ—Ç–∏, —è–∫—ñ –≤–∏ –≤–∏–∫–ª–∞–¥–∞—î—Ç–µ.</div>
        </div>
        <button class="theme-toggle-min" type="button" id="themeToggle">üåô</button>
      </div>

      <% if (error) { %>
        <div class="alert alert-danger glass"><%= decodeURIComponent(error) %></div>
      <% } %>

      <form method="POST" action="<%= isProfileEdit ? '/teacher/subjects' : '/register/teacher-subjects' %>">
        <div class="d-grid gap-3">
          <% (subjects || []).forEach(function(s) { %>
            <% const selectedGroup = selections && selections.get ? selections.get(s.id) : null; %>
            <% const isSelected = selections && selections.get ? selections.has(s.id) : false; %>
            <% const generalFlag = s.is_general === true || Number(s.is_general) === 1; %>
            <div class="glass subject-card">
              <div class="subject-row">
                <div class="subject-info">
                  <div class="subject-name"><%= s.name %></div>
                  <div class="subject-course"><%= s.course_name %></div>
                </div>
                <div class="form-check subject-toggle">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="subject_<%= s.id %>"
                    name="subject_<%= s.id %>"
                    value="1"
                    data-subject-toggle="<%= s.id %>"
                    <%= isSelected ? 'checked' : '' %>
                  />
                  <label class="form-check-label" for="subject_<%= s.id %>">–í–∏–∫–ª–∞–¥–∞—é</label>
                </div>
              </div>
              <% if (!generalFlag) { %>
                <div class="mt-3">
                  <label class="form-label small">–ì—Ä—É–ø–∞</label>
                  <select class="form-select" name="group_<%= s.id %>" data-subject-group="<%= s.id %>">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É</option>
                    <% for (let g = 1; g <= Number(s.group_count || 1); g += 1) { %>
                      <option value="<%= g %>" <%= Number(selectedGroup) === g ? 'selected' : '' %>><%= g %></option>
                    <% } %>
                  </select>
                </div>
              <% } %>
            </div>
          <% }); %>
        </div>

        <div class="d-grid gap-2 mt-4">
          <button class="btn btn-primary" type="submit"><%= isProfileEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏' : '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è' %></button>
          <% if (isProfileEdit) { %>
            <a href="/profile" class="btn btn-outline-secondary">–ù–∞–∑–∞–¥ –¥–æ –ø—Ä–æ—Ñ—ñ–ª—é</a>
          <% } else { %>
            <a href="/register/course" class="btn btn-outline-secondary">–ù–∞–∑–∞–¥</a>
          <% } %>
        </div>
      </form>

      <footer class="app-footer text-center mt-4">
        <small>
          ¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %> ¬∑
          <button
            type="button"
            class="btn btn-link btn-sm p-0 align-baseline"
            data-bs-toggle="modal"
            data-bs-target="#changelogModal"
          >
            Changelog
          </button>
        </small>
      </footer>
    </div>

    <%- include('partials/changelog-modal') %>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const themeToggle = document.getElementById('themeToggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      if (themeToggle) {
        themeToggle.textContent = storedTheme === 'theme-dark' ? '‚òÄÔ∏è' : 'üåô';
        themeToggle.addEventListener('click', () => {
          const isDark = document.body.classList.contains('theme-dark');
          const next = isDark ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-dark', 'theme-light');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggle.textContent = next === 'theme-dark' ? '‚òÄÔ∏è' : 'üåô';
        });
      }

      document.querySelectorAll('[data-subject-toggle]').forEach((toggle) => {
        const id = toggle.dataset.subjectToggle;
        const select = document.querySelector(`[data-subject-group="${id}"]`);
        const sync = () => {
          if (!select) return;
          select.disabled = !toggle.checked;
          if (!toggle.checked) {
            select.value = '';
          }
        };
        toggle.addEventListener('change', sync);
        sync();
      });
    </script>
      <script src="/js/design-system.js" defer></script>
  </body>
</html>
