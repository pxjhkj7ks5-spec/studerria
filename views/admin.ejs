<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('admin.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --radius: 16px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.12);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.35);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.22), transparent 60%),
          linear-gradient(135deg, #e6eef8 0%, #e9f0fb 45%, #eef2ff 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-dark .text-dark {
        color: #f8fafc !important;
      }
      .admin-nav {
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .admin-nav {
        background: rgba(255, 255, 255, 0.8);
        border-bottom-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-dark .admin-nav {
        background: rgba(10, 10, 20, 0.6);
      }
      .admin-viewas-form {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.45rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(12px);
      }
      body.theme-light .admin-viewas-form {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-dark .admin-viewas-form {
        background: rgba(15, 23, 42, 0.5);
        border-color: rgba(148, 163, 184, 0.25);
      }
      .admin-viewas-form .form-select {
        height: 32px;
        padding: 0.2rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 999px;
        min-width: 110px;
      }
      .admin-viewas-form .btn {
        height: 32px;
        padding: 0.2rem 0.9rem;
        border-radius: 999px;
        font-size: 0.85rem;
        white-space: nowrap;
      }
      .card {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .card {
        backdrop-filter: none;
        background: linear-gradient(180deg, rgba(22, 30, 50, 0.68) 0%, rgba(16, 22, 38, 0.74) 100%);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.06);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.48);
      }
      body.theme-light .card {
        background: var(--glass-bg-light);
        border-color: var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18), 0 0 0 1px rgba(255, 255, 255, 0.35) inset;
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-dark .table {
        color: #f8fafc;
      }
      body.theme-dark .table th,
      body.theme-dark .table td {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.92);
      }
      body.theme-dark h1,
      body.theme-dark h2,
      body.theme-dark h3,
      body.theme-dark h4,
      body.theme-dark h5,
      body.theme-dark h6,
      body.theme-dark .card-title,
      body.theme-dark .navbar-brand {
        color: #f8fafc;
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.9);
      }
      body.theme-dark .form-label,
      body.theme-dark .form-check-label,
      body.theme-dark label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .input-group-text {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
      }
      body.theme-dark .table > :not(caption) > * > * {
        background: transparent;
      }
      body.theme-dark .table-striped > tbody > tr:nth-of-type(odd) > * {
        background: rgba(255, 255, 255, 0.03);
      }
      body.theme-dark .table-striped > tbody > tr:hover > * {
        background: rgba(255, 255, 255, 0.06);
      }
      .form-control,
      .form-select {
        border-radius: 12px;
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 14px;
        color: inherit;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      body.theme-dark .form-control,
      body.theme-dark .form-select {
        background: rgba(255, 255, 255, 0.06);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
        color-scheme: dark;
      }
      body.theme-dark select.form-select[multiple] {
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(248, 250, 252, 0.65);
      }
      body.theme-dark .form-select option {
        background: rgba(15, 23, 42, 0.96);
        color: #f8fafc;
      }
      body.theme-dark .form-select optgroup {
        background: rgba(15, 23, 42, 0.98);
        color: #cbd5f5;
      }
      body.theme-light .form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark .form-select option:checked,
      body.theme-dark .form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light .form-select option:checked,
      body.theme-light .form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      .custom-tooltip {
        position: fixed;
        z-index: 2000;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 220ms ease, transform 220ms ease;
      }
      .custom-tooltip.show {
        opacity: 1;
        transform: translateY(0);
      }
      .custom-tooltip::before {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 20px;
        border: 6px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.08);
      }
      .custom-tooltip.below::before {
        top: -6px;
        bottom: auto;
        border-top-color: transparent;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-light .custom-tooltip {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      body.theme-light .custom-tooltip::before {
        border-top-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-light .custom-tooltip.below::before {
        border-bottom-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      body.theme-dark .text-muted {
        color: rgba(255, 255, 255, 0.65) !important;
      }
      body.theme-dark .list-group-item {
        background: transparent;
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .badge.text-bg-light {
        background: rgba(255, 255, 255, 0.12) !important;
        color: #f8fafc !important;
      }
      body.theme-dark a {
        color: #93c5fd;
      }
      body.theme-dark a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%);
        border: none;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary,
      .btn-outline-danger {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      body.theme-dark .btn-outline-primary,
      body.theme-dark .btn-outline-secondary,
      body.theme-dark .btn-outline-danger {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.3);
      }
      body.theme-dark .btn-outline-primary:hover,
      body.theme-dark .btn-outline-secondary:hover,
      body.theme-dark .btn-outline-danger:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .select-locked {
        pointer-events: none;
        opacity: 0.75;
      }
      .flash-alert {
        border-radius: 14px;
        padding: 0.5rem 0.9rem;
        font-size: 0.9rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.35);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(10px);
      }
      body.theme-dark .flash-alert {
        background: rgba(17, 17, 30, 0.7);
        border-color: rgba(255, 255, 255, 0.12);
        color: #f8fafc;
      }
      .flash-alert.alert-danger {
        border-color: rgba(239, 68, 68, 0.45);
        color: #b91c1c;
      }
      body.theme-dark .flash-alert.alert-danger {
        color: #fca5a5;
      }
      .flash-alert.alert-success {
        border-color: rgba(34, 197, 94, 0.45);
        color: #166534;
      }
      body.theme-dark .flash-alert.alert-success {
        color: #86efac;
      }
      .app-footer {
        font-size: 0.8rem;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
      .bulk-bar {
        position: sticky;
        top: 80px;
        z-index: 20;
        padding: 10px 12px;
        border-radius: 14px;
        margin-bottom: 12px;
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-light .bulk-bar {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      .validate-issue {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
      }
      .validate-meta {
        font-size: 0.85rem;
      }
      .study-day-row {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.06);
      }
      .week-time-row {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .week-time-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .week-time-label {
        font-weight: 700;
      }
      .week-time-sub {
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .week-time-hint {
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .study-day-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }
      .study-day-label {
        font-weight: 700;
      }
      .study-day-subjects {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0;
      }
      .study-day-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.35);
        color: inherit;
        font-size: 0.85rem;
      }
      .study-day-chip button {
        border: none;
        background: transparent;
        color: inherit;
      }
      body.theme-light .study-day-row {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-light .week-time-row {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      .save-all-btn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 1200;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
      }
      :root {
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 10px;
        --s-1: 8px;
        --s-2: 12px;
        --s-3: 16px;
        --s-4: 24px;
        --border-subtle: 1px solid rgba(255, 255, 255, 0.12);
        --border-hover: 1px solid rgba(255, 255, 255, 0.18);
        --glass-bg: rgba(20, 24, 32, 0.45);
        --glass-bg-light: rgba(255, 255, 255, 0.55);
        --glass-blur: 18px;
        --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        --text-primary: rgba(255, 255, 255, 0.92);
        --text-secondary: rgba(255, 255, 255, 0.68);
        --text-muted: rgba(255, 255, 255, 0.52);
        --focus-ring: 0 0 0 3px rgba(90, 140, 255, 0.25);
        --focus-border: rgba(90, 140, 255, 0.65);
      }
      body.theme-light {
        --text-primary: rgba(15, 23, 42, 0.92);
        --text-secondary: rgba(15, 23, 42, 0.68);
        --text-muted: rgba(15, 23, 42, 0.52);
      }
      .glass {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(var(--glass-blur));
        background: var(--glass-bg);
        border: var(--border-subtle);
        box-shadow: var(--glass-shadow);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      }
      .form-control,
      .form-select {
        border-radius: var(--radius-md);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--focus-border);
        box-shadow: var(--focus-ring);
      }
      .theme-toggle-min {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
      }
      body.theme-light .theme-toggle-min {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      .modal-backdrop.show {
        opacity: 0.48;
      }
      .modal-content {
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: var(--glass-bg);
        border: var(--border-subtle);
        backdrop-filter: blur(var(--glass-blur));
      }
      body.theme-light .modal-content {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
      .modal-header,
      .modal-footer {
        position: sticky;
        z-index: 2;
        background: inherit;
        backdrop-filter: blur(var(--glass-blur));
      }
      .modal-header {
        top: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-footer {
        bottom: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-body {
        overflow-y: auto;
      }
      .file-field {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
      }
      .file-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .file-ui {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: var(--radius-md);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-light .file-ui {
        border-color: rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
      }
      .file-name {
        color: var(--text-muted);
        font-size: 0.85rem;
      }
</style>
      <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/admin.css" />
    <link rel="stylesheet" href="/css/design-system.css" />
  </head>
  <body class="theme-light">
    <% const isLimitedView = typeof limitedStaffView !== 'undefined' && limitedStaffView; %>
    <% const allowedSectionsRaw = typeof locals !== 'undefined' && typeof locals.allowedSections !== 'undefined' ? locals.allowedSections : (typeof allowedSections !== 'undefined' ? allowedSections : null); %>
    <% const allowedSectionsList = role === 'admin' ? null : (Array.isArray(allowedSectionsRaw) ? allowedSectionsRaw : null); %>
    <% const sectionAllowed = (id) => !allowedSectionsList || allowedSectionsList.includes(id); %>
    <% const courseMap = {}; %>
    <% (courses || []).forEach(function(c) { courseMap[c.id] = c.name; }); %>
    <% const selectedCourse = (courses || []).find(function(c) { return Number(c.id) === Number(selectedCourseId); }) || {}; %>
    <% const selectedCourseLabel = selectedCourse.name || (courseMap[selectedCourseId] || ('Course ' + selectedCourseId)); %>
    <% const selectedCourseCampus = selectedCourse.is_teacher_course ? 'Teachers' : (String(selectedCourse.location || 'kyiv').toLowerCase() === 'munich' ? 'Munich' : 'Kyiv'); %>
    <% const canSwitchCourse = typeof allowCourseSelect !== 'undefined' ? allowCourseSelect : !isLimitedView; %>
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <div class="admin-topbar-left">
          <span class="navbar-brand"><%= isLimitedView && role === 'starosta' ? t('admin.starostaPanel') : t('admin.title') %></span>
          <div class="admin-course-chip">
            <span class="admin-course-label"><%= selectedCourseLabel %></span>
            <span class="badge admin-campus-badge"><%= selectedCourseCampus %></span>
            <% if (canSwitchCourse) { %>
              <form class="admin-course-form" method="GET" action="<%= role === 'deanery' ? '/deanery' : (role === 'starosta' ? '/starosta' : '/admin') %>">
                <select name="course" class="form-select form-select-sm" onchange="this.form.submit()">
                  <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>>
                      <%= c.name %>
                    </option>
                  <% }); %>
                </select>
              </form>
            <% } %>
          </div>
        </div>
        <div class="admin-topbar-right">
          <span class="admin-topbar-user text-muted">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.user') %>: <%= username %>
            <% } %>
          </span>
          <button
            class="session-health-chip is-loading"
            type="button"
            id="sessionHealthChip"
            aria-label="Session store status"
            title="Session store status"
          >
            <span class="session-health-dot" aria-hidden="true"></span>
            <span id="sessionHealthLabel">Session‚Ä¶</span>
          </button>
          <button
            class="theme-toggle-min"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="‚òÄÔ∏è"
            data-dark-label="üåô"
          >
            üåô
          </button>
          <% if (!isLimitedView && role === 'admin') { %>
            <button
              class="btn btn-outline-primary btn-sm admin-topbar-btn"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#adminPreviewModal"
            >
              –ü—Ä–µ–≤ º—é
            </button>
            <form method="POST" action="/admin/switch-to-student">
              <input type="hidden" name="mode" value="self" />
              <button class="btn btn-outline-secondary btn-sm admin-topbar-btn" type="submit">–†–æ–∑–∫–ª–∞–¥</button>
            </form>
          <% } else if (isLimitedView) { %>
            <a class="btn btn-outline-primary btn-sm admin-topbar-btn" href="/schedule"><%= t('admin.backToSchedule') %></a>
          <% } %>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm admin-topbar-btn" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="admin-layout">
      <aside class="admin-sidebar">
        <div class="admin-sidebar-inner">
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Overview</div>
            <% if (sectionAllowed('admin-overview')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-overview">Overview</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">System</div>
            <% if (sectionAllowed('admin-settings')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-settings">System Settings</button>
            <% } %>
            <% if (sectionAllowed('admin-role-access')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-role-studio">Role Studio</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Schedule</div>
            <% if (sectionAllowed('admin-schedule')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-schedule-editor">Schedule Editor</button>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-schedule-validate">Validate Schedule</button>
            <% } %>
            <% if (sectionAllowed('admin-import-export')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-import-export">Import/Export (CSV)</button>
            <% } %>
            <% if (sectionAllowed('admin-schedule-generator')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-schedule-generator">Semester Generator</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Academics</div>
            <% if (sectionAllowed('admin-subjects')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-subjects">Subjects</button>
            <% } %>
            <% if (sectionAllowed('admin-semesters')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-semesters">Semesters</button>
            <% } %>
            <% if (sectionAllowed('admin-courses')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-courses">Courses</button>
            <% } %>
            <% if (sectionAllowed('admin-homework')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-homework">Homework</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">People</div>
            <% if (sectionAllowed('admin-students')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-students">Students</button>
            <% } %>
            <% if (sectionAllowed('admin-users')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-users">Users</button>
            <% } %>
            <% if (sectionAllowed('admin-teachers')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-teachers">Teacher Requests</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Activity</div>
            <% if (sectionAllowed('admin-visit-analytics')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-visit-analytics">Visit analytics</button>
            <% } %>
            <% if (sectionAllowed('admin-history')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-history">History</button>
            <% } %>
            <% if (sectionAllowed('admin-activity')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-activity">Activity log</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Communications</div>
            <% if (sectionAllowed('admin-messages') && settings && settings.allow_messages) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-messages">Messages</button>
            <% } %>
          </div>
          <div class="admin-sidebar-section">
            <div class="admin-sidebar-title">Teamwork</div>
            <% if (sectionAllowed('admin-teamwork')) { %>
              <button class="admin-nav-link" type="button" data-admin-nav="admin-teamwork">Teamwork</button>
            <% } %>
          </div>
        </div>
      </aside>
      <div class="admin-content">
        <div class="container py-4">
      <div class="admin-header-rail mb-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h1 class="h3 mb-0"><%= t('admin.dashboard') %></h1>
          <% if (sectionAllowed('admin-overview')) { %>
            <a class="btn btn-outline-primary btn-sm" href="/admin/overview?course=<%= selectedCourseId %>"><%= t('admin.openOverview') %></a>
          <% } %>
        </div>
        <div class="admin-breadcrumbs mb-0" id="adminBreadcrumbs"></div>
      </div>

      <% const msg = typeof messages !== 'undefined' && messages ? messages : (typeof locals !== 'undefined' ? locals.messages : {}); %>
      <% const importOperation = msg && msg.operationId ? msg.operationId : ''; %>
      <% const semestersByCourseMap = typeof semestersByCourse !== 'undefined' && semestersByCourse ? semestersByCourse : { [(selectedCourseId || 1)]: (semesters || []) }; %>
      <% const settingsMetaInfo = typeof settingsMeta !== 'undefined' && settingsMeta ? settingsMeta : null; %>
      <div id="toastContainer" data-toast-success="<%= msg && msg.success ? msg.success : '' %>" data-toast-error="<%= msg && msg.error ? msg.error : '' %>"></div>

      <% const adminSectionOptionsList = typeof adminSectionOptions !== 'undefined' && Array.isArray(adminSectionOptions) ? adminSectionOptions : []; %>
      <% const dashboardStatsData = typeof dashboardStats !== 'undefined' && dashboardStats ? dashboardStats : null; %>
      <% const rbacRolesList = typeof rbacRoles !== 'undefined' && Array.isArray(rbacRoles) ? rbacRoles : []; %>
      <% const rbacPermissionOptionsList = typeof rbacPermissionOptions !== 'undefined' && Array.isArray(rbacPermissionOptions) ? rbacPermissionOptions : []; %>
      <% const courseKindOptionsList = typeof courseKindOptions !== 'undefined' && Array.isArray(courseKindOptions) ? courseKindOptions : []; %>
      <% const userRoleAssignmentsMap = typeof userRoleAssignments !== 'undefined' && userRoleAssignments ? userRoleAssignments : {}; %>
      <% const userPrimaryRoleMapData = typeof userPrimaryRoleMap !== 'undefined' && userPrimaryRoleMap ? userPrimaryRoleMap : {}; %>
      <% const roleLabelMapData = Object.assign({
        admin: '–ê–¥–º—ñ–Ω',
        teacher: '–í–∏–∫–ª–∞–¥–∞—á',
        deanery: '–î–µ–∫–∞–Ω–∞—Ç',
        starosta: '–°—Ç–∞—Ä–æ—Å—Ç–∞',
        student: '–°—Ç—É–¥–µ–Ω—Ç',
      }, (rbacRolesList || []).reduce((acc, roleRow) => {
        if (roleRow && roleRow.key) {
          acc[roleRow.key] = roleRow.label || roleRow.key;
        }
        return acc;
      }, {})); %>

      <% const groupMap = {}; %>
      <% (studentGroups || []).forEach(function(g) { %>
        <% if (!groupMap[g.student_id]) { groupMap[g.student_id] = {}; } %>
        <% groupMap[g.student_id][g.subject_id] = g.group_number; %>
      <% }); %>

      <div class="admin-panels">
        <% if (sectionAllowed('admin-overview')) { %>
          <div id="admin-overview" class="admin-panel" data-admin-title="Overview">
            <div class="card mb-4">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div>
                    <h5 class="card-title mb-1">Overview</h5>
                    <div class="small text-muted">–®–≤–∏–¥–∫–∏–π —Å—Ç–∞–Ω –ø–æ –∫—É—Ä—Å—É —Ç–∞ –Ω–∞–π–±–ª–∏–∂—á–∏—Ö –¥—ñ—è—Ö.</div>
                  </div>
                  <div class="d-flex gap-2 flex-wrap">
                    <a class="btn btn-outline-primary btn-sm" href="/admin/schedule-generator">Semester Generator</a>
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-admin-nav="admin-import-export">Import/Export</button>
                    <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-list">Schedule list</a>
                    <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-summary">Semester summary</a>
                  </div>
                </div>
                <div class="admin-overview-grid">
                  <div class="admin-metric-card">
                    <div class="small text-muted">Users</div>
                    <div class="admin-metric-value"><%= dashboardStatsData ? dashboardStatsData.users : '‚Äî' %></div>
                  </div>
                  <div class="admin-metric-card">
                    <div class="small text-muted">Subjects</div>
                    <div class="admin-metric-value"><%= dashboardStatsData ? dashboardStatsData.subjects : '‚Äî' %></div>
                  </div>
                  <div class="admin-metric-card">
                    <div class="small text-muted">Homework</div>
                    <div class="admin-metric-value"><%= dashboardStatsData ? dashboardStatsData.homework : '‚Äî' %></div>
                  </div>
                  <div class="admin-metric-card">
                    <div class="small text-muted">Teamwork tasks</div>
                    <div class="admin-metric-value"><%= dashboardStatsData ? dashboardStatsData.teamworkTasks : '‚Äî' %></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>
        <% if (sectionAllowed('admin-settings')) { %>
        <div id="admin-settings" class="admin-panel" data-admin-title="System / Settings">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div>
                  <h5 class="mb-1"><%= t('admin.settings') %></h5>
                  <% const settingsUpdatedAt = settingsMetaInfo && settingsMetaInfo.updated_at ? new Date(settingsMetaInfo.updated_at).toLocaleString('uk-UA') : '‚Äî'; %>
                  <% const settingsUpdatedBy = settingsMetaInfo && settingsMetaInfo.updated_by ? settingsMetaInfo.updated_by : '‚Äî'; %>
                  <div class="small text-muted" id="settingsMeta">
                    –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: <span data-settings-updated-at><%= settingsUpdatedAt %></span>
                    ¬∑ –û–Ω–æ–≤–∏–≤(–ª–∞): <span data-settings-updated-by><%= settingsUpdatedBy %></span>
                  </div>
                </div>
                <div class="badge admin-chip">System</div>
              </div>
              <div class="settings-status mb-3">
                <span class="badge text-bg-secondary" data-settings-status>Saved</span>
                <span class="small text-muted d-none" data-settings-dirty>Unsaved changes</span>
              </div>
              <form method="POST" action="/admin/settings" class="row g-3 align-items-end" id="systemSettingsForm">
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Security</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.sessionDuration') %></label>
                        <input
                          type="number"
                          min="1"
                          max="365"
                          class="form-control"
                          name="session_duration_days"
                          value="<%= (settings && settings.session_duration_days) || 14 %>"
                          data-settings-field
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Uploads</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.maxFileSize') %></label>
                        <input
                          type="number"
                          min="1"
                          max="100"
                          class="form-control"
                          name="max_file_size_mb"
                          value="<%= (settings && settings.max_file_size_mb) || 20 %>"
                          data-settings-field
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Teamwork</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.minTeamMembers') %></label>
                        <input
                          type="number"
                          min="2"
                          max="10"
                          class="form-control"
                          name="min_team_members"
                          value="<%= (settings && settings.min_team_members) || 2 %>"
                          data-settings-field
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Homework</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.allowHomework') %></label>
                        <select class="form-select" name="allow_homework_creation" data-settings-field>
                          <option value="true" <%= (settings && settings.allow_homework_creation) ? 'selected' : '' %>><%= t('admin.enabled') %></option>
                          <option value="false" <%= (settings && settings.allow_homework_creation) ? '' : 'selected' %>><%= t('admin.disabled') %></option>
                        </select>
                      </div>
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.allowCustomDeadlines') %></label>
                        <select class="form-select" name="allow_custom_deadlines" data-settings-field>
                          <option value="true" <%= (settings && settings.allow_custom_deadlines) ? 'selected' : '' %>><%= t('admin.enabled') %></option>
                          <option value="false" <%= (settings && settings.allow_custom_deadlines) ? '' : 'selected' %>><%= t('admin.disabled') %></option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.allowMessages') %></label>
                        <select class="form-select" name="allow_messages" data-settings-field>
                          <option value="true" <%= (settings && settings.allow_messages) ? 'selected' : '' %>><%= t('admin.enabled') %></option>
                          <option value="false" <%= (settings && settings.allow_messages) ? '' : 'selected' %>><%= t('admin.disabled') %></option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="settings-section">
                    <div class="settings-section-title">Schedule automation</div>
                    <div class="row g-3">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.scheduleRefreshMinutes') %></label>
                        <input
                          type="number"
                          min="1"
                          max="120"
                          class="form-control"
                          name="schedule_refresh_minutes"
                          value="<%= (settings && settings.schedule_refresh_minutes) || 5 %>"
                          data-settings-field
                          required
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 d-flex align-items-center gap-3">
                  <button class="btn btn-primary" type="submit" data-settings-save disabled><%= t('admin.saveSettings') %></button>
                  <div class="small text-muted">Manual save ¬∑ changes are applied after clicking ‚ÄúSave‚Äù.</div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-role-access')) { %>
        <div id="admin-role-studio" class="admin-panel" data-admin-title="System / Role Studio">
          <div class="card mb-4 role-studio-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div>
                  <h5 class="mb-1">Role Studio</h5>
                  <div class="small text-muted">–ö–∞—Å—Ç–æ–º–Ω—ñ —Ä–æ–ª—ñ, —Å–µ–∫—Ü—ñ–π–Ω—ñ –ø—Ä–∞–≤–∞ —Ç–∞ –¥–æ—Å—Ç—É–ø –¥–æ —Ç–∏–ø—ñ–≤ –∫—É—Ä—Å—ñ–≤.</div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-rbac-template="deanery">Default: Deanery</button>
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-rbac-template="starosta">Default: Starosta</button>
                  <button class="btn btn-outline-danger btn-sm" type="button" data-rbac-template="reset">Reset system defaults</button>
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-rbac-revert>Revert unsaved</button>
                </div>
              </div>
              <div class="small text-muted mb-3">–ó–∞—Å—Ç–æ—Å—É–π —à–∞–±–ª–æ–Ω, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω–∏ ‚Äú–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–ª—å‚Äù —É –ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö —Ä–æ–ª—è—Ö. –î—Ä–∞—Ñ—Ç–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</div>
              <form method="POST" action="/admin/rbac/roles/create" class="row g-2 align-items-end mb-4">
                <div class="col-12 col-md-3">
                  <label class="form-label">Key</label>
                  <input class="form-control" name="key" placeholder="assistant" pattern="[a-z][a-z0-9_-]{1,31}" required />
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">Label</label>
                  <input class="form-control" name="label" placeholder="–ê—Å–∏—Å—Ç–µ–Ω—Ç" required />
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">Clone from</label>
                  <select class="form-select" name="clone_from">
                    <option value="">–ü–æ—Ä–æ–∂–Ω—è —Ä–æ–ª—å</option>
                    <% rbacRolesList.forEach(function(roleRow) { %>
                      <option value="<%= roleRow.key %>"><%= roleRow.label %> (<%= roleRow.key %>)</option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">Description</label>
                  <input class="form-control" name="description" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å" />
                </div>
                <div class="col-12 d-flex gap-2">
                  <button class="btn btn-primary" type="submit">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–æ–ª—å</button>
                </div>
              </form>

              <% if (rbacRolesList.length) { %>
                <div class="d-grid gap-3">
                  <% rbacRolesList.forEach(function(roleRow) { %>
                    <form method="POST" action="/admin/rbac/roles/<%= roleRow.key %>/save" class="role-studio-role-card" data-rbac-role-form data-role-key="<%= roleRow.key %>">
                      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                        <div>
                          <div class="fw-semibold"><%= roleRow.label %> <span class="text-muted">(<%= roleRow.key %>)</span></div>
                          <div class="small text-muted">Users: <%= roleRow.members_count || 0 %> ¬∑ <%= roleRow.is_system ? 'System role' : 'Custom role' %></div>
                        </div>
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" name="is_active" value="1" id="rbacActive_<%= roleRow.key %>" <%= roleRow.is_active ? 'checked' : '' %> <%= roleRow.key === 'admin' ? 'disabled' : '' %> />
                          <label class="form-check-label" for="rbacActive_<%= roleRow.key %>">Active</label>
                        </div>
                      </div>
                      <div class="row g-2 mb-3">
                        <div class="col-12 col-md-4">
                          <label class="form-label">Label</label>
                          <input class="form-control" name="label" value="<%= roleRow.label %>" required />
                        </div>
                        <div class="col-12 col-md-8">
                          <label class="form-label">Description</label>
                          <input class="form-control" name="description" value="<%= roleRow.description || '' %>" />
                        </div>
                      </div>
                      <div class="mb-3">
                        <div class="small fw-semibold mb-2">Course access</div>
                        <div class="d-flex flex-wrap gap-3">
                          <% courseKindOptionsList.forEach(function(courseKind) { %>
                            <label class="form-check-label d-flex align-items-center gap-2">
                              <input class="form-check-input" type="checkbox" name="course_kinds" value="<%= courseKind.key %>" <%= (roleRow.course_kinds || []).includes(courseKind.key) ? 'checked' : '' %> />
                              <span><%= courseKind.label %></span>
                            </label>
                          <% }); %>
                        </div>
                      </div>
                      <div class="mb-3">
                        <div class="small fw-semibold mb-2">Admin sections</div>
                        <div class="d-flex flex-wrap gap-3">
                          <% rbacPermissionOptionsList.forEach(function(permission) { %>
                            <label class="form-check-label d-flex align-items-center gap-2">
                              <input class="form-check-input" type="checkbox" name="permission_keys" value="<%= permission.key %>" <%= (roleRow.permission_keys || []).includes(permission.key) ? 'checked' : '' %> />
                              <span><%= permission.label %></span>
                            </label>
                          <% }); %>
                        </div>
                      </div>
                      <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–æ–ª—å</button>
                        <% if (!roleRow.is_system) { %>
                          <button
                            class="btn btn-outline-danger"
                            type="submit"
                            formaction="/admin/rbac/roles/<%= roleRow.key %>/delete"
                            data-confirm="Delete role <%= roleRow.key %>? This cannot be undone."
                            data-confirm-level="danger"
                          >
                            –í–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–ª—å
                          </button>
                        <% } %>
                      </div>
                    </form>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="small text-muted">RBAC —Ä–æ–ª—ñ —â–µ –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ.</div>
              <% } %>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-schedule')) { %>
        <div id="admin-schedule-editor" class="admin-panel" data-admin-title="Schedule / Editor">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="card-title mb-1">Schedule Editor</h5>
                  <div class="small text-muted">–î–æ–¥–∞–≤–∞–π—Ç–µ –∞–±–æ –∫–æ—Ä–∏–≥—É–π—Ç–µ –ø–∞—Ä–∏ –≤—Ä—É—á–Ω—É.</div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-list">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä</a>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-summary">–°–≤–æ–¥–∫–∞ —Å–µ–º–µ—Å—Ç—Ä—É</a>
                </div>
              </div>
              <form method="POST" action="/admin/schedule/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <select class="form-select" id="addSubjectSelect" name="subject_id" required>
                      <option value="" disabled selected>Subject</option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>" data-group-count="<%= s.group_count %>" data-is-general="<%= s.is_general ? '1' : '0' %>"><%= s.name %> (1‚Äì<%= s.group_count %>)</option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" id="addLessonTypeSelect" name="lesson_type">
                      <option value="" selected>Type (auto)</option>
                      <option value="lecture">–õ–µ–∫—Ü—ñ—è</option>
                      <option value="seminar">–°–µ–º—ñ–Ω–∞—Ä</option>
                      <option value="lab">–õ–∞–±</option>
                      <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <div class="d-flex gap-2">
                      <select class="form-select" id="addGroupSelect" name="group_number" required>
                        <option value="" disabled selected>Group #</option>
                        <option value="1" data-group="1">1</option>
                        <option value="2" data-group="2">2</option>
                        <option value="3" data-group="3">3</option>
                      </select>
                      <button class="btn btn-outline-secondary" type="button" id="addGroupMultiBtn" style="display: none;">–ì—Ä—É–ø–∏</button>
                    </div>
                    <input type="hidden" name="group_numbers" id="addGroupNumbers" />
                    <div class="small text-muted mt-1" id="addGroupSelectionLabel"></div>
                    <span class="badge text-bg-primary mt-2 d-none" id="addGroupMultiBadge">–ú—É–ª—å—Ç–∏‚Äë–≥—Ä—É–ø–∏</span>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="semester_id" required>
                      <option value="" disabled selected>Semester</option>
                      <% (semesters || []).forEach(function(sem) { %>
                        <option value="<%= sem.id %>" <%= activeSemester && sem.id === activeSemester.id ? 'selected' : '' %>>
                          <%= sem.title %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="day_of_week" required>
                      <option value="" disabled selected>Day</option>
                      <% (typeof activeScheduleDays !== 'undefined' && Array.isArray(activeScheduleDays) && activeScheduleDays.length ? activeScheduleDays : ['Monday','Tuesday','Wednesday','Thursday','Friday']).forEach(function(d) { %>
                        <option value="<%= d %>"><%= d %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-1">
                    <select class="form-select" name="class_number" required>
                      <option value="" disabled selected>Class #</option>
                      <% [1,2,3,4,5,6,7].forEach(function(n) { %>
                        <option value="<%= n %>"><%= n %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <input
                      class="form-control"
                      name="week_numbers"
                      placeholder="Weeks: 1,2,3"
                      required
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <% if (sectionAllowed('admin-import-export')) { %>
        <div id="admin-import-export" class="admin-panel" data-admin-title="Schedule / Import Export">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
                <div>
                  <h5 class="card-title mb-1">Import/Export</h5>
                  <div class="small text-muted">–¢—Ä—å–æ—Ö–∫—Ä–æ–∫–æ–≤–∏–π —ñ–º–ø–æ—Ä—Ç: Upload ‚Üí Validate ‚Üí Confirm.</div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/export/schedule.csv">Export schedule CSV</a>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/export/users.csv?course=<%= selectedCourseId || 1 %>">Export users CSV</a>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/export/subjects.csv">Export subjects CSV</a>
                </div>
              </div>
              <% if (importOperation) { %>
                <div class="import-success-banner">
                  <div>
                    <div class="fw-semibold">–Ü–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    <div class="small text-muted"><%= msg && msg.success ? msg.success : '' %></div>
                  </div>
                  <a class="btn btn-link btn-sm" href="/admin?tab=admin-history&history_q=<%= importOperation %>">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–º—ñ–Ω–∏</a>
                </div>
              <% } %>
              <div class="import-grid">
                <div class="import-card" data-import-type="schedule" data-required-columns="subject,group_number,day_of_week,class_number,week_number">
                  <div class="import-card-header">
                    <div>
                      <div class="fw-semibold">Schedule CSV</div>
                      <div class="small text-muted">–§–æ—Ä–º–∞—Ç: subject, group_number, day_of_week, class_number, week_number, lesson_type (–æ–ø—Ü.)</div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-template="subject,group_number,day_of_week,class_number,week_number,lesson_type">Download template</button>
                  </div>
                  <form method="POST" action="/admin/import/schedule.csv" enctype="multipart/form-data" class="import-form">
                    <div class="import-scope">
                      <div class="import-step-title">Import scope</div>
                      <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                          <label class="form-label">–ö—É—Ä—Å</label>
                          <select class="form-select form-select-sm" name="scope_course_id" data-import-scope-course>
                            <% (courses || []).forEach(function(course) { %>
                              <option value="<%= course.id %>" <%= Number(course.id) === Number(selectedCourseId) ? 'selected' : '' %>>
                                <%= course.name %>
                              </option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-6">
                          <label class="form-label">–°–µ–º–µ—Å—Ç—Ä</label>
                          <select class="form-select form-select-sm" name="scope_semester_id" data-import-scope-semester>
                            <% ((semestersByCourseMap && semestersByCourseMap[selectedCourseId]) || []).forEach(function(sem) { %>
                              <option value="<%= sem.id %>" <%= activeSemester && sem.id === activeSemester.id ? 'selected' : '' %>>
                                <%= sem.title %> ¬∑ <%= sem.weeks_count %> —Ç–∏–∂–Ω—ñ–≤
                              </option>
                            <% }); %>
                          </select>
                        </div>
                      </div>
                      <div class="import-scope-summary" data-import-scope-summary></div>
                    </div>
                    <div class="import-step">
                      <div class="import-step-title">1. Upload file</div>
                      <input class="form-control" type="file" name="csv_file" accept=".csv" required />
                    </div>
                    <div class="import-step import-validate">
                      <div class="import-step-title">2. Validate (dry-run)</div>
                      <div class="import-summary">
                        <div>Creates: <span data-import-create>0</span></div>
                        <div>Updates: <span data-import-update>0</span></div>
                        <div>Skips: <span data-import-skip>0</span></div>
                        <div>Errors: <span data-import-error>0</span></div>
                      </div>
                      <div class="import-errors" data-import-errors></div>
                      <button class="btn btn-outline-secondary btn-sm" type="button" data-import-error-download disabled>Download error report CSV</button>
                    </div>
                    <div class="import-step import-confirm">
                      <div class="import-step-title">3. Confirm import</div>
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" data-import-confirm-check />
                        <span class="form-check-label">I understand this will modify data.</span>
                      </label>
                      <div class="import-typed-confirm d-none" data-import-typed-confirm>
                        <label class="form-label">Type IMPORT to continue</label>
                        <input class="form-control form-control-sm" name="confirm_phrase" data-import-confirm-phrase />
                      </div>
                      <input type="hidden" name="confirm_required" value="0" data-import-confirm-required />
                      <button class="btn btn-warning btn-sm" type="submit" data-confirm="Import schedule CSV? This will update existing schedule." data-confirm-level="warning">Confirm import</button>
                    </div>
                  </form>
                </div>

                <div class="import-card" data-import-type="users" data-required-columns="full_name,role,schedule_group,is_active,course_id">
                  <div class="import-card-header">
                    <div>
                      <div class="fw-semibold">Users CSV</div>
                      <div class="small text-muted">–§–æ—Ä–º–∞—Ç: full_name, role, schedule_group, is_active, course_id</div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-template="full_name,role,schedule_group,is_active,course_id">Download template</button>
                  </div>
                  <form method="POST" action="/admin/import/users.csv" enctype="multipart/form-data" class="import-form">
                    <div class="import-scope">
                      <div class="import-step-title">Import scope</div>
                      <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                          <label class="form-label">–ö—É—Ä—Å</label>
                          <select class="form-select form-select-sm" name="scope_course_id" data-import-scope-course>
                            <% (courses || []).forEach(function(course) { %>
                              <option value="<%= course.id %>" <%= Number(course.id) === Number(selectedCourseId) ? 'selected' : '' %>>
                                <%= course.name %>
                              </option>
                            <% }); %>
                          </select>
                        </div>
                      </div>
                      <div class="import-scope-summary" data-import-scope-summary></div>
                    </div>
                    <div class="import-step">
                      <div class="import-step-title">1. Upload file</div>
                      <input class="form-control" type="file" name="csv_file" accept=".csv" required />
                    </div>
                    <div class="import-step import-validate">
                      <div class="import-step-title">2. Validate (dry-run)</div>
                      <div class="import-summary">
                        <div>Creates: <span data-import-create>0</span></div>
                        <div>Updates: <span data-import-update>0</span></div>
                        <div>Skips: <span data-import-skip>0</span></div>
                        <div>Errors: <span data-import-error>0</span></div>
                      </div>
                      <div class="import-errors" data-import-errors></div>
                      <button class="btn btn-outline-secondary btn-sm" type="button" data-import-error-download disabled>Download error report CSV</button>
                    </div>
                    <div class="import-step import-confirm">
                      <div class="import-step-title">3. Confirm import</div>
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" data-import-confirm-check />
                        <span class="form-check-label">I understand this will modify data.</span>
                      </label>
                      <div class="import-typed-confirm d-none" data-import-typed-confirm>
                        <label class="form-label">Type IMPORT to continue</label>
                        <input class="form-control form-control-sm" name="confirm_phrase" data-import-confirm-phrase />
                      </div>
                      <input type="hidden" name="confirm_required" value="0" data-import-confirm-required />
                      <button class="btn btn-warning btn-sm" type="submit" data-confirm="Import users CSV? This will update existing users." data-confirm-level="warning">Confirm import</button>
                    </div>
                  </form>
                </div>

                <div class="import-card" data-import-type="subjects" data-required-columns="name,group_count,default_group,is_required,is_general">
                  <div class="import-card-header">
                    <div>
                      <div class="fw-semibold">Subjects CSV</div>
                      <div class="small text-muted">–§–æ—Ä–º–∞—Ç: name, group_count, default_group, is_required, is_general</div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-template="name,group_count,default_group,is_required,is_general">Download template</button>
                  </div>
                  <form method="POST" action="/admin/import/subjects.csv" enctype="multipart/form-data" class="import-form">
                    <div class="import-scope">
                      <div class="import-step-title">Import scope</div>
                      <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-6">
                          <label class="form-label">–ö—É—Ä—Å</label>
                          <select class="form-select form-select-sm" name="scope_course_id" data-import-scope-course>
                            <% (courses || []).forEach(function(course) { %>
                              <option value="<%= course.id %>" <%= Number(course.id) === Number(selectedCourseId) ? 'selected' : '' %>>
                                <%= course.name %>
                              </option>
                            <% }); %>
                          </select>
                        </div>
                      </div>
                      <div class="import-scope-summary" data-import-scope-summary></div>
                    </div>
                    <div class="import-step">
                      <div class="import-step-title">1. Upload file</div>
                      <input class="form-control" type="file" name="csv_file" accept=".csv" required />
                    </div>
                    <div class="import-step import-validate">
                      <div class="import-step-title">2. Validate (dry-run)</div>
                      <div class="import-summary">
                        <div>Creates: <span data-import-create>0</span></div>
                        <div>Updates: <span data-import-update>0</span></div>
                        <div>Skips: <span data-import-skip>0</span></div>
                        <div>Errors: <span data-import-error>0</span></div>
                      </div>
                      <div class="import-errors" data-import-errors></div>
                      <button class="btn btn-outline-secondary btn-sm" type="button" data-import-error-download disabled>Download error report CSV</button>
                    </div>
                    <div class="import-step import-confirm">
                      <div class="import-step-title">3. Confirm import</div>
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" data-import-confirm-check />
                        <span class="form-check-label">I understand this will modify data.</span>
                      </label>
                      <div class="import-typed-confirm d-none" data-import-typed-confirm>
                        <label class="form-label">Type IMPORT to continue</label>
                        <input class="form-control form-control-sm" name="confirm_phrase" data-import-confirm-phrase />
                      </div>
                      <input type="hidden" name="confirm_required" value="0" data-import-confirm-required />
                      <button class="btn btn-warning btn-sm" type="submit" data-confirm="Import subjects CSV? This will update existing subjects." data-confirm-level="warning">Confirm import</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-schedule-generator')) { %>
        <div id="admin-schedule-generator" class="admin-panel" data-admin-title="Schedule / Semester Generator">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div>
                  <h5 class="card-title mb-1">Semester Generator</h5>
                  <div class="small text-muted">Preview –∞–±–æ Publish –∑ –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–º scope.</div>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                  <a class="btn btn-outline-primary btn-sm" href="/admin/schedule-generator">Open generator</a>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/export/schedule.csv">Export current schedule CSV</a>
                </div>
              </div>
              <div class="small text-muted">–ü–µ—Ä–µ–¥ Publish —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –∑–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π CSV —è–∫ backup.</div>
            </div>
          </div>
        </div>
        <% } %>

        <div id="admin-schedule-validate" class="admin-panel" data-admin-title="Schedule / Validate">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div>
                  <h5 class="card-title mb-1">Validate Schedule</h5>
                  <div class="small text-muted">–®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ —Ç–∞ –Ω–µ–¥–æ–ª—ñ–∫—ñ–≤.</div>
                </div>
                <button class="btn btn-outline-primary btn-sm" type="button" id="validateScheduleBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</button>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-homework')) { %>
        <div id="admin-homework" class="admin-panel" data-admin-title="Academics / Homework">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0"><%= t('admin.searchHomework') %></h5>
                <form method="POST" action="/admin/homework/migrate">
                  <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.migrateLegacyHomework') %></button>
                </form>
              </div>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="group_number"
                      placeholder="<%= t('admin.groupNumber') %>"
                      value="<%= (filters && filters.group_number) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="subject"
                      placeholder="<%= t('admin.subject') %>"
                      value="<%= (filters && filters.subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-4">
                    <input
                      class="form-control"
                      name="q"
                      placeholder="<%= t('admin.searchDescAuthor') %>"
                      value="<%= (filters && filters.q) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.search') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_from"
                      value="<%= (filters && filters.homework_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_to"
                      value="<%= (filters && filters.homework_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="homework_tag"
                      placeholder="<%= t('admin.tag') %>"
                      list="adminHomeworkTags"
                      value="<%= (filters && filters.homework_tag) || '' %>"
                    />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-4">
                    <select class="form-select" name="sort_homework">
                      <option value=""><%= t('admin.sortHomework') %></option>
                      <option value="created" <%= sorts && sorts.homework === 'created' ? 'selected' : '' %>>
                        <%= t('admin.sortNewest') %>
                      </option>
                      <option value="subject" <%= sorts && sorts.homework === 'subject' ? 'selected' : '' %>>
                        <%= t('admin.sortSubject') %>
                      </option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-secondary" type="submit"><%= t('admin.applySort') %></button>
                  </div>
                </div>
                <datalist id="adminHomeworkTags">
                  <% (homeworkTags || []).forEach(function(tag) { %>
                    <option value="<%= tag %>"></option>
                  <% }); %>
                </datalist>
              </form>
            </div>
          </div>
          <div class="bulk-bar d-none" id="homeworkBulkBar">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span class="text-muted">Selected: <span id="homeworkSelectedCount">0</span></span>
              <select class="form-select form-select-sm w-auto" id="homeworkBulkAction">
                <option value="">Bulk action</option>
                <option value="add_tags">Add tags</option>
                <option value="remove_tags">Remove tags</option>
                <option value="set_deadline">Set deadline</option>
                <option value="shift_deadline">Shift deadline (days)</option>
                <option value="move_to_week">Move to week</option>
                <option value="delete">Delete</option>
                <option value="export_csv">Export CSV</option>
              </select>
              <input class="form-control form-control-sm w-auto d-none" id="bulkTags" placeholder="tag1, tag2" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkDeadline" type="date" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkShift" type="number" placeholder="+/- days" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkWeek" type="number" min="1" max="15" placeholder="Week #" />
              <button class="btn btn-sm btn-outline-primary" type="button" id="bulkApplyBtn">Apply</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllHomework" /></th>
                  <th>ID</th>
                  <th><%= t('admin.groupNumber') %></th>
                  <th><%= t('admin.classNumber') %></th>
                  <th><%= t('admin.description') %></th>
                  <th><%= t('admin.tag') %></th>
                  <th><%= t('admin.dayClass') %></th>
                  <th><%= t('admin.createdBy') %></th>
                  <th><%= t('admin.attachment') %></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% homework.forEach(function(item) { %>
                  <tr>
                    <td><input type="checkbox" class="homework-select" value="<%= item.id %>" /></td>
                    <td><%= item.id %></td>
                    <td><%= item.group_number %></td>
                    <td><%= item.subject_name || item.subject %> (<%= item.day_of_week || item.day %>)</td>
                    <td><%= item.description %></td>
                    <td>
                      <% if (item.tags && item.tags.length) { %>
                        <%= item.tags.join(', ') %>
                      <% } else { %>
                        <span class="text-muted">‚Äî</span>
                      <% } %>
                    </td>
                    <td><%= item.day_of_week || item.day %> ¬∑ #<%= item.class_number || '-' %></td>
                    <td><%= item.created_by %></td>
                    <td>
                      <% if (item.file_path) { %>
                        <a href="<%= item.file_path %>"><%= item.file_name || 'Download' %></a>
                      <% } else if (item.meeting_url) { %>
                        <a href="<%= item.meeting_url %>" target="_blank" rel="noopener">Online class</a>
                      <% } else if (item.link_url) { %>
                        <a href="<%= item.link_url %>" target="_blank" rel="noopener">Link</a>
                      <% } else { %>
                        <span class="text-muted">‚Äî</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary homework-clone-btn" type="button" data-homework-id="<%= item.id %>">Clone</button>
                        <form method="POST" action="/admin/homework/delete/<%= item.id %>">
                          <button
                            class="btn btn-sm btn-outline-danger"
                            type="submit"
                            data-confirm="Delete this homework item?"
                            data-confirm-level="danger"
                          >
                            <%= t('admin.delete') %>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-users')) { %>
        <div id="admin-users" class="admin-panel" data-admin-title="People / Users">
          <% const hasUserFilters = filters && (filters.users_q || filters.users_group); %>
          <div class="accordion admin-filter-accordion mb-3" id="usersFilterAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="usersFilterHeading">
                <button
                  class="accordion-button <%= hasUserFilters ? '' : 'collapsed' %>"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#usersFilterCollapse"
                  aria-expanded="<%= hasUserFilters ? 'true' : 'false' %>"
                  aria-controls="usersFilterCollapse"
                >
                  –§—ñ–ª—å—Ç—Ä–∏
                </button>
              </h2>
              <div
                id="usersFilterCollapse"
                class="accordion-collapse collapse <%= hasUserFilters ? 'show' : '' %>"
                data-bs-parent="#usersFilterAccordion"
              >
                <div class="accordion-body">
                  <form method="GET" action="/admin">
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-5">
                        <label class="form-label"><%= t('admin.searchByName') %></label>
                        <input
                          class="form-control"
                          name="users_q"
                          placeholder="<%= t('admin.searchByNamePlaceholder') %>"
                          value="<%= (filters && filters.users_q) || '' %>"
                        />
                      </div>
                      <div class="col-12 col-md-3">
                        <label class="form-label"><%= t('admin.scheduleGroup') %></label>
                        <input
                          class="form-control"
                          name="users_group"
                          placeholder="<%= t('admin.scheduleGroupPlaceholder') %>"
                          value="<%= (filters && filters.users_group) || '' %>"
                        />
                      </div>
                      <div class="col-12 col-md-2 d-grid">
                        <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div class="bulk-bar" id="usersBulkBar">
            <div class="bulk-bar-content">
              <span class="bulk-count">Selected: <span id="usersBulkCount">0</span></span>
              <button class="btn btn-danger btn-sm" type="submit" form="deleteUsersForm" data-confirm="Delete selected users?" data-confirm-level="danger">Delete selected</button>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-status="active"><%= t('admin.active') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="inactive"><%= t('admin.inactive') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="all"><%= t('admin.all') %></button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-role-filter="all"><%= t('admin.allRoles') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="admin"><%= t('admin.admins') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="starosta"><%= t('admin.starosta') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="deanery"><%= t('admin.deanery') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="student"><%= t('admin.students') %></button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllUsers" /></th>
                  <th><%= t('admin.name') %></th>
                  <th><%= t('admin.role') %></th>
                  <th><%= t('admin.subjectGroup') %></th>
                  <th><%= t('admin.setGroup') %></th>
                  <th><%= t('admin.actions') %></th>
                </tr>
              </thead>
              <tbody
                id="usersTableBody"
                data-current-user-id="<%= typeof userId !== 'undefined' ? userId : '' %>"
                data-status="<%= usersStatus || 'active' %>"
                data-role-filter="all"
                data-course-id="<%= selectedCourseId || 1 %>"
                data-search="<%= (filters && filters.users_q) || '' %>"
                data-group="<%= (filters && filters.users_group) || '' %>"
              >
                <% (users || []).forEach(function(u) { %>
                  <% const rowRoleKeys = Array.isArray(u.role_keys) && u.role_keys.length
                    ? u.role_keys
                    : (userRoleAssignmentsMap[u.id] || [userPrimaryRoleMapData[u.id] || u.primary_role || u.role || 'student']); %>
                  <% const rowPrimaryRole = u.primary_role || userPrimaryRoleMapData[u.id] || rowRoleKeys[0] || u.role || 'student'; %>
                  <% const hasAdminRole = rowRoleKeys.includes('admin'); %>
                  <% const rowRolesLabel = rowRoleKeys.map((key) => roleLabelMapData[key] || key).join(', '); %>
                  <tr
                    class="user-row"
                    data-user-id="<%= u.id %>"
                    data-user-name="<%= u.full_name %>"
                    data-user-role="<%= rowPrimaryRole %>"
                    data-user-roles="<%= rowRoleKeys.join(',') %>"
                    data-user-group="<%= u.schedule_group %>"
                    data-user-course="<%= courseMap[u.course_id] || ('Course ' + (u.course_id || 1)) %>"
                    data-user-course-id="<%= u.course_id || 1 %>"
                    data-user-active="<%= u.is_active %>"
                    data-user-ip="<%= u.last_login_ip || '' %>"
                    data-user-agent="<%= u.last_user_agent || '' %>"
                    data-user-login="<%= u.last_login_at || '' %>"
                  >
                    <td>
                      <% if (!hasAdminRole) { %>
                        <input type="checkbox" name="delete_user_ids" value="<%= u.id %>" form="deleteUsersForm" />
                      <% } %>
                    </td>
                    <td><%= u.full_name %></td>
                    <td>
                      <span class="badge text-bg-<%= rowPrimaryRole === 'admin' ? 'primary' : (rowPrimaryRole === 'starosta' ? 'warning' : (rowPrimaryRole === 'deanery' ? 'info' : 'secondary')) %>">
                        <%= rowRolesLabel %>
                      </span>
                    </td>
                    <td>
                      <% 
                        const subjectList = [];
                        if (groupMap[u.id]) {
                          Object.keys(groupMap[u.id]).forEach(function(subjectId) {
                            const subj = (subjects || []).find(function(s) { return String(s.id) === String(subjectId); });
                            if (subj) {
                              subjectList.push({ subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][subjectId] });
                            }
                          });
                        }
                      %>
                      <button
                        class="btn btn-sm btn-outline-primary subject-groups-btn"
                        type="button"
                        data-user-id="<%= u.id %>"
                        data-user-name="<%= u.full_name %>"
                        data-subjects='<%- JSON.stringify(subjectList) %>'
                      >
                        <%= t('admin.subjects') %> (<%= subjectList.length %>)
                      </button>
                    </td>
                    <td>
                      <form method="POST" action="/admin/student-groups/set" class="row g-2">
                        <input type="hidden" name="student_id" value="<%= u.id %>" />
                        <div class="col-12 col-md-6">
                          <select class="form-select form-select-sm" name="subject_id" required>
                            <option value="" disabled selected><%= t('admin.subject') %></option>
                            <% (subjects || []).forEach(function(s) { %>
                              <option value="<%= s.id %>"><%= s.name %> (1‚Äì<%= s.group_count %>)</option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-3">
                          <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                          <button class="btn btn-sm btn-outline-primary" type="submit"><%= t('admin.save') %></button>
                        </div>
                      </form>
                    </td>
                    <td class="text-end">
                      <form id="user-delete-<%= u.id %>" method="POST" action="/admin/users/delete-permanent"></form>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                          ‚ãØ
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><button class="dropdown-item user-manage-btn" type="button"><%= t('admin.manage') %></button></li>
                          <% if (!hasAdminRole && u.is_active === 0) { %>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                              <button
                                class="dropdown-item text-danger"
                                type="submit"
                                form="user-delete-<%= u.id %>"
                                data-confirm="<%= t('admin.deletePermanentConfirm') %>"
                                data-confirm-level="danger"
                              >
                                <%= t('admin.deletePermanent') %>
                              </button>
                              <input type="hidden" name="user_id" value="<%= u.id %>" form="user-delete-<%= u.id %>" />
                            </li>
                          <% } %>
                        </ul>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <form id="deleteUsersForm" method="POST" action="/admin/users/delete-multiple"></form>
          <form id="clearUsersForm" method="POST" action="/admin/users/clear-all"></form>
          <div class="danger-zone mt-3">
            <div class="danger-zone-header">Danger zone</div>
            <div class="small text-muted mb-2">–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å —É—Å—ñ—Ö —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –∫—É—Ä—Å—É –±–µ–∑ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.</div>
            <button
              class="btn btn-danger btn-sm"
              type="submit"
              form="clearUsersForm"
              data-confirm="Delete ALL students? This cannot be undone."
              data-confirm-level="danger"
              data-confirm-typed="DELETE ALL"
            >
              <%= t('admin.deleteAllStudents') %>
            </button>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-students')) { %>
        <div id="admin-students" class="admin-panel" data-admin-title="People / Students">
          <% const hasStudentsFilters = filters && (filters.users_q || filters.users_group || usersStatus); %>
          <div class="accordion admin-filter-accordion mb-3" id="studentsFilterAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="studentsFilterHeading">
                <button
                  class="accordion-button <%= hasStudentsFilters ? '' : 'collapsed' %>"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#studentsFilterCollapse"
                  aria-expanded="<%= hasStudentsFilters ? 'true' : 'false' %>"
                  aria-controls="studentsFilterCollapse"
                >
                  –§—ñ–ª—å—Ç—Ä–∏ students
                </button>
              </h2>
              <div
                id="studentsFilterCollapse"
                class="accordion-collapse collapse <%= hasStudentsFilters ? 'show' : '' %>"
                data-bs-parent="#studentsFilterAccordion"
              >
                <div class="accordion-body">
                  <form method="GET" action="/admin">
                    <input type="hidden" name="tab" value="admin-students" />
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-4">
                        <label class="form-label"><%= t('admin.searchByName') %></label>
                        <input
                          class="form-control"
                          name="users_q"
                          placeholder="<%= t('admin.searchByNamePlaceholder') %>"
                          value="<%= (filters && filters.users_q) || '' %>"
                        />
                      </div>
                      <div class="col-12 col-md-3">
                        <label class="form-label"><%= t('admin.scheduleGroup') %></label>
                        <input
                          class="form-control"
                          name="users_group"
                          placeholder="<%= t('admin.scheduleGroupPlaceholder') %>"
                          value="<%= (filters && filters.users_group) || '' %>"
                        />
                      </div>
                      <div class="col-12 col-md-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" name="users_status">
                          <% const studentsStatusValue = usersStatus || 'all'; %>
                          <option value="active" <%= studentsStatusValue === 'active' ? 'selected' : '' %>><%= t('admin.active') %></option>
                          <option value="inactive" <%= studentsStatusValue === 'inactive' ? 'selected' : '' %>><%= t('admin.inactive') %></option>
                          <option value="all" <%= studentsStatusValue === 'all' ? 'selected' : '' %>><%= t('admin.all') %></option>
                        </select>
                      </div>
                      <div class="col-12 col-md-2 d-grid">
                        <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <% const studentRows = (users || []).filter(function(u) {
            const roleKeys = Array.isArray(u.role_keys) && u.role_keys.length
              ? u.role_keys
              : (userRoleAssignmentsMap[u.id] || [userPrimaryRoleMapData[u.id] || u.primary_role || u.role || 'student']);
            const primaryRole = u.primary_role || userPrimaryRoleMapData[u.id] || roleKeys[0] || u.role || 'student';
            return ['student', 'starosta'].includes(String(primaryRole || '').toLowerCase());
          }); %>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><%= t('admin.name') %></th>
                  <th><%= t('admin.role') %></th>
                  <th><%= t('admin.subjectGroup') %></th>
                  <th><%= t('admin.setGroup') %></th>
                  <th><%= t('admin.actions') %></th>
                </tr>
              </thead>
              <tbody>
                <% studentRows.forEach(function(u) { %>
                  <% const rowRoleKeys = Array.isArray(u.role_keys) && u.role_keys.length
                    ? u.role_keys
                    : (userRoleAssignmentsMap[u.id] || [userPrimaryRoleMapData[u.id] || u.primary_role || u.role || 'student']); %>
                  <% const rowPrimaryRole = u.primary_role || userPrimaryRoleMapData[u.id] || rowRoleKeys[0] || u.role || 'student'; %>
                  <% const rowRolesLabel = rowRoleKeys.map((key) => roleLabelMapData[key] || key).join(', '); %>
                  <tr>
                    <td><%= u.full_name %></td>
                    <td>
                      <span class="badge text-bg-<%= rowPrimaryRole === 'starosta' ? 'warning' : 'secondary' %>">
                        <%= rowRolesLabel %>
                      </span>
                    </td>
                    <td>
                      <%
                        const subjectList = [];
                        if (groupMap[u.id]) {
                          Object.keys(groupMap[u.id]).forEach(function(subjectId) {
                            const subj = (subjects || []).find(function(s) { return String(s.id) === String(subjectId); });
                            if (subj) {
                              subjectList.push({ subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][subjectId] });
                            }
                          });
                        }
                      %>
                      <button
                        class="btn btn-sm btn-outline-primary subject-groups-btn"
                        type="button"
                        data-user-id="<%= u.id %>"
                        data-user-name="<%= u.full_name %>"
                        data-remove-action="/admin/students/group/remove"
                        data-subjects='<%- JSON.stringify(subjectList) %>'
                      >
                        <%= t('admin.subjects') %> (<%= subjectList.length %>)
                      </button>
                    </td>
                    <td>
                      <form method="POST" action="/admin/students/groups/set" class="row g-2">
                        <input type="hidden" name="student_id" value="<%= u.id %>" />
                        <div class="col-12 col-md-6">
                          <select class="form-select form-select-sm" name="subject_id" required>
                            <option value="" disabled selected><%= t('admin.subject') %></option>
                            <% (subjects || []).forEach(function(s) { %>
                              <option value="<%= s.id %>"><%= s.name %> (1‚Äì<%= s.group_count %>)</option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-3">
                          <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                          <button class="btn btn-sm btn-outline-primary" type="submit"><%= t('admin.save') %></button>
                        </div>
                      </form>
                    </td>
                    <td>
                      <% if (u.is_active === 0) { %>
                        <form method="POST" action="/admin/students/activate">
                          <input type="hidden" name="user_id" value="<%= u.id %>" />
                          <button class="btn btn-sm btn-outline-success" type="submit">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>
                        </form>
                      <% } else { %>
                        <form method="POST" action="/admin/students/deactivate">
                          <input type="hidden" name="user_id" value="<%= u.id %>" />
                          <button
                            class="btn btn-sm btn-outline-danger"
                            type="submit"
                            data-confirm="–î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ —Ü—å–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞?"
                            data-confirm-level="warning"
                          >
                            –î–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
                <% if (!studentRows.length) { %>
                  <tr>
                    <td colspan="7" class="text-muted">Students –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-teachers')) { %>
        <div id="admin-teachers" class="admin-panel" data-admin-title="People / Teacher Requests">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">–ó–∞—è–≤–∫–∏ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>–Ü–º º—è</th>
                      <th>–ü—Ä–µ–¥–º–µ—Ç–∏</th>
                      <th>–°—Ç–∞—Ç—É—Å</th>
                      <th>–î–∞—Ç–∞</th>
                      <th>–î—ñ—ó</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (teacherRequests || []).forEach(function(reqRow) { %>
                      <tr>
                        <td><%= reqRow.full_name %></td>
                        <td>
                          <% if (reqRow.subjects && reqRow.subjects.length) { %>
                            <div class="d-flex flex-wrap gap-1">
                              <% reqRow.subjects.forEach(function(subj) { %>
                                <span class="badge bg-secondary"><%= subj %></span>
                              <% }); %>
                            </div>
                          <% } else { %>
                            <span class="text-muted">‚Äî</span>
                          <% } %>
                        </td>
                        <td>
                          <span class="badge <%= reqRow.status === 'approved' ? 'bg-success' : (reqRow.status === 'rejected' ? 'bg-danger' : 'bg-warning text-dark') %>">
                            <%= reqRow.status %>
                          </span>
                        </td>
                        <td class="small text-muted">
                          <%= reqRow.created_at ? new Date(reqRow.created_at).toLocaleDateString('uk-UA') : '' %>
                        </td>
                        <td class="d-flex gap-2">
                          <% if (reqRow.status !== 'approved') { %>
                            <form method="POST" action="/admin/teacher-requests/<%= reqRow.user_id %>/approve">
                              <button class="btn btn-sm btn-outline-success" type="submit">Approve</button>
                            </form>
                          <% } %>
                          <% if (reqRow.status !== 'rejected') { %>
                            <form method="POST" action="/admin/teacher-requests/<%= reqRow.user_id %>/reject">
                              <button class="btn btn-sm btn-outline-danger" type="submit">Reject</button>
                            </form>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(teacherRequests || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-subjects')) { %>
        <div id="admin-subjects" class="admin-panel" data-admin-title="Academics / Subjects">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Add subject</h5>
              <form method="POST" action="/admin/subjects/add" novalidate>
                <div class="row g-2">
                  <div class="col-12 col-md-5">
                    <input class="form-control" name="name" placeholder="Subject name" />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="group_count">
                      <option value="" disabled selected>Groups</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="default_group">
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="show_in_teamwork">
                      <option value="1" selected>Teamwork: Yes</option>
                      <option value="0">Teamwork: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="visible">
                      <option value="1" selected>Visible: Yes</option>
                      <option value="0">Visible: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="is_required">
                      <option value="1" selected>Required: Yes</option>
                      <option value="0">Required: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-flex align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_general" id="subjectGeneralCreate" value="1" checked />
                      <label class="form-check-label" for="subjectGeneralCreate">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Groups</th>
                  <th>Default</th>
                  <th>Teamwork</th>
                  <th>Visible</th>
                  <th>Required</th>
                  <th>General</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% (subjects || []).forEach(function(s) { %>
                  <% const requiredFlag = typeof s.is_required === 'undefined' || s.is_required === null ? 1 : Number(s.is_required); %>
                  <% const generalFlag = typeof s.is_general === 'undefined' || s.is_general === null ? 1 : Number(s.is_general); %>
                  <tr>
                    <td><%= s.id %></td>
                    <td>
                      <input class="form-control form-control-sm" name="name" form="subject-<%= s.id %>" value="<%= s.name %>" required />
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="group_count" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.group_count === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.group_count === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.group_count === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="default_group" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.default_group === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.default_group === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.default_group === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="show_in_teamwork" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.show_in_teamwork === 1 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.show_in_teamwork === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="visible" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.visible !== 0 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.visible === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="is_required" form="subject-<%= s.id %>" required>
                        <option value="1" <%= requiredFlag === 1 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= requiredFlag === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td class="text-center">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="is_general"
                        form="subject-<%= s.id %>"
                        value="1"
                        <%= generalFlag === 1 ? 'checked' : '' %>
                      />
                    </td>
                    <td class="text-end">
                      <form id="subject-<%= s.id %>" method="POST" action="/admin/subjects/edit/<%= s.id %>" data-save-all="true"></form>
                      <form id="subject-delete-<%= s.id %>" method="POST" action="/admin/subjects/delete/<%= s.id %>"></form>
                      <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                          ‚ãØ
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><button class="dropdown-item" type="submit" form="subject-<%= s.id %>">Save</button></li>
                          <li><button class="dropdown-item subject-clone-btn" type="button" data-subject-id="<%= s.id %>" data-subject-name="<%= s.name %>">Clone</button></li>
                          <li><hr class="dropdown-divider" /></li>
                          <li><button class="dropdown-item text-danger" type="submit" form="subject-delete-<%= s.id %>" data-confirm="Delete this subject and its groups?" data-confirm-level="danger">Delete</button></li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-semesters')) { %>
        <div id="admin-semesters" class="admin-panel" data-admin-title="Academics / Semesters">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create semester</h5>
              <form method="POST" action="/admin/semesters/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="title" placeholder="Semester title" required />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" type="date" name="start_date" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <input class="form-control" type="number" name="weeks_count" min="1" max="30" value="15" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="is_active">
                      <option value="1">Active</option>
                      <option value="0" selected>Inactive</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Semesters</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Start date</th>
                      <th>Weeks</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (semesters || []).forEach(function(sem) { %>
                      <tr>
                        <td>
                          <input class="form-control form-control-sm" name="title" form="semester-<%= sem.id %>" value="<%= sem.title %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="date" name="start_date" form="semester-<%= sem.id %>" value="<%= sem.start_date %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="number" min="1" max="30" name="weeks_count" form="semester-<%= sem.id %>" value="<%= sem.weeks_count %>" required />
                        </td>
                        <td>
                          <% if (sem.is_active === 1) { %>
                            <span class="badge text-bg-success">Active</span>
                          <% } else if (sem.is_archived === 1) { %>
                            <span class="badge text-bg-secondary">Archived</span>
                          <% } else { %>
                            <span class="badge text-bg-light text-dark">Inactive</span>
                          <% } %>
                        </td>
                        <td class="text-end">
                          <form id="semester-<%= sem.id %>" method="POST" action="/admin/semesters/edit/<%= sem.id %>" data-save-all="true"></form>
                          <form id="semester-active-<%= sem.id %>" method="POST" action="/admin/semesters/set-active/<%= sem.id %>"></form>
                          <form id="semester-restore-<%= sem.id %>" method="POST" action="/admin/semesters/restore/<%= sem.id %>"></form>
                          <form id="semester-archive-<%= sem.id %>" method="POST" action="/admin/semesters/archive/<%= sem.id %>"></form>
                          <form id="semester-delete-<%= sem.id %>" method="POST" action="/admin/semesters/delete/<%= sem.id %>"></form>
                          <form id="semester-hard-delete-<%= sem.id %>" method="POST" action="/admin/semesters/hard-delete/<%= sem.id %>"></form>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              ‚ãØ
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li><button class="dropdown-item" type="submit" form="semester-<%= sem.id %>">Save</button></li>
                              <% if (!sem.is_active) { %>
                                <li><button class="dropdown-item" type="submit" form="semester-active-<%= sem.id %>" data-confirm="Set this semester as active? This affects schedule and homework." data-confirm-level="warning">Set active</button></li>
                              <% } %>
                              <% if (sem.is_archived) { %>
                                <li><button class="dropdown-item" type="submit" form="semester-restore-<%= sem.id %>">Restore</button></li>
                              <% } else { %>
                                <li><button class="dropdown-item" type="submit" form="semester-archive-<%= sem.id %>" data-confirm="Archive this semester?" data-confirm-level="warning">Archive</button></li>
                              <% } %>
                              <li><hr class="dropdown-divider" /></li>
                              <li><button class="dropdown-item text-danger" type="submit" form="semester-delete-<%= sem.id %>" data-confirm="Delete this semester? This cannot be undone." data-confirm-level="danger">Delete</button></li>
                              <li>
                                <button
                                  class="dropdown-item text-danger"
                                  type="submit"
                                  form="semester-hard-delete-<%= sem.id %>"
                                  data-confirm="Hard delete semester and ALL related data? This cannot be undone."
                                  data-confirm-level="danger"
                                  data-confirm-typed="HARD DELETE"
                                >
                                  Hard delete
                                </button>
                              </li>
                            </ul>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(semesters || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">No semesters yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-courses')) { %>
        <div id="admin-courses" class="admin-panel" data-admin-title="Academics / Courses">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create course</h5>
              <form method="POST" action="/admin/courses/add">
                <div class="row g-2">
                  <div class="col-12 col-md-2">
                    <input class="form-control" type="number" name="id" min="1" placeholder="Course ID (e.g. 3)" required />
                  </div>
                  <div class="col-12 col-md-4">
                    <input class="form-control" name="name" placeholder="Course name (e.g. 3 –∫—É—Ä—Å)" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="location" required>
                      <option value="kyiv" selected>Kyiv</option>
                      <option value="munich">Munich</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-flex align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_teacher_course" id="teacherCourseCreate" value="1" />
                      <label class="form-check-label" for="teacherCourseCreate">–ö—É—Ä—Å –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Courses</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Campus</th>
                      <th>Teacher</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (courses || []).forEach(function(c) { %>
                      <tr>
                        <td><%= c.id %></td>
                        <td>
                          <input class="form-control form-control-sm" name="name" form="course-<%= c.id %>" value="<%= c.name %>" required />
                        </td>
                        <td>
                          <select class="form-select form-select-sm" name="location" form="course-<%= c.id %>" required>
                            <option value="kyiv" <%= String(c.location || 'kyiv') === 'kyiv' ? 'selected' : '' %>>Kyiv</option>
                            <option value="munich" <%= String(c.location || '') === 'munich' ? 'selected' : '' %>>Munich</option>
                          </select>
                        </td>
                        <td>
                          <input
                            class="form-check-input"
                            type="checkbox"
                            name="is_teacher_course"
                            form="course-<%= c.id %>"
                            value="1"
                            <%= c.is_teacher_course ? 'checked' : '' %>
                          />
                        </td>
                        <td class="text-end">
                          <form id="course-<%= c.id %>" method="POST" action="/admin/courses/edit/<%= c.id %>" data-save-all="true"></form>
                          <form id="course-delete-<%= c.id %>" method="POST" action="/admin/courses/delete/<%= c.id %>"></form>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              ‚ãØ
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                              <li><button class="dropdown-item" type="submit" form="course-<%= c.id %>">Save</button></li>
                              <li>
                                <button
                                  class="dropdown-item study-days-btn"
                                  type="button"
                                  data-course-id="<%= c.id %>"
                                  data-course-name="<%= c.name %>"
                                >
                                  –î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è
                                </button>
                              </li>
                              <li>
                                <button
                                  class="dropdown-item week-time-btn"
                                  type="button"
                                  data-course-id="<%= c.id %>"
                                  data-course-name="<%= c.name %>"
                                >
                                  –ß–∞—Å —Ç–∏–∂–Ω—ñ–≤
                                </button>
                              </li>
                              <li><hr class="dropdown-divider" /></li>
                              <li><button class="dropdown-item text-danger" type="submit" form="course-delete-<%= c.id %>" data-confirm="Delete this course?" data-confirm-level="danger">Delete</button></li>
                            </ul>
                          </div>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(courses || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted"><%= t('admin.noCourses') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-visit-analytics')) { %>
        <div id="admin-visit-analytics" class="admin-panel" data-admin-title="Activity / Visit analytics">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                <div>
                  <h5 class="card-title mb-1">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è</h5>
                  <div class="small text-muted">–ñ–∏–≤—ñ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –≤—ñ–∑–∏—Ç–∞—Ö, —Ä–æ–ª—è—Ö —ñ –ø–æ–ø—É–ª—è—Ä–Ω–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö.</div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                  <select class="form-select form-select-sm" id="visitAnalyticsDays" aria-label="Analytics period">
                    <option value="7">7 –¥–Ω—ñ–≤</option>
                    <option value="14" selected>14 –¥–Ω—ñ–≤</option>
                    <option value="30">30 –¥–Ω—ñ–≤</option>
                    <option value="60">60 –¥–Ω—ñ–≤</option>
                    <option value="90">90 –¥–Ω—ñ–≤</option>
                  </select>
                  <button class="btn btn-outline-primary btn-sm" type="button" id="visitAnalyticsRefresh">–û–Ω–æ–≤–∏—Ç–∏</button>
                </div>
              </div>

              <div class="visit-analytics-grid mt-3">
                <div class="visit-metric-card">
                  <div class="small text-muted">–í—ñ–∑–∏—Ç–∏</div>
                  <div class="visit-metric-value" id="visitMetricTotal">‚Äî</div>
                </div>
                <div class="visit-metric-card">
                  <div class="small text-muted">–£–Ω—ñ–∫–∞–ª—å–Ω—ñ –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ</div>
                  <div class="visit-metric-value" id="visitMetricUnique">‚Äî</div>
                </div>
                <div class="visit-metric-card">
                  <div class="small text-muted">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</div>
                  <div class="visit-metric-value" id="visitMetricSigned">‚Äî</div>
                </div>
                <div class="visit-metric-card">
                  <div class="small text-muted">–ê–∫—Ç–∏–≤–Ω—ñ –¥–Ω—ñ</div>
                  <div class="visit-metric-value" id="visitMetricDays">‚Äî</div>
                </div>
              </div>

              <div class="visit-chart-wrap mt-3">
                <canvas id="visitAnalyticsChart" height="120"></canvas>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12 col-xl-6">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="mb-3">–¢–æ–ø —Å—Ç–æ—Ä—ñ–Ω–∫–∏</h6>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr>
                          <th>–°—Ç–æ—Ä—ñ–Ω–∫–∞</th>
                          <th>–í—ñ–∑–∏—Ç–∏</th>
                          <th>–£–Ω—ñ–∫–∞–ª—å–Ω—ñ</th>
                        </tr>
                      </thead>
                      <tbody id="visitTopPagesBody">
                        <tr>
                          <td colspan="3" class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 col-xl-6">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="mb-3">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ —Ä–æ–ª—è–º–∏</h6>
                  <div id="visitRolesList" class="visit-role-list">
                    <div class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h6 class="mb-3">–û—Å—Ç–∞–Ω–Ω—ñ –≤—ñ–∑–∏—Ç–∏</h6>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>–ß–∞—Å</th>
                      <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
                      <th>–†–æ–ª—å</th>
                      <th>–°—Ç–æ—Ä—ñ–Ω–∫–∞</th>
                      <th>–®–ª—è—Ö</th>
                    </tr>
                  </thead>
                  <tbody id="visitRecentBody">
                    <tr>
                      <td colspan="5" class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-history')) { %>
        <div id="admin-history" class="admin-panel" data-admin-title="Activity / History">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.historyFilters') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_actor" placeholder="<%= t('admin.actor') %>" value="<%= historyFilters && historyFilters.actor || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_action" placeholder="<%= t('admin.action') %>" value="<%= historyFilters && historyFilters.action || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_q" placeholder="<%= t('admin.detailsContains') %>" value="<%= historyFilters && historyFilters.q || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_from" value="<%= historyFilters && historyFilters.from || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_to" value="<%= historyFilters && historyFilters.to || '' %>" />
                  </div>
                  <div class="col-12 col-md-1 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="mt-2">
                <a
                  class="btn btn-outline-secondary btn-sm"
                  href="/admin/history.csv?history_actor=<%= encodeURIComponent(historyFilters && historyFilters.actor || '') %>&history_action=<%= encodeURIComponent(historyFilters && historyFilters.action || '') %>&history_q=<%= encodeURIComponent(historyFilters && historyFilters.q || '') %>&history_from=<%= encodeURIComponent(historyFilters && historyFilters.from || '') %>&history_to=<%= encodeURIComponent(historyFilters && historyFilters.to || '') %>"
                >
                  <%= t('admin.exportHistory') %>
                </a>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th><%= t('admin.actor') %></th>
                  <th><%= t('admin.action') %></th>
                  <th><%= t('admin.details') %></th>
                  <th><%= t('admin.time') %></th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <% (logs || []).forEach(function(log) { %>
                  <tr>
                    <td><%= log.id %></td>
                    <td><%= log.actor_name || '-' %></td>
                    <td><%= log.action %></td>
                    <td><%= log.details || '-' %></td>
                    <td><%= log.created_at %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-activity')) { %>
        <div id="admin-activity" class="admin-panel" data-admin-title="Activity / Log">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.activityLog') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.user') %></label>
                    <input class="form-control" name="activity_user" placeholder="<%= t('admin.userName') %>" value="<%= activityFilters && activityFilters.user ? activityFilters.user : '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.action') %></label>
                    <input class="form-control" name="activity_action" placeholder="<%= t('admin.actionPlaceholder') %>" value="<%= activityFilters && activityFilters.action ? activityFilters.action : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input class="form-control" type="date" name="activity_from" value="<%= activityFilters && activityFilters.from ? activityFilters.from : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input class="form-control" type="date" name="activity_to" value="<%= activityFilters && activityFilters.to ? activityFilters.to : '' %>" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h6 class="mb-3"><%= t('admin.topActive') %></h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.points') %></th>
                      <th><%= t('admin.actions') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityTop || []).forEach(function(row, idx) { %>
                      <tr>
                        <td><%= idx + 1 %></td>
                        <td><%= row.user_name || '-' %></td>
                        <td><%= row.points || 0 %></td>
                        <td><%= row.actions_count || 0 %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityTop || []).length) { %>
                      <tr>
                        <td colspan="4" class="text-muted"><%= t('admin.noActivity') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.action') %></th>
                      <th><%= t('admin.target') %></th>
                      <th><%= t('admin.details') %></th>
                      <th><%= t('admin.created') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityLogs || []).forEach(function(a) { %>
                      <tr>
                        <td><%= a.id %></td>
                        <td><%= a.user_name || '-' %></td>
                        <td><%= a.action_type %></td>
                        <td><%= a.target_type || '-' %> <%= a.target_id ? '#' + a.target_id : '' %></td>
                        <td><%= a.details || '-' %></td>
                        <td><%= a.created_at %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityLogs || []).length) { %>
                      <tr>
                        <td colspan="6" class="text-muted"><%= t('admin.noActivityLog') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-teamwork')) { %>
        <div id="admin-teamwork" class="admin-panel" data-admin-title="Teamwork">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.teamworkTasks') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <input
                      class="form-control"
                      name="teamwork_subject"
                      placeholder="<%= t('admin.subjectPlaceholder') %>"
                      value="<%= (filters && filters.teamwork_subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_from"
                      value="<%= (filters && filters.teamwork_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_to"
                      value="<%= (filters && filters.teamwork_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.subject') %></th>
                      <th><%= t('admin.titleLabel') %></th>
                      <th><%= t('admin.groups') %></th>
                      <th><%= t('admin.members') %></th>
                      <th><%= t('admin.created') %></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (teamworkTasks || []).forEach(function(task) { %>
                      <tr>
                        <td><%= task.id %></td>
                        <td><%= task.subject_name %></td>
                        <td><%= task.title %></td>
                        <td><%= task.group_count %></td>
                        <td><%= task.member_count %></td>
                        <td><%= task.created_at %></td>
                        <td>
                          <form method="POST" action="/admin/teamwork/delete/<%= task.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              data-confirm="Delete this teamwork task?"
                              data-confirm-level="danger"
                            >
                              <%= t('admin.delete') %>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(teamworkTasks || []).length) { %>
                      <tr>
                        <td colspan="7" class="text-muted"><%= t('admin.noTeamwork') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-messages') && settings && settings.allow_messages) { %>
        <div id="admin-messages" class="admin-panel" data-admin-title="Communications / Messages">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.sendMessage') %></h5>
              <form method="POST" action="/admin/messages/send">
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <textarea class="form-control" name="body" rows="3" placeholder="<%= t('admin.messagePlaceholder') %>" required></textarea>
                  </div>
                </div>
                <div class="row g-2 align-items-end">
                  <% const canBroadcastAllCourses = role === 'admin'; %>
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.target') %></label>
                    <select class="form-select" name="target_type" id="messageTargetType">
                      <option value="all"><%= t('admin.targetAll') %></option>
                      <% if (canBroadcastAllCourses) { %>
                        <option value="all_courses">–£—Å—ñ –∫—É—Ä—Å–∏</option>
                      <% } %>
                      <option value="subject"><%= t('admin.targetSubjectGroup') %></option>
                      <option value="users"><%= t('admin.targetUsers') %></option>
                    </select>
                    <div class="form-text text-muted">
                      <% if (canBroadcastAllCourses) { %>–ê–¥–º—ñ–Ω –º–æ–∂–µ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –≤—Å—ñ–º –∫—É—Ä—Å–∞–º, —ñ–Ω—à—ñ —Ä–æ–ª—ñ ‚Äî –ª–∏—à–µ —Å–≤–æ—î–º—É.<% } else { %>–î–æ—Å—Ç—É–ø–Ω–æ –ª–∏—à–µ –¥–ª—è –≤–∞—à–æ–≥–æ –∫—É—Ä—Å—É.<% } %>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <select class="form-select" name="subject_id" id="messageSubjectSelect">
                      <option value="" disabled selected><%= t('admin.selectSubject') %></option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>"><%= s.name %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.group') %></label>
                    <input class="form-control" type="number" min="1" max="3" name="group_number" id="messageGroupInput" placeholder="1-3" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit"><%= t('admin.send') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status" id="messageStatusSelect">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label">Publish at</label>
                    <input class="form-control" type="datetime-local" name="scheduled_at" id="messageScheduledAt" />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12">
                    <label class="form-label">Specific users</label>
                    <select class="form-select" name="user_ids" id="messageUsersSelect" multiple size="5">
                      <% (users || []).filter(function(u) {
                        const keys = Array.isArray(u.role_keys) && u.role_keys.length
                          ? u.role_keys
                          : [u.primary_role || u.role || 'student'];
                        return keys.includes('student');
                      }).forEach(function(u) { %>
                        <option value="<%= u.id %>"><%= u.full_name %></option>
                      <% }); %>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Existing messages</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Body</th>
                      <th>Target</th>
                      <th>Created</th>
                      <th>Status</th>
                      <th>Schedule</th>
                      <th>Reads</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (adminMessages || []).forEach(function(m) { %>
                      <tr>
                        <td><%= m.id %></td>
                        <td><%= m.body %></td>
                        <td>
                          <% if (m.target_all === 1) { %>
                            All students
                          <% } else if (m.subject_name) { %>
                            <%= m.subject_name %> ¬∑ Group <%= m.group_number %>
                          <% } else { %>
                            Users
                          <% } %>
                        </td>
                        <td><%= m.created_at %></td>
                        <td>
                          <span class="badge <%= m.status === 'draft' ? 'bg-secondary' : (m.status === 'scheduled' ? 'bg-warning text-dark' : 'bg-success') %>">
                            <%= m.status || 'published' %>
                          </span>
                        </td>
                        <td><%= m.scheduled_at || '‚Äî' %></td>
                        <td>
                          <% if (typeof m.target_count !== 'undefined' && m.target_count > 0) { %>
                            <button class="btn btn-sm btn-outline-primary message-reads-btn" type="button" data-message-id="<%= m.id %>">
                              <%= m.read_count || 0 %>/<%= m.target_count %>
                            </button>
                          <% } else { %>
                            <span class="text-muted">‚Äî</span>
                          <% } %>
                        </td>
                        <td>
                          <form method="POST" action="/admin/messages/delete/<%= m.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              data-confirm="Delete this message?"
                              data-confirm-level="danger"
                            >
                              Delete
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(adminMessages || []).length) { %>
                      <tr>
                        <td colspan="8" class="text-muted">No messages yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% } %>
        </div>
      </div>
    </main>
    <footer class="app-footer text-center py-4">
      <small>
        ¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %> ¬∑
        <button
          type="button"
          class="btn btn-link btn-sm p-0 align-baseline"
          data-bs-toggle="modal"
          data-bs-target="#changelogModal"
        >
          Changelog
        </button>
      </small>
    </footer>
    <% if (!isLimitedView) { %>
      <button class="btn btn-primary save-all-btn" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å–µ</button>
    <% } %>

    <% if (!isLimitedView && role === 'admin') { %>
      <div class="modal fade admin-preview-modal" id="adminPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">–¢–µ—Å—Ç–æ–≤–∏–π –ø–µ—Ä–µ–≥–ª—è–¥</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form method="POST" action="/admin/switch-to-student" class="admin-preview-form">
                <input type="hidden" name="mode" value="manual" />
                <label class="form-label mb-1">–ö—É—Ä—Å</label>
                <select name="course_id" class="form-select mb-2" aria-label="Select preview course">
                  <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>>
                      <%= c.name %>
                    </option>
                  <% }); %>
                </select>
                <label class="form-label mb-1">–ì—Ä—É–ø–∞</label>
                <select name="group_number" class="form-select mb-3" aria-label="Select preview group">
                  <option value="1">–ì—Ä—É–ø–∞ 1</option>
                  <option value="2">–ì—Ä—É–ø–∞ 2</option>
                  <option value="3">–ì—Ä—É–ø–∞ 3</option>
                </select>
                <button class="btn btn-outline-primary admin-topbar-btn w-100" type="submit"><%= t('admin.viewAsStudent') %></button>
              </form>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <%- include('partials/changelog-modal') %>
    <div class="modal fade" id="userActionsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userActionsTitle">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><strong>Name:</strong> <span id="uaName"></span></div>
            <div class="mb-2"><strong>Primary Role:</strong> <span id="uaRole"></span></div>
            <div class="mb-2"><strong>Roles:</strong> <span id="uaRoles"></span></div>
            <div class="mb-2"><strong>Active:</strong> <span id="uaActive"></span></div>
            <div class="mb-2"><strong>Schedule Group:</strong> <span id="uaGroup"></span></div>
            <div class="mb-2"><strong>Course:</strong> <span id="uaCourse"></span></div>
            <div class="mb-2"><strong>Last Login IP:</strong> <span id="uaIp"></span></div>
            <div class="mb-2"><strong>Device:</strong> <span id="uaAgent"></span></div>
            <div class="mb-3"><strong>Last Login:</strong> <span id="uaLoginAt"></span></div>
            <div class="mb-3">
              <strong>Login History:</strong>
              <ul id="uaLoginHistory" class="list-group list-group-flush mt-2"></ul>
            </div>

            <form method="POST" action="/admin/users/roles" class="mb-3" id="uaRolesForm" <%= sectionAllowed('admin-role-access') ? '' : 'style="display:none"' %>>
              <input type="hidden" name="user_id" id="uaRolesUserId" />
              <label class="form-label">Assign roles</label>
              <select class="form-select mb-2" name="role_keys[]" id="uaRolesSelect" multiple size="6" required></select>
              <label class="form-label">Primary role</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="primary_role" id="uaPrimaryRole" required></select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/course" class="mb-3">
              <input type="hidden" name="user_id" id="uaCourseUserId" />
              <label class="form-label">Change course</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="course_id" id="uaCourseSelect" required>
                  <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/reset-password" class="mb-3">
              <input type="hidden" name="user_id" id="uaPassUserId" />
              <label class="form-label">Reset password</label>
              <div class="d-flex gap-2">
                <input class="form-control" name="new_password" placeholder="New password" required />
                <button class="btn btn-outline-secondary glass" type="submit">Set</button>
              </div>
            </form>

            <button class="btn btn-outline-danger glass" type="button" id="uaDeleteBtn">Deactivate user</button>
            <button class="btn btn-outline-success glass ms-2" type="button" id="uaActivateBtn">Restore user</button>
            <form method="POST" action="/admin/users/delete-permanent" class="mt-3" id="uaDeletePermanentForm">
              <input type="hidden" name="user_id" id="uaDeleteUserId" />
              <button
                class="btn btn-outline-danger glass w-100"
                type="submit"
                data-confirm="Permanently delete this user? This cannot be undone."
                data-confirm-level="danger"
              >
                Delete permanently
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="groupMultiModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–û–±—Ä–∞—Ç–∏ –≥—Ä—É–ø–∏</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-check mb-2">
              <input class="form-check-input group-multi-check" type="checkbox" value="1" id="groupMulti1">
              <label class="form-check-label" for="groupMulti1">–ì—Ä—É–ø–∞ 1</label>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input group-multi-check" type="checkbox" value="2" id="groupMulti2">
              <label class="form-check-label" for="groupMulti2">–ì—Ä—É–ø–∞ 2</label>
            </div>
            <div class="form-check">
              <input class="form-check-input group-multi-check" type="checkbox" value="3" id="groupMulti3">
              <label class="form-check-label" for="groupMulti3">–ì—Ä—É–ø–∞ 3</label>
            </div>
            <div class="small text-muted mt-2">–î–ª—è –Ω–µ –∑–∞–≥–∞–ª—å–Ω–∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –º–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –≥—Ä—É–ø –æ–¥–Ω–æ—á–∞—Å–Ω–æ.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            <button type="button" class="btn btn-primary" id="groupMultiApply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="subjectGroupsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="subjectGroupsTitle">Subject groups</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="subjectGroupsList" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="messageReadsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Read receipts</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2 text-muted" id="messageReadsSummary">Loading‚Ä¶</div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <h6 class="mb-2">Read</h6>
                <div id="messageReadsList" class="list-group"></div>
              </div>
              <div class="col-12 col-md-6">
                <h6 class="mb-2">Unread</h6>
                <div id="messageUnreadList" class="list-group"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="studyDaysModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="studyDaysTitle">–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="studyDaysBody" class="d-grid gap-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="weekTimeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="weekTimeTitle">–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="week-time-hint mb-3">
              –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî –∑–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å. –£–≤—ñ–º–∫–Ω—ñ—Ç—å –ª–æ–∫–∞–ª—å–Ω–∏–π, —â–æ–± –ø–∞—Ä–∏ –ø–æ–∫–∞–∑—É–≤–∞–ª–∏—Å—å –∑–∞ —á–∞—Å–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
            </div>
            <div id="weekTimeBody" class="d-grid gap-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="scheduleValidateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–∫–ª–∞–¥—É</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex flex-wrap align-items-end gap-2 mb-3">
              <div>
                <label class="form-label mb-1">–¢–∏–∂–¥–µ–Ω—å (–æ–ø—Ü.)</label>
                <input class="form-control form-control-sm" type="number" min="1" max="15" id="validateWeekInput" placeholder="–ù–∞–ø—Ä. 3" />
              </div>
              <button class="btn btn-sm btn-outline-primary mt-3" type="button" id="runValidateBtn">–ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
              <div class="ms-auto text-muted">
                Errors: <span id="validateErrors">0</span> ¬∑ Warnings: <span id="validateWarnings">0</span>
              </div>
            </div>
            <div id="validateIssues" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmActionTitle">Confirm action</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="confirmActionMessage" class="mb-3"></div>
            <div class="confirm-typed" id="confirmTypedWrapper" style="display: none;">
              <label class="form-label">Type to confirm</label>
              <input class="form-control" id="confirmTypedInput" />
              <div class="small text-muted mt-1">–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å —Ñ—Ä–∞–∑—É –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="subjectCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone subject</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="cloneSubjectId" />
            <div class="mb-3">
              <label class="form-label">New name</label>
              <input class="form-control" id="cloneSubjectName" />
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cloneSubjectSettings" checked />
              <label class="form-check-label" for="cloneSubjectSettings">Copy settings</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneSubjectSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="scheduleCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone week</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Source week</label>
                <input class="form-control" type="number" min="1" max="15" id="cloneWeekSource" />
              </div>
              <div class="col-6">
                <label class="form-label">Target week</label>
                <input class="form-control" type="number" min="1" max="15" id="cloneWeekTarget" />
              </div>
              <div class="col-12">
                <select class="form-select" id="cloneWeekMode">
                  <option value="skip_conflicts">Skip conflicts</option>
                  <option value="overwrite">Overwrite</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneWeekSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="homeworkCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone homework</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="cloneHomeworkId" />
            <div class="row g-2">
              <div class="col-12">
                <select class="form-select" id="cloneHomeworkTargetType">
                  <option value="week">Target week</option>
                  <option value="date">Class date</option>
                  <option value="deadline">Deadline</option>
                </select>
              </div>
              <div class="col-12">
                <input class="form-control" id="cloneHomeworkTargetValue" />
              </div>
              <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" id="cloneHomeworkAttachments" checked />
                <label class="form-check-label" for="cloneHomeworkAttachments">Copy attachments</label>
              </div>
              <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" id="cloneHomeworkLinks" checked />
                <label class="form-check-label" for="cloneHomeworkLinks">Copy links</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneHomeworkSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
      document.querySelectorAll('.schedule-spoiler').forEach((spoiler) => {
        const summary = spoiler.querySelector('summary');
        if (!summary) return;
        const base = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –ø–∞—Ä–∏';
        const open = '–°—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –ø–∞—Ä–∏';
        const update = () => {
          summary.textContent = spoiler.open ? open : base;
        };
        update();
        summary.addEventListener('click', () => {
          requestAnimationFrame(update);
        });
      });
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      function showCustomTooltip(el, message) {
        document.querySelectorAll('.custom-tooltip').forEach((t) => t.remove());
        const anchor = el.closest('.form-check') || el.closest('.input-group') || el;
        const key = el.id || el.name || anchor.id || '';
        const tip = document.createElement('div');
        tip.className = 'custom-tooltip';
        tip.textContent = message || '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–ª–µ';
        if (key) tip.dataset.for = key;
        document.body.appendChild(tip);

        const rect = anchor.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        const margin = 10;
        let top = rect.bottom + margin;
        let left = rect.left;
        let placeBelow = true;
        if (top + tipRect.height > window.innerHeight - 8) {
          top = rect.top - tipRect.height - margin;
          placeBelow = false;
        }
        if (left + tipRect.width > window.innerWidth - 8) {
          left = window.innerWidth - tipRect.width - 8;
        }
        if (left < 8) left = 8;
        tip.style.top = `${Math.round(top)}px`;
        tip.style.left = `${Math.round(left)}px`;
        if (placeBelow) tip.classList.add('below');
        requestAnimationFrame(() => tip.classList.add('show'));
        const remove = () => tip.remove();
        tip.addEventListener('click', remove);
        setTimeout(remove, 3500);
      }

      function attachValidationTooltips(root = document) {
        root.querySelectorAll('input, select, textarea').forEach((el) => {
          el.addEventListener('invalid', (event) => {
            event.preventDefault();
            showCustomTooltip(el, el.validationMessage);
          });
          el.addEventListener('input', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
          el.addEventListener('blur', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
        });
      }

      attachValidationTooltips();

      const safeStorageGet = (key, fallback = '') => {
        try {
          const value = window.localStorage.getItem(key);
          return value === null || typeof value === 'undefined' ? fallback : value;
        } catch (_) {
          return fallback;
        }
      };
      const safeStorageSet = (key, value) => {
        try {
          window.localStorage.setItem(key, value);
        } catch (_) {
          // ignore storage failures
        }
      };
      const safeStorageRemove = (key) => {
        try {
          window.localStorage.removeItem(key);
        } catch (_) {
          // ignore storage failures
        }
      };

      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = safeStorageGet('ui-theme', 'theme-light') || 'theme-light';
      const labelLight = themeToggle ? (themeToggle.dataset.lightLabel || 'Light') : 'Light';
      const labelDark = themeToggle ? (themeToggle.dataset.darkLabel || 'Dark') : 'Dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      if (themeToggle) {
        themeToggle.textContent = savedTheme === 'theme-dark' ? labelLight : labelDark;
        themeToggle.addEventListener('click', () => {
          const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-light', 'theme-dark');
          document.body.classList.add(next);
          safeStorageSet('ui-theme', next);
          themeToggle.textContent = next === 'theme-dark' ? labelLight : labelDark;
        });
      }

      const sessionHealthChip = document.getElementById('sessionHealthChip');
      const sessionHealthLabel = document.getElementById('sessionHealthLabel');
      const healthChipIntervalMs = 30000;

      const formatHealthTime = (rawIso) => {
        if (!rawIso) return '';
        const parsed = new Date(rawIso);
        if (Number.isNaN(parsed.getTime())) return '';
        return parsed.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const setSessionHealthChipState = ({ state = 'loading', title = '', label = '' } = {}) => {
        if (!sessionHealthChip || !sessionHealthLabel) return;
        sessionHealthChip.classList.remove('is-loading', 'is-ok', 'is-fail');
        sessionHealthChip.classList.add(state === 'ok' ? 'is-ok' : (state === 'fail' ? 'is-fail' : 'is-loading'));
        sessionHealthChip.title = title || 'Session store status';
        sessionHealthChip.setAttribute('aria-label', sessionHealthChip.title);
        sessionHealthLabel.textContent = label || 'Session‚Ä¶';
      };

      const applySessionHealthPayload = (payload, networkError = '') => {
        if (!payload || networkError) {
          const fallbackMessage = networkError || 'Failed to load health status';
          setSessionHealthChipState({
            state: 'fail',
            label: 'Session off',
            title: fallbackMessage,
          });
          return;
        }
        const sessionHealth = payload.session || {};
        const checkedAt = formatHealthTime(sessionHealth.last_checked_at);
        const baseTitle = checkedAt ? `Last check: ${checkedAt}` : 'No checks yet';
        if (sessionHealth.ok) {
          setSessionHealthChipState({
            state: 'ok',
            label: 'Session OK',
            title: baseTitle,
          });
          return;
        }
        const failureTitle = sessionHealth.last_error
          ? `${baseTitle} ¬∑ ${sessionHealth.last_error}`
          : baseTitle;
        setSessionHealthChipState({
          state: 'fail',
          label: 'Session fail',
          title: failureTitle,
        });
      };

      const fetchSessionHealth = async () => {
        if (!sessionHealthChip) return;
        try {
          const res = await fetch('/_health', {
            headers: { Accept: 'application/json' },
            cache: 'no-store',
          });
          if (!res.ok) {
            throw new Error(`Health endpoint ${res.status}`);
          }
          const payload = await res.json();
          applySessionHealthPayload(payload);
        } catch (err) {
          const message = err && err.message ? err.message : 'Health endpoint unavailable';
          applySessionHealthPayload(null, message);
        }
      };

      if (sessionHealthChip) {
        setSessionHealthChipState({
          state: 'loading',
          label: 'Session‚Ä¶',
          title: 'Checking session store',
        });
        fetchSessionHealth();
        window.setInterval(fetchSessionHealth, healthChipIntervalMs);
        sessionHealthChip.addEventListener('click', () => {
          setSessionHealthChipState({
            state: 'loading',
            label: 'Session‚Ä¶',
            title: 'Checking session store',
          });
          fetchSessionHealth();
        });
      }

      document.querySelectorAll('.file-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.fileTarget;
          const input = target ? document.getElementById(target) : null;
          if (input) input.click();
        });
      });
      document.querySelectorAll('.file-input').forEach((input) => {
        input.addEventListener('change', () => {
          const label = document.querySelector(`[data-file-name="${input.id}"]`);
          if (!label) return;
          const name = input.files && input.files.length ? input.files[0].name : '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
          label.textContent = name;
        });
      });

      window.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;
        if (!bootstrapModalCtor || !bootstrapModalCtor.getInstance) return;
        const instance = bootstrapModalCtor.getInstance(openModal);
        if (instance) instance.hide();
      });

      const adminNavLinks = Array.from(document.querySelectorAll('[data-admin-nav]'));
      const adminPanels = Array.from(document.querySelectorAll('.admin-panel'));
      const breadcrumbsEl = document.getElementById('adminBreadcrumbs');
      const confirmModalEl = document.getElementById('confirmActionModal');
      const bootstrapModalCtor =
        typeof window !== 'undefined' && window.bootstrap && window.bootstrap.Modal ? window.bootstrap.Modal : null;
      const confirmModal = confirmModalEl && bootstrapModalCtor ? new bootstrapModalCtor(confirmModalEl) : null;
      const confirmActionTitle = document.getElementById('confirmActionTitle');
      const confirmActionMessage = document.getElementById('confirmActionMessage');
      const confirmActionButton = document.getElementById('confirmActionButton');
      const confirmTypedWrapper = document.getElementById('confirmTypedWrapper');
      const confirmTypedInput = document.getElementById('confirmTypedInput');
      let confirmResolve = null;

      const openConfirmModal = ({ message, title = 'Confirm action', level = 'danger', typed = '' } = {}) =>
        new Promise((resolve) => {
          if (!confirmModal) {
            resolve(window.confirm(message || 'Are you sure?'));
            return;
          }
          confirmResolve = resolve;
          if (confirmActionTitle) confirmActionTitle.textContent = title;
          if (confirmActionMessage) confirmActionMessage.textContent = message || '';
          if (confirmActionButton) {
            confirmActionButton.classList.remove('btn-danger', 'btn-warning', 'btn-primary');
            confirmActionButton.classList.add(level === 'warning' ? 'btn-warning' : 'btn-danger');
            confirmActionButton.textContent = level === 'warning' ? 'Confirm' : 'Delete';
          }
          if (confirmTypedWrapper && confirmTypedInput) {
            if (typed) {
              confirmTypedWrapper.style.display = 'block';
              confirmTypedInput.value = '';
              confirmTypedInput.dataset.typedValue = typed;
            } else {
              confirmTypedWrapper.style.display = 'none';
              confirmTypedInput.value = '';
              confirmTypedInput.dataset.typedValue = '';
            }
          }
          confirmModal.show();
        });

      if (confirmActionButton && confirmModalEl) {
        confirmActionButton.addEventListener('click', () => {
          const required = confirmTypedInput && confirmTypedInput.dataset.typedValue;
          if (required && confirmTypedInput.value.trim() !== required) {
            confirmTypedInput.classList.add('is-invalid');
            return;
          }
          if (confirmTypedInput) confirmTypedInput.classList.remove('is-invalid');
          if (confirmModal) confirmModal.hide();
          if (confirmResolve) confirmResolve(true);
          confirmResolve = null;
        });
        confirmModalEl.addEventListener('hidden.bs.modal', () => {
          if (confirmResolve) confirmResolve(false);
          confirmResolve = null;
        });
      }

      const getDefaultTab = () => {
        if (adminNavLinks.length) return adminNavLinks[0].dataset.adminNav;
        return adminPanels.length ? adminPanels[0].id : '';
      };
      const resolveAdminTab = (requestedTab) => {
        if (requestedTab === 'admin-role-access' && adminPanels.some((panel) => panel.id === 'admin-role-studio')) {
          return 'admin-role-studio';
        }
        return adminPanels.some((panel) => panel.id === requestedTab) ? requestedTab : getDefaultTab();
      };

      const updateBreadcrumbs = (panel) => {
        if (!breadcrumbsEl) return;
        const title = panel ? panel.dataset.adminTitle || panel.id || '' : '';
        breadcrumbsEl.innerHTML = title
          ? `<span class="breadcrumb-item">Admin</span><span class="breadcrumb-sep">/</span><span class="breadcrumb-item active">${title}</span>`
          : '<span class="breadcrumb-item">Admin</span>';
      };

      const setActiveTab = (tab, { push = true } = {}) => {
        const target = resolveAdminTab(tab);
        if (!target) {
          adminPanels.forEach((panel) => {
            panel.style.display = 'block';
          });
          return;
        }
        adminPanels.forEach((panel) => {
          panel.style.display = panel.id === target ? 'block' : 'none';
        });
        adminNavLinks.forEach((link) => {
          link.classList.toggle('is-active', link.dataset.adminNav === target);
        });
        const activePanel = adminPanels.find((panel) => panel.id === target);
        updateBreadcrumbs(activePanel);
        safeStorageSet('admin:tab', target);
        if (push) {
          const url = new URL(window.location.href);
          url.searchParams.set('tab', target);
          window.history.replaceState({}, '', url);
        }
      };

      const initialTab = new URLSearchParams(window.location.search).get('tab')
        || safeStorageGet('admin:tab', '')
        || getDefaultTab();
      setActiveTab(initialTab, { push: false });

      adminNavLinks.forEach((link) => {
        link.addEventListener('click', () => {
          setActiveTab(link.dataset.adminNav);
        });
      });

      const toastContainer = document.getElementById('toastContainer');
      const showToast = (type, message) => {
        if (!toastContainer || !message) return;
        const toast = document.createElement('div');
        toast.className = `admin-toast is-${type}`;
        const body = document.createElement('div');
        body.className = 'admin-toast-body';
        body.textContent = message;
        const closeBtn = document.createElement('button');
        closeBtn.className = 'admin-toast-close';
        closeBtn.type = 'button';
        closeBtn.textContent = '√ó';
        closeBtn.addEventListener('click', () => toast.remove());
        toast.appendChild(body);
        toast.appendChild(closeBtn);
        toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('is-visible'), 10);
        setTimeout(() => toast.remove(), 5000);
      };

      if (toastContainer) {
        const successMsg = toastContainer.dataset.toastSuccess;
        const errorMsg = toastContainer.dataset.toastError;
        if (successMsg) showToast('success', successMsg);
        if (errorMsg) showToast('error', errorMsg);
      }

      const visitAnalyticsPanel = document.getElementById('admin-visit-analytics');
      const visitDaysSelect = document.getElementById('visitAnalyticsDays');
      const visitRefreshBtn = document.getElementById('visitAnalyticsRefresh');
      const visitTopPagesBody = document.getElementById('visitTopPagesBody');
      const visitRecentBody = document.getElementById('visitRecentBody');
      const visitRolesList = document.getElementById('visitRolesList');
      const visitMetricTotal = document.getElementById('visitMetricTotal');
      const visitMetricUnique = document.getElementById('visitMetricUnique');
      const visitMetricSigned = document.getElementById('visitMetricSigned');
      const visitMetricDays = document.getElementById('visitMetricDays');
      const visitChartCanvas = document.getElementById('visitAnalyticsChart');
      const visitChartCtor =
        typeof window !== 'undefined' && window.Chart ? window.Chart : null;
      let visitChart = null;
      let visitAnalyticsLoading = false;

      const formatVisitNumber = (value) => {
        const n = Number(value || 0);
        return new Intl.NumberFormat('uk-UA').format(Number.isFinite(n) ? n : 0);
      };

      const prettyVisitPageLabel = (key) => {
        const labels = {
          login: '–õ–æ–≥—ñ–Ω',
          register: '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è',
          schedule: '–†–æ–∑–∫–ª–∞–¥',
          'my-day': 'My Day',
          teamwork: 'Teamwork',
          profile: '–ü—Ä–æ—Ñ—ñ–ª—å',
          admin: '–ê–¥–º—ñ–Ω–∫–∞',
          deanery: '–î–µ–∫–∞–Ω–∞—Ç',
          starosta: '–°—Ç–∞—Ä–æ—Å—Ç–∞',
          teacher: '–í–∏–∫–ª–∞–¥–∞—á',
          subjects: '–ü—Ä–µ–¥–º–µ—Ç–∏',
        };
        const normalized = String(key || '').trim().toLowerCase();
        return labels[normalized] || normalized || 'unknown';
      };

      const prettyVisitRoleLabel = (key) => {
        const labels = {
          admin: '–ê–¥–º—ñ–Ω',
          deanery: '–î–µ–∫–∞–Ω–∞—Ç',
          starosta: '–°—Ç–∞—Ä–æ—Å—Ç–∞',
          teacher: '–í–∏–∫–ª–∞–¥–∞—á',
          student: '–°—Ç—É–¥–µ–Ω—Ç',
          guest: '–ì—ñ—Å—Ç—å',
        };
        const normalized = String(key || '').trim().toLowerCase();
        return labels[normalized] || normalized || 'guest';
      };

      const setVisitAnalyticsLoading = (loading) => {
        visitAnalyticsLoading = !!loading;
        if (visitRefreshBtn) {
          visitRefreshBtn.disabled = visitAnalyticsLoading;
          visitRefreshBtn.textContent = visitAnalyticsLoading ? '–û–Ω–æ–≤–ª–µ–Ω–Ω—è‚Ä¶' : '–û–Ω–æ–≤–∏—Ç–∏';
        }
      };

      const renderVisitRoles = (rows) => {
        if (!visitRolesList) return;
        if (!rows || !rows.length) {
          visitRolesList.innerHTML = '<div class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –ø–µ—Ä—ñ–æ–¥.</div>';
          return;
        }
        const total = rows.reduce((sum, row) => sum + Number(row.visits || 0), 0) || 1;
        visitRolesList.innerHTML = rows.map((row) => {
          const visits = Number(row.visits || 0);
          const share = Math.round((visits / total) * 100);
          return `
            <div class="visit-role-item">
              <span class="visit-role-label">${prettyVisitRoleLabel(row.role_key)}</span>
              <span class="visit-role-value">${formatVisitNumber(visits)} ¬∑ ${share}%</span>
            </div>
          `;
        }).join('');
      };

      const renderVisitTopPages = (rows) => {
        if (!visitTopPagesBody) return;
        if (!rows || !rows.length) {
          visitTopPagesBody.innerHTML = '<tr><td colspan="3" class="text-muted">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –∑–∞ –ø–µ—Ä—ñ–æ–¥.</td></tr>';
          return;
        }
        visitTopPagesBody.innerHTML = rows.map((row) => `
          <tr>
            <td>${prettyVisitPageLabel(row.page_key)}</td>
            <td>${formatVisitNumber(row.visits)}</td>
            <td>${formatVisitNumber(row.unique_visitors)}</td>
          </tr>
        `).join('');
      };

      const renderVisitRecent = (rows) => {
        if (!visitRecentBody) return;
        if (!rows || !rows.length) {
          visitRecentBody.innerHTML = '<tr><td colspan="5" class="text-muted">–ù–µ–º–∞—î –ø–æ–¥—ñ–π –∑–∞ –ø–µ—Ä—ñ–æ–¥.</td></tr>';
          return;
        }
        visitRecentBody.innerHTML = rows.map((row) => {
          const at = row.created_at ? new Date(row.created_at).toLocaleString('uk-UA') : '‚Äî';
          return `
            <tr>
              <td>${at}</td>
              <td>${row.user_name || 'Guest'}</td>
              <td>${prettyVisitRoleLabel(row.role_key)}</td>
              <td>${prettyVisitPageLabel(row.page_key)}</td>
              <td>${row.route_path || '/'}</td>
            </tr>
          `;
        }).join('');
      };

      const renderVisitChart = (dailyRows) => {
        if (!visitChartCanvas || !visitChartCtor) return;
        const labels = (dailyRows || []).map((row) => row.day || '');
        const visits = (dailyRows || []).map((row) => Number(row.visits || 0));
        const unique = (dailyRows || []).map((row) => Number(row.unique_visitors || 0));
        if (visitChart) {
          visitChart.destroy();
          visitChart = null;
        }
        visitChart = new visitChartCtor(visitChartCanvas, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: '–í—ñ–∑–∏—Ç–∏',
                data: visits,
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.22)',
                fill: true,
                tension: 0.32,
                pointRadius: 2.5,
              },
              {
                label: '–£–Ω—ñ–∫–∞–ª—å–Ω—ñ',
                data: unique,
                borderColor: '#34d399',
                backgroundColor: 'rgba(52, 211, 153, 0.16)',
                fill: false,
                tension: 0.32,
                pointRadius: 2.5,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            scales: {
              x: {
                grid: { color: 'rgba(148, 163, 184, 0.16)' },
                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') || '#94a3b8' },
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(148, 163, 184, 0.12)' },
                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted') || '#94a3b8' },
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: getComputedStyle(document.body).getPropertyValue('--text-primary') || '#e2e8f0',
                },
              },
            },
          },
        });
      };

      const loadVisitAnalytics = async () => {
        if (!visitAnalyticsPanel || visitAnalyticsLoading) return;
        const days = visitDaysSelect ? Number(visitDaysSelect.value || 14) : 14;
        setVisitAnalyticsLoading(true);
        try {
          const res = await fetch(`/admin/visit-analytics.json?days=${encodeURIComponent(days)}`, {
            headers: { Accept: 'application/json' },
            cache: 'no-store',
          });
          if (!res.ok) {
            throw new Error(`Analytics ${res.status}`);
          }
          const data = await res.json();
          if (!data || !data.ok) {
            throw new Error('Analytics payload invalid');
          }
          if (visitMetricTotal) visitMetricTotal.textContent = formatVisitNumber(data.summary && data.summary.total_visits);
          if (visitMetricUnique) visitMetricUnique.textContent = formatVisitNumber(data.summary && data.summary.unique_visitors);
          if (visitMetricSigned) visitMetricSigned.textContent = formatVisitNumber(data.summary && data.summary.signed_users);
          if (visitMetricDays) visitMetricDays.textContent = formatVisitNumber(data.summary && data.summary.active_days);
          renderVisitChart(data.daily || []);
          renderVisitTopPages(data.top_pages || []);
          renderVisitRoles(data.roles || []);
          renderVisitRecent(data.recent || []);
        } catch (err) {
          renderVisitTopPages([]);
          renderVisitRoles([]);
          renderVisitRecent([]);
          if (visitMetricTotal) visitMetricTotal.textContent = '‚Äî';
          if (visitMetricUnique) visitMetricUnique.textContent = '‚Äî';
          if (visitMetricSigned) visitMetricSigned.textContent = '‚Äî';
          if (visitMetricDays) visitMetricDays.textContent = '‚Äî';
          showToast('error', '–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è.');
        } finally {
          setVisitAnalyticsLoading(false);
        }
      };

      if (visitAnalyticsPanel) {
        if (visitRefreshBtn) {
          visitRefreshBtn.addEventListener('click', loadVisitAnalytics);
        }
        if (visitDaysSelect) {
          visitDaysSelect.addEventListener('change', loadVisitAnalytics);
        }
        loadVisitAnalytics();
      }

      document.addEventListener('click', async (event) => {
        const trigger = event.target.closest('[data-confirm]');
        if (!trigger) return;
        const formId = trigger.getAttribute('form');
        const form = formId ? document.getElementById(formId) : trigger.closest('form');
        if (!form) return;
        event.preventDefault();
        const message = trigger.dataset.confirm || 'Are you sure?';
        const level = trigger.dataset.confirmLevel || 'danger';
        const typed = trigger.dataset.confirmTyped || '';
        const ok = await openConfirmModal({ message, level, typed });
        if (ok) form.submit();
      });

      const importScopeData = {
        courses: <%- JSON.stringify(courses || []) %>,
        semestersByCourse: <%- JSON.stringify(semestersByCourseMap || {}) %>,
      };
      const roleLabelMap = <%- JSON.stringify(roleLabelMapData || {}) %>;
      const roleCatalogBootstrap = <%- JSON.stringify((rbacRolesList || []).map((roleRow) => ({
        key: roleRow.key,
        label: roleRow.label || roleRow.key,
        is_active: roleRow.is_active !== false && Number(roleRow.is_active) !== 0,
      }))) %>;
      const normalizeRoleKeyClient = (value) => String(value || '').trim().toLowerCase();
      const getRoleLabel = (roleKey) => roleLabelMap[normalizeRoleKeyClient(roleKey)] || String(roleKey || 'student');
      const parseRoleKeys = (value, fallback = ['student']) => {
        const input = Array.isArray(value) ? value : (typeof value === 'string' ? value.split(',') : []);
        const seen = new Set();
        const keys = [];
        input.forEach((item) => {
          const normalized = normalizeRoleKeyClient(item);
          if (!normalized || seen.has(normalized)) return;
          seen.add(normalized);
          keys.push(normalized);
        });
        return keys.length ? keys : fallback;
      };
      const mapRoleKeysToLabels = (roleKeys) =>
        parseRoleKeys(roleKeys).map((key) => getRoleLabel(key)).join(', ');
      const getPrimaryRoleClass = (primaryRole) => (
        primaryRole === 'admin'
          ? 'primary'
          : (primaryRole === 'starosta'
            ? 'warning'
            : (primaryRole === 'deanery' ? 'info' : 'secondary'))
      );
      const getSelectedRoleKeys = () => {
        const rolesSelect = document.getElementById('uaRolesSelect');
        if (!rolesSelect) return [];
        return Array.from(rolesSelect.selectedOptions || [])
          .map((opt) => normalizeRoleKeyClient(opt.value))
          .filter(Boolean);
      };
      const setPrimaryRoleOptions = (roleKeys, preferredPrimary = '') => {
        const primarySelect = document.getElementById('uaPrimaryRole');
        if (!primarySelect) return;
        const keys = parseRoleKeys(roleKeys, []);
        if (!keys.length) {
          primarySelect.innerHTML = '';
          return;
        }
        primarySelect.innerHTML = keys
          .map((key) => `<option value="${escapeHtml(key)}">${escapeHtml(getRoleLabel(key))}</option>`)
          .join('');
        const normalizedPreferred = normalizeRoleKeyClient(preferredPrimary);
        primarySelect.value = keys.includes(normalizedPreferred) ? normalizedPreferred : keys[0];
      };
      const populateRoleEditor = (roleCatalog, roleKeys, preferredPrimary = '') => {
        const rolesSelect = document.getElementById('uaRolesSelect');
        if (!rolesSelect) return;
        const selectedKeys = parseRoleKeys(roleKeys, ['student']);
        const catalogRows = Array.isArray(roleCatalog) ? roleCatalog : [];
        const byKey = new Map();
        catalogRows.forEach((row) => {
          const key = normalizeRoleKeyClient(row && row.key);
          if (!key || byKey.has(key)) return;
          byKey.set(key, {
            key,
            label: row && row.label ? String(row.label) : getRoleLabel(key),
            is_active: row ? (row.is_active !== false && Number(row.is_active) !== 0) : true,
          });
        });
        selectedKeys.forEach((key) => {
          if (!byKey.has(key)) {
            byKey.set(key, { key, label: getRoleLabel(key), is_active: true });
          }
        });
        const options = Array.from(byKey.values())
          .filter((row) => row.is_active || selectedKeys.includes(row.key) || row.key === 'admin')
          .sort((a, b) => a.label.localeCompare(b.label, 'uk'));
        rolesSelect.innerHTML = options
          .map((row) => {
            const suffix = row.is_active ? '' : ' (inactive)';
            const selected = selectedKeys.includes(row.key) ? ' selected' : '';
            return `<option value="${escapeHtml(row.key)}"${selected}>${escapeHtml(`${row.label}${suffix}`)}</option>`;
          })
          .join('');
        setPrimaryRoleOptions(selectedKeys, preferredPrimary);
      };
      let userRolesModalRequestToken = 0;
      const hydrateUserRoleEditor = async (userId, fallbackRoleKeys, fallbackPrimaryRole) => {
        const token = ++userRolesModalRequestToken;
        try {
          const res = await fetch(`/admin/users/${encodeURIComponent(userId)}/roles.json`, {
            headers: { Accept: 'application/json' },
          });
          if (!res.ok) return;
          const data = await res.json();
          if (token !== userRolesModalRequestToken) return;
          const roleCatalog = Array.isArray(data.roles) && data.roles.length
            ? data.roles.map((row) => ({
                key: row.key,
                label: row.label || row.key,
                is_active: row.is_active !== false && Number(row.is_active) !== 0,
              }))
            : roleCatalogBootstrap;
          roleCatalog.forEach((row) => {
            const key = normalizeRoleKeyClient(row && row.key);
            if (!key) return;
            roleLabelMap[key] = row && row.label ? String(row.label) : key;
          });
          const roleKeys = parseRoleKeys(data.role_keys, fallbackRoleKeys);
          const primaryRole = normalizeRoleKeyClient(data.primary_role || fallbackPrimaryRole || roleKeys[0] || 'student');
          populateRoleEditor(roleCatalog, roleKeys, primaryRole);
          document.getElementById('uaRole').textContent = getRoleLabel(primaryRole);
          document.getElementById('uaRoles').textContent = mapRoleKeysToLabels(roleKeys);
        } catch (err) {
          // keep fallback role data
        }
      };
      const importCourseMap = new Map(
        (importScopeData.courses || []).map((course) => [String(course.id), course])
      );
      const importSemestersByCourse = importScopeData.semestersByCourse || {};
      const getCampusLabel = (course) => {
        if (!course) return '';
        return String(course.location || 'kyiv').toLowerCase() === 'munich' ? 'Munich' : 'Kyiv';
      };
      const updateScopeSummary = (scopeSummary, courseId, semesterId) => {
        if (!scopeSummary) return;
        const course = importCourseMap.get(String(courseId || ''));
        const campusLabel = getCampusLabel(course);
        const parts = [];
        if (course) parts.push(course.name);
        if (campusLabel) parts.push(campusLabel);
        if (semesterId) {
          const list = importSemestersByCourse[String(courseId)] || [];
          const sem = list.find((item) => String(item.id) === String(semesterId));
          if (sem) parts.push(`Semester=${sem.title}`);
        }
        scopeSummary.textContent = parts.length ? `Import into: ${parts.join(' ¬∑ ')}` : 'Select scope to validate.';
      };

      document.querySelectorAll('.import-card').forEach((card) => {
        const type = card.dataset.importType;
        const form = card.querySelector('form.import-form');
        const fileInput = form ? form.querySelector('input[type="file"]') : null;
        const createEl = card.querySelector('[data-import-create]');
        const updateEl = card.querySelector('[data-import-update]');
        const skipEl = card.querySelector('[data-import-skip]');
        const errorEl = card.querySelector('[data-import-error]');
        const errorsContainer = card.querySelector('[data-import-errors]');
        const downloadBtn = card.querySelector('[data-import-error-download]');
        const confirmCheck = card.querySelector('[data-import-confirm-check]');
        const confirmButton = form ? form.querySelector('button[type="submit"]') : null;
        const confirmRequiredInput = card.querySelector('[data-import-confirm-required]');
        const typedConfirmWrap = card.querySelector('[data-import-typed-confirm]');
        const typedConfirmInput = card.querySelector('[data-import-confirm-phrase]');
        const templateBtn = card.querySelector('[data-template]');
        const scopeCourseSelect = card.querySelector('[data-import-scope-course]');
        const scopeSemesterSelect = card.querySelector('[data-import-scope-semester]');
        const scopeSummary = card.querySelector('[data-import-scope-summary]');
        let operationId = '';
        let validationBlocked = false;
        let hasValidated = false;

        const syncSummary = ({ create = 0, update = 0, skip = 0, errors = 0 } = {}) => {
          if (createEl) createEl.textContent = create;
          if (updateEl) updateEl.textContent = update;
          if (skipEl) skipEl.textContent = skip;
          if (errorEl) errorEl.textContent = errors;
        };
        const setLoading = (loading) => {
          card.classList.toggle('is-loading', loading);
        };
        const scopeReady = () => {
          if (!scopeCourseSelect || !scopeCourseSelect.value) return false;
          if (scopeSemesterSelect && !scopeSemesterSelect.value) return false;
          return true;
        };
        const updateConfirmState = () => {
          if (!confirmButton) return;
          const requiresTyped = confirmRequiredInput && confirmRequiredInput.value === '1';
          const typedOk = !requiresTyped || (typedConfirmInput && typedConfirmInput.value.trim().toUpperCase() === 'IMPORT');
          const checked = confirmCheck ? confirmCheck.checked : true;
          const ready = hasValidated && !validationBlocked && scopeReady() && checked && typedOk;
          confirmButton.disabled = !ready;
        };
        const refreshSemesterOptions = () => {
          if (!scopeSemesterSelect || !scopeCourseSelect) return;
          const list = importSemestersByCourse[String(scopeCourseSelect.value)] || [];
          const selected = scopeSemesterSelect.value;
          scopeSemesterSelect.innerHTML = list.length
            ? list.map((sem) => `<option value="${sem.id}" ${String(sem.id) === String(selected) ? 'selected' : ''}>${sem.title} ¬∑ ${sem.weeks_count} —Ç–∏–∂–Ω—ñ–≤</option>`).join('')
            : '<option value="">–ù–µ–º–∞—î —Å–µ–º–µ—Å—Ç—Ä—ñ–≤</option>';
        };
        if (scopeCourseSelect) {
          updateScopeSummary(scopeSummary, scopeCourseSelect.value, scopeSemesterSelect ? scopeSemesterSelect.value : '');
        }

        if (templateBtn) {
          templateBtn.addEventListener('click', () => {
            const header = templateBtn.dataset.template || '';
            const blob = new Blob([`${header}\n`], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${type}_template.csv`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
          });
        }

        const runValidation = async () => {
          if (!fileInput || !fileInput.files || !fileInput.files.length) return;
          if (!scopeReady()) {
            syncSummary();
            if (errorsContainer) {
              errorsContainer.innerHTML = '<div class="text-muted">Select scope to validate.</div>';
            }
            if (confirmRequiredInput) confirmRequiredInput.value = '0';
            validationBlocked = true;
            hasValidated = false;
            updateConfirmState();
            return;
          }
          const formData = new FormData();
          formData.append('csv_file', fileInput.files[0]);
          formData.append('type', type);
          formData.append('scope_course_id', scopeCourseSelect ? scopeCourseSelect.value : '');
          if (scopeSemesterSelect) {
            formData.append('scope_semester_id', scopeSemesterSelect.value);
          }
          setLoading(true);
          try {
            const response = await fetch('/admin/import/validate', {
              method: 'POST',
              headers: { Accept: 'application/json' },
              body: formData,
            });
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data && data.error ? data.error : 'Validation failed');
            }
            operationId = data.operation_id || '';
            hasValidated = true;
            validationBlocked = Boolean(data.blocked);
            const counts = data.counts || {};
            syncSummary({
              create: counts.creates || 0,
              update: counts.updates || 0,
              skip: counts.skips || 0,
              errors: counts.errors || 0,
            });
            if (errorsContainer) {
              const preview = data.errors_preview || [];
              errorsContainer.innerHTML = preview.length
                ? preview.map((err) => `<div class="import-error">Row ${err.row_number}: ${err.column} ¬∑ ${err.reason}</div>`).join('')
                : '<div class="text-muted">No errors found.</div>';
            }
            if (downloadBtn) {
              downloadBtn.disabled = !(counts.errors > 0 && operationId);
              downloadBtn.dataset.op = operationId;
            }
            if (confirmRequiredInput) {
              confirmRequiredInput.value = data.requires_confirm ? '1' : '0';
            }
            if (typedConfirmWrap) {
              typedConfirmWrap.classList.toggle('d-none', !data.requires_confirm);
            }
            if (typedConfirmInput && !data.requires_confirm) {
              typedConfirmInput.value = '';
            }
          } catch (err) {
            hasValidated = false;
            validationBlocked = true;
            if (errorsContainer) {
              errorsContainer.innerHTML = `<div class="text-danger">${err.message || 'Validation failed'}</div>`;
            }
            if (downloadBtn) {
              downloadBtn.disabled = true;
              downloadBtn.dataset.op = '';
            }
            showToast('error', err.message || 'Validation failed');
          } finally {
            setLoading(false);
            updateConfirmState();
          }
        };

        if (fileInput) {
          fileInput.addEventListener('change', () => {
            runValidation();
          });
        }
        if (scopeCourseSelect) {
          scopeCourseSelect.addEventListener('change', () => {
            refreshSemesterOptions();
            updateScopeSummary(scopeSummary, scopeCourseSelect.value, scopeSemesterSelect ? scopeSemesterSelect.value : '');
            runValidation();
          });
        }
        if (scopeSemesterSelect) {
          scopeSemesterSelect.addEventListener('change', () => {
            updateScopeSummary(scopeSummary, scopeCourseSelect ? scopeCourseSelect.value : '', scopeSemesterSelect.value);
            runValidation();
          });
        }
        if (typedConfirmInput) {
          typedConfirmInput.addEventListener('input', () => {
            updateConfirmState();
          });
        }
        if (confirmCheck) {
          confirmCheck.addEventListener('change', () => {
            updateConfirmState();
          });
        }

        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => {
            const op = downloadBtn.dataset.op;
            if (!op) return;
            window.location.href = `/admin/import/errors.csv?op=${op}`;
          });
        }

        if (form && confirmCheck) {
          form.addEventListener('submit', (event) => {
            if (!confirmCheck.checked) {
              event.preventDefault();
              showToast('error', 'Please confirm before import.');
              return;
            }
            const requiresTyped = confirmRequiredInput && confirmRequiredInput.value === '1';
            if (requiresTyped && typedConfirmInput && typedConfirmInput.value.trim().toUpperCase() !== 'IMPORT') {
              event.preventDefault();
              showToast('error', 'Type IMPORT to continue.');
              return;
            }
            if (validationBlocked || !hasValidated) {
              event.preventDefault();
              showToast('error', 'Resolve validation errors before import.');
            }
          });
        }
        updateConfirmState();
      });

      const settingsForm = document.getElementById('systemSettingsForm');
      if (settingsForm) {
        const fields = Array.from(settingsForm.querySelectorAll('[data-settings-field]'));
        const saveBtn = settingsForm.querySelector('[data-settings-save]');
        const statusEl = document.querySelector('[data-settings-status]');
        const dirtyEl = document.querySelector('[data-settings-dirty]');
        const updatedAtEl = document.querySelector('[data-settings-updated-at]');
        const updatedByEl = document.querySelector('[data-settings-updated-by]');
        const initialValues = new Map(fields.map((field) => [field.name, field.value]));

        const setStatus = (label, variant = 'secondary') => {
          if (!statusEl) return;
          statusEl.textContent = label;
          statusEl.className = `badge text-bg-${variant}`;
        };
        const isDirty = () => fields.some((field) => String(field.value) !== String(initialValues.get(field.name)));
        const setDirtyState = () => {
          const dirty = isDirty();
          if (dirtyEl) dirtyEl.classList.toggle('d-none', !dirty);
          if (saveBtn) saveBtn.disabled = !dirty;
        };
        const setFieldError = (field, message) => {
          if (!field) return;
          field.classList.toggle('is-invalid', Boolean(message));
          let errorEl = field.parentElement ? field.parentElement.querySelector('.settings-error') : null;
          if (!errorEl && field.parentElement) {
            errorEl = document.createElement('div');
            errorEl.className = 'settings-error small text-danger';
            field.parentElement.appendChild(errorEl);
          }
          if (errorEl) {
            errorEl.textContent = message || '';
            errorEl.style.display = message ? 'block' : 'none';
          }
        };
        const validateField = (field) => {
          if (!field || field.type !== 'number') return true;
          const value = Number(field.value);
          const min = field.min ? Number(field.min) : null;
          const max = field.max ? Number(field.max) : null;
          if (Number.isNaN(value)) {
            setFieldError(field, 'Invalid number');
            return false;
          }
          if (min !== null && value < min) {
            setFieldError(field, `Min ${min}`);
            return false;
          }
          if (max !== null && value > max) {
            setFieldError(field, `Max ${max}`);
            return false;
          }
          setFieldError(field, '');
          return true;
        };
        const validateAll = () => {
          let valid = true;
          fields.forEach((field) => {
            if (!validateField(field)) valid = false;
          });
          return valid;
        };

        fields.forEach((field) => {
          field.addEventListener('input', () => {
            validateField(field);
            setDirtyState();
            setStatus('Unsaved', 'secondary');
          });
          field.addEventListener('change', () => {
            validateField(field);
            setDirtyState();
            setStatus('Unsaved', 'secondary');
          });
        });

        settingsForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!validateAll()) {
            showToast('error', 'Fix validation errors before saving.');
            return;
          }
          setStatus('Saving‚Ä¶', 'warning');
          if (saveBtn) saveBtn.disabled = true;
          try {
            const formData = new FormData(settingsForm);
            const response = await fetch(settingsForm.action, {
              method: 'POST',
              headers: { Accept: 'application/json' },
              body: formData,
            });
            const data = await response.json();
            if (!response.ok || !data.ok) {
              throw new Error(data.error || 'Save failed');
            }
            fields.forEach((field) => {
              initialValues.set(field.name, field.value);
            });
            setDirtyState();
            setStatus('Saved', 'success');
            if (updatedAtEl && data.updated_at) {
              updatedAtEl.textContent = new Date(data.updated_at).toLocaleString('uk-UA');
            }
            if (updatedByEl && data.updated_by) {
              updatedByEl.textContent = data.updated_by;
            }
            showToast('success', 'Settings saved.');
          } catch (err) {
            setStatus('Error', 'danger');
            if (saveBtn) saveBtn.disabled = false;
            showToast('error', err.message || 'Save failed.');
          }
        });

        setDirtyState();
      }

      const rbacRoleForms = Array.from(document.querySelectorAll('[data-rbac-role-form]'));
      const rbacTemplateButtons = Array.from(document.querySelectorAll('[data-rbac-template]'));
      const rbacRevertBtn = document.querySelector('[data-rbac-revert]');
      if (rbacRoleForms.length) {
        try {
          const rbacPermissionDefaults = <%- JSON.stringify((typeof defaultRolePermissions !== 'undefined' && defaultRolePermissions) ? defaultRolePermissions : {}) %>;
          const allAdminSectionKeys = <%- JSON.stringify((adminSectionOptionsList || []).map((section) => section.id)) %>;
          const rbacCourseDefaults = {
            admin: ['regular', 'teacher'],
            teacher: ['regular', 'teacher'],
            deanery: ['regular'],
            starosta: ['regular'],
            student: ['regular'],
          };
          const roleSnapshots = new Map();
          const ROLE_DRAFT_PREFIX = 'admin:rbac:draft:';
          let draftRestoreNotified = false;

          const getRoleForm = (roleKey) =>
            rbacRoleForms.find((form) => normalizeRoleKeyClient(form.dataset.roleKey) === normalizeRoleKeyClient(roleKey));
          const getRoleDraftKey = (form) => {
            const roleKey = normalizeRoleKeyClient(form && form.dataset ? form.dataset.roleKey : '');
            return roleKey ? `${ROLE_DRAFT_PREFIX}${roleKey}` : '';
          };
          const collectRoleDraft = (form) => ({
            label: (form.querySelector('input[name="label"]') || {}).value || '',
            description: (form.querySelector('input[name="description"]') || {}).value || '',
            is_active: (() => {
              const activeField = form.querySelector('input[name="is_active"]');
              return !!(activeField && activeField.checked);
            })(),
            permission_keys: Array.from(form.querySelectorAll('input[name="permission_keys"]:checked')).map((input) => input.value),
            course_kinds: Array.from(form.querySelectorAll('input[name="course_kinds"]:checked')).map((input) => input.value),
          });
          const setCheckedValues = (form, name, values) => {
            const allowed = new Set(Array.isArray(values) ? values : []);
            form.querySelectorAll(`input[name="${name}"]`).forEach((input) => {
              input.checked = allowed.has(input.value);
            });
          };
          const applyRoleDraft = (form, payload) => {
            if (!payload || typeof payload !== 'object') return;
            const labelField = form.querySelector('input[name="label"]');
            const descField = form.querySelector('input[name="description"]');
            const activeField = form.querySelector('input[name="is_active"]');
            if (labelField && typeof payload.label === 'string') labelField.value = payload.label;
            if (descField && typeof payload.description === 'string') descField.value = payload.description;
            if (activeField && !activeField.disabled) activeField.checked = !!payload.is_active;
            setCheckedValues(form, 'permission_keys', payload.permission_keys || []);
            setCheckedValues(form, 'course_kinds', payload.course_kinds || []);
          };
          const saveRoleDraft = (form) => {
            const draftKey = getRoleDraftKey(form);
            if (!draftKey) return;
            safeStorageSet(draftKey, JSON.stringify(collectRoleDraft(form)));
          };
          const clearRoleDraft = (form) => {
            const draftKey = getRoleDraftKey(form);
            if (!draftKey) return;
            safeStorageRemove(draftKey);
          };
          const captureRoleSnapshots = () => {
            roleSnapshots.clear();
            rbacRoleForms.forEach((form) => {
              const key = normalizeRoleKeyClient(form.dataset.roleKey);
              if (!key) return;
              roleSnapshots.set(key, collectRoleDraft(form));
            });
          };
          const applyRolePreset = (roleKey) => {
            const form = getRoleForm(roleKey);
            if (!form) return false;
            const normalizedRole = normalizeRoleKeyClient(roleKey);
            const permissions = normalizedRole === 'admin'
              ? allAdminSectionKeys
              : (rbacPermissionDefaults[normalizedRole] || []);
            const courseKinds = rbacCourseDefaults[normalizedRole] || ['regular'];
            setCheckedValues(form, 'permission_keys', permissions);
            setCheckedValues(form, 'course_kinds', courseKinds);
            const activeField = form.querySelector('input[name="is_active"]');
            if (activeField && !activeField.disabled) activeField.checked = true;
            saveRoleDraft(form);
            return true;
          };
          const revertRoleSnapshots = () => {
            rbacRoleForms.forEach((form) => {
              const key = normalizeRoleKeyClient(form.dataset.roleKey);
              const snapshot = roleSnapshots.get(key);
              if (!snapshot) return;
              applyRoleDraft(form, snapshot);
              clearRoleDraft(form);
            });
          };
          const applySystemDefaults = () => {
            ['admin', 'deanery', 'starosta', 'teacher', 'student'].forEach((roleKey) => {
              applyRolePreset(roleKey);
            });
          };

          rbacRoleForms.forEach((form) => {
            const draftKey = getRoleDraftKey(form);
            const rawDraft = draftKey ? safeStorageGet(draftKey, '') : '';
            if (rawDraft) {
              try {
                applyRoleDraft(form, JSON.parse(rawDraft));
                if (!draftRestoreNotified) {
                  showToast('success', '–ß–µ—Ä–Ω–µ—Ç–∫–∏ Role Studio –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.');
                  draftRestoreNotified = true;
                }
              } catch (_) {
                clearRoleDraft(form);
              }
            }
          });
          captureRoleSnapshots();
          rbacRoleForms.forEach((form) => {
            const fields = Array.from(form.querySelectorAll('input, select, textarea'));
            fields.forEach((field) => {
              if (!field || field.disabled || !field.name) return;
              field.addEventListener('input', () => saveRoleDraft(form));
              field.addEventListener('change', () => saveRoleDraft(form));
            });
            form.addEventListener('submit', () => {
              clearRoleDraft(form);
            });
          });

          rbacTemplateButtons.forEach((btn) => {
            btn.addEventListener('click', () => {
              const template = normalizeRoleKeyClient(btn.dataset.rbacTemplate);
              if (!template) return;
              if (template === 'reset') {
                applySystemDefaults();
                showToast('success', 'System defaults applied in Role Studio.');
                return;
              }
              if (applyRolePreset(template)) {
                showToast('success', `Default preset applied for ${template}.`);
              }
            });
          });

          if (rbacRevertBtn) {
            rbacRevertBtn.addEventListener('click', () => {
              revertRoleSnapshots();
              showToast('success', 'Unsaved role changes reverted.');
            });
          }
        } catch (err) {
          console.error('RBAC role studio init failed:', err);
        }
      }

      const selectAll = document.getElementById('selectAllSchedule');
      if (selectAll) {
        selectAll.addEventListener('change', () => {
          document
            .querySelectorAll('input[name="delete_ids"]')
            .forEach((cb) => (cb.checked = selectAll.checked));
        });
      }

      const selectAllUsers = document.getElementById('selectAllUsers');
      if (selectAllUsers) {
        selectAllUsers.addEventListener('change', () => {
          document
            .querySelectorAll('input[name=\"delete_user_ids\"]')
            .forEach((cb) => (cb.checked = selectAllUsers.checked));
          updateUsersBulkBar();
        });
      }
      document.querySelectorAll('input[name="delete_user_ids"]').forEach((cb) => {
        cb.addEventListener('change', updateUsersBulkBar);
      });
      updateUsersBulkBar();

      function updateUsersBulkBar() {
        const bulkBar = document.getElementById('usersBulkBar');
        const countEl = document.getElementById('usersBulkCount');
        if (!bulkBar || !countEl) return;
        const selected = document.querySelectorAll('input[name="delete_user_ids"]:checked').length;
        countEl.textContent = selected;
        bulkBar.classList.toggle('is-visible', selected > 0);
      }

      function renderUsersTable(data) {
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        const currentUserId = tbody.dataset.currentUserId;
        const status = tbody.dataset.status || 'active';
        const subjectMap = new Map();
        data.subjects.forEach((s) => subjectMap.set(String(s.id), s));
        const courseMap = new Map();
        (data.courses || []).forEach((c) => courseMap.set(String(c.id), c.name));
        const groupMap = {};
        data.studentGroups.forEach((g) => {
          if (!groupMap[g.student_id]) groupMap[g.student_id] = {};
          groupMap[g.student_id][g.subject_id] = g.group_number;
        });

        tbody.innerHTML = data.users
          .map((u) => {
            const isActive = typeof u.is_active === 'undefined' ? 1 : u.is_active;
            const roleKeys = Array.isArray(u.role_keys) && u.role_keys.length
              ? parseRoleKeys(u.role_keys, [u.primary_role || u.role || 'student'])
              : parseRoleKeys([u.primary_role || u.role || 'student']);
            const primaryRole = normalizeRoleKeyClient(u.primary_role || roleKeys[0] || 'student');
            const rolesLabel = mapRoleKeysToLabels(roleKeys);
            const hasAdminRole = roleKeys.includes('admin');
            const badgeClass = getPrimaryRoleClass(primaryRole);
            const checkbox = !hasAdminRole
              ? `<input type="checkbox" name="delete_user_ids" value="${u.id}" form="deleteUsersForm" />`
              : '';
            const subjectList = groupMap[u.id]
              ? Object.keys(groupMap[u.id]).map((sid) => {
                  const subj = subjectMap.get(String(sid));
                  if (!subj) return null;
                  return { subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][sid] };
                }).filter(Boolean)
              : [];
            const subjectsBtn = `
              <button
                class="btn btn-sm btn-outline-primary subject-groups-btn"
                type="button"
                data-user-id="${u.id}"
                data-user-name="${u.full_name}"
                data-subjects='${JSON.stringify(subjectList).replace(/'/g, '&#39;')}'
              >
                Subjects (${subjectList.length})
              </button>
            `;

            const subjectOptions = data.subjects
              .map((s) => `<option value="${s.id}">${s.name} (1‚Äì${s.group_count})</option>`)
              .join('');

            return `
              <tr class="user-row"
                  data-user-id="${u.id}"
                  data-user-name="${u.full_name}"
                  data-user-role="${primaryRole}"
                  data-user-roles="${roleKeys.join(',')}"
                  data-user-group="${u.schedule_group}"
                  data-user-course="${courseMap.get(String(u.course_id)) || `Course ${u.course_id || 1}`}"
                  data-user-course-id="${u.course_id || 1}"
                  data-user-active="${isActive}"
                  data-user-ip="${u.last_login_ip || ''}"
                  data-user-agent="${(u.last_user_agent || '').replace(/\"/g, '&quot;')}"
                  data-user-login="${u.last_login_at || ''}">
                <td>${checkbox}</td>
                <td>${u.full_name}</td>
                <td><span class="badge text-bg-${badgeClass}">${escapeHtml(rolesLabel)}</span></td>
                <td>${subjectsBtn}</td>
                <td>
                  <form method="POST" action="/admin/student-groups/set" class="row g-2">
                    <input type="hidden" name="student_id" value="${u.id}" />
                    <div class="col-12 col-md-6">
                      <select class="form-select form-select-sm" name="subject_id" required>
                        <option value="" disabled selected>Subject</option>
                        ${subjectOptions}
                      </select>
                    </div>
                    <div class="col-12 col-md-3">
                      <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                    </div>
                    <div class="col-12 col-md-3 d-grid">
                      <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                    </div>
                  </form>
                </td>
                <td class="text-end">
                  <form id="user-delete-${u.id}" method="POST" action="/admin/users/delete-permanent"></form>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">‚ãØ</button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><button class="dropdown-item user-manage-btn" type="button">Manage</button></li>
                      ${!hasAdminRole && isActive === 0 ? `
                        <li><hr class="dropdown-divider" /></li>
                        <li>
                          <button class="dropdown-item text-danger" type="submit" form="user-delete-${u.id}" data-confirm="Permanently delete this user? This cannot be undone." data-confirm-level="danger">
                            Delete permanently
                          </button>
                          <input type="hidden" name="user_id" value="${u.id}" form="user-delete-${u.id}" />
                        </li>
                      ` : ''}
                    </ul>
                  </div>
                </td>
              </tr>
            `;
          })
          .join('');
        tbody.querySelectorAll('input[name="delete_user_ids"]').forEach((cb) => {
          cb.addEventListener('change', updateUsersBulkBar);
        });
        updateUsersBulkBar();
      }

      async function refreshUsers() {
        try {
          const tbodyEl = document.getElementById('usersTableBody');
          if (!tbodyEl) return;
          tbodyEl.innerHTML = Array.from({ length: 6 }).map(() => `
            <tr class="skeleton-row">
              <td colspan="6">
                <div class="skeleton-line"></div>
              </td>
            </tr>
          `).join('');
          const status = tbodyEl.dataset.status || 'active';
          const courseId = tbodyEl.dataset.courseId || '1';
          const q = tbodyEl.dataset.search || '';
          const group = tbodyEl.dataset.group || '';
          const res = await fetch(
            `/admin/users.json?status=${encodeURIComponent(status)}&course=${encodeURIComponent(courseId)}&q=${encodeURIComponent(
              q
            )}&group=${encodeURIComponent(group)}`
          );
          if (!res.ok) return;
          const data = await res.json();
          const roleFilter = tbodyEl.dataset.roleFilter || 'all';
          const filtered = roleFilter === 'all'
            ? data
            : {
                ...data,
                users: data.users.filter((u) => {
                  const roleKeys = Array.isArray(u.role_keys) && u.role_keys.length
                    ? parseRoleKeys(u.role_keys, [u.primary_role || u.role || 'student'])
                    : parseRoleKeys([u.primary_role || u.role || 'student']);
                  return roleKeys.includes(roleFilter);
                }),
              };
          renderUsersTable(filtered);
          bindUserRowClicks();
          bindSubjectButtons();
        } catch (err) {
          return;
        }
      }

      function connectUserSocket() {
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${location.host}`);
        socket.addEventListener('message', (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'users_updated') {
              refreshUsers();
            }
            if (msg.type === 'history_updated') {
              refreshHistory();
            }
          } catch (e) {
            return;
          }
        });
        socket.addEventListener('close', () => {
          setTimeout(connectUserSocket, 3000);
        });
      }

      if (document.getElementById('usersTableBody')) {
        connectUserSocket();
      }

      const historyForm = document.querySelector('#admin-history form');
      if (historyForm) {
        historyForm.addEventListener('submit', () => {
          setTimeout(refreshHistory, 0);
        });
      }

      async function refreshHistory() {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;
        try {
          tbody.innerHTML = Array.from({ length: 6 }).map(() => `
            <tr class="skeleton-row">
              <td colspan="4">
                <div class="skeleton-line"></div>
              </td>
            </tr>
          `).join('');
          const params = new URLSearchParams(new FormData(document.querySelector('#admin-history form'))).toString();
          const res = await fetch(`/admin/history.json?${params}`);
          if (!res.ok) return;
          const data = await res.json();
          tbody.innerHTML = data.logs
            .map(
              (log) => `
                <tr>
                  <td>${log.id}</td>
                  <td>${log.actor_name || '-'}</td>
                  <td>${log.action}</td>
                  <td>${log.details || '-'}</td>
                  <td>${log.created_at}</td>
                </tr>
              `
            )
            .join('');
        } catch (err) {
          return;
        }
      }

      function bindUserRowClicks() {
        document.querySelectorAll('.user-row').forEach((row) => {
          row.addEventListener('click', (e) => {
            const tag = e.target.tagName.toLowerCase();
            const isManage = e.target.classList.contains('user-manage-btn');
            if (['input', 'select', 'button', 'a', 'form', 'label'].includes(tag) && !isManage) return;
            const userId = row.dataset.userId;
            const userName = row.dataset.userName;
            const userRole = normalizeRoleKeyClient(row.dataset.userRole || 'student');
            const userRoleKeys = parseRoleKeys(row.dataset.userRoles || userRole, [userRole || 'student']);
            const userGroup = row.dataset.userGroup;
            const userActive = row.dataset.userActive === '1' ? 'Yes' : 'No';
            const userCourse = row.dataset.userCourse || '';
            const userIp = row.dataset.userIp || '-';
            const userAgent = row.dataset.userAgent || '-';
            const userLogin = row.dataset.userLogin || '-';

            document.getElementById('uaName').textContent = userName;
            document.getElementById('uaRole').textContent = getRoleLabel(userRole);
            document.getElementById('uaRoles').textContent = mapRoleKeysToLabels(userRoleKeys);
            document.getElementById('uaGroup').textContent = userGroup;
            document.getElementById('uaActive').textContent = userActive;
            document.getElementById('uaCourse').textContent = userCourse;
            document.getElementById('uaIp').textContent = userIp;
            document.getElementById('uaAgent').textContent = userAgent;
            document.getElementById('uaLoginAt').textContent = userLogin;
            document.getElementById('uaRolesUserId').value = userId;
            document.getElementById('uaPassUserId').value = userId;
            document.getElementById('uaDeleteUserId').value = userId;
            document.getElementById('uaCourseUserId').value = userId;
            populateRoleEditor(roleCatalogBootstrap, userRoleKeys, userRole);
            hydrateUserRoleEditor(userId, userRoleKeys, userRole);
            if (document.getElementById('uaCourseSelect')) {
              document.getElementById('uaCourseSelect').value = row.dataset.userCourseId || '';
            }

            const modal = new bootstrap.Modal(document.getElementById('userActionsModal'));
            modal.show();

            const deleteBtn = document.getElementById('uaDeleteBtn');
            deleteBtn.onclick = async () => {
              const ok = await openConfirmModal({ message: 'Deactivate this user?', level: 'warning' });
              if (!ok) return;
              const res = await fetch('/admin/users/deactivate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const activateBtn = document.getElementById('uaActivateBtn');
            activateBtn.onclick = async () => {
              const res = await fetch('/admin/users/activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const permForm = document.getElementById('uaDeletePermanentForm');
            if (permForm) {
              permForm.style.display = userActive === 'Yes' ? 'none' : 'block';
            }

            const historyList = document.getElementById('uaLoginHistory');
            historyList.innerHTML = '<li class="list-group-item text-muted">Loading‚Ä¶</li>';
            fetch(`/admin/user-logins.json?user_id=${encodeURIComponent(userId)}`)
              .then((resp) => resp.json())
              .then((data) => {
                if (!data.logins || !data.logins.length) {
                  historyList.innerHTML = '<li class="list-group-item text-muted">No logins yet</li>';
                  return;
                }
                historyList.innerHTML = data.logins
                  .map(
                    (l) =>
                      `<li class="list-group-item">${l.created_at} ‚Äî ${l.ip || '-'} ‚Äî ${l.user_agent || '-'}</li>`
                  )
                  .join('');
              })
              .catch(() => {
                historyList.innerHTML = '<li class="list-group-item text-muted">Failed to load</li>';
              });
          });
        });
        document.querySelectorAll('.user-row select, .user-row input, .user-row button').forEach((el) => {
          el.addEventListener('click', (e) => e.stopPropagation());
        });
      }

      function bindSubjectButtons() {
        document.querySelectorAll('.subject-groups-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            const removeAction = btn.dataset.removeAction || '/admin/group/remove';
            const raw = btn.dataset.subjects || '[]';
            let items = [];
            try {
              items = JSON.parse(raw);
            } catch (e) {
              items = [];
            }
            document.getElementById('subjectGroupsTitle').textContent = `Subjects for ${userName}`;
            const list = document.getElementById('subjectGroupsList');
            list.innerHTML = '';
            if (!items.length) {
              list.innerHTML = '<div class="text-muted">No subjects assigned.</div>';
            } else {
              items.forEach((item) => {
                const row = document.createElement('div');
                row.className = 'list-group-item d-flex justify-content-between align-items-center';
                row.innerHTML = `
                  <div>${item.name} ‚Äî Group ${item.group_number}</div>
                  <form method="POST" action="${removeAction}" class="ms-2">
                    <input type="hidden" name="student_id" value="${userId}">
                    <input type="hidden" name="subject_id" value="${item.subject_id}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                  </form>
                `;
                list.appendChild(row);
              });
            }
            const modal = new bootstrap.Modal(document.getElementById('subjectGroupsModal'));
            modal.show();
          });
        });
      }

      document.querySelectorAll('[data-status]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const status = btn.dataset.status;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.status = status;
          refreshUsers();
        });
      });

      document.querySelectorAll('[data-role-filter]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const roleFilter = btn.dataset.roleFilter;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.roleFilter = roleFilter;
          refreshUsers();
        });
      });

      const uaRolesSelect = document.getElementById('uaRolesSelect');
      if (uaRolesSelect) {
        uaRolesSelect.addEventListener('change', () => {
          const primarySelect = document.getElementById('uaPrimaryRole');
          setPrimaryRoleOptions(getSelectedRoleKeys(), primarySelect ? primarySelect.value : '');
        });
      }

      function updateMessageTargetFields() {
        const type = document.getElementById('messageTargetType');
        const subject = document.getElementById('messageSubjectSelect');
        const group = document.getElementById('messageGroupInput');
        const users = document.getElementById('messageUsersSelect');
        if (!type || !subject || !group || !users) return;
        if (type.value === 'subject') {
          subject.disabled = false;
          group.disabled = false;
          users.disabled = true;
        } else if (type.value === 'users') {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = false;
        } else {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = true;
        }
      }

      function updateMessageScheduleFields() {
        const status = document.getElementById('messageStatusSelect');
        const schedule = document.getElementById('messageScheduledAt');
        if (!status || !schedule) return;
        const isScheduled = status.value === 'scheduled';
        schedule.disabled = !isScheduled;
        schedule.required = isScheduled;
        if (!isScheduled) {
          schedule.value = '';
        }
      }

      const messageTarget = document.getElementById('messageTargetType');
      if (messageTarget) {
        messageTarget.addEventListener('change', updateMessageTargetFields);
        updateMessageTargetFields();
      }

      const messageStatus = document.getElementById('messageStatusSelect');
      if (messageStatus) {
        messageStatus.addEventListener('change', updateMessageScheduleFields);
        updateMessageScheduleFields();
      }

      const messageReadsModal = document.getElementById('messageReadsModal');
      const messageReadsSummary = document.getElementById('messageReadsSummary');
      const messageReadsList = document.getElementById('messageReadsList');
      const messageUnreadList = document.getElementById('messageUnreadList');

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderReadRows(list, target) {
        if (!target) return;
        if (!list.length) {
          target.innerHTML = '<div class="list-group-item text-muted">Empty</div>';
          return;
        }
        target.innerHTML = list
          .map((row) => {
            const meta = row.read_at ? ` ¬∑ ${escapeHtml(row.read_at)}` : '';
            return `<div class="list-group-item">${escapeHtml(row.full_name)}${meta}</div>`;
          })
          .join('');
      }

      function renderUnreadRows(list, target) {
        if (!target) return;
        if (!list.length) {
          target.innerHTML = '<div class="list-group-item text-muted">Empty</div>';
          return;
        }
        target.innerHTML = list
          .map((row) => `<div class="list-group-item">${escapeHtml(row.full_name)}</div>`)
          .join('');
      }

      document.querySelectorAll('.message-reads-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const messageId = btn.dataset.messageId;
          if (!messageId || !messageReadsModal) return;
          if (messageReadsSummary) messageReadsSummary.textContent = 'Loading‚Ä¶';
          if (messageReadsList) messageReadsList.innerHTML = '';
          if (messageUnreadList) messageUnreadList.innerHTML = '';
          const modal = new bootstrap.Modal(messageReadsModal);
          modal.show();
          try {
            const params = new URLSearchParams(window.location.search);
            const courseParam = params.get('course');
            const url = courseParam
              ? `/admin/api/messages/${encodeURIComponent(messageId)}/reads?course=${encodeURIComponent(courseParam)}`
              : `/admin/api/messages/${encodeURIComponent(messageId)}/reads`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('bad');
            const data = await res.json();
            if (messageReadsSummary) {
              messageReadsSummary.textContent = `Read ${data.read_count || 0} of ${data.target_count || 0}`;
            }
            renderReadRows(data.reads || [], messageReadsList);
            renderUnreadRows(data.unread || [], messageUnreadList);
          } catch (err) {
            if (messageReadsSummary) messageReadsSummary.textContent = 'Failed to load';
          }
        });
      });

      bindUserRowClicks();
      bindSubjectButtons();

      function getTrackableInputs(form) {
        const byId = Array.from(document.querySelectorAll(`[form="${form.id}"]`));
        const inside = Array.from(form.querySelectorAll('input, select, textarea'));
        return [...new Set([...byId, ...inside])];
      }

      function initInputTracking() {
        document.querySelectorAll('input, select, textarea').forEach((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.dataset.initialChecked = el.checked ? '1' : '0';
          } else {
            el.dataset.initialValue = el.value;
          }
        });
      }

      function formHasChanges(form) {
        const inputs = getTrackableInputs(form);
        return inputs.some((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            return (el.dataset.initialChecked === '1') !== el.checked;
          }
          return (el.dataset.initialValue ?? '') !== el.value;
        });
      }

      function buildFormBody(form) {
        const params = new URLSearchParams();
        getTrackableInputs(form).forEach((el) => {
          if (!el.name) return;
          if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
          params.append(el.name, el.value);
        });
        return params;
      }

      function formIsVisible(form) {
        const section = form.closest('[id^="admin-"]');
        if (!section) return true;
        return section.offsetParent !== null;
      }

      async function saveAllForms() {
        const forms = Array.from(document.querySelectorAll('form[data-save-all="true"]'))
          .filter(formIsVisible)
          .filter(formHasChanges);
        const button = document.querySelector('.save-all-btn');
        if (!forms.length) {
          alert('–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
          return;
        }
        if (button) button.disabled = true;
        for (const form of forms) {
          const method = (form.method || 'POST').toUpperCase();
          await fetch(form.action, {
            method,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: buildFormBody(form),
          });
        }
        if (button) button.disabled = false;
        window.location.reload();
      }

      const addSubjectSelect = document.getElementById('addSubjectSelect');
      const addLessonTypeSelect = document.getElementById('addLessonTypeSelect');
      const addGroupSelect = document.getElementById('addGroupSelect');
      const addGroupMultiBtn = document.getElementById('addGroupMultiBtn');
      const addGroupNumbers = document.getElementById('addGroupNumbers');
      const addGroupSelectionLabel = document.getElementById('addGroupSelectionLabel');
      const addGroupMultiBadge = document.getElementById('addGroupMultiBadge');
      const groupMultiModalEl = document.getElementById('groupMultiModal');
      const groupMultiModal = groupMultiModalEl ? new bootstrap.Modal(groupMultiModalEl) : null;
      const groupMultiChecks = groupMultiModalEl
        ? Array.from(groupMultiModalEl.querySelectorAll('.group-multi-check'))
        : [];
      const groupMultiApply = document.getElementById('groupMultiApply');

      const getAddSubjectMeta = () => {
        if (!addSubjectSelect) return { groupCount: 3, isGeneral: true };
        const selected = addSubjectSelect.options[addSubjectSelect.selectedIndex];
        if (!selected) return { groupCount: 3, isGeneral: true };
        return {
          groupCount: Number(selected.dataset.groupCount || 3),
          isGeneral: selected.dataset.isGeneral !== '0',
        };
      };

      const setGroupSelectionLabel = (text) => {
        if (addGroupSelectionLabel) {
          addGroupSelectionLabel.textContent = text || '';
        }
      };

      const setGroupMultiBadge = (visible) => {
        if (!addGroupMultiBadge) return;
        addGroupMultiBadge.classList.toggle('d-none', !visible);
      };

      const updateGroupOptions = () => {
        if (!addGroupSelect) return;
        const { groupCount } = getAddSubjectMeta();
        const options = Array.from(addGroupSelect.querySelectorAll('option[data-group]'));
        options.forEach((opt) => {
          const num = Number(opt.dataset.group || 0);
          opt.disabled = num > groupCount;
        });
        if (Number(addGroupSelect.value) > groupCount) {
          addGroupSelect.value = groupCount >= 1 ? '1' : '';
        }
      };

      const applyGroupSelection = (groups) => {
        if (!addGroupSelect || !addGroupNumbers) return;
        const unique = Array.from(new Set((groups || []).map((g) => Number(g)).filter((g) => Number.isFinite(g))));
        unique.sort((a, b) => a - b);
        if (unique.length > 1) {
          addGroupNumbers.value = unique.join(',');
          addGroupSelect.value = String(unique[0]);
          addGroupSelect.classList.add('select-locked');
          setGroupSelectionLabel(`–û–±—Ä–∞–Ω–æ –≥—Ä—É–ø–∏: ${unique.join(', ')}`);
          setGroupMultiBadge(true);
        } else if (unique.length === 1) {
          addGroupNumbers.value = '';
          addGroupSelect.value = String(unique[0]);
          addGroupSelect.classList.remove('select-locked');
          setGroupSelectionLabel('');
          setGroupMultiBadge(false);
        } else {
          addGroupNumbers.value = '';
          addGroupSelect.classList.remove('select-locked');
          setGroupSelectionLabel('');
          setGroupMultiBadge(false);
        }
      };

      function syncAddGroupSelect() {
        if (!addSubjectSelect || !addGroupSelect) return;
        const { groupCount, isGeneral } = getAddSubjectMeta();
        updateGroupOptions();
        const lessonType = addLessonTypeSelect ? addLessonTypeSelect.value : '';
        const isLecture = lessonType === 'lecture';

        if (isLecture) {
          addGroupSelect.value = '1';
          addGroupSelect.classList.add('select-locked');
          if (addGroupNumbers) addGroupNumbers.value = '';
          if (addGroupMultiBtn) addGroupMultiBtn.style.display = 'none';
          setGroupSelectionLabel('–ì—Ä—É–ø–∞ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∞ –¥–ª—è –ª–µ–∫—Ü—ñ—ó.');
          setGroupMultiBadge(false);
          return;
        }

        if (groupCount <= 1) {
          addGroupSelect.value = '1';
          addGroupSelect.classList.add('select-locked');
          if (addGroupNumbers) addGroupNumbers.value = '';
          if (addGroupMultiBtn) addGroupMultiBtn.style.display = 'none';
          setGroupSelectionLabel('');
          setGroupMultiBadge(false);
          return;
        }

        addGroupSelect.classList.remove('select-locked');
        if (addGroupNumbers && addGroupNumbers.value) {
          const groups = addGroupNumbers.value
            .split(',')
            .map((g) => Number(g.trim()))
            .filter((g) => Number.isFinite(g));
          applyGroupSelection(groups);
        } else {
          setGroupSelectionLabel('');
          setGroupMultiBadge(false);
        }

        if (addGroupMultiBtn) {
          addGroupMultiBtn.style.display = isGeneral ? 'none' : '';
          addGroupMultiBtn.disabled = isGeneral;
        }
        if (isGeneral && addGroupNumbers) {
          addGroupNumbers.value = '';
          setGroupMultiBadge(false);
        }
      }

      if (addSubjectSelect) {
        addSubjectSelect.addEventListener('change', () => {
          if (addGroupNumbers) addGroupNumbers.value = '';
          setGroupSelectionLabel('');
          setGroupMultiBadge(false);
          syncAddGroupSelect();
        });
      }
      if (addLessonTypeSelect) {
        addLessonTypeSelect.addEventListener('change', syncAddGroupSelect);
      }
      if (addGroupSelect) {
        addGroupSelect.addEventListener('change', () => {
          if (addGroupNumbers && addGroupNumbers.value) {
            addGroupNumbers.value = '';
            setGroupSelectionLabel('');
          }
          syncAddGroupSelect();
        });
      }
      if (addGroupMultiBtn && groupMultiModal && groupMultiChecks.length) {
        addGroupMultiBtn.addEventListener('click', () => {
          const { groupCount } = getAddSubjectMeta();
          const selected = addGroupNumbers && addGroupNumbers.value
            ? addGroupNumbers.value.split(',').map((g) => Number(g.trim()))
            : [Number(addGroupSelect.value || 1)];
          groupMultiChecks.forEach((checkbox) => {
            const num = Number(checkbox.value);
            const disabled = num > groupCount;
            checkbox.disabled = disabled;
            checkbox.checked = !disabled && selected.includes(num);
          });
          groupMultiModal.show();
        });
      }
      if (groupMultiApply && groupMultiChecks.length) {
        groupMultiApply.addEventListener('click', () => {
          const selected = groupMultiChecks
            .filter((checkbox) => checkbox.checked && !checkbox.disabled)
            .map((checkbox) => Number(checkbox.value));
          const { groupCount } = getAddSubjectMeta();
          const fallback = Array.from({ length: groupCount }, (_, i) => i + 1);
          const finalSelection = selected.length ? selected : fallback.slice(0, 1);
          applyGroupSelection(finalSelection);
          if (groupMultiModal) {
            groupMultiModal.hide();
          }
        });
      }
      syncAddGroupSelect();

      const saveAllBtn = document.querySelector('.save-all-btn');
      if (saveAllBtn) {
        saveAllBtn.addEventListener('click', saveAllForms);
      }

      const homeworkBulkBar = document.getElementById('homeworkBulkBar');
      const homeworkSelectedCount = document.getElementById('homeworkSelectedCount');
      const homeworkBulkAction = document.getElementById('homeworkBulkAction');
      const bulkApplyBtn = document.getElementById('bulkApplyBtn');
      const bulkTags = document.getElementById('bulkTags');
      const bulkDeadline = document.getElementById('bulkDeadline');
      const bulkShift = document.getElementById('bulkShift');
      const bulkWeek = document.getElementById('bulkWeek');
      const selectAllHomework = document.getElementById('selectAllHomework');

      function getSelectedHomeworkIds() {
        return Array.from(document.querySelectorAll('.homework-select:checked')).map((el) => Number(el.value));
      }

      function updateBulkBar() {
        if (!homeworkSelectedCount || !homeworkBulkBar) return;
        const count = getSelectedHomeworkIds().length;
        homeworkSelectedCount.textContent = String(count);
        homeworkBulkBar.classList.toggle('d-none', count === 0);
      }

      function resetBulkInputs() {
        [bulkTags, bulkDeadline, bulkShift, bulkWeek].forEach((el) => {
          if (el) el.classList.add('d-none');
        });
      }

      if (homeworkBulkAction) {
        homeworkBulkAction.addEventListener('change', () => {
          resetBulkInputs();
          const action = homeworkBulkAction.value;
          if (action === 'add_tags' || action === 'remove_tags') bulkTags.classList.remove('d-none');
          if (action === 'set_deadline') bulkDeadline.classList.remove('d-none');
          if (action === 'shift_deadline') bulkShift.classList.remove('d-none');
          if (action === 'move_to_week') bulkWeek.classList.remove('d-none');
        });
      }

      if (selectAllHomework) {
        selectAllHomework.addEventListener('change', () => {
          document.querySelectorAll('.homework-select').forEach((el) => {
            el.checked = selectAllHomework.checked;
          });
          updateBulkBar();
        });
      }

      document.querySelectorAll('.homework-select').forEach((el) => {
        el.addEventListener('change', updateBulkBar);
      });

      if (bulkApplyBtn) {
        bulkApplyBtn.addEventListener('click', async () => {
          const ids = getSelectedHomeworkIds();
          if (!ids.length) return;
          const action = homeworkBulkAction.value;
          if (!action) return;
          const payload = {};
          if (action === 'add_tags' || action === 'remove_tags') {
            payload.tags = (bulkTags.value || '').split(',').map((t) => t.trim()).filter(Boolean);
          }
          if (action === 'set_deadline') payload.deadline = bulkDeadline.value;
          if (action === 'shift_deadline') payload.days = Number(bulkShift.value || 0);
          if (action === 'move_to_week') payload.week = Number(bulkWeek.value || 0);
          if (action === 'delete') {
            const ok = await openConfirmModal({ message: 'Delete selected homework?', level: 'danger' });
            if (!ok) return;
          }

          const res = await fetch('/admin/api/homework/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids, action, payload }),
          });
          if (!res.ok) {
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è');
            return;
          }
          if (action === 'export_csv') {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'homework_export.csv';
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            return;
          }
          window.location.reload();
        });
      }

      const validateScheduleBtn = document.getElementById('validateScheduleBtn');
      const scheduleValidateModal = document.getElementById('scheduleValidateModal');
      const runValidateBtn = document.getElementById('runValidateBtn');
      const validateWeekInput = document.getElementById('validateWeekInput');
      const validateIssues = document.getElementById('validateIssues');
      const validateErrors = document.getElementById('validateErrors');
      const validateWarnings = document.getElementById('validateWarnings');

      function renderValidateIssues(issues = []) {
        if (!validateIssues) return;
        if (!issues.length) {
          validateIssues.innerHTML = '<div class="text-muted">–ü—Ä–æ–±–ª–µ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }
        validateIssues.innerHTML = issues
          .map((issue) => {
            const badge =
              issue.severity === 'error'
                ? '<span class="badge text-bg-danger">error</span>'
                : '<span class="badge text-bg-warning">warning</span>';
            const meta = issue.context
              ? `week ${issue.context.week || '-'} ¬∑ ${issue.context.day_of_week || '-'} ¬∑ #${issue.context.class_number || '-'} ¬∑ –≥—Ä—É–ø–∞ ${issue.context.group || '-'}`
              : '';
            return `
              <div class="list-group-item validate-issue">
                <div>
                  ${badge}
                  <div class="fw-semibold mt-1">${issue.message}</div>
                  <div class="text-muted validate-meta">${meta}</div>
                </div>
                <a class="btn btn-sm btn-outline-primary" href="${issue.fix_url}">–ü–µ—Ä–µ–π—Ç–∏</a>
              </div>
            `;
          })
          .join('');
      }

      async function runScheduleValidation() {
        if (!validateIssues) return;
        validateIssues.innerHTML = '<div class="text-muted">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...</div>';
        const week = validateWeekInput && validateWeekInput.value ? Number(validateWeekInput.value) : null;
        const url = week ? `/admin/api/schedule/validate?week=${week}` : '/admin/api/schedule/validate';
        const res = await fetch(url);
        if (!res.ok) {
          validateIssues.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>';
          return;
        }
        const data = await res.json();
        if (validateErrors) validateErrors.textContent = data.summary?.errors ?? 0;
        if (validateWarnings) validateWarnings.textContent = data.summary?.warnings ?? 0;
        renderValidateIssues(data.issues || []);
      }

      if (validateScheduleBtn && scheduleValidateModal) {
        validateScheduleBtn.addEventListener('click', async () => {
          const modal = new bootstrap.Modal(scheduleValidateModal);
          modal.show();
          await runScheduleValidation();
        });
      }
      if (runValidateBtn) {
        runValidateBtn.addEventListener('click', runScheduleValidation);
      }

      const subjectCloneModal = document.getElementById('subjectCloneModal');
      const cloneSubjectId = document.getElementById('cloneSubjectId');
      const cloneSubjectName = document.getElementById('cloneSubjectName');
      const cloneSubjectSettings = document.getElementById('cloneSubjectSettings');
      const cloneSubjectSubmit = document.getElementById('cloneSubjectSubmit');

      document.querySelectorAll('.subject-clone-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!subjectCloneModal) return;
          cloneSubjectId.value = btn.dataset.subjectId;
          cloneSubjectName.value = `${btn.dataset.subjectName} (Copy)`;
          const modal = new bootstrap.Modal(subjectCloneModal);
          modal.show();
        });
      });
      if (cloneSubjectSubmit) {
        cloneSubjectSubmit.addEventListener('click', async () => {
          const res = await fetch(`/admin/api/subjects/${cloneSubjectId.value}/clone`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              new_name: cloneSubjectName.value,
              copy_settings: cloneSubjectSettings.checked,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è');
          window.location.reload();
        });
      }

      const scheduleCloneModal = document.getElementById('scheduleCloneModal');
      const cloneWeekSubmit = document.getElementById('cloneWeekSubmit');
      const cloneWeekSource = document.getElementById('cloneWeekSource');
      const cloneWeekTarget = document.getElementById('cloneWeekTarget');
      const cloneWeekMode = document.getElementById('cloneWeekMode');
      const validateScheduleBtnEl = document.getElementById('validateScheduleBtn');
      if (validateScheduleBtnEl && scheduleCloneModal) {
        const cloneBtn = document.createElement('button');
        cloneBtn.type = 'button';
        cloneBtn.className = 'btn btn-outline-primary btn-sm';
        cloneBtn.textContent = 'Clone week';
        validateScheduleBtnEl.parentElement.insertBefore(cloneBtn, validateScheduleBtnEl);
        cloneBtn.addEventListener('click', () => {
          const modal = new bootstrap.Modal(scheduleCloneModal);
          modal.show();
        });
      }
      if (cloneWeekSubmit) {
        cloneWeekSubmit.addEventListener('click', async () => {
          const res = await fetch('/admin/api/schedule/weeks/clone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              source_week: Number(cloneWeekSource.value || 0),
              target_week: Number(cloneWeekTarget.value || 0),
              mode: cloneWeekMode.value,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ç–∏–∂–Ω—è');
          window.location.reload();
        });
      }

      const homeworkCloneModal = document.getElementById('homeworkCloneModal');
      const cloneHomeworkId = document.getElementById('cloneHomeworkId');
      const cloneHomeworkTargetType = document.getElementById('cloneHomeworkTargetType');
      const cloneHomeworkTargetValue = document.getElementById('cloneHomeworkTargetValue');
      const cloneHomeworkAttachments = document.getElementById('cloneHomeworkAttachments');
      const cloneHomeworkLinks = document.getElementById('cloneHomeworkLinks');
      const cloneHomeworkSubmit = document.getElementById('cloneHomeworkSubmit');

      document.querySelectorAll('.homework-clone-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!homeworkCloneModal) return;
          cloneHomeworkId.value = btn.dataset.homeworkId;
          cloneHomeworkTargetValue.value = '';
          const modal = new bootstrap.Modal(homeworkCloneModal);
          modal.show();
        });
      });
      if (cloneHomeworkSubmit) {
        cloneHomeworkSubmit.addEventListener('click', async () => {
          const targetType = cloneHomeworkTargetType.value;
          const value = cloneHomeworkTargetValue.value;
          const target = {};
          if (targetType === 'week') target.week = Number(value || 0);
          if (targetType === 'date') target.class_date = value;
          if (targetType === 'deadline') target.deadline = value;
          const res = await fetch(`/admin/api/homework/${cloneHomeworkId.value}/clone`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              target,
              copy_attachments: cloneHomeworkAttachments.checked,
              copy_links: cloneHomeworkLinks.checked,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è –î–ó');
          window.location.reload();
        });
      }

      async function refreshScheduleDayOptions(courseId, selectedValue = '') {
        const daySelect = document.querySelector('select[name="day"]');
        if (!daySelect) return;
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) return;
        const data = await res.json();
        const days = (data.days || data).filter((d) => d.is_active);
        const options = ['<option value="">All days</option>'];
        days.forEach((day) => {
          const label = day.label || day.day_name || day.weekday;
          const value = day.day_name || '';
          if (!value) return;
          options.push(
            `<option value="${value}" ${selectedValue === value ? 'selected' : ''}>${label}</option>`
          );
        });
        daySelect.innerHTML = options.join('');
      }

      async function refreshStudyDaySelects(courseId) {
        const selects = Array.from(document.querySelectorAll('select[name="day_of_week"]'));
        if (!selects.length) return;
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) return;
        const data = await res.json();
        const days = (data.days || data).filter((d) => d.is_active);
        const dayOptions = days
          .map((day) => {
            const label = day.label || day.day_name || day.weekday;
            const value = day.day_name || '';
            if (!value) return '';
            return `<option value="${value}">${label}</option>`;
          })
          .filter(Boolean)
          .join('');
        selects.forEach((select) => {
          const current = select.value;
          const hasCurrent = days.some((d) => d.day_name === current);
          const currentOption = hasCurrent || !current
            ? ''
            : `<option value="${current}" selected>${current} (inactive)</option>`;
          const placeholder = select.required ? '<option value="" disabled>Day</option>' : '';
          select.innerHTML = `${placeholder}${currentOption}${dayOptions}`;
          if (hasCurrent) {
            select.value = current;
          }
        });
      }

      refreshScheduleDayOptions(<%= selectedCourseId || 1 %>, '<%= (filters && filters.day) || '' %>');
      refreshStudyDaySelects(<%= selectedCourseId || 1 %>);

      const studyDaysModal = document.getElementById('studyDaysModal');
      const studyDaysBody = document.getElementById('studyDaysBody');
      const studyDaysTitle = document.getElementById('studyDaysTitle');
      const studyDayLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
      const weekTimeModal = document.getElementById('weekTimeModal');
      const weekTimeBody = document.getElementById('weekTimeBody');
      const weekTimeTitle = document.getElementById('weekTimeTitle');

      async function loadStudyDays(courseId, courseName) {
        if (!studyDaysBody) return;
        studyDaysBody.innerHTML = '<div class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) {
          studyDaysBody.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
          return;
        }
        const data = await res.json();
            const days = data.days || data;
        const subjects = data.subjects || [];
        if (studyDaysTitle) {
          studyDaysTitle.textContent = courseName ? `–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è ‚Äî ${courseName}` : '–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è';
        }
        studyDaysBody.innerHTML = days
          .map((day) => {
            const active = day.is_active;
            const assigned = day.subjects || [];
            const chips = assigned.length
              ? assigned
                  .map(
                    (s) =>
                      `<span class="study-day-chip">${s.name}<button type="button" data-subject-id="${s.id}" data-weekday="${day.weekday}" class="study-day-remove">√ó</button></span>`
                  )
                  .join('')
              : '<span class="text-muted">–ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</span>';
            return `
              <div class="study-day-row" data-weekday="${day.weekday}">
                <div class="study-day-header">
                  <div class="study-day-label">${day.label || studyDayLabels[day.weekday - 1]}</div>
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input study-day-toggle" type="checkbox" ${active ? 'checked' : ''} data-weekday="${day.weekday}">
                  </div>
                </div>
                <div class="study-day-subjects">${chips}</div>
              </div>
            `;
          })
          .join('');

        studyDaysBody.querySelectorAll('.study-day-toggle').forEach((toggle) => {
          toggle.addEventListener('change', async (event) => {
            const weekday = event.target.dataset.weekday;
            await fetch(`/admin/api/courses/${courseId}/study-days/${weekday}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ is_active: event.target.checked }),
            });
            await refreshScheduleDayOptions(courseId, '<%= (filters && filters.day) || '' %>');
            await refreshStudyDaySelects(courseId);
          });
        });

        studyDaysBody.querySelectorAll('.study-day-remove').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const weekday = btn.dataset.weekday;
            const subjectId = btn.dataset.subjectId;
            await fetch(`/admin/api/courses/${courseId}/study-days/${weekday}/subjects/${subjectId}`, {
              method: 'DELETE',
            });
            await loadStudyDays(courseId, courseName);
          });
        });
      }

      async function loadWeekTime(courseId, courseName) {
        if (!weekTimeBody) return;
        weekTimeBody.innerHTML = '<div class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        const res = await fetch(`/admin/api/courses/${courseId}/week-time`);
        if (!res.ok) {
          weekTimeBody.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
          return;
        }
        const data = await res.json();
        const weeks = data.weeks || [];
        if (weekTimeTitle) {
          weekTimeTitle.textContent = courseName ? `–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤ ‚Äî ${courseName}` : '–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤';
        }
        if (!weeks.length) {
          weekTimeBody.innerHTML = '<div class="text-muted">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–º–µ—Å—Ç—Ä—É</div>';
          return;
        }
        weekTimeBody.innerHTML = weeks
          .map((week) => {
            const isLocal = week.use_local_time;
            const modeLabel = isLocal ? '–õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å' : '–ó–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å';
            return `
              <div class="week-time-row" data-week="${week.week_number}">
                <div class="week-time-meta">
                  <div class="week-time-label">–¢–∏–∂–¥–µ–Ω—å ${week.week_number}</div>
                  <div class="week-time-sub">${modeLabel}</div>
                </div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input week-time-toggle" type="checkbox" ${isLocal ? 'checked' : ''} data-week="${week.week_number}">
                </div>
              </div>
            `;
          })
          .join('');

        weekTimeBody.querySelectorAll('.week-time-toggle').forEach((toggle) => {
          toggle.addEventListener('change', async (event) => {
            const week = event.target.dataset.week;
            const nextValue = event.target.checked;
            const row = event.target.closest('.week-time-row');
            const label = row ? row.querySelector('.week-time-sub') : null;
            const resUpdate = await fetch(`/admin/api/courses/${courseId}/week-time/${week}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ use_local_time: nextValue }),
            });
            if (!resUpdate.ok) {
              event.target.checked = !nextValue;
              return alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è');
            }
            if (label) {
              label.textContent = nextValue ? '–õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å' : '–ó–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å';
            }
          });
        });
      }

      document.querySelectorAll('.study-days-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const courseId = btn.dataset.courseId;
          const courseName = btn.dataset.courseName;
          if (!courseId || !studyDaysModal) return;
          await loadStudyDays(courseId, courseName);
          const modal = new bootstrap.Modal(studyDaysModal);
          modal.show();
        });
      });

      document.querySelectorAll('.week-time-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const courseId = btn.dataset.courseId;
          const courseName = btn.dataset.courseName;
          if (!courseId || !weekTimeModal) return;
          await loadWeekTime(courseId, courseName);
          const modal = new bootstrap.Modal(weekTimeModal);
          modal.show();
        });
      });

      initInputTracking();
    </script>
    <script>
      (function adminTabsFallback() {
        const navLinks = Array.from(document.querySelectorAll('[data-admin-nav]'));
        const panels = Array.from(document.querySelectorAll('.admin-panels .admin-panel'));
        const breadcrumbsEl = document.getElementById('adminBreadcrumbs');
        if (!panels.length) return;

        const safeGet = (key, fallback = '') => {
          try {
            const value = window.localStorage.getItem(key);
            return value === null || typeof value === 'undefined' ? fallback : value;
          } catch (_) {
            return fallback;
          }
        };
        const safeSet = (key, value) => {
          try {
            window.localStorage.setItem(key, value);
          } catch (_) {
            // ignore storage errors
          }
        };

        const panelIds = new Set(panels.map((panel) => panel.id));
        const getDefaultTab = () => {
          const firstLinked = navLinks.find((link) => panelIds.has(link.dataset.adminNav || ''));
          return firstLinked ? firstLinked.dataset.adminNav : panels[0].id;
        };
        const resolveAdminTab = (requestedTab) => {
          if (requestedTab === 'admin-role-access' && panelIds.has('admin-role-studio')) {
            return 'admin-role-studio';
          }
          return panelIds.has(requestedTab) ? requestedTab : getDefaultTab();
        };

        const updateBreadcrumbs = (tabId) => {
          if (!breadcrumbsEl) return;
          const panel = panels.find((item) => item.id === tabId);
          const title = panel ? (panel.dataset.adminTitle || panel.id || '') : '';
          breadcrumbsEl.innerHTML = title
            ? `<span class="breadcrumb-item">Admin</span><span class="breadcrumb-sep">/</span><span class="breadcrumb-item active">${title}</span>`
            : '<span class="breadcrumb-item">Admin</span>';
        };

        const applyTab = (requestedTab, push = true) => {
          const resolved = resolveAdminTab(requestedTab);
          panels.forEach((panel) => {
            panel.style.display = panel.id === resolved ? 'block' : 'none';
          });
          navLinks.forEach((link) => {
            link.classList.toggle('is-active', link.dataset.adminNav === resolved);
          });
          updateBreadcrumbs(resolved);
          safeSet('admin:tab', resolved);
          if (push) {
            const url = new URL(window.location.href);
            url.searchParams.set('tab', resolved);
            window.history.replaceState({}, '', url);
          }
        };

        const initialTab = new URLSearchParams(window.location.search).get('tab')
          || safeGet('admin:tab', '')
          || getDefaultTab();
        applyTab(initialTab, false);

        navLinks.forEach((link) => {
          link.addEventListener('click', () => {
            applyTab(link.dataset.adminNav || '', true);
          });
        });
      })();
    </script>
      <script src="/js/design-system.js" defer></script>
  </body>
</html>
