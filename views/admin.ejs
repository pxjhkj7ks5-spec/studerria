<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('admin.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --radius: 16px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.12);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.35);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.22), transparent 60%),
          linear-gradient(135deg, #e6eef8 0%, #e9f0fb 45%, #eef2ff 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-dark .text-dark {
        color: #f8fafc !important;
      }
      .admin-nav {
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .admin-nav {
        background: rgba(255, 255, 255, 0.8);
        border-bottom-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-dark .admin-nav {
        background: rgba(10, 10, 20, 0.6);
      }
      .card {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .card {
        backdrop-filter: none;
        background: linear-gradient(180deg, rgba(22, 30, 50, 0.68) 0%, rgba(16, 22, 38, 0.74) 100%);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.06);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.48);
      }
      body.theme-light .card {
        background: var(--glass-bg-light);
        border-color: var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18), 0 0 0 1px rgba(255, 255, 255, 0.35) inset;
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-dark .table {
        color: #f8fafc;
      }
      body.theme-dark .table th,
      body.theme-dark .table td {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.92);
      }
      body.theme-dark h1,
      body.theme-dark h2,
      body.theme-dark h3,
      body.theme-dark h4,
      body.theme-dark h5,
      body.theme-dark h6,
      body.theme-dark .card-title,
      body.theme-dark .navbar-brand {
        color: #f8fafc;
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.9);
      }
      body.theme-dark .form-label,
      body.theme-dark .form-check-label,
      body.theme-dark label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .input-group-text {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
      }
      body.theme-dark .table > :not(caption) > * > * {
        background: transparent;
      }
      body.theme-dark .table-striped > tbody > tr:nth-of-type(odd) > * {
        background: rgba(255, 255, 255, 0.03);
      }
      body.theme-dark .table-striped > tbody > tr:hover > * {
        background: rgba(255, 255, 255, 0.06);
      }
      .form-control,
      .form-select {
        border-radius: 12px;
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 14px;
        color: inherit;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      body.theme-dark .form-control,
      body.theme-dark .form-select {
        background: rgba(255, 255, 255, 0.06);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
        color-scheme: dark;
      }
      body.theme-dark select.form-select[multiple] {
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(248, 250, 252, 0.65);
      }
      body.theme-dark .form-select option {
        background: rgba(15, 23, 42, 0.96);
        color: #f8fafc;
      }
      body.theme-dark .form-select optgroup {
        background: rgba(15, 23, 42, 0.98);
        color: #cbd5f5;
      }
      body.theme-light .form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark .form-select option:checked,
      body.theme-dark .form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light .form-select option:checked,
      body.theme-light .form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      .custom-tooltip {
        position: fixed;
        z-index: 2000;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 220ms ease, transform 220ms ease;
      }
      .custom-tooltip.show {
        opacity: 1;
        transform: translateY(0);
      }
      .custom-tooltip::before {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 20px;
        border: 6px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.08);
      }
      .custom-tooltip.below::before {
        top: -6px;
        bottom: auto;
        border-top-color: transparent;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-light .custom-tooltip {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      body.theme-light .custom-tooltip::before {
        border-top-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-light .custom-tooltip.below::before {
        border-bottom-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      body.theme-dark .text-muted {
        color: rgba(255, 255, 255, 0.65) !important;
      }
      body.theme-dark .list-group-item {
        background: transparent;
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .badge.text-bg-light {
        background: rgba(255, 255, 255, 0.12) !important;
        color: #f8fafc !important;
      }
      body.theme-dark a {
        color: #93c5fd;
      }
      body.theme-dark a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%);
        border: none;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary,
      .btn-outline-danger {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      body.theme-dark .btn-outline-primary,
      body.theme-dark .btn-outline-secondary,
      body.theme-dark .btn-outline-danger {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.3);
      }
      body.theme-dark .btn-outline-primary:hover,
      body.theme-dark .btn-outline-secondary:hover,
      body.theme-dark .btn-outline-danger:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .select-locked {
        pointer-events: none;
        opacity: 0.75;
      }
      .flash-alert {
        border-radius: 14px;
        padding: 0.5rem 0.9rem;
        font-size: 0.9rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.35);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
        backdrop-filter: blur(10px);
      }
      body.theme-dark .flash-alert {
        background: rgba(17, 17, 30, 0.7);
        border-color: rgba(255, 255, 255, 0.12);
        color: #f8fafc;
      }
      .flash-alert.alert-danger {
        border-color: rgba(239, 68, 68, 0.45);
        color: #b91c1c;
      }
      body.theme-dark .flash-alert.alert-danger {
        color: #fca5a5;
      }
      .flash-alert.alert-success {
        border-color: rgba(34, 197, 94, 0.45);
        color: #166534;
      }
      body.theme-dark .flash-alert.alert-success {
        color: #86efac;
      }
      .app-footer {
        font-size: 0.8rem;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
      .bulk-bar {
        position: sticky;
        top: 80px;
        z-index: 20;
        padding: 10px 12px;
        border-radius: 14px;
        margin-bottom: 12px;
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-light .bulk-bar {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      .validate-issue {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
      }
      .validate-meta {
        font-size: 0.85rem;
      }
      .study-day-row {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.06);
      }
      .week-time-row {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 14px;
        padding: 12px 14px;
        background: rgba(255, 255, 255, 0.06);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .week-time-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .week-time-label {
        font-weight: 700;
      }
      .week-time-sub {
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .week-time-hint {
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .study-day-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }
      .study-day-label {
        font-weight: 700;
      }
      .study-day-subjects {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0;
      }
      .study-day-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.35);
        color: inherit;
        font-size: 0.85rem;
      }
      .study-day-chip button {
        border: none;
        background: transparent;
        color: inherit;
      }
      body.theme-light .study-day-row {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-light .week-time-row {
        background: rgba(255, 255, 255, 0.7);
        border-color: rgba(15, 23, 42, 0.12);
      }
      .save-all-btn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 1200;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
      }
      :root {
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 10px;
        --s-1: 8px;
        --s-2: 12px;
        --s-3: 16px;
        --s-4: 24px;
        --border-subtle: 1px solid rgba(255, 255, 255, 0.12);
        --border-hover: 1px solid rgba(255, 255, 255, 0.18);
        --glass-bg: rgba(20, 24, 32, 0.45);
        --glass-bg-light: rgba(255, 255, 255, 0.55);
        --glass-blur: 18px;
        --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        --text-primary: rgba(255, 255, 255, 0.92);
        --text-secondary: rgba(255, 255, 255, 0.68);
        --text-muted: rgba(255, 255, 255, 0.52);
        --focus-ring: 0 0 0 3px rgba(90, 140, 255, 0.25);
        --focus-border: rgba(90, 140, 255, 0.65);
      }
      body.theme-light {
        --text-primary: rgba(15, 23, 42, 0.92);
        --text-secondary: rgba(15, 23, 42, 0.68);
        --text-muted: rgba(15, 23, 42, 0.52);
      }
      .glass {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius-lg);
        backdrop-filter: blur(var(--glass-blur));
        background: var(--glass-bg);
        border: var(--border-subtle);
        box-shadow: var(--glass-shadow);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      }
      .form-control,
      .form-select {
        border-radius: var(--radius-md);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--focus-border);
        box-shadow: var(--focus-ring);
      }
      .theme-toggle-min {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
      }
      body.theme-light .theme-toggle-min {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      .modal-backdrop.show {
        opacity: 0.48;
      }
      .modal-content {
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: var(--glass-bg);
        border: var(--border-subtle);
        backdrop-filter: blur(var(--glass-blur));
      }
      body.theme-light .modal-content {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
      .modal-header,
      .modal-footer {
        position: sticky;
        z-index: 2;
        background: inherit;
        backdrop-filter: blur(var(--glass-blur));
      }
      .modal-header {
        top: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-footer {
        bottom: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-body {
        overflow-y: auto;
      }
      .file-field {
        display: flex;
        align-items: center;
        gap: 10px;
        position: relative;
      }
      .file-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .file-ui {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: var(--radius-md);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-light .file-ui {
        border-color: rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
      }
      .file-name {
        color: var(--text-muted);
        font-size: 0.85rem;
      }
</style>
      <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/admin.css" />
</head>
  <body class="theme-light">
    <% const isLimitedView = typeof limitedStaffView !== 'undefined' && limitedStaffView; %>
    <% const allowedSectionsList = typeof locals !== 'undefined' && typeof locals.allowedSections !== 'undefined' ? locals.allowedSections : (typeof allowedSections !== 'undefined' ? allowedSections : null); %>
    <% const sectionAllowed = (id) => !allowedSectionsList || allowedSectionsList.includes(id); %>
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <span class="navbar-brand"><%= isLimitedView && role === 'starosta' ? t('admin.starostaPanel') : t('admin.title') %></span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.user') %>: <%= username %>
            <% } %>
          </span>
          <button
            class="theme-toggle-min me-2"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="‚òÄÔ∏è"
            data-dark-label="üåô"
          >
            üåô
          </button>
          <% if (!isLimitedView) { %>
            <form method="POST" action="/admin/switch-to-student" class="me-2">
              <button class="btn btn-outline-primary btn-sm" type="submit"><%= t('admin.viewAsStudent') %></button>
            </form>
          <% } else { %>
            <a class="btn btn-outline-primary btn-sm me-2" href="/schedule"><%= t('admin.backToSchedule') %></a>
          <% } %>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h1 class="h3 mb-0"><%= t('admin.dashboard') %></h1>
        <% if (sectionAllowed('admin-overview')) { %>
          <a class="btn btn-outline-primary btn-sm" href="/admin/overview?course=<%= selectedCourseId %>"><%= t('admin.openOverview') %></a>
        <% } %>
      </div>

      <% const msg = typeof messages !== 'undefined' && messages ? messages : (typeof locals !== 'undefined' ? locals.messages : {}); %>
      <% if (msg && msg.error) { %>
        <div class="alert alert-danger flash-alert"><%= msg.error %></div>
      <% } %>
      <% if (msg && msg.success) { %>
        <div class="alert alert-success flash-alert"><%= msg.success %></div>
      <% } %>

      <% const courseMap = {}; %>
      <% (courses || []).forEach(function(c) { courseMap[c.id] = c.name; }); %>

      <% if (!isLimitedView || role === 'deanery') { %>
        <form class="mb-3" method="GET" action="<%= role === 'deanery' ? '/deanery' : '/admin' %>">
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0"><%= t('admin.course') %></label>
            <select name="course" class="form-select w-auto" onchange="this.form.submit()">
              <% (courses || []).forEach(function(c) { %>
                <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>>
                  <%= c.name %>
                </option>
              <% }); %>
            </select>
          </div>
        </form>
      <% } else { %>
        <div class="mb-3 text-muted"><%= t('admin.course') %>: <%= courseMap[selectedCourseId] || ('Course ' + selectedCourseId) %></div>
      <% } %>

      <% const groupMap = {}; %>
      <% (studentGroups || []).forEach(function(g) { %>
        <% if (!groupMap[g.student_id]) { groupMap[g.student_id] = {}; } %>
        <% groupMap[g.student_id][g.subject_id] = g.group_number; %>
      <% }); %>

      <div class="d-flex flex-wrap gap-2 mb-3">
        <% if (sectionAllowed('admin-settings')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-settings')">
            <%= t('admin.settings') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-schedule')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-schedule')">
            <%= t('admin.schedule') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-homework')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-homework')">
            <%= t('admin.homework') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-users')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-users')">
            <%= t('admin.users') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-teachers')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-teachers')">
            –ó–∞—è–≤–∫–∏ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤
          </button>
        <% } %>
        <% if (sectionAllowed('admin-subjects')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-subjects')">
            <%= t('admin.subjects') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-semesters')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-semesters')">
            <%= t('admin.semesters') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-courses')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-courses')">
            <%= t('admin.courses') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-history')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-history')">
            <%= t('admin.history') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-activity')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-activity')">
            <%= t('admin.activity') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-teamwork')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-teamwork')">
            <%= t('admin.teamwork') %>
          </button>
        <% } %>
        <% if (sectionAllowed('admin-messages')) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-messages')">
            <%= t('admin.messages') %>
          </button>
        <% } %>
        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleAllSections()">
          <%= t('admin.showHideAll') %>
        </button>
      </div>

      <div class="tab-content">
        <% if (sectionAllowed('admin-settings')) { %>
        <div id="admin-settings" class="card mb-3">
          <div class="card-body">
            <h5 class="mb-3"><%= t('admin.settings') %></h5>
            <form method="POST" action="/admin/settings" class="row g-3 align-items-end">
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.sessionDuration') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="session_duration_days"
                  value="<%= (settings && settings.session_duration_days) || 14 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.maxFileSize') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="max_file_size_mb"
                  value="<%= (settings && settings.max_file_size_mb) || 20 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.minTeamMembers') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="min_team_members"
                  value="<%= (settings && settings.min_team_members) || 2 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.allowHomework') %></label>
                <select class="form-select" name="allow_homework_creation">
                  <option value="true" <%= (settings && settings.allow_homework_creation) ? 'selected' : '' %>><%= t('admin.enabled') %></option>
                  <option value="false" <%= (settings && settings.allow_homework_creation) ? '' : 'selected' %>><%= t('admin.disabled') %></option>
                </select>
              </div>
              <div class="col-12 col-md-2 d-grid">
                <button class="btn btn-primary" type="submit"><%= t('admin.saveSettings') %></button>
              </div>
            </form>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-schedule')) { %>
        <div id="admin-schedule">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Add class</h5>
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-outline-primary btn-sm" type="button" id="validateScheduleBtn">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥</button>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-list">–í—ñ–¥–∫—Ä–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä</a>
                  <a class="btn btn-outline-secondary btn-sm" href="/admin/export/schedule.csv">Export CSV</a>
                  <form class="d-flex gap-2" method="POST" action="/admin/import/schedule.csv" enctype="multipart/form-data">
                    <div class="file-field">
                      <input id="scheduleCsv" class="file-input" type="file" name="csv_file" accept=".csv" required />
                      <div class="file-ui">
                        <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="scheduleCsv">–û–±–µ—Ä—ñ—Ç—å</button>
                        <span class="file-name" data-file-name="scheduleCsv">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
                      </div>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm" type="submit">Import CSV</button>
                  </form>
                </div>
              </div>
              <form method="POST" action="/admin/schedule/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <select class="form-select" id="addSubjectSelect" name="subject_id" required>
                      <option value="" disabled selected>Subject</option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>" data-group-count="<%= s.group_count %>"><%= s.name %> (1‚Äì<%= s.group_count %>)</option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" id="addGroupSelect" name="group_number" required>
                      <option value="" disabled selected>Group #</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="semester_id" required>
                      <option value="" disabled selected>Semester</option>
                      <% (semesters || []).forEach(function(sem) { %>
                        <option value="<%= sem.id %>" <%= activeSemester && sem.id === activeSemester.id ? 'selected' : '' %>>
                          <%= sem.title %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="day_of_week" required>
                      <option value="" disabled selected>Day</option>
                      <% (activeScheduleDays || ['Monday','Tuesday','Wednesday','Thursday','Friday']).forEach(function(d) { %>
                        <option value="<%= d %>"><%= d %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-1">
                    <select class="form-select" name="class_number" required>
                      <option value="" disabled selected>Class #</option>
                      <% [1,2,3,4,5,6,7].forEach(function(n) { %>
                        <option value="<%= n %>"><%= n %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <input
                      class="form-control"
                      name="week_numbers"
                      placeholder="Weeks: 1,2,3"
                      required
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-homework')) { %>
        <div id="admin-homework">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0"><%= t('admin.searchHomework') %></h5>
                <form method="POST" action="/admin/homework/migrate">
                  <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.migrateLegacyHomework') %></button>
                </form>
              </div>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="group_number"
                      placeholder="<%= t('admin.groupNumber') %>"
                      value="<%= (filters && filters.group_number) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="subject"
                      placeholder="<%= t('admin.subject') %>"
                      value="<%= (filters && filters.subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-4">
                    <input
                      class="form-control"
                      name="q"
                      placeholder="<%= t('admin.searchDescAuthor') %>"
                      value="<%= (filters && filters.q) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.search') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_from"
                      value="<%= (filters && filters.homework_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_to"
                      value="<%= (filters && filters.homework_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="homework_tag"
                      placeholder="<%= t('admin.tag') %>"
                      list="adminHomeworkTags"
                      value="<%= (filters && filters.homework_tag) || '' %>"
                    />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-4">
                    <select class="form-select" name="sort_homework">
                      <option value=""><%= t('admin.sortHomework') %></option>
                      <option value="created" <%= sorts && sorts.homework === 'created' ? 'selected' : '' %>>
                        <%= t('admin.sortNewest') %>
                      </option>
                      <option value="subject" <%= sorts && sorts.homework === 'subject' ? 'selected' : '' %>>
                        <%= t('admin.sortSubject') %>
                      </option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-secondary" type="submit"><%= t('admin.applySort') %></button>
                  </div>
                </div>
                <datalist id="adminHomeworkTags">
                  <% (homeworkTags || []).forEach(function(tag) { %>
                    <option value="<%= tag %>"></option>
                  <% }); %>
                </datalist>
              </form>
            </div>
          </div>
          <div class="bulk-bar d-none" id="homeworkBulkBar">
            <div class="d-flex flex-wrap align-items-center gap-2">
              <span class="text-muted">Selected: <span id="homeworkSelectedCount">0</span></span>
              <select class="form-select form-select-sm w-auto" id="homeworkBulkAction">
                <option value="">Bulk action</option>
                <option value="add_tags">Add tags</option>
                <option value="remove_tags">Remove tags</option>
                <option value="set_deadline">Set deadline</option>
                <option value="shift_deadline">Shift deadline (days)</option>
                <option value="move_to_week">Move to week</option>
                <option value="delete">Delete</option>
                <option value="export_csv">Export CSV</option>
              </select>
              <input class="form-control form-control-sm w-auto d-none" id="bulkTags" placeholder="tag1, tag2" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkDeadline" type="date" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkShift" type="number" placeholder="+/- days" />
              <input class="form-control form-control-sm w-auto d-none" id="bulkWeek" type="number" min="1" max="15" placeholder="Week #" />
              <button class="btn btn-sm btn-outline-primary" type="button" id="bulkApplyBtn">Apply</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllHomework" /></th>
                  <th>ID</th>
                  <th><%= t('admin.groupNumber') %></th>
                  <th><%= t('admin.classNumber') %></th>
                  <th><%= t('admin.description') %></th>
                  <th><%= t('admin.tag') %></th>
                  <th><%= t('admin.dayClass') %></th>
                  <th><%= t('admin.createdBy') %></th>
                  <th><%= t('admin.attachment') %></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% homework.forEach(function(item) { %>
                  <tr>
                    <td><input type="checkbox" class="homework-select" value="<%= item.id %>" /></td>
                    <td><%= item.id %></td>
                    <td><%= item.group_number %></td>
                    <td><%= item.subject_name || item.subject %> (<%= item.day_of_week || item.day %>)</td>
                    <td><%= item.description %></td>
                    <td>
                      <% if (item.tags && item.tags.length) { %>
                        <%= item.tags.join(', ') %>
                      <% } else { %>
                        <span class="text-muted">‚Äî</span>
                      <% } %>
                    </td>
                    <td><%= item.day_of_week || item.day %> ¬∑ #<%= item.class_number || '-' %></td>
                    <td><%= item.created_by %></td>
                    <td>
                      <% if (item.file_path) { %>
                        <a href="<%= item.file_path %>"><%= item.file_name || 'Download' %></a>
                      <% } else if (item.meeting_url) { %>
                        <a href="<%= item.meeting_url %>" target="_blank" rel="noopener">Online class</a>
                      <% } else if (item.link_url) { %>
                        <a href="<%= item.link_url %>" target="_blank" rel="noopener">Link</a>
                      <% } else { %>
                        <span class="text-muted">‚Äî</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary homework-clone-btn" type="button" data-homework-id="<%= item.id %>">Clone</button>
                        <form method="POST" action="/admin/homework/delete/<%= item.id %>">
                          <button
                            class="btn btn-sm btn-outline-danger"
                            type="submit"
                            onclick="return confirm('Delete this homework item?');"
                          >
                            <%= t('admin.delete') %>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-users')) { %>
        <div id="admin-users">
          <div class="card mb-3">
            <div class="card-body">
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-5">
                    <label class="form-label"><%= t('admin.searchByName') %></label>
                    <input
                      class="form-control"
                      name="users_q"
                      placeholder="<%= t('admin.searchByNamePlaceholder') %>"
                      value="<%= (filters && filters.users_q) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.scheduleGroup') %></label>
                    <input
                      class="form-control"
                      name="users_group"
                      placeholder="<%= t('admin.scheduleGroupPlaceholder') %>"
                      value="<%= (filters && filters.users_group) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-outline-danger btn-sm" type="submit" form="deleteUsersForm"><%= t('admin.deleteSelected') %></button>
            <button
              class="btn btn-danger btn-sm"
              type="submit"
              form="clearUsersForm"
              onclick="return confirm('<%= t('admin.deleteAllConfirm') %>');"
            >
              <%= t('admin.deleteAllStudents') %>
            </button>
            <a
              class="btn btn-outline-secondary btn-sm"
              href="/admin/export/users.csv?course=<%= selectedCourseId || 1 %><%= activeSemester ? '&semester_id=' + activeSemester.id : '' %><%= (filters && filters.users_group) ? '&group=' + encodeURIComponent(filters.users_group) : '' %>"
            ><%= t('admin.exportUsers') %></a>
            <form class="d-flex gap-2" method="POST" action="/admin/import/users.csv" enctype="multipart/form-data">
              <div class="file-field">
                <input id="usersCsv" class="file-input" type="file" name="csv_file" accept=".csv" required />
                <div class="file-ui">
                  <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="usersCsv">–û–±–µ—Ä—ñ—Ç—å</button>
                  <span class="file-name" data-file-name="usersCsv">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
                </div>
              </div>
              <button class="btn btn-outline-secondary btn-sm" type="submit">Import CSV</button>
            </form>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-status="active"><%= t('admin.active') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="inactive"><%= t('admin.inactive') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="all"><%= t('admin.all') %></button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-role-filter="all"><%= t('admin.allRoles') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="admin"><%= t('admin.admins') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="starosta"><%= t('admin.starosta') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="deanery"><%= t('admin.deanery') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="student"><%= t('admin.students') %></button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllUsers" /></th>
                  <th><%= t('admin.name') %></th>
                  <th><%= t('admin.role') %></th>
                  <th><%= t('admin.course') %></th>
                  <th><%= t('admin.scheduleGroup') %></th>
                  <th><%= t('admin.subjectGroup') %></th>
                  <th><%= t('admin.setGroup') %></th>
                  <th><%= t('admin.actions') %></th>
                </tr>
              </thead>
              <tbody
                id="usersTableBody"
                data-current-user-id="<%= typeof userId !== 'undefined' ? userId : '' %>"
                data-status="<%= usersStatus || 'active' %>"
                data-role-filter="all"
                data-course-id="<%= selectedCourseId || 1 %>"
                data-search="<%= (filters && filters.users_q) || '' %>"
                data-group="<%= (filters && filters.users_group) || '' %>"
              >
                <% (users || []).forEach(function(u) { %>
                  <tr
                    class="user-row"
                    data-user-id="<%= u.id %>"
                    data-user-name="<%= u.full_name %>"
                    data-user-role="<%= u.role %>"
                    data-user-group="<%= u.schedule_group %>"
                    data-user-course="<%= courseMap[u.course_id] || ('Course ' + (u.course_id || 1)) %>"
                    data-user-course-id="<%= u.course_id || 1 %>"
                    data-user-active="<%= u.is_active %>"
                    data-user-ip="<%= u.last_login_ip || '' %>"
                    data-user-agent="<%= u.last_user_agent || '' %>"
                    data-user-login="<%= u.last_login_at || '' %>"
                  >
                    <td>
                      <% if (u.role !== 'admin') { %>
                        <input type="checkbox" name="delete_user_ids" value="<%= u.id %>" form="deleteUsersForm" />
                      <% } %>
                    </td>
                    <td><%= u.full_name %></td>
                    <td><span class="badge text-bg-<%= u.role === 'admin' ? 'primary' : (u.role === 'starosta' ? 'warning' : (u.role === 'deanery' ? 'info' : 'secondary')) %>"><%= u.role %></span></td>
                    <td><%= courseMap[u.course_id] || ('Course ' + (u.course_id || 1)) %></td>
                    <td><%= u.schedule_group %></td>
                    <td>
                      <% 
                        const subjectList = [];
                        if (groupMap[u.id]) {
                          Object.keys(groupMap[u.id]).forEach(function(subjectId) {
                            const subj = (subjects || []).find(function(s) { return String(s.id) === String(subjectId); });
                            if (subj) {
                              subjectList.push({ subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][subjectId] });
                            }
                          });
                        }
                      %>
                      <button
                        class="btn btn-sm btn-outline-primary subject-groups-btn"
                        type="button"
                        data-user-id="<%= u.id %>"
                        data-user-name="<%= u.full_name %>"
                        data-subjects='<%- JSON.stringify(subjectList) %>'
                      >
                        <%= t('admin.subjects') %> (<%= subjectList.length %>)
                      </button>
                    </td>
                    <td>
                      <form method="POST" action="/admin/student-groups/set" class="row g-2">
                        <input type="hidden" name="student_id" value="<%= u.id %>" />
                        <div class="col-12 col-md-6">
                          <select class="form-select form-select-sm" name="subject_id" required>
                            <option value="" disabled selected><%= t('admin.subject') %></option>
                            <% (subjects || []).forEach(function(s) { %>
                              <option value="<%= s.id %>"><%= s.name %> (1‚Äì<%= s.group_count %>)</option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-3">
                          <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                          <button class="btn btn-sm btn-outline-primary" type="submit"><%= t('admin.save') %></button>
                        </div>
                      </form>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary user-manage-btn" type="button"><%= t('admin.manage') %></button>
                      <% if (u.role !== 'admin' && u.is_active === 0) { %>
                        <form method="POST" action="/admin/users/delete-permanent" class="d-inline">
                          <input type="hidden" name="user_id" value="<%= u.id %>" />
                          <button
                            class="btn btn-sm btn-outline-danger ms-2"
                            type="submit"
                            onclick="return confirm('<%= t('admin.deletePermanentConfirm') %>');"
                          >
                            <%= t('admin.deletePermanent') %>
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <form id="deleteUsersForm" method="POST" action="/admin/users/delete-multiple"></form>
          <form id="clearUsersForm" method="POST" action="/admin/users/clear-all"></form>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-teachers')) { %>
        <div id="admin-teachers">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">–ó–∞—è–≤–∫–∏ –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>–Ü–º º—è</th>
                      <th>–ü—Ä–µ–¥–º–µ—Ç–∏</th>
                      <th>–°—Ç–∞—Ç—É—Å</th>
                      <th>–î–∞—Ç–∞</th>
                      <th>–î—ñ—ó</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (teacherRequests || []).forEach(function(reqRow) { %>
                      <tr>
                        <td><%= reqRow.full_name %></td>
                        <td>
                          <% if (reqRow.subjects && reqRow.subjects.length) { %>
                            <div class="d-flex flex-wrap gap-1">
                              <% reqRow.subjects.forEach(function(subj) { %>
                                <span class="badge bg-secondary"><%= subj %></span>
                              <% }); %>
                            </div>
                          <% } else { %>
                            <span class="text-muted">‚Äî</span>
                          <% } %>
                        </td>
                        <td>
                          <span class="badge <%= reqRow.status === 'approved' ? 'bg-success' : (reqRow.status === 'rejected' ? 'bg-danger' : 'bg-warning text-dark') %>">
                            <%= reqRow.status %>
                          </span>
                        </td>
                        <td class="small text-muted">
                          <%= reqRow.created_at ? new Date(reqRow.created_at).toLocaleDateString('uk-UA') : '' %>
                        </td>
                        <td class="d-flex gap-2">
                          <% if (reqRow.status !== 'approved') { %>
                            <form method="POST" action="/admin/teacher-requests/<%= reqRow.user_id %>/approve">
                              <button class="btn btn-sm btn-outline-success" type="submit">Approve</button>
                            </form>
                          <% } %>
                          <% if (reqRow.status !== 'rejected') { %>
                            <form method="POST" action="/admin/teacher-requests/<%= reqRow.user_id %>/reject">
                              <button class="btn btn-sm btn-outline-danger" type="submit">Reject</button>
                            </form>
                          <% } %>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(teacherRequests || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">–ù–µ–º–∞—î –∑–∞—è–≤–æ–∫</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-subjects')) { %>
        <div id="admin-subjects">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Add subject</h5>
              <form method="POST" action="/admin/subjects/add" novalidate>
                <div class="row g-2">
                  <div class="col-12 col-md-5">
                    <input class="form-control" name="name" placeholder="Subject name" />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="group_count">
                      <option value="" disabled selected>Groups</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="default_group">
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="show_in_teamwork">
                      <option value="1" selected>Teamwork: Yes</option>
                      <option value="0">Teamwork: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="visible">
                      <option value="1" selected>Visible: Yes</option>
                      <option value="0">Visible: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="is_required">
                      <option value="1" selected>Required: Yes</option>
                      <option value="0">Required: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-flex align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_general" id="subjectGeneralCreate" value="1" checked />
                      <label class="form-check-label" for="subjectGeneralCreate">–ó–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2 mb-2 flex-wrap">
            <a class="btn btn-outline-secondary btn-sm" href="/admin/export/subjects.csv">Export Subjects CSV</a>
            <form class="d-flex gap-2" method="POST" action="/admin/import/subjects.csv" enctype="multipart/form-data">
              <div class="file-field">
                <input id="subjectsCsv" class="file-input" type="file" name="csv_file" accept=".csv" required />
                <div class="file-ui">
                  <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="subjectsCsv">–û–±–µ—Ä—ñ—Ç—å</button>
                  <span class="file-name" data-file-name="subjectsCsv">–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ</span>
                </div>
              </div>
              <button class="btn btn-outline-secondary btn-sm" type="submit">Import CSV</button>
            </form>
          </div>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Groups</th>
                  <th>Default</th>
                  <th>Teamwork</th>
                  <th>Visible</th>
                  <th>Required</th>
                  <th>General</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% (subjects || []).forEach(function(s) { %>
                  <% const requiredFlag = typeof s.is_required === 'undefined' || s.is_required === null ? 1 : Number(s.is_required); %>
                  <% const generalFlag = typeof s.is_general === 'undefined' || s.is_general === null ? 1 : Number(s.is_general); %>
                  <tr>
                    <td><%= s.id %></td>
                    <td>
                      <input class="form-control form-control-sm" name="name" form="subject-<%= s.id %>" value="<%= s.name %>" required />
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="group_count" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.group_count === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.group_count === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.group_count === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="default_group" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.default_group === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.default_group === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.default_group === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="show_in_teamwork" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.show_in_teamwork === 1 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.show_in_teamwork === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="visible" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.visible !== 0 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.visible === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="is_required" form="subject-<%= s.id %>" required>
                        <option value="1" <%= requiredFlag === 1 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= requiredFlag === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td class="text-center">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="is_general"
                        form="subject-<%= s.id %>"
                        value="1"
                        <%= generalFlag === 1 ? 'checked' : '' %>
                      />
                    </td>
                    <td class="d-flex gap-2">
                      <form id="subject-<%= s.id %>" method="POST" action="/admin/subjects/edit/<%= s.id %>" data-save-all="true"></form>
                      <button class="btn btn-sm btn-outline-secondary" type="submit" form="subject-<%= s.id %>">Save</button>
                      <button class="btn btn-sm btn-outline-primary subject-clone-btn" type="button" data-subject-id="<%= s.id %>" data-subject-name="<%= s.name %>">Clone</button>
                      <form method="POST" action="/admin/subjects/delete/<%= s.id %>">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                          onclick="return confirm('Delete this subject and its groups?');"
                        >
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-semesters')) { %>
        <div id="admin-semesters">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create semester</h5>
              <form method="POST" action="/admin/semesters/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="title" placeholder="Semester title" required />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" type="date" name="start_date" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <input class="form-control" type="number" name="weeks_count" min="1" max="30" value="15" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="is_active">
                      <option value="1">Active</option>
                      <option value="0" selected>Inactive</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Semesters</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Start date</th>
                      <th>Weeks</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (semesters || []).forEach(function(sem) { %>
                      <tr>
                        <td>
                          <input class="form-control form-control-sm" name="title" form="semester-<%= sem.id %>" value="<%= sem.title %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="date" name="start_date" form="semester-<%= sem.id %>" value="<%= sem.start_date %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="number" min="1" max="30" name="weeks_count" form="semester-<%= sem.id %>" value="<%= sem.weeks_count %>" required />
                        </td>
                        <td>
                          <% if (sem.is_active === 1) { %>
                            <span class="badge text-bg-success">Active</span>
                          <% } else if (sem.is_archived === 1) { %>
                            <span class="badge text-bg-secondary">Archived</span>
                          <% } else { %>
                            <span class="badge text-bg-light text-dark">Inactive</span>
                          <% } %>
                        </td>
                        <td class="d-flex flex-wrap gap-2">
                          <form id="semester-<%= sem.id %>" method="POST" action="/admin/semesters/edit/<%= sem.id %>" data-save-all="true"></form>
                          <button class="btn btn-sm btn-outline-secondary" type="submit" form="semester-<%= sem.id %>">Save</button>
                          <% if (!sem.is_active) { %>
                            <form method="POST" action="/admin/semesters/set-active/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-primary" type="submit">Set active</button>
                            </form>
                          <% } %>
                          <% if (sem.is_archived) { %>
                            <form method="POST" action="/admin/semesters/restore/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-secondary" type="submit">Restore</button>
                            </form>
                          <% } else { %>
                            <form method="POST" action="/admin/semesters/archive/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-warning" type="submit">Archive</button>
                            </form>
                          <% } %>
                          <form method="POST" action="/admin/semesters/delete/<%= sem.id %>">
                            <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this semester?');">Delete</button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(semesters || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">No semesters yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-courses')) { %>
        <div id="admin-courses">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create course</h5>
              <form method="POST" action="/admin/courses/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" type="number" name="id" min="1" placeholder="Course ID (e.g. 3)" required />
                  </div>
                  <div class="col-12 col-md-5">
                    <input class="form-control" name="name" placeholder="Course name (e.g. 3 –∫—É—Ä—Å)" required />
                  </div>
                  <div class="col-12 col-md-2 d-flex align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="is_teacher_course" id="teacherCourseCreate" value="1" />
                      <label class="form-check-label" for="teacherCourseCreate">–ö—É—Ä—Å –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤</label>
                    </div>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Courses</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Teacher</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (courses || []).forEach(function(c) { %>
                      <tr>
                        <td><%= c.id %></td>
                        <td>
                          <input class="form-control form-control-sm" name="name" form="course-<%= c.id %>" value="<%= c.name %>" required />
                        </td>
                        <td>
                          <input
                            class="form-check-input"
                            type="checkbox"
                            name="is_teacher_course"
                            form="course-<%= c.id %>"
                            value="1"
                            <%= c.is_teacher_course ? 'checked' : '' %>
                          />
                        </td>
                        <td class="d-flex gap-2">
                          <form id="course-<%= c.id %>" method="POST" action="/admin/courses/edit/<%= c.id %>" data-save-all="true"></form>
                          <button class="btn btn-sm btn-outline-secondary" type="submit" form="course-<%= c.id %>">Save</button>
                          <button
                            class="btn btn-sm btn-outline-primary study-days-btn"
                            type="button"
                            data-course-id="<%= c.id %>"
                            data-course-name="<%= c.name %>"
                          >
                            –î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è
                          </button>
                          <button
                            class="btn btn-sm btn-outline-primary week-time-btn"
                            type="button"
                            data-course-id="<%= c.id %>"
                            data-course-name="<%= c.name %>"
                          >
                            –ß–∞—Å —Ç–∏–∂–Ω—ñ–≤
                          </button>
                          <form method="POST" action="/admin/courses/delete/<%= c.id %>">
                            <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this course?');">Delete</button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(courses || []).length) { %>
                      <tr>
                        <td colspan="4" class="text-muted"><%= t('admin.noCourses') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-history')) { %>
        <div id="admin-history">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.historyFilters') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_actor" placeholder="<%= t('admin.actor') %>" value="<%= historyFilters && historyFilters.actor || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_action" placeholder="<%= t('admin.action') %>" value="<%= historyFilters && historyFilters.action || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_q" placeholder="<%= t('admin.detailsContains') %>" value="<%= historyFilters && historyFilters.q || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_from" value="<%= historyFilters && historyFilters.from || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_to" value="<%= historyFilters && historyFilters.to || '' %>" />
                  </div>
                  <div class="col-12 col-md-1 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="mt-2">
                <a
                  class="btn btn-outline-secondary btn-sm"
                  href="/admin/history.csv?history_actor=<%= encodeURIComponent(historyFilters && historyFilters.actor || '') %>&history_action=<%= encodeURIComponent(historyFilters && historyFilters.action || '') %>&history_q=<%= encodeURIComponent(historyFilters && historyFilters.q || '') %>&history_from=<%= encodeURIComponent(historyFilters && historyFilters.from || '') %>&history_to=<%= encodeURIComponent(historyFilters && historyFilters.to || '') %>"
                >
                  <%= t('admin.exportHistory') %>
                </a>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th><%= t('admin.actor') %></th>
                  <th><%= t('admin.action') %></th>
                  <th><%= t('admin.details') %></th>
                  <th><%= t('admin.time') %></th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <% (logs || []).forEach(function(log) { %>
                  <tr>
                    <td><%= log.id %></td>
                    <td><%= log.actor_name || '-' %></td>
                    <td><%= log.action %></td>
                    <td><%= log.details || '-' %></td>
                    <td><%= log.created_at %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-activity')) { %>
        <div id="admin-activity">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.activityLog') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.user') %></label>
                    <input class="form-control" name="activity_user" placeholder="<%= t('admin.userName') %>" value="<%= activityFilters && activityFilters.user ? activityFilters.user : '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.action') %></label>
                    <input class="form-control" name="activity_action" placeholder="<%= t('admin.actionPlaceholder') %>" value="<%= activityFilters && activityFilters.action ? activityFilters.action : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input class="form-control" type="date" name="activity_from" value="<%= activityFilters && activityFilters.from ? activityFilters.from : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input class="form-control" type="date" name="activity_to" value="<%= activityFilters && activityFilters.to ? activityFilters.to : '' %>" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h6 class="mb-3"><%= t('admin.topActive') %></h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.points') %></th>
                      <th><%= t('admin.actions') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityTop || []).forEach(function(row, idx) { %>
                      <tr>
                        <td><%= idx + 1 %></td>
                        <td><%= row.user_name || '-' %></td>
                        <td><%= row.points || 0 %></td>
                        <td><%= row.actions_count || 0 %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityTop || []).length) { %>
                      <tr>
                        <td colspan="4" class="text-muted"><%= t('admin.noActivity') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.action') %></th>
                      <th><%= t('admin.target') %></th>
                      <th><%= t('admin.details') %></th>
                      <th><%= t('admin.created') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityLogs || []).forEach(function(a) { %>
                      <tr>
                        <td><%= a.id %></td>
                        <td><%= a.user_name || '-' %></td>
                        <td><%= a.action_type %></td>
                        <td><%= a.target_type || '-' %> <%= a.target_id ? '#' + a.target_id : '' %></td>
                        <td><%= a.details || '-' %></td>
                        <td><%= a.created_at %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityLogs || []).length) { %>
                      <tr>
                        <td colspan="6" class="text-muted"><%= t('admin.noActivityLog') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <% if (sectionAllowed('admin-teamwork')) { %>
        <div id="admin-teamwork">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.teamworkTasks') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <input
                      class="form-control"
                      name="teamwork_subject"
                      placeholder="<%= t('admin.subjectPlaceholder') %>"
                      value="<%= (filters && filters.teamwork_subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_from"
                      value="<%= (filters && filters.teamwork_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_to"
                      value="<%= (filters && filters.teamwork_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.subject') %></th>
                      <th><%= t('admin.titleLabel') %></th>
                      <th><%= t('admin.groups') %></th>
                      <th><%= t('admin.members') %></th>
                      <th><%= t('admin.created') %></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (teamworkTasks || []).forEach(function(task) { %>
                      <tr>
                        <td><%= task.id %></td>
                        <td><%= task.subject_name %></td>
                        <td><%= task.title %></td>
                        <td><%= task.group_count %></td>
                        <td><%= task.member_count %></td>
                        <td><%= task.created_at %></td>
                        <td>
                          <form method="POST" action="/admin/teamwork/delete/<%= task.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              onclick="return confirm('Delete this teamwork task?');"
                            >
                              <%= t('admin.delete') %>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(teamworkTasks || []).length) { %>
                      <tr>
                        <td colspan="7" class="text-muted"><%= t('admin.noTeamwork') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <% } %>

        <% if (sectionAllowed('admin-messages')) { %>
        <div id="admin-messages">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.sendMessage') %></h5>
              <form method="POST" action="/admin/messages/send">
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <textarea class="form-control" name="body" rows="3" placeholder="<%= t('admin.messagePlaceholder') %>" required></textarea>
                  </div>
                </div>
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.target') %></label>
                    <select class="form-select" name="target_type" id="messageTargetType">
                      <option value="all"><%= t('admin.targetAll') %></option>
                      <option value="subject"><%= t('admin.targetSubjectGroup') %></option>
                      <option value="users"><%= t('admin.targetUsers') %></option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <select class="form-select" name="subject_id" id="messageSubjectSelect">
                      <option value="" disabled selected><%= t('admin.selectSubject') %></option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>"><%= s.name %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.group') %></label>
                    <input class="form-control" type="number" min="1" max="3" name="group_number" id="messageGroupInput" placeholder="1-3" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit"><%= t('admin.send') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status" id="messageStatusSelect">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label">Publish at</label>
                    <input class="form-control" type="datetime-local" name="scheduled_at" id="messageScheduledAt" />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12">
                    <label class="form-label">Specific users</label>
                    <select class="form-select" name="user_ids" id="messageUsersSelect" multiple size="5">
                      <% (users || []).filter(u => u.role === 'student').forEach(function(u) { %>
                        <option value="<%= u.id %>"><%= u.full_name %></option>
                      <% }); %>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Existing messages</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Body</th>
                      <th>Target</th>
                      <th>Created</th>
                      <th>Status</th>
                      <th>Schedule</th>
                      <th>Reads</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (adminMessages || []).forEach(function(m) { %>
                      <tr>
                        <td><%= m.id %></td>
                        <td><%= m.body %></td>
                        <td>
                          <% if (m.target_all === 1) { %>
                            All students
                          <% } else if (m.subject_name) { %>
                            <%= m.subject_name %> ¬∑ Group <%= m.group_number %>
                          <% } else { %>
                            Users
                          <% } %>
                        </td>
                        <td><%= m.created_at %></td>
                        <td>
                          <span class="badge <%= m.status === 'draft' ? 'bg-secondary' : (m.status === 'scheduled' ? 'bg-warning text-dark' : 'bg-success') %>">
                            <%= m.status || 'published' %>
                          </span>
                        </td>
                        <td><%= m.scheduled_at || '‚Äî' %></td>
                        <td>
                          <% if (typeof m.target_count !== 'undefined' && m.target_count > 0) { %>
                            <button class="btn btn-sm btn-outline-primary message-reads-btn" type="button" data-message-id="<%= m.id %>">
                              <%= m.read_count || 0 %>/<%= m.target_count %>
                            </button>
                          <% } else { %>
                            <span class="text-muted">‚Äî</span>
                          <% } %>
                        </td>
                        <td>
                          <form method="POST" action="/admin/messages/delete/<%= m.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              onclick="return confirm('Delete this message?');"
                            >
                              Delete
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(adminMessages || []).length) { %>
                      <tr>
                        <td colspan="8" class="text-muted">No messages yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </main>
    <footer class="app-footer text-center py-4">
      <small>
        ¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %> ¬∑
        <button
          type="button"
          class="btn btn-link btn-sm p-0 align-baseline"
          data-bs-toggle="modal"
          data-bs-target="#changelogModal"
        >
          Changelog
        </button>
      </small>
    </footer>
    <% if (!isLimitedView) { %>
      <button class="btn btn-primary save-all-btn" type="button">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å–µ</button>
    <% } %>

    <%- include('partials/changelog-modal') %>
    <div class="modal fade" id="userActionsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userActionsTitle">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><strong>Name:</strong> <span id="uaName"></span></div>
            <div class="mb-2"><strong>Role:</strong> <span id="uaRole"></span></div>
            <div class="mb-2"><strong>Active:</strong> <span id="uaActive"></span></div>
            <div class="mb-2"><strong>Schedule Group:</strong> <span id="uaGroup"></span></div>
            <div class="mb-2"><strong>Course:</strong> <span id="uaCourse"></span></div>
            <div class="mb-2"><strong>Last Login IP:</strong> <span id="uaIp"></span></div>
            <div class="mb-2"><strong>Device:</strong> <span id="uaAgent"></span></div>
            <div class="mb-3"><strong>Last Login:</strong> <span id="uaLoginAt"></span></div>
            <div class="mb-3">
              <strong>Login History:</strong>
              <ul id="uaLoginHistory" class="list-group list-group-flush mt-2"></ul>
            </div>

            <form method="POST" action="/admin/users/role" class="mb-3">
              <input type="hidden" name="user_id" id="uaRoleUserId" />
              <label class="form-label">Change role</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="role" id="uaRoleSelect" required>
                  <option value="student">student</option>
                  <option value="starosta">starosta</option>
                  <option value="deanery">deanery</option>
                  <option value="teacher">teacher</option>
                  <option value="admin">admin</option>
                </select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/course" class="mb-3">
              <input type="hidden" name="user_id" id="uaCourseUserId" />
              <label class="form-label">Change course</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="course_id" id="uaCourseSelect" required>
                  <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/reset-password" class="mb-3">
              <input type="hidden" name="user_id" id="uaPassUserId" />
              <label class="form-label">Reset password</label>
              <div class="d-flex gap-2">
                <input class="form-control" name="new_password" placeholder="New password" required />
                <button class="btn btn-outline-secondary glass" type="submit">Set</button>
              </div>
            </form>

            <button class="btn btn-outline-danger glass" type="button" id="uaDeleteBtn">Deactivate user</button>
            <button class="btn btn-outline-success glass ms-2" type="button" id="uaActivateBtn">Restore user</button>
            <form method="POST" action="/admin/users/delete-permanent" class="mt-3" id="uaDeletePermanentForm">
              <input type="hidden" name="user_id" id="uaDeleteUserId" />
              <button
                class="btn btn-outline-danger glass w-100"
                type="submit"
                onclick="return confirm('Permanently delete this user? This cannot be undone.');"
              >
                Delete permanently
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="subjectGroupsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="subjectGroupsTitle">Subject groups</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="subjectGroupsList" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="messageReadsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Read receipts</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2 text-muted" id="messageReadsSummary">Loading‚Ä¶</div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <h6 class="mb-2">Read</h6>
                <div id="messageReadsList" class="list-group"></div>
              </div>
              <div class="col-12 col-md-6">
                <h6 class="mb-2">Unread</h6>
                <div id="messageUnreadList" class="list-group"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="studyDaysModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="studyDaysTitle">–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="studyDaysBody" class="d-grid gap-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="weekTimeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="weekTimeTitle">–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="week-time-hint mb-3">
              –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî –∑–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å. –£–≤—ñ–º–∫–Ω—ñ—Ç—å –ª–æ–∫–∞–ª—å–Ω–∏–π, —â–æ–± –ø–∞—Ä–∏ –ø–æ–∫–∞–∑—É–≤–∞–ª–∏—Å—å –∑–∞ —á–∞—Å–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
            </div>
            <div id="weekTimeBody" class="d-grid gap-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="scheduleValidateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–∫–ª–∞–¥—É</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex flex-wrap align-items-end gap-2 mb-3">
              <div>
                <label class="form-label mb-1">–¢–∏–∂–¥–µ–Ω—å (–æ–ø—Ü.)</label>
                <input class="form-control form-control-sm" type="number" min="1" max="15" id="validateWeekInput" placeholder="–ù–∞–ø—Ä. 3" />
              </div>
              <button class="btn btn-sm btn-outline-primary mt-3" type="button" id="runValidateBtn">–ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
              <div class="ms-auto text-muted">
                Errors: <span id="validateErrors">0</span> ¬∑ Warnings: <span id="validateWarnings">0</span>
              </div>
            </div>
            <div id="validateIssues" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="subjectCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone subject</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="cloneSubjectId" />
            <div class="mb-3">
              <label class="form-label">New name</label>
              <input class="form-control" id="cloneSubjectName" />
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cloneSubjectSettings" checked />
              <label class="form-check-label" for="cloneSubjectSettings">Copy settings</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneSubjectSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="scheduleCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone week</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Source week</label>
                <input class="form-control" type="number" min="1" max="15" id="cloneWeekSource" />
              </div>
              <div class="col-6">
                <label class="form-label">Target week</label>
                <input class="form-control" type="number" min="1" max="15" id="cloneWeekTarget" />
              </div>
              <div class="col-12">
                <select class="form-select" id="cloneWeekMode">
                  <option value="skip_conflicts">Skip conflicts</option>
                  <option value="overwrite">Overwrite</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneWeekSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="homeworkCloneModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Clone homework</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="cloneHomeworkId" />
            <div class="row g-2">
              <div class="col-12">
                <select class="form-select" id="cloneHomeworkTargetType">
                  <option value="week">Target week</option>
                  <option value="date">Class date</option>
                  <option value="deadline">Deadline</option>
                </select>
              </div>
              <div class="col-12">
                <input class="form-control" id="cloneHomeworkTargetValue" />
              </div>
              <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" id="cloneHomeworkAttachments" checked />
                <label class="form-check-label" for="cloneHomeworkAttachments">Copy attachments</label>
              </div>
              <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" id="cloneHomeworkLinks" checked />
                <label class="form-check-label" for="cloneHomeworkLinks">Copy links</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary glass" id="cloneHomeworkSubmit">Clone</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
      document.querySelectorAll('.schedule-spoiler').forEach((spoiler) => {
        const summary = spoiler.querySelector('summary');
        if (!summary) return;
        const base = '–ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ –ø–∞—Ä–∏';
        const open = '–°—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –ø–∞—Ä–∏';
        const update = () => {
          summary.textContent = spoiler.open ? open : base;
        };
        update();
        summary.addEventListener('click', () => {
          requestAnimationFrame(update);
        });
      });
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      function showCustomTooltip(el, message) {
        document.querySelectorAll('.custom-tooltip').forEach((t) => t.remove());
        const anchor = el.closest('.form-check') || el.closest('.input-group') || el;
        const key = el.id || el.name || anchor.id || '';
        const tip = document.createElement('div');
        tip.className = 'custom-tooltip';
        tip.textContent = message || '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ–ª–µ';
        if (key) tip.dataset.for = key;
        document.body.appendChild(tip);

        const rect = anchor.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        const margin = 10;
        let top = rect.bottom + margin;
        let left = rect.left;
        let placeBelow = true;
        if (top + tipRect.height > window.innerHeight - 8) {
          top = rect.top - tipRect.height - margin;
          placeBelow = false;
        }
        if (left + tipRect.width > window.innerWidth - 8) {
          left = window.innerWidth - tipRect.width - 8;
        }
        if (left < 8) left = 8;
        tip.style.top = `${Math.round(top)}px`;
        tip.style.left = `${Math.round(left)}px`;
        if (placeBelow) tip.classList.add('below');
        requestAnimationFrame(() => tip.classList.add('show'));
        const remove = () => tip.remove();
        tip.addEventListener('click', remove);
        setTimeout(remove, 3500);
      }

      function attachValidationTooltips(root = document) {
        root.querySelectorAll('input, select, textarea').forEach((el) => {
          el.addEventListener('invalid', (event) => {
            event.preventDefault();
            showCustomTooltip(el, el.validationMessage);
          });
          el.addEventListener('input', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
          el.addEventListener('blur', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
        });
      }

      attachValidationTooltips();

      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      const labelLight = themeToggle.dataset.lightLabel || 'Light';
      const labelDark = themeToggle.dataset.darkLabel || 'Dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      themeToggle.textContent = savedTheme === 'theme-dark' ? labelLight : labelDark;
      themeToggle.addEventListener('click', () => {
        const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add(next);
        localStorage.setItem('ui-theme', next);
        themeToggle.textContent = next === 'theme-dark' ? labelLight : labelDark;
      });

      document.querySelectorAll('.file-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.fileTarget;
          const input = target ? document.getElementById(target) : null;
          if (input) input.click();
        });
      });
      document.querySelectorAll('.file-input').forEach((input) => {
        input.addEventListener('change', () => {
          const label = document.querySelector(`[data-file-name="${input.id}"]`);
          if (!label) return;
          const name = input.files && input.files.length ? input.files[0].name : '–§–∞–π–ª –Ω–µ –≤–∏–±—Ä–∞–Ω–æ';
          label.textContent = name;
        });
      });

      window.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;
        const instance = bootstrap.Modal.getInstance(openModal);
        if (instance) instance.hide();
      });

      const limitedStaffView = <%= isLimitedView ? 'true' : 'false' %>;
      const allowedSectionsRaw = <%- JSON.stringify(allowedSectionsList || []) %>;
      const allowedSections = Array.isArray(allowedSectionsRaw)
        ? allowedSectionsRaw
        : typeof allowedSectionsRaw === 'string'
          ? allowedSectionsRaw.split(',').map((s) => s.trim()).filter(Boolean)
          : [];
      const adminSections = allowedSections.length
        ? allowedSections
        : Array.from(document.querySelectorAll('.tab-content > [id^="admin-"]')).map((el) => el.id);

      function toggleSection(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        localStorage.setItem(`admin:${id}`, el.style.display);
      }

      function toggleAllSections() {
        const allHidden = adminSections.every((id) => {
          const el = document.getElementById(id);
          return el && el.style.display === 'none';
        });
        adminSections.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = allHidden ? 'block' : 'none';
          localStorage.setItem(`admin:${id}`, el.style.display);
        });
      }

      window.addEventListener('load', () => {
        adminSections.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          const saved = localStorage.getItem(`admin:${id}`);
          if (saved === 'none') {
            el.style.display = 'none';
          }
        });
      });

      const selectAll = document.getElementById('selectAllSchedule');
      if (selectAll) {
        selectAll.addEventListener('change', () => {
          document
            .querySelectorAll('input[name="delete_ids"]')
            .forEach((cb) => (cb.checked = selectAll.checked));
        });
      }

      const selectAllUsers = document.getElementById('selectAllUsers');
      if (selectAllUsers) {
        selectAllUsers.addEventListener('change', () => {
          document
            .querySelectorAll('input[name=\"delete_user_ids\"]')
            .forEach((cb) => (cb.checked = selectAllUsers.checked));
        });
      }

      function renderUsersTable(data) {
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        const currentUserId = tbody.dataset.currentUserId;
        const status = tbody.dataset.status || 'active';
        const subjectMap = new Map();
        data.subjects.forEach((s) => subjectMap.set(String(s.id), s));
        const courseMap = new Map();
        (data.courses || []).forEach((c) => courseMap.set(String(c.id), c.name));
        const groupMap = {};
        data.studentGroups.forEach((g) => {
          if (!groupMap[g.student_id]) groupMap[g.student_id] = {};
          groupMap[g.student_id][g.subject_id] = g.group_number;
        });

        tbody.innerHTML = data.users
          .map((u) => {
            const isActive = typeof u.is_active === 'undefined' ? 1 : u.is_active;
            const checkbox = u.role !== 'admin'
              ? `<input type="checkbox" name="delete_user_ids" value="${u.id}" form="deleteUsersForm" />`
              : '';
            const subjectList = groupMap[u.id]
              ? Object.keys(groupMap[u.id]).map((sid) => {
                  const subj = subjectMap.get(String(sid));
                  if (!subj) return null;
                  return { subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][sid] };
                }).filter(Boolean)
              : [];
            const subjectsBtn = `
              <button
                class="btn btn-sm btn-outline-primary subject-groups-btn"
                type="button"
                data-user-id="${u.id}"
                data-user-name="${u.full_name}"
                data-subjects='${JSON.stringify(subjectList).replace(/'/g, '&#39;')}'
              >
                Subjects (${subjectList.length})
              </button>
            `;

            const subjectOptions = data.subjects
              .map((s) => `<option value="${s.id}">${s.name} (1‚Äì${s.group_count})</option>`)
              .join('');

            const roleEditor =
              String(u.id) === String(currentUserId)
                ? '<span class="text-muted">‚Äî</span>'
                : `
                  <form method="POST" action="/admin/users/role" class="d-flex gap-2">
                    <input type="hidden" name="user_id" value="${u.id}" />
                    <select class="form-select form-select-sm" name="role" required>
                      <option value="student" ${u.role === 'student' ? 'selected' : ''}>student</option>
                      <option value="starosta" ${u.role === 'starosta' ? 'selected' : ''}>starosta</option>
                      <option value="deanery" ${u.role === 'deanery' ? 'selected' : ''}>deanery</option>
                      <option value="teacher" ${u.role === 'teacher' ? 'selected' : ''}>teacher</option>
                      <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                  </form>
                `;

            return `
              <tr class="user-row"
                  data-user-id="${u.id}"
                  data-user-name="${u.full_name}"
                  data-user-role="${u.role}"
                  data-user-group="${u.schedule_group}"
                  data-user-course="${courseMap.get(String(u.course_id)) || `Course ${u.course_id || 1}`}"
                  data-user-course-id="${u.course_id || 1}"
                  data-user-active="${isActive}"
                  data-user-ip="${u.last_login_ip || ''}"
                  data-user-agent="${(u.last_user_agent || '').replace(/\"/g, '&quot;')}"
                  data-user-login="${u.last_login_at || ''}">
                <td>${checkbox}</td>
                <td>${u.full_name}</td>
                <td><span class="badge text-bg-${u.role === 'admin' ? 'primary' : (u.role === 'starosta' ? 'warning' : (u.role === 'deanery' ? 'info' : 'secondary'))}">${u.role}</span></td>
                <td>${courseMap.get(String(u.course_id)) || `Course ${u.course_id || 1}`}</td>
                <td>${u.schedule_group}</td>
                <td>${subjectsBtn}</td>
                <td>
                  <form method="POST" action="/admin/student-groups/set" class="row g-2">
                    <input type="hidden" name="student_id" value="${u.id}" />
                    <div class="col-12 col-md-6">
                      <select class="form-select form-select-sm" name="subject_id" required>
                        <option value="" disabled selected>Subject</option>
                        ${subjectOptions}
                      </select>
                    </div>
                    <div class="col-12 col-md-3">
                      <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                    </div>
                    <div class="col-12 col-md-3 d-grid">
                      <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                    </div>
                  </form>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary user-manage-btn" type="button">Manage</button>
                  ${u.role !== 'admin' && isActive === 0 ? `
                    <form method="POST" action="/admin/users/delete-permanent" class="d-inline">
                      <input type="hidden" name="user_id" value="${u.id}">
                      <button class="btn btn-sm btn-outline-danger ms-2" type="submit"
                        onclick="return confirm('Permanently delete this user? This cannot be undone.');">
                        Delete permanently
                      </button>
                    </form>
                  ` : ''}
                </td>
              </tr>
            `;
          })
          .join('');
      }

      async function refreshUsers() {
        try {
          const tbodyEl = document.getElementById('usersTableBody');
          if (!tbodyEl) return;
          const status = tbodyEl.dataset.status || 'active';
          const courseId = tbodyEl.dataset.courseId || '1';
          const q = tbodyEl.dataset.search || '';
          const group = tbodyEl.dataset.group || '';
          const res = await fetch(
            `/admin/users.json?status=${encodeURIComponent(status)}&course=${encodeURIComponent(courseId)}&q=${encodeURIComponent(
              q
            )}&group=${encodeURIComponent(group)}`
          );
          if (!res.ok) return;
          const data = await res.json();
          const roleFilter = tbodyEl.dataset.roleFilter || 'all';
          const filtered = roleFilter === 'all'
            ? data
            : { ...data, users: data.users.filter((u) => u.role === roleFilter) };
          renderUsersTable(filtered);
          bindUserRowClicks();
          bindSubjectButtons();
        } catch (err) {
          return;
        }
      }

      function connectUserSocket() {
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${location.host}`);
        socket.addEventListener('message', (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'users_updated') {
              refreshUsers();
            }
            if (msg.type === 'history_updated') {
              refreshHistory();
            }
          } catch (e) {
            return;
          }
        });
        socket.addEventListener('close', () => {
          setTimeout(connectUserSocket, 3000);
        });
      }

      if (document.getElementById('usersTableBody')) {
        connectUserSocket();
      }

      const historyForm = document.querySelector('#admin-history form');
      if (historyForm) {
        historyForm.addEventListener('submit', () => {
          setTimeout(refreshHistory, 0);
        });
      }

      async function refreshHistory() {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;
        try {
          const params = new URLSearchParams(new FormData(document.querySelector('#admin-history form'))).toString();
          const res = await fetch(`/admin/history.json?${params}`);
          if (!res.ok) return;
          const data = await res.json();
          tbody.innerHTML = data.logs
            .map(
              (log) => `
                <tr>
                  <td>${log.id}</td>
                  <td>${log.actor_name || '-'}</td>
                  <td>${log.action}</td>
                  <td>${log.details || '-'}</td>
                  <td>${log.created_at}</td>
                </tr>
              `
            )
            .join('');
        } catch (err) {
          return;
        }
      }

      function bindUserRowClicks() {
        document.querySelectorAll('.user-row').forEach((row) => {
          row.addEventListener('click', (e) => {
            const tag = e.target.tagName.toLowerCase();
            const isManage = e.target.classList.contains('user-manage-btn');
            if (['input', 'select', 'button', 'a', 'form', 'label'].includes(tag) && !isManage) return;
            const userId = row.dataset.userId;
            const userName = row.dataset.userName;
            const userRole = row.dataset.userRole;
            const userGroup = row.dataset.userGroup;
            const userActive = row.dataset.userActive === '1' ? 'Yes' : 'No';
            const userCourse = row.dataset.userCourse || '';
            const userIp = row.dataset.userIp || '-';
            const userAgent = row.dataset.userAgent || '-';
            const userLogin = row.dataset.userLogin || '-';

            document.getElementById('uaName').textContent = userName;
            document.getElementById('uaRole').textContent = userRole;
            document.getElementById('uaGroup').textContent = userGroup;
            document.getElementById('uaActive').textContent = userActive;
            document.getElementById('uaCourse').textContent = userCourse;
            document.getElementById('uaIp').textContent = userIp;
            document.getElementById('uaAgent').textContent = userAgent;
            document.getElementById('uaLoginAt').textContent = userLogin;
            document.getElementById('uaRoleUserId').value = userId;
            document.getElementById('uaPassUserId').value = userId;
            document.getElementById('uaRoleSelect').value = userRole;
            document.getElementById('uaDeleteUserId').value = userId;
            document.getElementById('uaCourseUserId').value = userId;
            if (document.getElementById('uaCourseSelect')) {
              document.getElementById('uaCourseSelect').value = row.dataset.userCourseId || '';
            }

            const modal = new bootstrap.Modal(document.getElementById('userActionsModal'));
            modal.show();

            const deleteBtn = document.getElementById('uaDeleteBtn');
            deleteBtn.onclick = async () => {
              if (!confirm('Deactivate this user?')) return;
              const res = await fetch('/admin/users/deactivate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const activateBtn = document.getElementById('uaActivateBtn');
            activateBtn.onclick = async () => {
              const res = await fetch('/admin/users/activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const permForm = document.getElementById('uaDeletePermanentForm');
            if (permForm) {
              permForm.style.display = userActive === 'Yes' ? 'none' : 'block';
            }

            const historyList = document.getElementById('uaLoginHistory');
            historyList.innerHTML = '<li class="list-group-item text-muted">Loading‚Ä¶</li>';
            fetch(`/admin/user-logins.json?user_id=${encodeURIComponent(userId)}`)
              .then((resp) => resp.json())
              .then((data) => {
                if (!data.logins || !data.logins.length) {
                  historyList.innerHTML = '<li class="list-group-item text-muted">No logins yet</li>';
                  return;
                }
                historyList.innerHTML = data.logins
                  .map(
                    (l) =>
                      `<li class="list-group-item">${l.created_at} ‚Äî ${l.ip || '-'} ‚Äî ${l.user_agent || '-'}</li>`
                  )
                  .join('');
              })
              .catch(() => {
                historyList.innerHTML = '<li class="list-group-item text-muted">Failed to load</li>';
              });
          });
        });
        document.querySelectorAll('.user-row select, .user-row input, .user-row button').forEach((el) => {
          el.addEventListener('click', (e) => e.stopPropagation());
        });
      }

      function bindSubjectButtons() {
        document.querySelectorAll('.subject-groups-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            const raw = btn.dataset.subjects || '[]';
            let items = [];
            try {
              items = JSON.parse(raw);
            } catch (e) {
              items = [];
            }
            document.getElementById('subjectGroupsTitle').textContent = `Subjects for ${userName}`;
            const list = document.getElementById('subjectGroupsList');
            list.innerHTML = '';
            if (!items.length) {
              list.innerHTML = '<div class="text-muted">No subjects assigned.</div>';
            } else {
              items.forEach((item) => {
                const row = document.createElement('div');
                row.className = 'list-group-item d-flex justify-content-between align-items-center';
                row.innerHTML = `
                  <div>${item.name} ‚Äî Group ${item.group_number}</div>
                  <form method="POST" action="/admin/group/remove" class="ms-2">
                    <input type="hidden" name="student_id" value="${userId}">
                    <input type="hidden" name="subject_id" value="${item.subject_id}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                  </form>
                `;
                list.appendChild(row);
              });
            }
            const modal = new bootstrap.Modal(document.getElementById('subjectGroupsModal'));
            modal.show();
          });
        });
      }

      document.querySelectorAll('[data-status]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const status = btn.dataset.status;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.status = status;
          refreshUsers();
        });
      });

      document.querySelectorAll('[data-role-filter]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const roleFilter = btn.dataset.roleFilter;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.roleFilter = roleFilter;
          refreshUsers();
        });
      });

      function updateMessageTargetFields() {
        const type = document.getElementById('messageTargetType');
        const subject = document.getElementById('messageSubjectSelect');
        const group = document.getElementById('messageGroupInput');
        const users = document.getElementById('messageUsersSelect');
        if (!type || !subject || !group || !users) return;
        if (type.value === 'subject') {
          subject.disabled = false;
          group.disabled = false;
          users.disabled = true;
        } else if (type.value === 'users') {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = false;
        } else {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = true;
        }
      }

      function updateMessageScheduleFields() {
        const status = document.getElementById('messageStatusSelect');
        const schedule = document.getElementById('messageScheduledAt');
        if (!status || !schedule) return;
        const isScheduled = status.value === 'scheduled';
        schedule.disabled = !isScheduled;
        schedule.required = isScheduled;
        if (!isScheduled) {
          schedule.value = '';
        }
      }

      const messageTarget = document.getElementById('messageTargetType');
      if (messageTarget) {
        messageTarget.addEventListener('change', updateMessageTargetFields);
        updateMessageTargetFields();
      }

      const messageStatus = document.getElementById('messageStatusSelect');
      if (messageStatus) {
        messageStatus.addEventListener('change', updateMessageScheduleFields);
        updateMessageScheduleFields();
      }

      const messageReadsModal = document.getElementById('messageReadsModal');
      const messageReadsSummary = document.getElementById('messageReadsSummary');
      const messageReadsList = document.getElementById('messageReadsList');
      const messageUnreadList = document.getElementById('messageUnreadList');

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function renderReadRows(list, target) {
        if (!target) return;
        if (!list.length) {
          target.innerHTML = '<div class="list-group-item text-muted">Empty</div>';
          return;
        }
        target.innerHTML = list
          .map((row) => {
            const meta = row.read_at ? ` ¬∑ ${escapeHtml(row.read_at)}` : '';
            return `<div class="list-group-item">${escapeHtml(row.full_name)}${meta}</div>`;
          })
          .join('');
      }

      function renderUnreadRows(list, target) {
        if (!target) return;
        if (!list.length) {
          target.innerHTML = '<div class="list-group-item text-muted">Empty</div>';
          return;
        }
        target.innerHTML = list
          .map((row) => `<div class="list-group-item">${escapeHtml(row.full_name)}</div>`)
          .join('');
      }

      document.querySelectorAll('.message-reads-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const messageId = btn.dataset.messageId;
          if (!messageId || !messageReadsModal) return;
          if (messageReadsSummary) messageReadsSummary.textContent = 'Loading‚Ä¶';
          if (messageReadsList) messageReadsList.innerHTML = '';
          if (messageUnreadList) messageUnreadList.innerHTML = '';
          const modal = new bootstrap.Modal(messageReadsModal);
          modal.show();
          try {
            const params = new URLSearchParams(window.location.search);
            const courseParam = params.get('course');
            const url = courseParam
              ? `/admin/api/messages/${encodeURIComponent(messageId)}/reads?course=${encodeURIComponent(courseParam)}`
              : `/admin/api/messages/${encodeURIComponent(messageId)}/reads`;
            const res = await fetch(url);
            if (!res.ok) throw new Error('bad');
            const data = await res.json();
            if (messageReadsSummary) {
              messageReadsSummary.textContent = `Read ${data.read_count || 0} of ${data.target_count || 0}`;
            }
            renderReadRows(data.reads || [], messageReadsList);
            renderUnreadRows(data.unread || [], messageUnreadList);
          } catch (err) {
            if (messageReadsSummary) messageReadsSummary.textContent = 'Failed to load';
          }
        });
      });

      bindUserRowClicks();
      bindSubjectButtons();

      function getTrackableInputs(form) {
        const byId = Array.from(document.querySelectorAll(`[form="${form.id}"]`));
        const inside = Array.from(form.querySelectorAll('input, select, textarea'));
        return [...new Set([...byId, ...inside])];
      }

      function initInputTracking() {
        document.querySelectorAll('input, select, textarea').forEach((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.dataset.initialChecked = el.checked ? '1' : '0';
          } else {
            el.dataset.initialValue = el.value;
          }
        });
      }

      function formHasChanges(form) {
        const inputs = getTrackableInputs(form);
        return inputs.some((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            return (el.dataset.initialChecked === '1') !== el.checked;
          }
          return (el.dataset.initialValue ?? '') !== el.value;
        });
      }

      function buildFormBody(form) {
        const params = new URLSearchParams();
        getTrackableInputs(form).forEach((el) => {
          if (!el.name) return;
          if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
          params.append(el.name, el.value);
        });
        return params;
      }

      function formIsVisible(form) {
        const section = form.closest('[id^="admin-"]');
        if (!section) return true;
        return section.offsetParent !== null;
      }

      async function saveAllForms() {
        const forms = Array.from(document.querySelectorAll('form[data-save-all="true"]'))
          .filter(formIsVisible)
          .filter(formHasChanges);
        const button = document.querySelector('.save-all-btn');
        if (!forms.length) {
          alert('–ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
          return;
        }
        if (button) button.disabled = true;
        for (const form of forms) {
          const method = (form.method || 'POST').toUpperCase();
          await fetch(form.action, {
            method,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: buildFormBody(form),
          });
        }
        if (button) button.disabled = false;
        window.location.reload();
      }

      const addSubjectSelect = document.getElementById('addSubjectSelect');
      const addGroupSelect = document.getElementById('addGroupSelect');

      function syncAddGroupSelect() {
        if (!addSubjectSelect || !addGroupSelect) return;
        const selected = addSubjectSelect.options[addSubjectSelect.selectedIndex];
        if (!selected) return;
        const groupCount = Number(selected.dataset.groupCount || 3);
        if (groupCount <= 1) {
          addGroupSelect.value = '1';
          addGroupSelect.classList.add('select-locked');
        } else {
          addGroupSelect.classList.remove('select-locked');
        }
      }

      if (addSubjectSelect && addGroupSelect) {
        addSubjectSelect.addEventListener('change', syncAddGroupSelect);
        syncAddGroupSelect();
      }

      const saveAllBtn = document.querySelector('.save-all-btn');
      if (saveAllBtn) {
        saveAllBtn.addEventListener('click', saveAllForms);
      }

      const homeworkBulkBar = document.getElementById('homeworkBulkBar');
      const homeworkSelectedCount = document.getElementById('homeworkSelectedCount');
      const homeworkBulkAction = document.getElementById('homeworkBulkAction');
      const bulkApplyBtn = document.getElementById('bulkApplyBtn');
      const bulkTags = document.getElementById('bulkTags');
      const bulkDeadline = document.getElementById('bulkDeadline');
      const bulkShift = document.getElementById('bulkShift');
      const bulkWeek = document.getElementById('bulkWeek');
      const selectAllHomework = document.getElementById('selectAllHomework');

      function getSelectedHomeworkIds() {
        return Array.from(document.querySelectorAll('.homework-select:checked')).map((el) => Number(el.value));
      }

      function updateBulkBar() {
        if (!homeworkSelectedCount || !homeworkBulkBar) return;
        const count = getSelectedHomeworkIds().length;
        homeworkSelectedCount.textContent = String(count);
        homeworkBulkBar.classList.toggle('d-none', count === 0);
      }

      function resetBulkInputs() {
        [bulkTags, bulkDeadline, bulkShift, bulkWeek].forEach((el) => {
          if (el) el.classList.add('d-none');
        });
      }

      if (homeworkBulkAction) {
        homeworkBulkAction.addEventListener('change', () => {
          resetBulkInputs();
          const action = homeworkBulkAction.value;
          if (action === 'add_tags' || action === 'remove_tags') bulkTags.classList.remove('d-none');
          if (action === 'set_deadline') bulkDeadline.classList.remove('d-none');
          if (action === 'shift_deadline') bulkShift.classList.remove('d-none');
          if (action === 'move_to_week') bulkWeek.classList.remove('d-none');
        });
      }

      if (selectAllHomework) {
        selectAllHomework.addEventListener('change', () => {
          document.querySelectorAll('.homework-select').forEach((el) => {
            el.checked = selectAllHomework.checked;
          });
          updateBulkBar();
        });
      }

      document.querySelectorAll('.homework-select').forEach((el) => {
        el.addEventListener('change', updateBulkBar);
      });

      if (bulkApplyBtn) {
        bulkApplyBtn.addEventListener('click', async () => {
          const ids = getSelectedHomeworkIds();
          if (!ids.length) return;
          const action = homeworkBulkAction.value;
          if (!action) return;
          const payload = {};
          if (action === 'add_tags' || action === 'remove_tags') {
            payload.tags = (bulkTags.value || '').split(',').map((t) => t.trim()).filter(Boolean);
          }
          if (action === 'set_deadline') payload.deadline = bulkDeadline.value;
          if (action === 'shift_deadline') payload.days = Number(bulkShift.value || 0);
          if (action === 'move_to_week') payload.week = Number(bulkWeek.value || 0);
          if (action === 'delete' && !confirm('Delete selected homework?')) return;

          const res = await fetch('/admin/api/homework/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids, action, payload }),
          });
          if (!res.ok) {
            alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è');
            return;
          }
          if (action === 'export_csv') {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'homework_export.csv';
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            return;
          }
          window.location.reload();
        });
      }

      const validateScheduleBtn = document.getElementById('validateScheduleBtn');
      const scheduleValidateModal = document.getElementById('scheduleValidateModal');
      const runValidateBtn = document.getElementById('runValidateBtn');
      const validateWeekInput = document.getElementById('validateWeekInput');
      const validateIssues = document.getElementById('validateIssues');
      const validateErrors = document.getElementById('validateErrors');
      const validateWarnings = document.getElementById('validateWarnings');

      function renderValidateIssues(issues = []) {
        if (!validateIssues) return;
        if (!issues.length) {
          validateIssues.innerHTML = '<div class="text-muted">–ü—Ä–æ–±–ª–µ–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
          return;
        }
        validateIssues.innerHTML = issues
          .map((issue) => {
            const badge =
              issue.severity === 'error'
                ? '<span class="badge text-bg-danger">error</span>'
                : '<span class="badge text-bg-warning">warning</span>';
            const meta = issue.context
              ? `week ${issue.context.week || '-'} ¬∑ ${issue.context.day_of_week || '-'} ¬∑ #${issue.context.class_number || '-'} ¬∑ –≥—Ä—É–ø–∞ ${issue.context.group || '-'}`
              : '';
            return `
              <div class="list-group-item validate-issue">
                <div>
                  ${badge}
                  <div class="fw-semibold mt-1">${issue.message}</div>
                  <div class="text-muted validate-meta">${meta}</div>
                </div>
                <a class="btn btn-sm btn-outline-primary" href="${issue.fix_url}">–ü–µ—Ä–µ–π—Ç–∏</a>
              </div>
            `;
          })
          .join('');
      }

      async function runScheduleValidation() {
        if (!validateIssues) return;
        validateIssues.innerHTML = '<div class="text-muted">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...</div>';
        const week = validateWeekInput && validateWeekInput.value ? Number(validateWeekInput.value) : null;
        const url = week ? `/admin/api/schedule/validate?week=${week}` : '/admin/api/schedule/validate';
        const res = await fetch(url);
        if (!res.ok) {
          validateIssues.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</div>';
          return;
        }
        const data = await res.json();
        if (validateErrors) validateErrors.textContent = data.summary?.errors ?? 0;
        if (validateWarnings) validateWarnings.textContent = data.summary?.warnings ?? 0;
        renderValidateIssues(data.issues || []);
      }

      if (validateScheduleBtn && scheduleValidateModal) {
        validateScheduleBtn.addEventListener('click', async () => {
          const modal = new bootstrap.Modal(scheduleValidateModal);
          modal.show();
          await runScheduleValidation();
        });
      }
      if (runValidateBtn) {
        runValidateBtn.addEventListener('click', runScheduleValidation);
      }

      const subjectCloneModal = document.getElementById('subjectCloneModal');
      const cloneSubjectId = document.getElementById('cloneSubjectId');
      const cloneSubjectName = document.getElementById('cloneSubjectName');
      const cloneSubjectSettings = document.getElementById('cloneSubjectSettings');
      const cloneSubjectSubmit = document.getElementById('cloneSubjectSubmit');

      document.querySelectorAll('.subject-clone-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!subjectCloneModal) return;
          cloneSubjectId.value = btn.dataset.subjectId;
          cloneSubjectName.value = `${btn.dataset.subjectName} (Copy)`;
          const modal = new bootstrap.Modal(subjectCloneModal);
          modal.show();
        });
      });
      if (cloneSubjectSubmit) {
        cloneSubjectSubmit.addEventListener('click', async () => {
          const res = await fetch(`/admin/api/subjects/${cloneSubjectId.value}/clone`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              new_name: cloneSubjectName.value,
              copy_settings: cloneSubjectSettings.checked,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è');
          window.location.reload();
        });
      }

      const scheduleCloneModal = document.getElementById('scheduleCloneModal');
      const cloneWeekSubmit = document.getElementById('cloneWeekSubmit');
      const cloneWeekSource = document.getElementById('cloneWeekSource');
      const cloneWeekTarget = document.getElementById('cloneWeekTarget');
      const cloneWeekMode = document.getElementById('cloneWeekMode');
      const validateScheduleBtnEl = document.getElementById('validateScheduleBtn');
      if (validateScheduleBtnEl && scheduleCloneModal) {
        const cloneBtn = document.createElement('button');
        cloneBtn.type = 'button';
        cloneBtn.className = 'btn btn-outline-primary btn-sm';
        cloneBtn.textContent = 'Clone week';
        validateScheduleBtnEl.parentElement.insertBefore(cloneBtn, validateScheduleBtnEl);
        cloneBtn.addEventListener('click', () => {
          const modal = new bootstrap.Modal(scheduleCloneModal);
          modal.show();
        });
      }
      if (cloneWeekSubmit) {
        cloneWeekSubmit.addEventListener('click', async () => {
          const res = await fetch('/admin/api/schedule/weeks/clone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              source_week: Number(cloneWeekSource.value || 0),
              target_week: Number(cloneWeekTarget.value || 0),
              mode: cloneWeekMode.value,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ç–∏–∂–Ω—è');
          window.location.reload();
        });
      }

      const homeworkCloneModal = document.getElementById('homeworkCloneModal');
      const cloneHomeworkId = document.getElementById('cloneHomeworkId');
      const cloneHomeworkTargetType = document.getElementById('cloneHomeworkTargetType');
      const cloneHomeworkTargetValue = document.getElementById('cloneHomeworkTargetValue');
      const cloneHomeworkAttachments = document.getElementById('cloneHomeworkAttachments');
      const cloneHomeworkLinks = document.getElementById('cloneHomeworkLinks');
      const cloneHomeworkSubmit = document.getElementById('cloneHomeworkSubmit');

      document.querySelectorAll('.homework-clone-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (!homeworkCloneModal) return;
          cloneHomeworkId.value = btn.dataset.homeworkId;
          cloneHomeworkTargetValue.value = '';
          const modal = new bootstrap.Modal(homeworkCloneModal);
          modal.show();
        });
      });
      if (cloneHomeworkSubmit) {
        cloneHomeworkSubmit.addEventListener('click', async () => {
          const targetType = cloneHomeworkTargetType.value;
          const value = cloneHomeworkTargetValue.value;
          const target = {};
          if (targetType === 'week') target.week = Number(value || 0);
          if (targetType === 'date') target.class_date = value;
          if (targetType === 'deadline') target.deadline = value;
          const res = await fetch(`/admin/api/homework/${cloneHomeworkId.value}/clone`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              target,
              copy_attachments: cloneHomeworkAttachments.checked,
              copy_links: cloneHomeworkLinks.checked,
            }),
          });
          if (!res.ok) return alert('–ü–æ–º–∏–ª–∫–∞ –∫–ª–æ–Ω—É–≤–∞–Ω–Ω—è –î–ó');
          window.location.reload();
        });
      }

      async function refreshScheduleDayOptions(courseId, selectedValue = '') {
        const daySelect = document.querySelector('select[name="day"]');
        if (!daySelect) return;
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) return;
        const data = await res.json();
        const days = (data.days || data).filter((d) => d.is_active);
        const options = ['<option value="">All days</option>'];
        days.forEach((day) => {
          const label = day.label || day.day_name || day.weekday;
          const value = day.day_name || '';
          if (!value) return;
          options.push(
            `<option value="${value}" ${selectedValue === value ? 'selected' : ''}>${label}</option>`
          );
        });
        daySelect.innerHTML = options.join('');
      }

      async function refreshStudyDaySelects(courseId) {
        const selects = Array.from(document.querySelectorAll('select[name="day_of_week"]'));
        if (!selects.length) return;
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) return;
        const data = await res.json();
        const days = (data.days || data).filter((d) => d.is_active);
        const dayOptions = days
          .map((day) => {
            const label = day.label || day.day_name || day.weekday;
            const value = day.day_name || '';
            if (!value) return '';
            return `<option value="${value}">${label}</option>`;
          })
          .filter(Boolean)
          .join('');
        selects.forEach((select) => {
          const current = select.value;
          const hasCurrent = days.some((d) => d.day_name === current);
          const currentOption = hasCurrent || !current
            ? ''
            : `<option value="${current}" selected>${current} (inactive)</option>`;
          const placeholder = select.required ? '<option value="" disabled>Day</option>' : '';
          select.innerHTML = `${placeholder}${currentOption}${dayOptions}`;
          if (hasCurrent) {
            select.value = current;
          }
        });
      }

      refreshScheduleDayOptions(<%= selectedCourseId || 1 %>, '<%= (filters && filters.day) || '' %>');
      refreshStudyDaySelects(<%= selectedCourseId || 1 %>);

      const studyDaysModal = document.getElementById('studyDaysModal');
      const studyDaysBody = document.getElementById('studyDaysBody');
      const studyDaysTitle = document.getElementById('studyDaysTitle');
      const studyDayLabels = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–ù–¥'];
      const weekTimeModal = document.getElementById('weekTimeModal');
      const weekTimeBody = document.getElementById('weekTimeBody');
      const weekTimeTitle = document.getElementById('weekTimeTitle');

      async function loadStudyDays(courseId, courseName) {
        if (!studyDaysBody) return;
        studyDaysBody.innerHTML = '<div class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        const res = await fetch(`/admin/api/courses/${courseId}/study-days`);
        if (!res.ok) {
          studyDaysBody.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
          return;
        }
        const data = await res.json();
            const days = data.days || data;
        const subjects = data.subjects || [];
        if (studyDaysTitle) {
          studyDaysTitle.textContent = courseName ? `–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è ‚Äî ${courseName}` : '–î–Ω—ñ –Ω–∞–≤—á–∞–Ω–Ω—è';
        }
        studyDaysBody.innerHTML = days
          .map((day) => {
            const active = day.is_active;
            const assigned = day.subjects || [];
            const chips = assigned.length
              ? assigned
                  .map(
                    (s) =>
                      `<span class="study-day-chip">${s.name}<button type="button" data-subject-id="${s.id}" data-weekday="${day.weekday}" class="study-day-remove">√ó</button></span>`
                  )
                  .join('')
              : '<span class="text-muted">–ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</span>';
            return `
              <div class="study-day-row" data-weekday="${day.weekday}">
                <div class="study-day-header">
                  <div class="study-day-label">${day.label || studyDayLabels[day.weekday - 1]}</div>
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input study-day-toggle" type="checkbox" ${active ? 'checked' : ''} data-weekday="${day.weekday}">
                  </div>
                </div>
                <div class="study-day-subjects">${chips}</div>
              </div>
            `;
          })
          .join('');

        studyDaysBody.querySelectorAll('.study-day-toggle').forEach((toggle) => {
          toggle.addEventListener('change', async (event) => {
            const weekday = event.target.dataset.weekday;
            await fetch(`/admin/api/courses/${courseId}/study-days/${weekday}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ is_active: event.target.checked }),
            });
            await refreshScheduleDayOptions(courseId, '<%= (filters && filters.day) || '' %>');
            await refreshStudyDaySelects(courseId);
          });
        });

        studyDaysBody.querySelectorAll('.study-day-remove').forEach((btn) => {
          btn.addEventListener('click', async () => {
            const weekday = btn.dataset.weekday;
            const subjectId = btn.dataset.subjectId;
            await fetch(`/admin/api/courses/${courseId}/study-days/${weekday}/subjects/${subjectId}`, {
              method: 'DELETE',
            });
            await loadStudyDays(courseId, courseName);
          });
        });
      }

      async function loadWeekTime(courseId, courseName) {
        if (!weekTimeBody) return;
        weekTimeBody.innerHTML = '<div class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        const res = await fetch(`/admin/api/courses/${courseId}/week-time`);
        if (!res.ok) {
          weekTimeBody.innerHTML = '<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>';
          return;
        }
        const data = await res.json();
        const weeks = data.weeks || [];
        if (weekTimeTitle) {
          weekTimeTitle.textContent = courseName ? `–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤ ‚Äî ${courseName}` : '–ß–∞—Å —Ç–∏–∂–Ω—ñ–≤';
        }
        if (!weeks.length) {
          weekTimeBody.innerHTML = '<div class="text-muted">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–º–µ—Å—Ç—Ä—É</div>';
          return;
        }
        weekTimeBody.innerHTML = weeks
          .map((week) => {
            const isLocal = week.use_local_time;
            const modeLabel = isLocal ? '–õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å' : '–ó–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å';
            return `
              <div class="week-time-row" data-week="${week.week_number}">
                <div class="week-time-meta">
                  <div class="week-time-label">–¢–∏–∂–¥–µ–Ω—å ${week.week_number}</div>
                  <div class="week-time-sub">${modeLabel}</div>
                </div>
                <div class="form-check form-switch m-0">
                  <input class="form-check-input week-time-toggle" type="checkbox" ${isLocal ? 'checked' : ''} data-week="${week.week_number}">
                </div>
              </div>
            `;
          })
          .join('');

        weekTimeBody.querySelectorAll('.week-time-toggle').forEach((toggle) => {
          toggle.addEventListener('change', async (event) => {
            const week = event.target.dataset.week;
            const nextValue = event.target.checked;
            const row = event.target.closest('.week-time-row');
            const label = row ? row.querySelector('.week-time-sub') : null;
            const resUpdate = await fetch(`/admin/api/courses/${courseId}/week-time/${week}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ use_local_time: nextValue }),
            });
            if (!resUpdate.ok) {
              event.target.checked = !nextValue;
              return alert('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è');
            }
            if (label) {
              label.textContent = nextValue ? '–õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å' : '–ó–≤–∏—á–∞–π–Ω–∏–π —á–∞—Å';
            }
          });
        });
      }

      document.querySelectorAll('.study-days-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const courseId = btn.dataset.courseId;
          const courseName = btn.dataset.courseName;
          if (!courseId || !studyDaysModal) return;
          await loadStudyDays(courseId, courseName);
          const modal = new bootstrap.Modal(studyDaysModal);
          modal.show();
        });
      });

      document.querySelectorAll('.week-time-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const courseId = btn.dataset.courseId;
          const courseName = btn.dataset.courseName;
          if (!courseId || !weekTimeModal) return;
          await loadWeekTime(courseId, courseName);
          const modal = new bootstrap.Modal(weekTimeModal);
          modal.show();
        });
      });

      initInputTracking();
    </script>
  </body>
</html>
