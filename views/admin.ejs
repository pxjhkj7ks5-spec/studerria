<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('admin.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --radius: 16px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.08);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.7);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.18), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.18), transparent 60%),
          linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-dark .text-dark {
        color: #f8fafc !important;
      }
      .admin-nav {
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .admin-nav {
        background: rgba(255, 255, 255, 0.8);
        border-bottom-color: rgba(15, 23, 42, 0.08);
      }
      body.theme-dark .admin-nav {
        background: rgba(10, 10, 20, 0.6);
      }
      .card {
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .card {
        background: var(--glass-bg-dark);
        color: #f8fafc;
        border-color: var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .card {
        background: var(--glass-bg-light);
        border-color: var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.7) inset;
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-dark .table {
        color: #f8fafc;
      }
      body.theme-dark .table th,
      body.theme-dark .table td {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.92);
      }
      body.theme-dark h1,
      body.theme-dark h2,
      body.theme-dark h3,
      body.theme-dark h4,
      body.theme-dark h5,
      body.theme-dark h6,
      body.theme-dark .card-title,
      body.theme-dark .navbar-brand {
        color: #f8fafc;
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.9);
      }
      body.theme-dark .form-label,
      body.theme-dark .form-check-label,
      body.theme-dark label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .input-group-text {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
      }
      body.theme-dark .table > :not(caption) > * > * {
        background: transparent;
      }
      body.theme-dark .table-striped > tbody > tr:nth-of-type(odd) > * {
        background: rgba(255, 255, 255, 0.03);
      }
      body.theme-dark .table-striped > tbody > tr:hover > * {
        background: rgba(255, 255, 255, 0.06);
      }
      .form-control,
      .form-select {
        border-radius: 12px;
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 14px;
        color: inherit;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      body.theme-dark .form-control,
      body.theme-dark .form-select {
        background: rgba(255, 255, 255, 0.06);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.18);
        color-scheme: dark;
      }
      body.theme-dark select.form-select[multiple] {
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(248, 250, 252, 0.65);
      }
      body.theme-dark .form-select option {
        background: rgba(15, 23, 42, 0.96);
        color: #f8fafc;
      }
      body.theme-dark .form-select optgroup {
        background: rgba(15, 23, 42, 0.98);
        color: #cbd5f5;
      }
      body.theme-light .form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark .form-select option:checked,
      body.theme-dark .form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light .form-select option:checked,
      body.theme-light .form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      body.theme-dark .text-muted {
        color: rgba(255, 255, 255, 0.65) !important;
      }
      body.theme-dark .list-group-item {
        background: transparent;
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .badge.text-bg-light {
        background: rgba(255, 255, 255, 0.12) !important;
        color: #f8fafc !important;
      }
      body.theme-dark a {
        color: #93c5fd;
      }
      body.theme-dark a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(180deg, var(--accent) 0%, var(--accent-dark) 100%);
        border: none;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary,
      .btn-outline-danger {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      body.theme-dark .btn-outline-primary,
      body.theme-dark .btn-outline-secondary,
      body.theme-dark .btn-outline-danger {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.3);
      }
      body.theme-dark .btn-outline-primary:hover,
      body.theme-dark .btn-outline-secondary:hover,
      body.theme-dark .btn-outline-danger:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .select-locked {
        pointer-events: none;
        opacity: 0.75;
      }
      .flash-alert {
        border-radius: 14px;
        padding: 0.5rem 0.9rem;
        font-size: 0.9rem;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        backdrop-filter: blur(10px);
      }
      body.theme-dark .flash-alert {
        background: rgba(17, 17, 30, 0.7);
        border-color: rgba(255, 255, 255, 0.12);
        color: #f8fafc;
      }
      .flash-alert.alert-danger {
        border-color: rgba(239, 68, 68, 0.45);
        color: #b91c1c;
      }
      body.theme-dark .flash-alert.alert-danger {
        color: #fca5a5;
      }
      .flash-alert.alert-success {
        border-color: rgba(34, 197, 94, 0.45);
        color: #166534;
      }
      body.theme-dark .flash-alert.alert-success {
        color: #86efac;
      }
      .app-footer {
        font-size: 0.8rem;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
      .save-all-btn {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 1200;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
      }
    </style>
  </head>
  <body class="theme-light">
    <% const isLimitedView = typeof limitedStaffView !== 'undefined' && limitedStaffView; %>
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <span class="navbar-brand"><%= isLimitedView ? t('admin.starostaPanel') : t('admin.title') %></span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.user') %>: <%= username %>
            <% } %>
          </span>
          <button
            class="btn btn-outline-secondary btn-sm me-2"
            type="button"
            id="themeToggle"
            data-light-label="<%= t('theme.light') %>"
            data-dark-label="<%= t('theme.dark') %>"
          >
            <%= t('theme.dark') %>
          </button>
          <% if (!isLimitedView) { %>
            <form method="POST" action="/admin/switch-to-student" class="me-2">
              <button class="btn btn-outline-primary btn-sm" type="submit"><%= t('admin.viewAsStudent') %></button>
            </form>
          <% } else { %>
            <a class="btn btn-outline-primary btn-sm me-2" href="/schedule"><%= t('admin.backToSchedule') %></a>
          <% } %>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h1 class="h3 mb-0"><%= t('admin.dashboard') %></h1>
        <a class="btn btn-outline-primary btn-sm" href="/admin/overview?course=<%= selectedCourseId %>"><%= t('admin.openOverview') %></a>
      </div>

      <% const msg = typeof messages !== 'undefined' && messages ? messages : (typeof locals !== 'undefined' ? locals.messages : {}); %>
      <% if (msg && msg.error) { %>
        <div class="alert alert-danger flash-alert"><%= msg.error %></div>
      <% } %>
      <% if (msg && msg.success) { %>
        <div class="alert alert-success flash-alert"><%= msg.success %></div>
      <% } %>

      <% const courseMap = {}; %>
      <% (courses || []).forEach(function(c) { courseMap[c.id] = c.name; }); %>

      <% if (!isLimitedView) { %>
        <form class="mb-3" method="GET" action="/admin">
          <div class="d-flex align-items-center gap-2">
            <label class="form-label mb-0"><%= t('admin.course') %></label>
            <select name="course" class="form-select w-auto" onchange="this.form.submit()">
              <% (courses || []).forEach(function(c) { %>
                <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>>
                  <%= c.name %>
                </option>
              <% }); %>
            </select>
          </div>
        </form>
      <% } else { %>
        <div class="mb-3 text-muted"><%= t('admin.course') %>: <%= courseMap[selectedCourseId] || ('Course ' + selectedCourseId) %></div>
      <% } %>

      <% const groupMap = {}; %>
      <% (studentGroups || []).forEach(function(g) { %>
        <% if (!groupMap[g.student_id]) { groupMap[g.student_id] = {}; } %>
        <% groupMap[g.student_id][g.subject_id] = g.group_number; %>
      <% }); %>

      <div class="d-flex flex-wrap gap-2 mb-3">
        <% if (!isLimitedView) { %>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-settings')">
            <%= t('admin.settings') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-schedule')">
            <%= t('admin.schedule') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-homework')">
            <%= t('admin.homework') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-users')">
            <%= t('admin.users') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-subjects')">
            <%= t('admin.subjects') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-semesters')">
            <%= t('admin.semesters') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-courses')">
            <%= t('admin.courses') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-history')">
            <%= t('admin.history') %>
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-activity')">
            <%= t('admin.activity') %>
          </button>
        <% } %>
        <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-teamwork')">
          <%= t('admin.teamwork') %>
        </button>
        <button class="btn btn-outline-primary btn-sm" type="button" onclick="toggleSection('admin-messages')">
          <%= t('admin.messages') %>
        </button>
        <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleAllSections()">
          <%= t('admin.showHideAll') %>
        </button>
      </div>

      <div class="tab-content">
        <% if (!isLimitedView) { %>
        <div id="admin-settings" class="card mb-3">
          <div class="card-body">
            <h5 class="mb-3"><%= t('admin.settings') %></h5>
            <form method="POST" action="/admin/settings" class="row g-3 align-items-end">
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.sessionDuration') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="session_duration_days"
                  value="<%= (settings && settings.session_duration_days) || 14 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.maxFileSize') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="max_file_size_mb"
                  value="<%= (settings && settings.max_file_size_mb) || 20 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.minTeamMembers') %></label>
                <input
                  type="number"
                  min="1"
                  class="form-control"
                  name="min_team_members"
                  value="<%= (settings && settings.min_team_members) || 2 %>"
                  required
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"><%= t('admin.allowHomework') %></label>
                <select class="form-select" name="allow_homework_creation">
                  <option value="true" <%= (settings && settings.allow_homework_creation) ? 'selected' : '' %>><%= t('admin.enabled') %></option>
                  <option value="false" <%= (settings && settings.allow_homework_creation) ? '' : 'selected' %>><%= t('admin.disabled') %></option>
                </select>
              </div>
              <div class="col-12 col-md-2 d-grid">
                <button class="btn btn-primary" type="submit"><%= t('admin.saveSettings') %></button>
              </div>
            </form>
          </div>
        </div>

        <div id="admin-schedule">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.filters') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="group_number"
                      placeholder="Group number"
                      value="<%= (filters && filters.group_number) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <select class="form-select" name="day">
                      <option value="">All days</option>
                      <% ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(function(d) { %>
                        <option value="<%= d %>" <%= filters && filters.day === d ? 'selected' : '' %>><%= d %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="subject"
                      placeholder="Subject"
                      value="<%= (filters && filters.subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="schedule_date"
                      value="<%= (filters && filters.schedule_date) || '' %>"
                    />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.apply') %></button>
                  </div>
                  <div class="col-12 col-md-3">
                    <select class="form-select" name="sort_schedule">
                      <option value=""><%= t('admin.sortSchedule') %></option>
                      <option value="group" <%= sorts && sorts.schedule === 'group' ? 'selected' : '' %>><%= t('admin.sortGroup') %></option>
                      <option value="day" <%= sorts && sorts.schedule === 'day' ? 'selected' : '' %>><%= t('admin.sortDay') %></option>
                      <option value="time" <%= sorts && sorts.schedule === 'time' ? 'selected' : '' %>><%= t('admin.sortTime') %></option>
                    </select>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-outline-secondary" type="submit"><%= t('admin.applySort') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Add class</h5>
                <a class="btn btn-outline-secondary btn-sm" href="/admin/export/schedule.csv">Export CSV</a>
              </div>
              <form method="POST" action="/admin/schedule/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <select class="form-select" id="addSubjectSelect" name="subject_id" required>
                      <option value="" disabled selected>Subject</option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>" data-group-count="<%= s.group_count %>"><%= s.name %> (1–<%= s.group_count %>)</option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" id="addGroupSelect" name="group_number" required>
                      <option value="" disabled selected>Group #</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="semester_id" required>
                      <option value="" disabled selected>Semester</option>
                      <% (semesters || []).forEach(function(sem) { %>
                        <option value="<%= sem.id %>" <%= activeSemester && sem.id === activeSemester.id ? 'selected' : '' %>>
                          <%= sem.title %>
                        </option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="day_of_week" required>
                      <option value="" disabled selected>Day</option>
                      <% ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(function(d) { %>
                        <option value="<%= d %>"><%= d %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-1">
                    <select class="form-select" name="class_number" required>
                      <option value="" disabled selected>Class #</option>
                      <% [1,2,3,4,5,6,7].forEach(function(n) { %>
                        <option value="<%= n %>"><%= n %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <input
                      class="form-control"
                      name="week_numbers"
                      placeholder="Weeks: 1,2,3"
                      required
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <form method="POST" action="/admin/schedule/delete-multiple">
            <div class="d-flex flex-wrap gap-2 mb-2">
              <button class="btn btn-outline-danger btn-sm" type="submit">Delete Selected</button>
              <button
                class="btn btn-danger btn-sm"
                type="submit"
                form="clearScheduleForm"
                onclick="return confirm('Clear ALL schedule entries?');"
              >
                Clear All
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllSchedule" /></th>
                  <th>ID</th>
                  <th>Subject</th>
                  <th>Group #</th>
                  <th>Day</th>
                  <th>Semester</th>
                  <th>Class #</th>
                  <th>Week</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% schedule.forEach(function(item) { %>
                  <tr>
                    <td>
                      <input type="checkbox" name="delete_ids" value="<%= item.id %>" />
                    </td>
                    <td><%= item.id %></td>
                    <td>
                      <select class="form-select form-select-sm" name="subject_id" form="edit-<%= item.id %>" required>
                        <% (subjects || []).forEach(function(s) { %>
                          <option value="<%= s.id %>" <%= item.subject_id === s.id ? 'selected' : '' %>>
                            <%= s.name %>
                          </option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <input
                        class="form-control form-control-sm"
                        name="group_number"
                        form="edit-<%= item.id %>"
                        value="<%= item.group_number %>"
                        type="number"
                        min="1"
                        max="3"
                        required
                      />
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="day_of_week" form="edit-<%= item.id %>" required>
                        <% ['Monday','Tuesday','Wednesday','Thursday','Friday'].forEach(function(d) { %>
                          <option value="<%= d %>" <%= item.day_of_week === d ? 'selected' : '' %>><%= d %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="semester_id" form="edit-<%= item.id %>" required>
                        <% (semesters || []).forEach(function(sem) { %>
                          <option value="<%= sem.id %>" <%= item.semester_id === sem.id ? 'selected' : '' %>><%= sem.title %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="class_number" form="edit-<%= item.id %>" required>
                        <% [1,2,3,4,5,6,7].forEach(function(n) { %>
                          <option value="<%= n %>" <%= item.class_number === n ? 'selected' : '' %>><%= n %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <input
                        class="form-control form-control-sm"
                        name="week_number"
                        form="edit-<%= item.id %>"
                        value="<%= item.week_number %>"
                        type="number"
                        min="1"
                        max="<%= activeSemester && activeSemester.weeks_count ? activeSemester.weeks_count : 15 %>"
                        required
                      />
                    </td>
                    <td class="d-flex gap-2">
                      <form
                        id="edit-<%= item.id %>"
                        method="POST"
                        action="/admin/schedule/edit/<%= item.id %>"
                        class="d-inline"
                        data-save-all="true"
                      ></form>
                      <button class="btn btn-sm btn-outline-secondary" type="submit" form="edit-<%= item.id %>">
                        Save
                      </button>
                      <form method="POST" action="/admin/schedule/delete/<%= item.id %>" class="d-inline">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                          onclick="return confirm('Delete this class from schedule?');"
                        >
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
              </table>
            </div>
          </form>
          <form id="clearScheduleForm" method="POST" action="/admin/schedule/clear-all"></form>
        </div>

        <div id="admin-homework">
          <div class="card mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0"><%= t('admin.searchHomework') %></h5>
                <form method="POST" action="/admin/homework/migrate">
                  <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.migrateLegacyHomework') %></button>
                </form>
              </div>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="group_number"
                      placeholder="<%= t('admin.groupNumber') %>"
                      value="<%= (filters && filters.group_number) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="subject"
                      placeholder="<%= t('admin.subject') %>"
                      value="<%= (filters && filters.subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-4">
                    <input
                      class="form-control"
                      name="q"
                      placeholder="<%= t('admin.searchDescAuthor') %>"
                      value="<%= (filters && filters.q) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.search') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_from"
                      value="<%= (filters && filters.homework_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      type="date"
                      name="homework_to"
                      value="<%= (filters && filters.homework_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <input
                      class="form-control"
                      name="homework_tag"
                      placeholder="<%= t('admin.tag') %>"
                      list="adminHomeworkTags"
                      value="<%= (filters && filters.homework_tag) || '' %>"
                    />
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12 col-md-4">
                    <select class="form-select" name="sort_homework">
                      <option value=""><%= t('admin.sortHomework') %></option>
                      <option value="created" <%= sorts && sorts.homework === 'created' ? 'selected' : '' %>>
                        <%= t('admin.sortNewest') %>
                      </option>
                      <option value="subject" <%= sorts && sorts.homework === 'subject' ? 'selected' : '' %>>
                        <%= t('admin.sortSubject') %>
                      </option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-secondary" type="submit"><%= t('admin.applySort') %></button>
                  </div>
                </div>
                <datalist id="adminHomeworkTags">
                  <% (homeworkTags || []).forEach(function(tag) { %>
                    <option value="<%= tag %>"></option>
                  <% }); %>
                </datalist>
              </form>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th><%= t('admin.groupNumber') %></th>
                  <th><%= t('admin.classNumber') %></th>
                  <th><%= t('admin.description') %></th>
                  <th><%= t('admin.tag') %></th>
                  <th><%= t('admin.dayClass') %></th>
                  <th><%= t('admin.createdBy') %></th>
                  <th><%= t('admin.attachment') %></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% homework.forEach(function(item) { %>
                  <tr>
                    <td><%= item.id %></td>
                    <td><%= item.group_number %></td>
                    <td><%= item.subject_name || item.subject %> (<%= item.day_of_week || item.day %>)</td>
                    <td><%= item.description %></td>
                    <td>
                      <% if (item.tags && item.tags.length) { %>
                        <%= item.tags.join(', ') %>
                      <% } else { %>
                        <span class="text-muted">—</span>
                      <% } %>
                    </td>
                    <td><%= item.day_of_week || item.day %> · #<%= item.class_number || '-' %></td>
                    <td><%= item.created_by %></td>
                    <td>
                      <% if (item.file_path) { %>
                        <a href="<%= item.file_path %>"><%= item.file_name || 'Download' %></a>
                      <% } else if (item.meeting_url) { %>
                        <a href="<%= item.meeting_url %>" target="_blank" rel="noopener">Online class</a>
                      <% } else if (item.link_url) { %>
                        <a href="<%= item.link_url %>" target="_blank" rel="noopener">Link</a>
                      <% } else { %>
                        <span class="text-muted">—</span>
                      <% } %>
                    </td>
                    <td>
                      <form method="POST" action="/admin/homework/delete/<%= item.id %>">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                          onclick="return confirm('Delete this homework item?');"
                        >
                          <%= t('admin.delete') %>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <div id="admin-users">
          <div class="card mb-3">
            <div class="card-body">
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-5">
                    <label class="form-label"><%= t('admin.searchByName') %></label>
                    <input
                      class="form-control"
                      name="users_q"
                      placeholder="<%= t('admin.searchByNamePlaceholder') %>"
                      value="<%= (filters && filters.users_q) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.scheduleGroup') %></label>
                    <input
                      class="form-control"
                      name="users_group"
                      placeholder="<%= t('admin.scheduleGroupPlaceholder') %>"
                      value="<%= (filters && filters.users_group) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-outline-danger btn-sm" type="submit" form="deleteUsersForm"><%= t('admin.deleteSelected') %></button>
            <button
              class="btn btn-danger btn-sm"
              type="submit"
              form="clearUsersForm"
              onclick="return confirm('<%= t('admin.deleteAllConfirm') %>');"
            >
              <%= t('admin.deleteAllStudents') %>
            </button>
            <a
              class="btn btn-outline-secondary btn-sm"
              href="/admin/export/users.csv?course=<%= selectedCourseId || 1 %><%= activeSemester ? '&semester_id=' + activeSemester.id : '' %><%= (filters && filters.users_group) ? '&group=' + encodeURIComponent(filters.users_group) : '' %>"
            ><%= t('admin.exportUsers') %></a>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-status="active"><%= t('admin.active') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="inactive"><%= t('admin.inactive') %></button>
              <button class="btn btn-outline-primary" type="button" data-status="all"><%= t('admin.all') %></button>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-primary" type="button" data-role-filter="all"><%= t('admin.allRoles') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="admin"><%= t('admin.admins') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="starosta"><%= t('admin.starosta') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="deanery"><%= t('admin.deanery') %></button>
              <button class="btn btn-outline-primary" type="button" data-role-filter="student"><%= t('admin.students') %></button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllUsers" /></th>
                  <th><%= t('admin.name') %></th>
                  <th><%= t('admin.role') %></th>
                  <th><%= t('admin.course') %></th>
                  <th><%= t('admin.scheduleGroup') %></th>
                  <th><%= t('admin.subjectGroup') %></th>
                  <th><%= t('admin.setGroup') %></th>
                  <th><%= t('admin.actions') %></th>
                </tr>
              </thead>
              <tbody
                id="usersTableBody"
                data-current-user-id="<%= typeof userId !== 'undefined' ? userId : '' %>"
                data-status="<%= usersStatus || 'active' %>"
                data-role-filter="all"
                data-course-id="<%= selectedCourseId || 1 %>"
                data-search="<%= (filters && filters.users_q) || '' %>"
                data-group="<%= (filters && filters.users_group) || '' %>"
              >
                <% (users || []).forEach(function(u) { %>
                  <tr
                    class="user-row"
                    data-user-id="<%= u.id %>"
                    data-user-name="<%= u.full_name %>"
                    data-user-role="<%= u.role %>"
                    data-user-group="<%= u.schedule_group %>"
                    data-user-course="<%= courseMap[u.course_id] || ('Course ' + (u.course_id || 1)) %>"
                    data-user-course-id="<%= u.course_id || 1 %>"
                    data-user-active="<%= u.is_active %>"
                    data-user-ip="<%= u.last_login_ip || '' %>"
                    data-user-agent="<%= u.last_user_agent || '' %>"
                    data-user-login="<%= u.last_login_at || '' %>"
                  >
                    <td>
                      <% if (u.role !== 'admin') { %>
                        <input type="checkbox" name="delete_user_ids" value="<%= u.id %>" form="deleteUsersForm" />
                      <% } %>
                    </td>
                    <td><%= u.full_name %></td>
                    <td><span class="badge text-bg-<%= u.role === 'admin' ? 'primary' : (u.role === 'starosta' ? 'warning' : (u.role === 'deanery' ? 'info' : 'secondary')) %>"><%= u.role %></span></td>
                    <td><%= courseMap[u.course_id] || ('Course ' + (u.course_id || 1)) %></td>
                    <td><%= u.schedule_group %></td>
                    <td>
                      <% 
                        const subjectList = [];
                        if (groupMap[u.id]) {
                          Object.keys(groupMap[u.id]).forEach(function(subjectId) {
                            const subj = (subjects || []).find(function(s) { return String(s.id) === String(subjectId); });
                            if (subj) {
                              subjectList.push({ subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][subjectId] });
                            }
                          });
                        }
                      %>
                      <button
                        class="btn btn-sm btn-outline-primary subject-groups-btn"
                        type="button"
                        data-user-id="<%= u.id %>"
                        data-user-name="<%= u.full_name %>"
                        data-subjects='<%- JSON.stringify(subjectList) %>'
                      >
                        <%= t('admin.subjects') %> (<%= subjectList.length %>)
                      </button>
                    </td>
                    <td>
                      <form method="POST" action="/admin/student-groups/set" class="row g-2">
                        <input type="hidden" name="student_id" value="<%= u.id %>" />
                        <div class="col-12 col-md-6">
                          <select class="form-select form-select-sm" name="subject_id" required>
                            <option value="" disabled selected><%= t('admin.subject') %></option>
                            <% (subjects || []).forEach(function(s) { %>
                              <option value="<%= s.id %>"><%= s.name %> (1–<%= s.group_count %>)</option>
                            <% }); %>
                          </select>
                        </div>
                        <div class="col-12 col-md-3">
                          <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                          <button class="btn btn-sm btn-outline-primary" type="submit"><%= t('admin.save') %></button>
                        </div>
                      </form>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary user-manage-btn" type="button"><%= t('admin.manage') %></button>
                      <% if (u.role !== 'admin' && u.is_active === 0) { %>
                        <form method="POST" action="/admin/users/delete-permanent" class="d-inline">
                          <input type="hidden" name="user_id" value="<%= u.id %>" />
                          <button
                            class="btn btn-sm btn-outline-danger ms-2"
                            type="submit"
                            onclick="return confirm('<%= t('admin.deletePermanentConfirm') %>');"
                          >
                            <%= t('admin.deletePermanent') %>
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <form id="deleteUsersForm" method="POST" action="/admin/users/delete-multiple"></form>
          <form id="clearUsersForm" method="POST" action="/admin/users/clear-all"></form>
        </div>

        <div id="admin-subjects">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Add subject</h5>
              <form method="POST" action="/admin/subjects/add" novalidate>
                <div class="row g-2">
                  <div class="col-12 col-md-5">
                    <input class="form-control" name="name" placeholder="Subject name" />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="group_count">
                      <option value="" disabled selected>Groups</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="default_group">
                      <option value="1" selected>1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="show_in_teamwork">
                      <option value="1" selected>Teamwork: Yes</option>
                      <option value="0">Teamwork: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="visible">
                      <option value="1" selected>Visible: Yes</option>
                      <option value="0">Visible: No</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-3 d-grid">
                    <button class="btn btn-primary" type="submit">Add</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="d-flex justify-content-end mb-2">
            <a class="btn btn-outline-secondary btn-sm" href="/admin/export/subjects.csv">Export Subjects CSV</a>
          </div>

          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Groups</th>
                  <th>Default</th>
                  <th>Teamwork</th>
                  <th>Visible</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% (subjects || []).forEach(function(s) { %>
                  <tr>
                    <td><%= s.id %></td>
                    <td>
                      <input class="form-control form-control-sm" name="name" form="subject-<%= s.id %>" value="<%= s.name %>" required />
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="group_count" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.group_count === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.group_count === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.group_count === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="default_group" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.default_group === 1 ? 'selected' : '' %>>1</option>
                        <option value="2" <%= s.default_group === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= s.default_group === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="show_in_teamwork" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.show_in_teamwork === 1 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.show_in_teamwork === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="visible" form="subject-<%= s.id %>" required>
                        <option value="1" <%= s.visible !== 0 ? 'selected' : '' %>>Yes</option>
                        <option value="0" <%= s.visible === 0 ? 'selected' : '' %>>No</option>
                      </select>
                    </td>
                    <td class="d-flex gap-2">
                      <form id="subject-<%= s.id %>" method="POST" action="/admin/subjects/edit/<%= s.id %>" data-save-all="true"></form>
                      <button class="btn btn-sm btn-outline-secondary" type="submit" form="subject-<%= s.id %>">Save</button>
                      <form method="POST" action="/admin/subjects/delete/<%= s.id %>">
                        <button
                          class="btn btn-sm btn-outline-danger"
                          type="submit"
                          onclick="return confirm('Delete this subject and its groups?');"
                        >
                          Delete
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <div id="admin-semesters">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create semester</h5>
              <form method="POST" action="/admin/semesters/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="title" placeholder="Semester title" required />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" type="date" name="start_date" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <input class="form-control" type="number" name="weeks_count" min="1" max="30" value="15" required />
                  </div>
                  <div class="col-12 col-md-2">
                    <select class="form-select" name="is_active">
                      <option value="1">Active</option>
                      <option value="0" selected>Inactive</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Semesters</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Start date</th>
                      <th>Weeks</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (semesters || []).forEach(function(sem) { %>
                      <tr>
                        <td>
                          <input class="form-control form-control-sm" name="title" form="semester-<%= sem.id %>" value="<%= sem.title %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="date" name="start_date" form="semester-<%= sem.id %>" value="<%= sem.start_date %>" required />
                        </td>
                        <td>
                          <input class="form-control form-control-sm" type="number" min="1" max="30" name="weeks_count" form="semester-<%= sem.id %>" value="<%= sem.weeks_count %>" required />
                        </td>
                        <td>
                          <% if (sem.is_active === 1) { %>
                            <span class="badge text-bg-success">Active</span>
                          <% } else if (sem.is_archived === 1) { %>
                            <span class="badge text-bg-secondary">Archived</span>
                          <% } else { %>
                            <span class="badge text-bg-light text-dark">Inactive</span>
                          <% } %>
                        </td>
                        <td class="d-flex flex-wrap gap-2">
                          <form id="semester-<%= sem.id %>" method="POST" action="/admin/semesters/edit/<%= sem.id %>" data-save-all="true"></form>
                          <button class="btn btn-sm btn-outline-secondary" type="submit" form="semester-<%= sem.id %>">Save</button>
                          <% if (!sem.is_active) { %>
                            <form method="POST" action="/admin/semesters/set-active/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-primary" type="submit">Set active</button>
                            </form>
                          <% } %>
                          <% if (sem.is_archived) { %>
                            <form method="POST" action="/admin/semesters/restore/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-secondary" type="submit">Restore</button>
                            </form>
                          <% } else { %>
                            <form method="POST" action="/admin/semesters/archive/<%= sem.id %>">
                              <button class="btn btn-sm btn-outline-warning" type="submit">Archive</button>
                            </form>
                          <% } %>
                          <form method="POST" action="/admin/semesters/delete/<%= sem.id %>">
                            <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this semester?');">Delete</button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(semesters || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">No semesters yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="admin-courses">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Create course</h5>
              <form method="POST" action="/admin/courses/add">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" type="number" name="id" min="1" placeholder="Course ID (e.g. 3)" required />
                  </div>
                  <div class="col-12 col-md-5">
                    <input class="form-control" name="name" placeholder="Course name (e.g. 3 курс)" required />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit">Create</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Courses</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (courses || []).forEach(function(c) { %>
                      <tr>
                        <td><%= c.id %></td>
                        <td>
                          <input class="form-control form-control-sm" name="name" form="course-<%= c.id %>" value="<%= c.name %>" required />
                        </td>
                        <td class="d-flex gap-2">
                          <form id="course-<%= c.id %>" method="POST" action="/admin/courses/edit/<%= c.id %>" data-save-all="true"></form>
                          <button class="btn btn-sm btn-outline-secondary" type="submit" form="course-<%= c.id %>">Save</button>
                          <form method="POST" action="/admin/courses/delete/<%= c.id %>">
                            <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this course?');">Delete</button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(courses || []).length) { %>
                      <tr>
                        <td colspan="3" class="text-muted"><%= t('admin.noCourses') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="admin-history">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.historyFilters') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2">
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_actor" placeholder="<%= t('admin.actor') %>" value="<%= historyFilters && historyFilters.actor || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_action" placeholder="<%= t('admin.action') %>" value="<%= historyFilters && historyFilters.action || '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <input class="form-control" name="history_q" placeholder="<%= t('admin.detailsContains') %>" value="<%= historyFilters && historyFilters.q || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_from" value="<%= historyFilters && historyFilters.from || '' %>" />
                  </div>
                  <div class="col-6 col-md-1">
                    <input class="form-control" type="date" name="history_to" value="<%= historyFilters && historyFilters.to || '' %>" />
                  </div>
                  <div class="col-12 col-md-1 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="mt-2">
                <a
                  class="btn btn-outline-secondary btn-sm"
                  href="/admin/history.csv?history_actor=<%= encodeURIComponent(historyFilters && historyFilters.actor || '') %>&history_action=<%= encodeURIComponent(historyFilters && historyFilters.action || '') %>&history_q=<%= encodeURIComponent(historyFilters && historyFilters.q || '') %>&history_from=<%= encodeURIComponent(historyFilters && historyFilters.from || '') %>&history_to=<%= encodeURIComponent(historyFilters && historyFilters.to || '') %>"
                >
                  <%= t('admin.exportHistory') %>
                </a>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th><%= t('admin.actor') %></th>
                  <th><%= t('admin.action') %></th>
                  <th><%= t('admin.details') %></th>
                  <th><%= t('admin.time') %></th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <% (logs || []).forEach(function(log) { %>
                  <tr>
                    <td><%= log.id %></td>
                    <td><%= log.actor_name || '-' %></td>
                    <td><%= log.action %></td>
                    <td><%= log.details || '-' %></td>
                    <td><%= log.created_at %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>

        <% if (!isLimitedView) { %>
        <div id="admin-activity">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.activityLog') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.user') %></label>
                    <input class="form-control" name="activity_user" placeholder="<%= t('admin.userName') %>" value="<%= activityFilters && activityFilters.user ? activityFilters.user : '' %>" />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.action') %></label>
                    <input class="form-control" name="activity_action" placeholder="<%= t('admin.actionPlaceholder') %>" value="<%= activityFilters && activityFilters.action ? activityFilters.action : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input class="form-control" type="date" name="activity_from" value="<%= activityFilters && activityFilters.from ? activityFilters.from : '' %>" />
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input class="form-control" type="date" name="activity_to" value="<%= activityFilters && activityFilters.to ? activityFilters.to : '' %>" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h6 class="mb-3"><%= t('admin.topActive') %></h6>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.points') %></th>
                      <th><%= t('admin.actions') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityTop || []).forEach(function(row, idx) { %>
                      <tr>
                        <td><%= idx + 1 %></td>
                        <td><%= row.user_name || '-' %></td>
                        <td><%= row.points || 0 %></td>
                        <td><%= row.actions_count || 0 %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityTop || []).length) { %>
                      <tr>
                        <td colspan="4" class="text-muted"><%= t('admin.noActivity') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.user') %></th>
                      <th><%= t('admin.action') %></th>
                      <th><%= t('admin.target') %></th>
                      <th><%= t('admin.details') %></th>
                      <th><%= t('admin.created') %></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (activityLogs || []).forEach(function(a) { %>
                      <tr>
                        <td><%= a.id %></td>
                        <td><%= a.user_name || '-' %></td>
                        <td><%= a.action_type %></td>
                        <td><%= a.target_type || '-' %> <%= a.target_id ? '#' + a.target_id : '' %></td>
                        <td><%= a.details || '-' %></td>
                        <td><%= a.created_at %></td>
                      </tr>
                    <% }); %>
                    <% if (!(activityLogs || []).length) { %>
                      <tr>
                        <td colspan="6" class="text-muted"><%= t('admin.noActivityLog') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <% } %>
        <% } %>

        <div id="admin-teamwork">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.teamworkTasks') %></h5>
              <form method="GET" action="/admin">
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <input
                      class="form-control"
                      name="teamwork_subject"
                      placeholder="<%= t('admin.subjectPlaceholder') %>"
                      value="<%= (filters && filters.teamwork_subject) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.from') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_from"
                      value="<%= (filters && filters.teamwork_from) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label"><%= t('admin.to') %></label>
                    <input
                      class="form-control"
                      type="date"
                      name="teamwork_to"
                      value="<%= (filters && filters.teamwork_to) || '' %>"
                    />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-outline-primary" type="submit"><%= t('admin.filter') %></button>
                  </div>
                </div>
              </form>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th><%= t('admin.subject') %></th>
                      <th><%= t('admin.titleLabel') %></th>
                      <th><%= t('admin.groups') %></th>
                      <th><%= t('admin.members') %></th>
                      <th><%= t('admin.created') %></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (teamworkTasks || []).forEach(function(task) { %>
                      <tr>
                        <td><%= task.id %></td>
                        <td><%= task.subject_name %></td>
                        <td><%= task.title %></td>
                        <td><%= task.group_count %></td>
                        <td><%= task.member_count %></td>
                        <td><%= task.created_at %></td>
                        <td>
                          <form method="POST" action="/admin/teamwork/delete/<%= task.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              onclick="return confirm('Delete this teamwork task?');"
                            >
                              <%= t('admin.delete') %>
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(teamworkTasks || []).length) { %>
                      <tr>
                        <td colspan="7" class="text-muted"><%= t('admin.noTeamwork') %></td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div id="admin-messages">
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3"><%= t('admin.sendMessage') %></h5>
              <form method="POST" action="/admin/messages/send">
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <textarea class="form-control" name="body" rows="3" placeholder="<%= t('admin.messagePlaceholder') %>" required></textarea>
                  </div>
                </div>
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.target') %></label>
                    <select class="form-select" name="target_type" id="messageTargetType">
                      <option value="all"><%= t('admin.targetAll') %></option>
                      <option value="subject"><%= t('admin.targetSubjectGroup') %></option>
                      <option value="users"><%= t('admin.targetUsers') %></option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <label class="form-label"><%= t('admin.subject') %></label>
                    <select class="form-select" name="subject_id" id="messageSubjectSelect">
                      <option value="" disabled selected><%= t('admin.selectSubject') %></option>
                      <% (subjects || []).forEach(function(s) { %>
                        <option value="<%= s.id %>"><%= s.name %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-12 col-md-2">
                    <label class="form-label"><%= t('admin.group') %></label>
                    <input class="form-control" type="number" min="1" max="3" name="group_number" id="messageGroupInput" placeholder="1-3" />
                  </div>
                  <div class="col-12 col-md-2 d-grid">
                    <button class="btn btn-primary" type="submit"><%= t('admin.send') %></button>
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-12">
                    <label class="form-label">Specific users</label>
                    <select class="form-select" name="user_ids" id="messageUsersSelect" multiple size="5">
                      <% (users || []).filter(u => u.role === 'student').forEach(function(u) { %>
                        <option value="<%= u.id %>"><%= u.full_name %></option>
                      <% }); %>
                    </select>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Existing messages</h5>
              <div class="table-responsive">
                <table class="table table-striped align-middle">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Body</th>
                      <th>Target</th>
                      <th>Created</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <% (adminMessages || []).forEach(function(m) { %>
                      <tr>
                        <td><%= m.id %></td>
                        <td><%= m.body %></td>
                        <td>
                          <% if (m.target_all === 1) { %>
                            All students
                          <% } else if (m.subject_name) { %>
                            <%= m.subject_name %> · Group <%= m.group_number %>
                          <% } else { %>
                            Users
                          <% } %>
                        </td>
                        <td><%= m.created_at %></td>
                        <td>
                          <form method="POST" action="/admin/messages/delete/<%= m.id %>">
                            <button
                              class="btn btn-sm btn-outline-danger"
                              type="submit"
                              onclick="return confirm('Delete this message?');"
                            >
                              Delete
                            </button>
                          </form>
                        </td>
                      </tr>
                    <% }); %>
                    <% if (!(adminMessages || []).length) { %>
                      <tr>
                        <td colspan="5" class="text-muted">No messages yet.</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="app-footer text-center py-4">
      <small>© <%= new Date().getFullYear() %> <%= authorName %> · v<%= appVersion %> · <%= buildStamp %></small>
    </footer>
    <% if (!isLimitedView) { %>
      <button class="btn btn-primary save-all-btn" type="button">Зберегти все</button>
    <% } %>

    <div class="modal fade" id="userActionsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userActionsTitle">User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2"><strong>Name:</strong> <span id="uaName"></span></div>
            <div class="mb-2"><strong>Role:</strong> <span id="uaRole"></span></div>
            <div class="mb-2"><strong>Active:</strong> <span id="uaActive"></span></div>
            <div class="mb-2"><strong>Schedule Group:</strong> <span id="uaGroup"></span></div>
            <div class="mb-2"><strong>Course:</strong> <span id="uaCourse"></span></div>
            <div class="mb-2"><strong>Last Login IP:</strong> <span id="uaIp"></span></div>
            <div class="mb-2"><strong>Device:</strong> <span id="uaAgent"></span></div>
            <div class="mb-3"><strong>Last Login:</strong> <span id="uaLoginAt"></span></div>
            <div class="mb-3">
              <strong>Login History:</strong>
              <ul id="uaLoginHistory" class="list-group list-group-flush mt-2"></ul>
            </div>

            <form method="POST" action="/admin/users/role" class="mb-3">
              <input type="hidden" name="user_id" id="uaRoleUserId" />
              <label class="form-label">Change role</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="role" id="uaRoleSelect" required>
                  <option value="student">student</option>
                  <option value="starosta">starosta</option>
                  <option value="deanery">deanery</option>
                  <option value="admin">admin</option>
                </select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/course" class="mb-3">
              <input type="hidden" name="user_id" id="uaCourseUserId" />
              <label class="form-label">Change course</label>
              <div class="d-flex gap-2">
                <select class="form-select" name="course_id" id="uaCourseSelect" required>
                  <% (courses || []).forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
                <button class="btn btn-outline-primary glass" type="submit">Save</button>
              </div>
            </form>

            <form method="POST" action="/admin/users/reset-password" class="mb-3">
              <input type="hidden" name="user_id" id="uaPassUserId" />
              <label class="form-label">Reset password</label>
              <div class="d-flex gap-2">
                <input class="form-control" name="new_password" placeholder="New password" required />
                <button class="btn btn-outline-secondary glass" type="submit">Set</button>
              </div>
            </form>

            <button class="btn btn-outline-danger glass" type="button" id="uaDeleteBtn">Deactivate user</button>
            <button class="btn btn-outline-success glass ms-2" type="button" id="uaActivateBtn">Restore user</button>
            <form method="POST" action="/admin/users/delete-permanent" class="mt-3" id="uaDeletePermanentForm">
              <input type="hidden" name="user_id" id="uaDeleteUserId" />
              <button
                class="btn btn-outline-danger glass w-100"
                type="submit"
                onclick="return confirm('Permanently delete this user? This cannot be undone.');"
              >
                Delete permanently
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="subjectGroupsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="subjectGroupsTitle">Subject groups</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="subjectGroupsList" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      const labelLight = themeToggle.dataset.lightLabel || 'Light';
      const labelDark = themeToggle.dataset.darkLabel || 'Dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      themeToggle.textContent = savedTheme === 'theme-dark' ? labelLight : labelDark;
      themeToggle.addEventListener('click', () => {
        const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add(next);
        localStorage.setItem('ui-theme', next);
        themeToggle.textContent = next === 'theme-dark' ? labelLight : labelDark;
      });

      const limitedStaffView = <%= isLimitedView ? 'true' : 'false' %>;
      const adminSections = limitedStaffView
        ? ['admin-teamwork', 'admin-messages']
        : ['admin-settings', 'admin-schedule', 'admin-homework', 'admin-users', 'admin-subjects', 'admin-semesters', 'admin-courses', 'admin-history', 'admin-activity', 'admin-teamwork', 'admin-messages'];

      function toggleSection(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        localStorage.setItem(`admin:${id}`, el.style.display);
      }

      function toggleAllSections() {
        const allHidden = adminSections.every((id) => {
          const el = document.getElementById(id);
          return el && el.style.display === 'none';
        });
        adminSections.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = allHidden ? 'block' : 'none';
          localStorage.setItem(`admin:${id}`, el.style.display);
        });
      }

      window.addEventListener('load', () => {
        adminSections.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          const saved = localStorage.getItem(`admin:${id}`);
          if (saved === 'none') {
            el.style.display = 'none';
          }
        });
      });

      const selectAll = document.getElementById('selectAllSchedule');
      if (selectAll) {
        selectAll.addEventListener('change', () => {
          document
            .querySelectorAll('input[name="delete_ids"]')
            .forEach((cb) => (cb.checked = selectAll.checked));
        });
      }

      const selectAllUsers = document.getElementById('selectAllUsers');
      if (selectAllUsers) {
        selectAllUsers.addEventListener('change', () => {
          document
            .querySelectorAll('input[name=\"delete_user_ids\"]')
            .forEach((cb) => (cb.checked = selectAllUsers.checked));
        });
      }

      function renderUsersTable(data) {
        const tbody = document.getElementById('usersTableBody');
        if (!tbody) return;
        const currentUserId = tbody.dataset.currentUserId;
        const status = tbody.dataset.status || 'active';
        const subjectMap = new Map();
        data.subjects.forEach((s) => subjectMap.set(String(s.id), s));
        const courseMap = new Map();
        (data.courses || []).forEach((c) => courseMap.set(String(c.id), c.name));
        const groupMap = {};
        data.studentGroups.forEach((g) => {
          if (!groupMap[g.student_id]) groupMap[g.student_id] = {};
          groupMap[g.student_id][g.subject_id] = g.group_number;
        });

        tbody.innerHTML = data.users
          .map((u) => {
            const isActive = typeof u.is_active === 'undefined' ? 1 : u.is_active;
            const checkbox = u.role !== 'admin'
              ? `<input type="checkbox" name="delete_user_ids" value="${u.id}" form="deleteUsersForm" />`
              : '';
            const subjectList = groupMap[u.id]
              ? Object.keys(groupMap[u.id]).map((sid) => {
                  const subj = subjectMap.get(String(sid));
                  if (!subj) return null;
                  return { subject_id: subj.id, name: subj.name, group_number: groupMap[u.id][sid] };
                }).filter(Boolean)
              : [];
            const subjectsBtn = `
              <button
                class="btn btn-sm btn-outline-primary subject-groups-btn"
                type="button"
                data-user-id="${u.id}"
                data-user-name="${u.full_name}"
                data-subjects='${JSON.stringify(subjectList).replace(/'/g, '&#39;')}'
              >
                Subjects (${subjectList.length})
              </button>
            `;

            const subjectOptions = data.subjects
              .map((s) => `<option value="${s.id}">${s.name} (1–${s.group_count})</option>`)
              .join('');

            const roleEditor =
              String(u.id) === String(currentUserId)
                ? '<span class="text-muted">—</span>'
                : `
                  <form method="POST" action="/admin/users/role" class="d-flex gap-2">
                    <input type="hidden" name="user_id" value="${u.id}" />
                    <select class="form-select form-select-sm" name="role" required>
                      <option value="student" ${u.role === 'student' ? 'selected' : ''}>student</option>
                      <option value="starosta" ${u.role === 'starosta' ? 'selected' : ''}>starosta</option>
                      <option value="deanery" ${u.role === 'deanery' ? 'selected' : ''}>deanery</option>
                      <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                  </form>
                `;

            return `
              <tr class="user-row"
                  data-user-id="${u.id}"
                  data-user-name="${u.full_name}"
                  data-user-role="${u.role}"
                  data-user-group="${u.schedule_group}"
                  data-user-course="${courseMap.get(String(u.course_id)) || `Course ${u.course_id || 1}`}"
                  data-user-course-id="${u.course_id || 1}"
                  data-user-active="${isActive}"
                  data-user-ip="${u.last_login_ip || ''}"
                  data-user-agent="${(u.last_user_agent || '').replace(/\"/g, '&quot;')}"
                  data-user-login="${u.last_login_at || ''}">
                <td>${checkbox}</td>
                <td>${u.full_name}</td>
                <td><span class="badge text-bg-${u.role === 'admin' ? 'primary' : (u.role === 'starosta' ? 'warning' : (u.role === 'deanery' ? 'info' : 'secondary'))}">${u.role}</span></td>
                <td>${courseMap.get(String(u.course_id)) || `Course ${u.course_id || 1}`}</td>
                <td>${u.schedule_group}</td>
                <td>${subjectsBtn}</td>
                <td>
                  <form method="POST" action="/admin/student-groups/set" class="row g-2">
                    <input type="hidden" name="student_id" value="${u.id}" />
                    <div class="col-12 col-md-6">
                      <select class="form-select form-select-sm" name="subject_id" required>
                        <option value="" disabled selected>Subject</option>
                        ${subjectOptions}
                      </select>
                    </div>
                    <div class="col-12 col-md-3">
                      <input class="form-control form-control-sm" name="group_number" type="number" min="1" max="3" required />
                    </div>
                    <div class="col-12 col-md-3 d-grid">
                      <button class="btn btn-sm btn-outline-primary" type="submit">Save</button>
                    </div>
                  </form>
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary user-manage-btn" type="button">Manage</button>
                  ${u.role !== 'admin' && isActive === 0 ? `
                    <form method="POST" action="/admin/users/delete-permanent" class="d-inline">
                      <input type="hidden" name="user_id" value="${u.id}">
                      <button class="btn btn-sm btn-outline-danger ms-2" type="submit"
                        onclick="return confirm('Permanently delete this user? This cannot be undone.');">
                        Delete permanently
                      </button>
                    </form>
                  ` : ''}
                </td>
              </tr>
            `;
          })
          .join('');
      }

      async function refreshUsers() {
        try {
          const tbodyEl = document.getElementById('usersTableBody');
          if (!tbodyEl) return;
          const status = tbodyEl.dataset.status || 'active';
          const courseId = tbodyEl.dataset.courseId || '1';
          const q = tbodyEl.dataset.search || '';
          const group = tbodyEl.dataset.group || '';
          const res = await fetch(
            `/admin/users.json?status=${encodeURIComponent(status)}&course=${encodeURIComponent(courseId)}&q=${encodeURIComponent(
              q
            )}&group=${encodeURIComponent(group)}`
          );
          if (!res.ok) return;
          const data = await res.json();
          const roleFilter = tbodyEl.dataset.roleFilter || 'all';
          const filtered = roleFilter === 'all'
            ? data
            : { ...data, users: data.users.filter((u) => u.role === roleFilter) };
          renderUsersTable(filtered);
          bindUserRowClicks();
          bindSubjectButtons();
        } catch (err) {
          return;
        }
      }

      function connectUserSocket() {
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const socket = new WebSocket(`${protocol}://${location.host}`);
        socket.addEventListener('message', (event) => {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'users_updated') {
              refreshUsers();
            }
            if (msg.type === 'history_updated') {
              refreshHistory();
            }
          } catch (e) {
            return;
          }
        });
        socket.addEventListener('close', () => {
          setTimeout(connectUserSocket, 3000);
        });
      }

      if (document.getElementById('usersTableBody')) {
        connectUserSocket();
      }

      const historyForm = document.querySelector('#admin-history form');
      if (historyForm) {
        historyForm.addEventListener('submit', () => {
          setTimeout(refreshHistory, 0);
        });
      }

      async function refreshHistory() {
        const tbody = document.getElementById('historyTableBody');
        if (!tbody) return;
        try {
          const params = new URLSearchParams(new FormData(document.querySelector('#admin-history form'))).toString();
          const res = await fetch(`/admin/history.json?${params}`);
          if (!res.ok) return;
          const data = await res.json();
          tbody.innerHTML = data.logs
            .map(
              (log) => `
                <tr>
                  <td>${log.id}</td>
                  <td>${log.actor_name || '-'}</td>
                  <td>${log.action}</td>
                  <td>${log.details || '-'}</td>
                  <td>${log.created_at}</td>
                </tr>
              `
            )
            .join('');
        } catch (err) {
          return;
        }
      }

      function bindUserRowClicks() {
        document.querySelectorAll('.user-row').forEach((row) => {
          row.addEventListener('click', (e) => {
            const tag = e.target.tagName.toLowerCase();
            const isManage = e.target.classList.contains('user-manage-btn');
            if (['input', 'select', 'button', 'a', 'form', 'label'].includes(tag) && !isManage) return;
            const userId = row.dataset.userId;
            const userName = row.dataset.userName;
            const userRole = row.dataset.userRole;
            const userGroup = row.dataset.userGroup;
            const userActive = row.dataset.userActive === '1' ? 'Yes' : 'No';
            const userCourse = row.dataset.userCourse || '';
            const userIp = row.dataset.userIp || '-';
            const userAgent = row.dataset.userAgent || '-';
            const userLogin = row.dataset.userLogin || '-';

            document.getElementById('uaName').textContent = userName;
            document.getElementById('uaRole').textContent = userRole;
            document.getElementById('uaGroup').textContent = userGroup;
            document.getElementById('uaActive').textContent = userActive;
            document.getElementById('uaCourse').textContent = userCourse;
            document.getElementById('uaIp').textContent = userIp;
            document.getElementById('uaAgent').textContent = userAgent;
            document.getElementById('uaLoginAt').textContent = userLogin;
            document.getElementById('uaRoleUserId').value = userId;
            document.getElementById('uaPassUserId').value = userId;
            document.getElementById('uaRoleSelect').value = userRole;
            document.getElementById('uaDeleteUserId').value = userId;
            document.getElementById('uaCourseUserId').value = userId;
            if (document.getElementById('uaCourseSelect')) {
              document.getElementById('uaCourseSelect').value = row.dataset.userCourseId || '';
            }

            const modal = new bootstrap.Modal(document.getElementById('userActionsModal'));
            modal.show();

            const deleteBtn = document.getElementById('uaDeleteBtn');
            deleteBtn.onclick = async () => {
              if (!confirm('Deactivate this user?')) return;
              const res = await fetch('/admin/users/deactivate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const activateBtn = document.getElementById('uaActivateBtn');
            activateBtn.onclick = async () => {
              const res = await fetch('/admin/users/activate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId }),
              });
              if (res.ok) {
                modal.hide();
                refreshUsers();
              }
            };

            const permForm = document.getElementById('uaDeletePermanentForm');
            if (permForm) {
              permForm.style.display = userActive === 'Yes' ? 'none' : 'block';
            }

            const historyList = document.getElementById('uaLoginHistory');
            historyList.innerHTML = '<li class="list-group-item text-muted">Loading…</li>';
            fetch(`/admin/user-logins.json?user_id=${encodeURIComponent(userId)}`)
              .then((resp) => resp.json())
              .then((data) => {
                if (!data.logins || !data.logins.length) {
                  historyList.innerHTML = '<li class="list-group-item text-muted">No logins yet</li>';
                  return;
                }
                historyList.innerHTML = data.logins
                  .map(
                    (l) =>
                      `<li class="list-group-item">${l.created_at} — ${l.ip || '-'} — ${l.user_agent || '-'}</li>`
                  )
                  .join('');
              })
              .catch(() => {
                historyList.innerHTML = '<li class="list-group-item text-muted">Failed to load</li>';
              });
          });
        });
        document.querySelectorAll('.user-row select, .user-row input, .user-row button').forEach((el) => {
          el.addEventListener('click', (e) => e.stopPropagation());
        });
      }

      function bindSubjectButtons() {
        document.querySelectorAll('.subject-groups-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            const raw = btn.dataset.subjects || '[]';
            let items = [];
            try {
              items = JSON.parse(raw);
            } catch (e) {
              items = [];
            }
            document.getElementById('subjectGroupsTitle').textContent = `Subjects for ${userName}`;
            const list = document.getElementById('subjectGroupsList');
            list.innerHTML = '';
            if (!items.length) {
              list.innerHTML = '<div class="text-muted">No subjects assigned.</div>';
            } else {
              items.forEach((item) => {
                const row = document.createElement('div');
                row.className = 'list-group-item d-flex justify-content-between align-items-center';
                row.innerHTML = `
                  <div>${item.name} — Group ${item.group_number}</div>
                  <form method="POST" action="/admin/group/remove" class="ms-2">
                    <input type="hidden" name="student_id" value="${userId}">
                    <input type="hidden" name="subject_id" value="${item.subject_id}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Remove</button>
                  </form>
                `;
                list.appendChild(row);
              });
            }
            const modal = new bootstrap.Modal(document.getElementById('subjectGroupsModal'));
            modal.show();
          });
        });
      }

      document.querySelectorAll('[data-status]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const status = btn.dataset.status;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.status = status;
          refreshUsers();
        });
      });

      document.querySelectorAll('[data-role-filter]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const roleFilter = btn.dataset.roleFilter;
          const tbody = document.getElementById('usersTableBody');
          if (!tbody) return;
          tbody.dataset.roleFilter = roleFilter;
          refreshUsers();
        });
      });

      function updateMessageTargetFields() {
        const type = document.getElementById('messageTargetType');
        const subject = document.getElementById('messageSubjectSelect');
        const group = document.getElementById('messageGroupInput');
        const users = document.getElementById('messageUsersSelect');
        if (!type || !subject || !group || !users) return;
        if (type.value === 'subject') {
          subject.disabled = false;
          group.disabled = false;
          users.disabled = true;
        } else if (type.value === 'users') {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = false;
        } else {
          subject.disabled = true;
          group.disabled = true;
          users.disabled = true;
        }
      }

      const messageTarget = document.getElementById('messageTargetType');
      if (messageTarget) {
        messageTarget.addEventListener('change', updateMessageTargetFields);
        updateMessageTargetFields();
      }

      bindUserRowClicks();
      bindSubjectButtons();

      function getTrackableInputs(form) {
        const byId = Array.from(document.querySelectorAll(`[form="${form.id}"]`));
        const inside = Array.from(form.querySelectorAll('input, select, textarea'));
        return [...new Set([...byId, ...inside])];
      }

      function initInputTracking() {
        document.querySelectorAll('input, select, textarea').forEach((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            el.dataset.initialChecked = el.checked ? '1' : '0';
          } else {
            el.dataset.initialValue = el.value;
          }
        });
      }

      function formHasChanges(form) {
        const inputs = getTrackableInputs(form);
        return inputs.some((el) => {
          if (el.type === 'checkbox' || el.type === 'radio') {
            return (el.dataset.initialChecked === '1') !== el.checked;
          }
          return (el.dataset.initialValue ?? '') !== el.value;
        });
      }

      function buildFormBody(form) {
        const params = new URLSearchParams();
        getTrackableInputs(form).forEach((el) => {
          if (!el.name) return;
          if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) return;
          params.append(el.name, el.value);
        });
        return params;
      }

      function formIsVisible(form) {
        const section = form.closest('[id^="admin-"]');
        if (!section) return true;
        return section.offsetParent !== null;
      }

      async function saveAllForms() {
        const forms = Array.from(document.querySelectorAll('form[data-save-all="true"]'))
          .filter(formIsVisible)
          .filter(formHasChanges);
        const button = document.querySelector('.save-all-btn');
        if (!forms.length) {
          alert('Немає змін для збереження');
          return;
        }
        if (button) button.disabled = true;
        for (const form of forms) {
          const method = (form.method || 'POST').toUpperCase();
          await fetch(form.action, {
            method,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
            body: buildFormBody(form),
          });
        }
        if (button) button.disabled = false;
        window.location.reload();
      }

      const addSubjectSelect = document.getElementById('addSubjectSelect');
      const addGroupSelect = document.getElementById('addGroupSelect');

      function syncAddGroupSelect() {
        if (!addSubjectSelect || !addGroupSelect) return;
        const selected = addSubjectSelect.options[addSubjectSelect.selectedIndex];
        if (!selected) return;
        const groupCount = Number(selected.dataset.groupCount || 3);
        if (groupCount <= 1) {
          addGroupSelect.value = '1';
          addGroupSelect.classList.add('select-locked');
        } else {
          addGroupSelect.classList.remove('select-locked');
        }
      }

      if (addSubjectSelect && addGroupSelect) {
        addSubjectSelect.addEventListener('change', syncAddGroupSelect);
        syncAddGroupSelect();
      }

      const saveAllBtn = document.querySelector('.save-all-btn');
      if (saveAllBtn) {
        saveAllBtn.addEventListener('click', saveAllForms);
      }

      initInputTracking();
    </script>
  </body>
</html>
