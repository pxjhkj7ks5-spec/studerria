<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('admin.overview') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --radius: 16px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.08);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.7);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.25), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.25), transparent 60%),
          linear-gradient(135deg, #eef2ff 0%, #f0f9ff 50%, #fdf4ff 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(139, 92, 246, 0.25), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(59, 130, 246, 0.2), transparent 60%),
          linear-gradient(160deg, #050508 0%, #12061a 45%, #1b0f26 100%);
        color: #f8fafc;
      }
      body.theme-dark .text-dark {
        color: #f8fafc !important;
      }
      .admin-nav {
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .admin-nav {
        background: rgba(255, 255, 255, 0.8);
        border-bottom-color: rgba(15, 23, 42, 0.08);
      }
      body.theme-dark .admin-nav {
        background: rgba(10, 10, 20, 0.6);
      }
      .card {
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .card,
      body.theme-dark .modal-content {
        background: var(--glass-bg-dark);
        color: #f8fafc;
        border-color: var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .card,
      body.theme-light .modal-content {
        background: var(--glass-bg-light);
        border-color: var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.7) inset;
      }
      body.theme-dark .table {
        color: #f8fafc;
      }
      body.theme-dark .table th,
      body.theme-dark .table td {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .table thead th {
        color: rgba(248, 250, 252, 0.92);
      }
      body.theme-dark h1,
      body.theme-dark h2,
      body.theme-dark h3,
      body.theme-dark h4,
      body.theme-dark h5,
      body.theme-dark h6,
      body.theme-dark .card-title {
        color: #f8fafc;
      }
      body.theme-dark .text-muted {
        color: rgba(226, 232, 240, 0.7) !important;
      }
      body.theme-dark .form-control,
      body.theme-dark .form-select,
      body.theme-dark .input-group-text {
        background: rgba(15, 15, 30, 0.75);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.16);
      }
      body.theme-dark .form-control::placeholder {
        color: rgba(226, 232, 240, 0.6);
      }
      body.theme-dark .btn-outline-primary {
        color: #bfdbfe;
        border-color: rgba(96, 165, 250, 0.6);
      }
      body.theme-dark .btn-outline-primary:hover {
        background: rgba(59, 130, 246, 0.2);
      }
      body.theme-dark .btn-outline-secondary {
        color: rgba(248, 250, 252, 0.8);
        border-color: rgba(148, 163, 184, 0.45);
      }
    </style>
  </head>
  <body class="theme-light">
    <nav class="navbar admin-nav py-3">
      <div class="container">
        <span class="navbar-brand"><%= t('admin.overview') %></span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.user') %>: <%= username %>
            <% } %>
          </span>
          <button
            class="btn btn-outline-secondary btn-sm me-2"
            type="button"
            id="themeToggle"
            data-light-label="<%= t('theme.light') %>"
            data-dark-label="<%= t('theme.dark') %>"
          >
            <%= t('theme.dark') %>
          </button>
          <a class="btn btn-outline-primary btn-sm" href="/admin?course=<%= selectedCourseId %>"><%= t('admin.backToAdmin') %></a>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h1 class="h3 mb-0"><%= t('admin.dashboardOverview') %></h1>
      </div>

      <% const courseMap = {}; %>
      <% (courses || []).forEach(function(c) { courseMap[c.id] = c.name; }); %>
      <% if (!limitedStaffView) { %>
        <form method="GET" action="/admin/overview" class="mb-3">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <label class="form-label mb-0"><%= t('admin.course') %></label>
            <select class="form-select w-auto" name="course" onchange="this.form.submit()">
              <% (courses || []).forEach(function(c) { %>
                <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>><%= c.name %></option>
              <% }); %>
            </select>
          </div>
        </form>
      <% } else { %>
        <div class="mb-3 text-muted"><%= t('admin.course') %>: <%= courseMap[selectedCourseId] || ('Course ' + selectedCourseId) %></div>
      <% } %>

      <% const stats = dashboardStats || { users: 0, subjects: 0, homework: 0, teamworkTasks: 0, teamworkGroups: 0, teamworkMembers: 0 }; %>
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.users') %></div>
                <div class="h4 mb-0"><%= stats.users %></div>
              </div>
            </div>
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.subjects') %></div>
                <div class="h4 mb-0"><%= stats.subjects %></div>
              </div>
            </div>
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.homework') %></div>
                <div class="h4 mb-0"><%= stats.homework %></div>
              </div>
            </div>
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.teamworkTasks') %></div>
                <div class="h4 mb-0"><%= stats.teamworkTasks %></div>
              </div>
            </div>
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.teamworkGroups') %></div>
                <div class="h4 mb-0"><%= stats.teamworkGroups %></div>
              </div>
            </div>
            <div class="col-6 col-lg-2">
              <div class="p-3 rounded-4 border bg-white bg-opacity-75">
                <div class="text-muted small"><%= t('admin.teamworkMembers') %></div>
                <div class="h4 mb-0"><%= stats.teamworkMembers %></div>
              </div>
            </div>
          </div>
          <div class="row g-4">
            <div class="col-12 col-lg-7">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <h6 class="mb-3"><%= t('admin.platformActivity') %></h6>
                  <canvas id="adminStatsChart" height="160"></canvas>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-5">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                  <h6 class="mb-3"><%= t('admin.teamworkDistribution') %></h6>
                  <canvas id="adminTeamworkChart" height="160"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      const labelLight = themeToggle.dataset.lightLabel || 'Light';
      const labelDark = themeToggle.dataset.darkLabel || 'Dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      themeToggle.textContent = savedTheme === 'theme-dark' ? labelLight : labelDark;
      themeToggle.addEventListener('click', () => {
        const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add(next);
        localStorage.setItem('ui-theme', next);
        themeToggle.textContent = next === 'theme-dark' ? labelLight : labelDark;
        renderAdminCharts();
      });

      function renderAdminCharts() {
        if (!window.Chart) return;
        const stats = {
          users: <%= stats.users %>,
          subjects: <%= stats.subjects %>,
          homework: <%= stats.homework %>,
          teamworkTasks: <%= stats.teamworkTasks %>,
          teamworkGroups: <%= stats.teamworkGroups %>,
          teamworkMembers: <%= stats.teamworkMembers %>,
        };
        const isDark = document.body.classList.contains('theme-dark');
        Chart.defaults.color = isDark ? '#e2e8f0' : '#1f2937';
        Chart.defaults.borderColor = isDark ? 'rgba(255,255,255,0.12)' : 'rgba(15,23,42,0.08)';

        const barCtx = document.getElementById('adminStatsChart');
        if (barCtx) {
          new Chart(barCtx, {
            type: 'bar',
            data: {
              labels: ['<%= t('admin.users') %>', '<%= t('admin.subjects') %>', '<%= t('admin.homework') %>'],
              datasets: [
                {
                  data: [stats.users, stats.subjects, stats.homework],
                  backgroundColor: ['#60a5fa', '#a78bfa', '#f472b6'],
                  borderRadius: 10,
                },
              ],
            },
            options: {
              plugins: { legend: { display: false } },
              scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } },
              },
            },
          });
        }

        const doughnutCtx = document.getElementById('adminTeamworkChart');
        if (doughnutCtx) {
          new Chart(doughnutCtx, {
            type: 'doughnut',
            data: {
              labels: [
                '<%= t('admin.teamworkTasks') %>',
                '<%= t('admin.teamworkGroups') %>',
                '<%= t('admin.teamworkMembers') %>',
              ],
              datasets: [
                {
                  data: [stats.teamworkTasks, stats.teamworkGroups, stats.teamworkMembers],
                  backgroundColor: ['#38bdf8', '#22c55e', '#f97316'],
                },
              ],
            },
            options: {
              plugins: { legend: { position: 'bottom' } },
              cutout: '65%',
            },
          });
        }
      }

      renderAdminCharts();
    </script>
  </body>
</html>
