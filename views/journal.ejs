<!doctype html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Журнал • Studerria</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/journal.css" />
    <link rel="stylesheet" href="/css/design-system.css" />
  </head>
  <body class="theme-dark page-journal">
    <%- include('partials/topbar', { role, username, t, activePage: 'journal', pageTitle: 'Журнал' }) %>

    <main class="container py-4">
      <% if (messages && messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>
      <% if (undoGrade && canEditJournal) { %>
        <form method="POST" action="/journal/grades/restore" class="alert alert-warning d-flex flex-wrap gap-2 align-items-center">
          <input type="hidden" name="column_id" value="<%= undoGrade.column_id %>" />
          <input type="hidden" name="student_id" value="<%= undoGrade.student_id %>" />
          <span>Оцінку видалено. Можна скасувати протягом <strong id="journalUndoCountdown"><%= undoGrade.seconds_left %></strong> с.</span>
          <button class="btn btn-sm btn-outline-dark" type="submit" id="journalUndoDeleteBtn" data-undo-until="<%= undoGrade.until %>">
            Скасувати видалення
          </button>
        </form>
      <% } %>

      <section class="glass liquid-card p-3 mb-3">
        <form method="GET" action="/journal" class="row g-3 align-items-end">
          <% if (attendanceContext && attendanceContext.date) { %>
            <input type="hidden" name="attendance_date" value="<%= attendanceContext.date %>" />
          <% } %>
          <% if (attendanceContext && attendanceContext.class_number) { %>
            <input type="hidden" name="attendance_class_number" value="<%= attendanceContext.class_number %>" />
          <% } %>
          <div class="col-12 col-lg-7">
            <label class="form-label">Предмет</label>
            <select class="form-select" name="subject_id" onchange="this.form.submit()">
              <% if (!subjects || !subjects.length) { %>
                <option value="">Немає доступних предметів</option>
              <% } else { %>
                <% subjects.forEach(function(subject) { %>
                  <option value="<%= subject.subject_id %>" <%= selectedSubject && selectedSubject.subject_id === subject.subject_id ? 'selected' : '' %>>
                    <%= subject.subject_name %> · <%= subject.course_name %> · <%= subject.group_label %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          </div>
          <div class="col-12 col-lg-5">
            <% if (selectedSubject) { %>
              <div class="journal-subject-meta">
                <span class="status-chip status-chip--info"><%= selectedSubject.course_name %></span>
                <% if (selectedSemester && selectedSemester.title) { %>
                  <span class="status-chip status-chip--neutral"><%= selectedSemester.title %></span>
                <% } %>
                <span class="status-chip status-chip--neutral"><%= selectedSubject.group_label %></span>
                <% if (canManageAllSubjects) { %>
                  <span class="status-chip status-chip--success">Повний доступ</span>
                <% } %>
              </div>
            <% } %>
          </div>
        </form>
      </section>

      <% if (selectedSubject) { %>
        <%
          const attendance = attendanceContext || {};
          const attendanceRows = Array.isArray(attendance.rows) ? attendance.rows : [];
          const attendanceSummary = attendance.summary || {};
          const attendanceStatuses = Array.isArray(attendance.statuses) ? attendance.statuses : [];
          const attendanceStudentSummary = attendance.student_summary || null;
          const attendanceClassOptions = Array.isArray(attendance.class_options) ? attendance.class_options : [];
          const attendanceStatusChipClass = {
            present: 'status-chip--success',
            late: 'status-chip--warning',
            absent: 'status-chip--danger',
            excused: 'status-chip--info',
          };
          const attendanceStatusLabelMap = attendanceStatuses.reduce((acc, item) => {
            if (!item || !item.key) return acc;
            acc[item.key] = item.label || item.key;
            return acc;
          }, {});
          const attendanceStatusLabel = (key) => attendanceStatusLabelMap[key] || '—';
          const attendanceMarkedRate = attendanceSummary.students_total
            ? Math.round((Number(attendanceSummary.marked_total || 0) / Number(attendanceSummary.students_total || 1)) * 100)
            : 0;
          const gradingTypeRows = [
            { key: 'homework', label: 'ДЗ' },
            { key: 'seminar', label: 'Семінар' },
            { key: 'exam', label: 'Екзамен' },
            { key: 'credit', label: 'Залік' },
            { key: 'custom', label: 'Кастом' },
          ];
          let enabledWeightTotal = 0;
          gradingTypeRows.forEach((cfg) => {
            const enabled = Number(gradingSettings && gradingSettings[`${cfg.key}_enabled`]) === 1;
            const weight = Number(gradingSettings && gradingSettings[`${cfg.key}_weight_points`]);
            if (enabled && Number.isFinite(weight)) enabledWeightTotal += weight;
          });
        %>
        <section class="glass liquid-card p-3 mb-3">
          <details class="journal-attendance-details" open>
            <summary class="journal-attendance-summary">
              <div class="journal-attendance-summary-main">
                <span class="journal-attendance-summary-title"><%= canEditJournal ? 'Відвідуваність (MVP)' : 'Моя відвідуваність' %></span>
                <span class="journal-attendance-summary-subtitle">
                  <%= attendance.date || '-' %> · Пара <%= attendance.class_number || '-' %>
                </span>
              </div>
              <div class="journal-attendance-summary-chips">
                <span class="status-chip status-chip--success">Присутні: <%= Number(attendanceSummary.present || 0) %></span>
                <span class="status-chip status-chip--warning">Запізнення: <%= Number(attendanceSummary.late || 0) %></span>
                <span class="status-chip status-chip--danger">Відсутні: <%= Number(attendanceSummary.absent || 0) %></span>
                <span class="status-chip status-chip--info">Поважні: <%= Number(attendanceSummary.excused || 0) %></span>
                <span class="status-chip status-chip--neutral">Заповнено: <%= attendanceMarkedRate %>%</span>
              </div>
            </summary>
            <div class="journal-attendance-body">
              <form method="GET" action="/journal" class="row g-2 align-items-end mb-3">
                <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                <div class="col-12 col-md-4 col-xl-3">
                  <label class="form-label">Дата</label>
                  <input class="form-control form-control-sm" type="date" name="attendance_date" value="<%= attendance.date || '' %>" required />
                </div>
                <div class="col-12 col-md-4 col-xl-3">
                  <label class="form-label">Пара</label>
                  <select class="form-select form-select-sm" name="attendance_class_number">
                    <% attendanceClassOptions.forEach((item) => { %>
                      <option value="<%= item.value %>" <%= Number(attendance.class_number) === Number(item.value) ? 'selected' : '' %>><%= item.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="col-12 col-md-4 col-xl-3">
                  <button class="btn btn-outline-secondary btn-sm w-100" type="submit">Показати</button>
                </div>
              </form>

              <% if (canEditJournal) { %>
                <% if (!attendanceRows.length) { %>
                  <div class="text-muted">Немає студентів для відмітки відвідуваності в поточному доступі.</div>
                <% } else { %>
                  <form method="POST" action="/journal/attendance/save" id="journalAttendanceForm" autocomplete="off">
                    <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                    <input type="hidden" name="attendance_date" value="<%= attendance.date || '' %>" />
                    <input type="hidden" name="attendance_class_number" value="<%= attendance.class_number || '' %>" />
                    <input type="hidden" name="rows_json" id="journalAttendanceRowsJson" />
                    <div class="journal-attendance-table-wrap">
                      <table class="table table-sm align-middle mb-0 journal-attendance-table">
                        <thead>
                          <tr>
                            <th>ПІБ</th>
                            <th>Статус</th>
                            <th>Причина / коментар</th>
                            <th>Оновлено</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% attendanceRows.forEach((row) => { %>
                            <tr data-attendance-row data-student-id="<%= row.student_id %>">
                              <td>
                                <div class="fw-semibold"><%= row.full_name %></div>
                                <% if (row.group_number) { %>
                                  <div class="text-muted small">Група <%= row.group_number %></div>
                                <% } %>
                              </td>
                              <td>
                                <select class="form-select form-select-sm journal-attendance-status" data-attendance-status>
                                  <option value="">— Не відмічено —</option>
                                  <% attendanceStatuses.forEach((status) => { %>
                                    <option value="<%= status.key %>" <%= row.status === status.key ? 'selected' : '' %>><%= status.label %></option>
                                  <% }) %>
                                </select>
                              </td>
                              <td>
                                <input
                                  class="form-control form-control-sm"
                                  type="text"
                                  maxlength="<%= attendance.reason_max_length || 240 %>"
                                  value="<%= row.reason || '' %>"
                                  data-attendance-reason
                                  placeholder="Опц. причина відсутності або короткий коментар"
                                />
                              </td>
                              <td class="text-muted small">
                                <%= row.marked_at ? new Date(row.marked_at).toLocaleString('uk-UA') : '—' %>
                              </td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
                      <button class="btn btn-primary btn-sm" type="submit">Зберегти відвідуваність</button>
                      <span class="text-muted small">Порожній статус означає: запис буде прибрано.</span>
                    </div>
                  </form>
                <% } %>
              <% } else { %>
                <div class="row g-3">
                  <div class="col-12 col-lg-5">
                    <div class="journal-student-attendance-card">
                      <div class="small text-muted mb-1">Поточний зріз по предмету</div>
                      <div class="d-flex flex-wrap gap-2">
                        <span class="status-chip status-chip--success">Присутні: <%= Number(attendanceStudentSummary ? attendanceStudentSummary.present : attendanceSummary.present || 0) %></span>
                        <span class="status-chip status-chip--warning">Запізнення: <%= Number(attendanceStudentSummary ? attendanceStudentSummary.late : attendanceSummary.late || 0) %></span>
                        <span class="status-chip status-chip--danger">Відсутні: <%= Number(attendanceStudentSummary ? attendanceStudentSummary.absent : attendanceSummary.absent || 0) %></span>
                        <span class="status-chip status-chip--info">Поважні: <%= Number(attendanceStudentSummary ? attendanceStudentSummary.excused : attendanceSummary.excused || 0) %></span>
                        <% if (attendanceStudentSummary && Number.isFinite(Number(attendanceStudentSummary.attendance_rate))) { %>
                          <span class="status-chip status-chip--neutral">Відвідуваність: <%= attendanceStudentSummary.attendance_rate %>%</span>
                        <% } %>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-lg-7">
                    <div class="journal-attendance-table-wrap">
                      <table class="table table-sm align-middle mb-0 journal-attendance-table">
                        <thead>
                          <tr>
                            <th>Дата</th>
                            <th>Пара</th>
                            <th>Статус</th>
                            <th>Причина</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% const studentRecentRecords = attendanceStudentSummary && Array.isArray(attendanceStudentSummary.recent_records)
                            ? attendanceStudentSummary.recent_records
                            : []; %>
                          <% if (!studentRecentRecords.length) { %>
                            <tr>
                              <td colspan="4" class="text-muted">Ще немає записів відвідуваності.</td>
                            </tr>
                          <% } %>
                          <% studentRecentRecords.forEach((record) => { %>
                            <% const statusKey = record.status || ''; %>
                            <tr>
                              <td><%= record.class_date || '-' %></td>
                              <td><%= record.class_number || '-' %></td>
                              <td>
                                <span class="status-chip <%= attendanceStatusChipClass[statusKey] || 'status-chip--neutral' %>">
                                  <%= attendanceStatusLabel(statusKey) %>
                                </span>
                              </td>
                              <td class="small text-muted"><%= record.reason || '—' %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </details>
        </section>
        <section class="glass liquid-card p-3 mb-3">
          <details class="journal-grading-details">
            <summary class="journal-grading-summary">
              <div class="journal-grading-summary-main">
                <span class="journal-grading-summary-title"><%= canEditJournal ? 'Налаштування системи оцінювання' : 'Як формується оцінка' %></span>
                <span class="journal-grading-summary-subtitle">Натисніть, щоб <span class="journal-grading-summary-open-text">розгорнути</span><span class="journal-grading-summary-close-text">згорнути</span></span>
              </div>
              <div class="journal-grading-summary-chips">
                <span class="status-chip status-chip--info">Сума внесків (активні): <%= enabledWeightTotal.toFixed(2).replace(/\.00$/, '') %> / 100</span>
                <span class="status-chip status-chip--neutral">Фінал: 100 (фіксовано)</span>
              </div>
            </summary>
            <div class="journal-grading-body">
              <% if (canEditJournal) { %>
                <div class="row g-3">
                  <div class="col-12 col-xl-8">
                    <h6 class="mb-2">Налаштування системи оцінювання</h6>
                    <form method="POST" action="/journal/config/save" class="row g-3" id="journalConfigForm">
                      <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                      <div class="col-12">
                        <div class="row g-2 align-items-end">
                          <div class="col-12 col-lg-5">
                            <label class="form-label" for="journalPresetSelect">Швидкий пресет</label>
                            <select class="form-select form-select-sm" id="journalPresetSelect">
                              <option value="">Оберіть шаблон...</option>
                              <option value="balanced">Балансований (20/20/40/10/10)</option>
                              <option value="exam_focus">Фокус на екзамені (15/15/60/10/0)</option>
                              <option value="continuous">Безперервний контроль (35/35/20/10/0)</option>
                              <option value="homework_only">Лише ДЗ (100/0/0/0/0)</option>
                            </select>
                          </div>
                          <div class="col-12 col-lg-7 d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" id="journalApplyPresetBtn">Застосувати пресет</button>
                            <button class="btn btn-sm btn-outline-info" type="button" id="journalNormalizeWeightsBtn">Авто-розподіл ваг до 100</button>
                          </div>
                        </div>
                      </div>
                      <div class="col-12 journal-config-table-wrap">
                        <table class="table table-sm journal-config-table align-middle mb-0">
                          <thead>
                            <tr>
                              <th>Тип</th>
                              <th class="text-center">Увімк.</th>
                              <th>Бал за 1 роботу</th>
                              <th>Внесок у фінал / 100</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% gradingTypeRows.forEach(function(cfg) { %>
                              <% const enabledField = `${cfg.key}_enabled`; %>
                              <% const maxField = `${cfg.key}_max_points`; %>
                              <% const weightField = `${cfg.key}_weight_points`; %>
                              <% const enabledValue = Number(gradingSettings && gradingSettings[enabledField]) === 1; %>
                              <tr>
                                <td><strong><%= cfg.label %></strong></td>
                                <td class="text-center">
                                  <input type="hidden" name="<%= enabledField %>" value="0" />
                                  <input
                                    class="form-check-input journal-enabled-input"
                                    type="checkbox"
                                    name="<%= enabledField %>"
                                    value="1"
                                    data-type-key="<%= cfg.key %>"
                                    <%= enabledValue ? 'checked' : '' %>
                                  />
                                </td>
                                <td>
                                  <input
                                    class="form-control form-control-sm journal-max-input"
                                    type="number"
                                    step="0.01"
                                    min="0.01"
                                    name="<%= maxField %>"
                                    data-type-key="<%= cfg.key %>"
                                    value="<%= gradingSettings[maxField] %>"
                                    required
                                  />
                                </td>
                                <td>
                                  <input
                                    class="form-control form-control-sm journal-weight-input"
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    name="<%= weightField %>"
                                    data-type-key="<%= cfg.key %>"
                                    value="<%= gradingSettings[weightField] %>"
                                    required
                                  />
                                </td>
                              </tr>
                            <% }); %>
                          </tbody>
                        </table>
                      </div>
                      <div class="col-12 d-flex flex-wrap gap-2 align-items-center">
                        <span class="status-chip status-chip--info">Сума внесків (активні): <span id="journalEnabledWeightTotal"><%= enabledWeightTotal.toFixed(2).replace(/\.00$/, '') %></span> / 100</span>
                        <span class="status-chip status-chip--neutral">Фінал: 100 (фіксовано)</span>
                      </div>
                      <div class="col-12">
                        <button class="btn btn-primary" type="submit">Зберегти систему</button>
                      </div>
                    </form>
                  </div>
                  <div class="col-12 col-xl-4">
                    <h6 class="mb-2">Нова колонка</h6>
                    <form method="POST" action="/journal/columns/create" class="row g-2">
                      <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                      <div class="col-12">
                        <label class="form-label">Назва</label>
                        <input class="form-control" name="title" maxlength="140" required />
                      </div>
                      <div class="col-6">
                        <label class="form-label">Тип</label>
                        <select class="form-select" name="column_type">
                          <option value="custom">Кастом</option>
                          <option value="seminar">Семінар</option>
                          <option value="exam">Екзамен</option>
                          <option value="credit">Залік</option>
                          <option value="homework">ДЗ</option>
                        </select>
                      </div>
                      <div class="col-6">
                        <label class="form-label">Макс. бал</label>
                        <input class="form-control" type="number" step="0.01" min="0.01" name="max_points" />
                      </div>
                      <div class="col-12">
                        <input type="hidden" name="include_in_final" value="0" />
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" id="journalIncludeFinal" name="include_in_final" value="1" checked />
                          <label class="form-check-label" for="journalIncludeFinal">Враховувати у фінальному розрахунку</label>
                        </div>
                      </div>
                      <div class="col-12">
                        <button class="btn btn-outline-primary w-100" type="submit">Додати колонку</button>
                      </div>
                    </form>
                  </div>
                </div>
              <% } else { %>
                <div class="journal-grading-student-view">
                  <p class="text-muted mb-2">Нижче показано, як рахується фінальний бал для цього предмета.</p>
                  <div class="journal-config-table-wrap">
                    <table class="table table-sm journal-config-table journal-config-table--readonly align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Вид діяльності</th>
                          <th>Бал за 1 роботу</th>
                          <th>Внесок у фінал / 100</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% gradingTypeRows.forEach(function(cfg) { %>
                          <% const enabledField = `${cfg.key}_enabled`; %>
                          <% const maxField = `${cfg.key}_max_points`; %>
                          <% const weightField = `${cfg.key}_weight_points`; %>
                          <% const enabledValue = Number(gradingSettings && gradingSettings[enabledField]) === 1; %>
                          <% const maxValueRaw = Number(gradingSettings && gradingSettings[maxField]); %>
                          <% const maxValue = Number.isFinite(maxValueRaw) ? maxValueRaw.toFixed(2).replace(/\.00$/, '') : '0'; %>
                          <% const weightValueRaw = Number(gradingSettings && gradingSettings[weightField]); %>
                          <% const weightValue = Number.isFinite(weightValueRaw) ? weightValueRaw.toFixed(2).replace(/\.00$/, '') : '0'; %>
                          <tr class="<%= enabledValue ? '' : 'is-disabled' %>">
                            <td><strong><%= cfg.label %></strong></td>
                            <td><%= maxValue %></td>
                            <td>
                              <% if (enabledValue) { %>
                                <span class="status-chip status-chip--info"><%= weightValue %></span>
                              <% } else { %>
                                <span class="status-chip status-chip--neutral">Вимкнено</span>
                              <% } %>
                            </td>
                          </tr>
                        <% }); %>
                      </tbody>
                    </table>
                  </div>
                  <div class="d-flex flex-wrap gap-2 align-items-center mt-2">
                    <span class="status-chip status-chip--info">Сума внесків (активні): <%= enabledWeightTotal.toFixed(2).replace(/\.00$/, '') %> / 100</span>
                    <span class="status-chip status-chip--neutral">Фінал: 100 (фіксовано)</span>
                  </div>
                </div>
              <% } %>
            </div>
          </details>
        </section>
      <% } %>

      <section class="glass liquid-card p-3">
        <% if (!selectedSubject) { %>
          <div class="text-muted">Предмет не обрано.</div>
        <% } else if (!columns || !columns.length) { %>
          <div class="text-muted">Поки що немає колонок у журналі. Додайте завдання у розкладі або створіть ручну колонку.</div>
        <% } else if (!journalRows || !journalRows.length) { %>
          <div class="text-muted">Немає студентів у цьому предметі для поточного доступу.</div>
        <% } else { %>
          <div class="journal-table-wrap">
            <table class="table journal-table mb-0 align-middle">
              <thead>
                <tr>
                  <th class="journal-th-student">ПІБ</th>
                  <% columns.forEach(function(column) { %>
                    <th class="journal-th-column">
                      <div class="journal-col-title"><%= column.title %></div>
                      <div class="journal-col-meta">
                        <span><%= Number(column.max_points).toFixed(2).replace(/\.00$/, '') %> б.</span>
                        <% if (column.is_credit) { %>
                          <span class="status-chip status-chip--warning">Залік</span>
                        <% } %>
                        <% if (!column.include_in_final) { %>
                          <span class="status-chip status-chip--neutral">Не враховується</span>
                        <% } %>
                        <% if (column.is_locked) { %>
                          <span class="status-chip status-chip--danger">Заблоковано</span>
                        <% } else { %>
                          <span class="status-chip status-chip--success">Відкрито</span>
                        <% } %>
                        <% if (column.source_homework_id && column.homework_meeting_url) { %>
                          <span class="status-chip status-chip--info">Meet</span>
                        <% } %>
                      </div>
                      <% if (canEditJournal) { %>
                        <div class="journal-col-actions">
                          <form method="POST" action="/journal/columns/final-toggle" class="journal-column-toggle-form">
                            <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                            <input type="hidden" name="column_id" value="<%= column.id %>" />
                            <input type="hidden" name="include_in_final" value="<%= column.include_in_final ? 0 : 1 %>" />
                            <button
                              class="btn btn-sm journal-col-action-btn <%= column.include_in_final ? 'btn-outline-warning' : 'btn-outline-success' %>"
                              type="submit"
                              title="<%= column.include_in_final ? 'Виключити з фіналу' : 'Врахувати у фіналі' %>"
                            >
                              <%= column.include_in_final ? 'Фінал-' : 'Фінал+' %>
                            </button>
                          </form>
                          <form method="POST" action="/journal/columns/lock-toggle" class="journal-column-toggle-form">
                            <input type="hidden" name="subject_id" value="<%= selectedSubject.subject_id %>" />
                            <input type="hidden" name="column_id" value="<%= column.id %>" />
                            <input type="hidden" name="is_locked" value="<%= column.is_locked ? 0 : 1 %>" />
                            <button
                              class="btn btn-sm journal-col-action-btn <%= column.is_locked ? 'btn-outline-success' : 'btn-outline-danger' %>"
                              type="submit"
                              title="<%= column.is_locked ? 'Розблокувати колонку' : 'Заблокувати колонку' %>"
                            >
                              <%= column.is_locked ? 'Unlock' : 'Lock' %>
                            </button>
                          </form>
                          <button
                            class="btn btn-sm btn-outline-primary journal-col-action-btn journal-bulk-open-btn"
                            type="button"
                            data-column-id="<%= column.id %>"
                            data-column-title="<%= column.title %>"
                            data-column-max="<%= Number(column.max_points).toFixed(2) %>"
                            data-column-locked="<%= column.is_locked ? 1 : 0 %>"
                            title="Масове оцінювання"
                          >
                            Bulk
                          </button>
                        </div>
                      <% } %>
                    </th>
                  <% }); %>
                  <th class="journal-th-final final-col">Підсумок / 100</th>
                </tr>
              </thead>
              <tbody>
                <% journalRows.forEach(function(row, rowIndex) { %>
                  <tr>
                    <td class="journal-student-cell">
                      <div class="journal-student-name"><%= row.student.full_name %></div>
                      <div class="journal-student-meta">Група <%= row.student.group_number %></div>
                    </td>
                    <% row.cells.forEach(function(cell, cellIndex) { %>
                      <% const cellColumn = columns[cellIndex] || null; %>
                      <% const lockedClass = cellColumn && cellColumn.is_locked ? 'is-locked' : ''; %>
                      <% const statusClass = cell.status === 'on_time' ? 'is-on-time' : cell.status === 'late' ? 'is-late' : cell.status === 'manual' ? 'is-manual' : 'is-missing'; %>
                      <td class="journal-cell">
                        <button
                          class="journal-cell-btn <%= statusClass %> <%= lockedClass %>"
                          type="button"
                          data-column-id="<%= cell.column_id %>"
                          data-student-id="<%= cell.student_id %>"
                          data-row-index="<%= rowIndex %>"
                          data-column-index="<%= cellIndex %>"
                          data-can-open="1"
                        >
                          <span class="journal-cell-score"><%= Number.isFinite(cell.score) ? String(cell.score).replace(/\.00$/, '') : '—' %></span>
                        </button>
                      </td>
                    <% }); %>
                    <td class="journal-final-cell final-col">
                      <% const weightedEarned = Number.isFinite(Number(row.weighted_earned)) ? Number(row.weighted_earned) : Number(row.final_score || 0); %>
                      <div class="journal-final-value"><%= row.final_score.toFixed(2).replace(/\.00$/, '') %></div>
                      <div class="journal-final-meta"><%= weightedEarned.toFixed(2).replace(/\.00$/, '') %> / 100 · сирі <%= row.raw_earned.toFixed(2).replace(/\.00$/, '') %> / <%= row.raw_max.toFixed(2).replace(/\.00$/, '') %></div>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>
    </main>

    <%- include('partials/app-footer') %>
    <%- include('partials/mobile-menu-modal', { role, t, activePage: 'journal' }) %>
    <%- include('partials/changelog-modal') %>

    <div class="modal fade" id="journalCellModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="journalCellTitle">Оцінювання</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <div class="text-muted small mb-1">Студент</div>
              <div class="fw-semibold" id="journalCellStudent">-</div>
            </div>
            <div class="mb-3">
              <div class="text-muted small mb-1">Статус здачі</div>
              <span class="status-chip status-chip--neutral" id="journalCellStatus">-</span>
            </div>
            <div class="alert alert-warning d-none py-2" id="journalLockedNotice">
              Колонка заблокована: редагування оцінок вимкнено.
            </div>
            <div id="journalSubmissionBox" class="journal-submission-box mb-4">
              <div class="text-muted">Здача відсутня.</div>
            </div>
            <section id="journalRetakeSection" class="journal-retake-section mb-4">
              <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
                <div>
                  <div class="text-muted small mb-1">Перездачі / відпрацювання</div>
                  <div class="small text-muted">Спроби, дедлайни, статус і внесення у фінальний бал.</div>
                </div>
              </div>
              <div id="journalRetakeList" class="journal-retake-list">
                <div class="text-muted small">Спроб поки немає.</div>
              </div>
              <% if (canEditJournal) { %>
                <form id="journalRetakeCreateForm" method="POST" action="/journal/retakes/create" class="journal-retake-create-form mt-3" autocomplete="off">
                  <input type="hidden" name="column_id" id="journalRetakeCreateColumnId" />
                  <input type="hidden" name="student_id" id="journalRetakeCreateStudentId" />
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label form-label-sm mb-1">Тип</label>
                      <select class="form-select form-select-sm" name="kind" id="journalRetakeCreateKind">
                        <option value="retake">Перездача</option>
                        <option value="makeup">Відпрацювання</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label form-label-sm mb-1">Дедлайн (опц.)</label>
                      <input class="form-control form-control-sm" type="date" name="due_date" id="journalRetakeCreateDueDate" />
                    </div>
                    <div class="col-12 col-md-4">
                      <button class="btn btn-sm btn-outline-info w-100" type="submit" id="journalRetakeCreateSubmitBtn">Додати спробу</button>
                    </div>
                  </div>
                  <div class="mt-2">
                    <label class="form-label form-label-sm mb-1">Нотатка (опц.)</label>
                    <textarea class="form-control form-control-sm" name="note" rows="2" maxlength="1200" placeholder="Що саме потрібно перездати / відпрацювати"></textarea>
                  </div>
                </form>
              <% } %>
            </section>
            <section id="journalAppealSection" class="journal-appeal-section mb-4">
              <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-2">
                <div>
                  <div class="text-muted small mb-1">Апеляції оцінок</div>
                  <div class="small text-muted">Статус розгляду, SLA відповіді та історія рішення.</div>
                </div>
              </div>
              <div id="journalAppealList" class="journal-appeal-list">
                <div class="text-muted small">Апеляцій поки немає.</div>
              </div>
              <% if (!canEditJournal) { %>
                <form id="journalAppealCreateForm" method="POST" action="/journal/appeals/create" class="journal-appeal-create-form mt-3" autocomplete="off">
                  <input type="hidden" name="column_id" id="journalAppealCreateColumnId" />
                  <input type="hidden" name="student_id" id="journalAppealCreateStudentId" />
                  <div class="row g-2 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label form-label-sm mb-1">Бажаний бал (опц.)</label>
                      <input class="form-control form-control-sm" type="number" step="0.01" min="0" name="requested_score" id="journalAppealCreateRequestedScore" />
                    </div>
                    <div class="col-12 col-md-8">
                      <label class="form-label form-label-sm mb-1">Причина апеляції</label>
                      <textarea
                        class="form-control form-control-sm"
                        name="reason"
                        id="journalAppealCreateReason"
                        rows="2"
                        maxlength="2400"
                        required
                        placeholder="Опишіть, чому оцінку варто переглянути"
                      ></textarea>
                    </div>
                  </div>
                  <div class="d-flex justify-content-end mt-2">
                    <button class="btn btn-sm btn-outline-warning" type="submit" id="journalAppealCreateSubmitBtn">Подати апеляцію</button>
                  </div>
                </form>
              <% } %>
            </section>
            <form id="journalGradeForm" method="POST" action="/journal/grades/save" autocomplete="off">
              <input type="hidden" name="column_id" id="journalGradeColumnId" />
              <input type="hidden" name="student_id" id="journalGradeStudentId" />
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label">Бал</label>
                  <input class="form-control" type="number" step="0.01" min="0" name="score" id="journalGradeScore" required />
                </div>
                <div class="col-12 col-md-8">
                  <label class="form-label">Коментар (опц.)</label>
                  <textarea class="form-control" name="teacher_comment" id="journalGradeComment" rows="2" maxlength="2000"></textarea>
                  <% if (canEditJournal) { %>
                    <div class="journal-feedback-templates mt-2">
                      <span class="text-muted small">Шаблони:</span>
                      <button class="btn btn-sm btn-outline-secondary journal-feedback-template-btn" type="button" data-feedback-template="Сильна робота: чітка структура, аргументи і висновок. Так тримати.">Сильна робота</button>
                      <button class="btn btn-sm btn-outline-secondary journal-feedback-template-btn" type="button" data-feedback-template="Добрий старт, але потрібно посилити аргументацію фактами та прикладами.">Посилити аргументи</button>
                      <button class="btn btn-sm btn-outline-secondary journal-feedback-template-btn" type="button" data-feedback-template="Потрібно більше конкретики: додай чіткі тези, приклади і короткий висновок.">Більше конкретики</button>
                      <button class="btn btn-sm btn-outline-secondary journal-feedback-template-btn" type="button" data-feedback-clear="1">Очистити</button>
                    </div>
                  <% } %>
                </div>
              </div>
              <% if (canEditJournal) { %>
                <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
                  <button class="btn btn-primary" type="submit">Зберегти оцінку</button>
                  <button class="btn btn-outline-secondary" type="button" id="journalPrevCellBtn">Попередня клітинка</button>
                  <button class="btn btn-outline-secondary" type="button" id="journalNextCellBtn">Наступна клітинка</button>
                  <span class="text-muted small">Гарячі клавіші: `Ctrl+Enter` зберегти, `Alt+←/→/↑/↓` навігація</span>
                </div>
              <% } %>
            </form>
            <form id="journalGradeDeleteForm" method="POST" action="/journal/grades/delete" class="mt-2" autocomplete="off">
              <input type="hidden" name="column_id" id="journalGradeDeleteColumnId" />
              <input type="hidden" name="student_id" id="journalGradeDeleteStudentId" />
              <% if (canEditJournal) { %>
                <button class="btn btn-outline-danger" type="submit" id="journalGradeDeleteBtn" disabled>Видалити оцінку</button>
              <% } %>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="journalBulkModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form method="POST" action="/journal/grades/bulk-save" id="journalBulkForm" autocomplete="off">
            <div class="modal-header">
              <h5 class="modal-title">Масове оцінювання</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="subject_id" value="<%= selectedSubject ? selectedSubject.subject_id : '' %>" />
              <input type="hidden" name="column_id" id="journalBulkColumnId" />
              <input type="hidden" name="entries_json" id="journalBulkEntriesJson" />
              <div class="mb-2">
                <div class="text-muted small">Колонка</div>
                <div class="fw-semibold" id="journalBulkColumnTitle">-</div>
              </div>
              <div class="alert alert-warning py-2 d-none" id="journalBulkLockedAlert">
                Колонка заблокована. Масове оцінювання недоступне.
              </div>
              <div class="text-muted small mb-2">
                Вставте значення з Excel у порядку студентів у таблиці. Формат рядка: `бал` або `бал[TAB]коментар`.
              </div>
              <textarea
                class="form-control"
                id="journalBulkPaste"
                rows="8"
                placeholder="90&#9;Вчасно&#10;75&#9;Потрібно допрацювати&#10;100"
              ></textarea>
              <div class="mt-3">
                <div class="text-muted small mb-1" id="journalBulkPreviewMeta">Попередній перегляд: 0 записів</div>
                <div class="journal-bulk-preview" id="journalBulkPreview"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Скасувати</button>
              <button class="btn btn-primary" type="submit" id="journalBulkSubmitBtn">Зберегти масово</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const themeToggles = document.querySelectorAll('.theme-toggle');
      const savedTheme = localStorage.getItem('ui-theme') || 'theme-dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      themeToggles.forEach((btn) => {
        btn.textContent = savedTheme === 'theme-dark' ? btn.dataset.lightLabel : btn.dataset.darkLabel;
        btn.addEventListener('click', () => {
          const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-light', 'theme-dark');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggles.forEach((b) => {
            b.textContent = next === 'theme-dark' ? b.dataset.lightLabel : b.dataset.darkLabel;
          });
        });
      });

      const canEditJournal = <%- canEditJournal ? 'true' : 'false' %>;
      const queryParams = new URLSearchParams(window.location.search);
      const autoOpenColumnId = Number(queryParams.get('open_column_id') || 0);
      const autoOpenStudentId = Number(queryParams.get('open_student_id') || 0);
      let pendingPrefillComment = String(queryParams.get('prefill_comment') || '').trim().slice(0, 2000);
      const journalColumnsData = <%- JSON.stringify((columns || []).map(function(column) {
        return {
          id: Number(column.id),
          title: String(column.title || ''),
          max_points: Number(column.max_points || 0),
          is_locked: Boolean(column.is_locked),
        };
      })).replace(/</g, '\\u003c') %>;
      const journalStudentsData = <%- JSON.stringify((journalRows || []).map(function(row) {
        return {
          id: Number(row.student.id),
          full_name: String(row.student.full_name || ''),
          group_number: Number(row.student.group_number || 0),
        };
      })).replace(/</g, '\\u003c') %>;

      const modalEl = document.getElementById('journalCellModal');
      const modal = modalEl && window.bootstrap ? new window.bootstrap.Modal(modalEl) : null;
      const statusEl = document.getElementById('journalCellStatus');
      const submissionBox = document.getElementById('journalSubmissionBox');
      const titleEl = document.getElementById('journalCellTitle');
      const studentEl = document.getElementById('journalCellStudent');
      const scoreEl = document.getElementById('journalGradeScore');
      const commentEl = document.getElementById('journalGradeComment');
      const columnInput = document.getElementById('journalGradeColumnId');
      const studentInput = document.getElementById('journalGradeStudentId');
      const gradeForm = document.getElementById('journalGradeForm');
      const feedbackTemplateButtons = Array.from(document.querySelectorAll('.journal-feedback-template-btn'));
      const deleteForm = document.getElementById('journalGradeDeleteForm');
      const deleteColumnInput = document.getElementById('journalGradeDeleteColumnId');
      const deleteStudentInput = document.getElementById('journalGradeDeleteStudentId');
      const deleteBtn = document.getElementById('journalGradeDeleteBtn');
      const lockedNotice = document.getElementById('journalLockedNotice');
      const prevCellBtn = document.getElementById('journalPrevCellBtn');
      const nextCellBtn = document.getElementById('journalNextCellBtn');
      const retakeSectionEl = document.getElementById('journalRetakeSection');
      const retakeListEl = document.getElementById('journalRetakeList');
      const retakeCreateForm = document.getElementById('journalRetakeCreateForm');
      const retakeCreateColumnInput = document.getElementById('journalRetakeCreateColumnId');
      const retakeCreateStudentInput = document.getElementById('journalRetakeCreateStudentId');
      const retakeCreateSubmitBtn = document.getElementById('journalRetakeCreateSubmitBtn');
      const appealSectionEl = document.getElementById('journalAppealSection');
      const appealListEl = document.getElementById('journalAppealList');
      const appealCreateForm = document.getElementById('journalAppealCreateForm');
      const appealCreateColumnInput = document.getElementById('journalAppealCreateColumnId');
      const appealCreateStudentInput = document.getElementById('journalAppealCreateStudentId');
      const appealCreateRequestedScore = document.getElementById('journalAppealCreateRequestedScore');
      const appealCreateReason = document.getElementById('journalAppealCreateReason');
      const appealCreateSubmitBtn = document.getElementById('journalAppealCreateSubmitBtn');

      const bulkModalEl = document.getElementById('journalBulkModal');
      const bulkModal = bulkModalEl && window.bootstrap ? new window.bootstrap.Modal(bulkModalEl) : null;
      const bulkForm = document.getElementById('journalBulkForm');
      const bulkColumnIdInput = document.getElementById('journalBulkColumnId');
      const bulkEntriesInput = document.getElementById('journalBulkEntriesJson');
      const bulkColumnTitleEl = document.getElementById('journalBulkColumnTitle');
      const bulkPasteEl = document.getElementById('journalBulkPaste');
      const bulkPreviewEl = document.getElementById('journalBulkPreview');
      const bulkPreviewMetaEl = document.getElementById('journalBulkPreviewMeta');
      const bulkSubmitBtn = document.getElementById('journalBulkSubmitBtn');
      const bulkLockedAlert = document.getElementById('journalBulkLockedAlert');
      const attendanceForm = document.getElementById('journalAttendanceForm');
      const attendanceRowsJsonInput = document.getElementById('journalAttendanceRowsJson');
      const attendanceRowEls = Array.from(document.querySelectorAll('[data-attendance-row]'));

      let currentCellColumnId = 0;
      let currentCellStudentId = 0;
      let currentCellLocked = false;
      let bulkCurrentMax = 0;
      let bulkCurrentLocked = false;

      const formatNumber = (value) => {
        const num = Number(value || 0);
        if (!Number.isFinite(num)) return '0';
        return num.toFixed(2).replace(/\.00$/, '');
      };
      const escapeHtml = (value) => String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
      const formatDateTime = (value) => {
        if (!value) return '';
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return String(value);
        return parsed.toLocaleString('uk-UA');
      };
      const getRetakeStatusChipClass = (statusKey) => {
        const key = String(statusKey || '').toLowerCase();
        if (key === 'graded') return 'status-chip--success';
        if (key === 'submitted') return 'status-chip--info';
        if (key === 'cancelled') return 'status-chip--danger';
        return 'status-chip--warning';
      };
      const getAppealStatusChipClass = (statusKey) => {
        const key = String(statusKey || '').toLowerCase();
        if (key === 'approved') return 'status-chip--success';
        if (key === 'rejected') return 'status-chip--danger';
        if (key === 'in_review') return 'status-chip--info';
        return 'status-chip--warning';
      };

      const findColumnIndex = (columnId) => journalColumnsData.findIndex((column) => Number(column.id) === Number(columnId));
      const findStudentIndex = (studentId) => journalStudentsData.findIndex((student) => Number(student.id) === Number(studentId));

      const refreshWeightSummary = () => {
        const enabledInputs = Array.from(document.querySelectorAll('.journal-enabled-input'));
        const totalEl = document.getElementById('journalEnabledWeightTotal');
        if (!enabledInputs.length || !totalEl) return;
        let sum = 0;
        enabledInputs.forEach((checkbox) => {
          if (!checkbox.checked) return;
          const typeKey = checkbox.dataset.typeKey || '';
          const weightInput = document.querySelector(`.journal-weight-input[data-type-key="${typeKey}"]`);
          const weight = Number(String(weightInput ? weightInput.value : '0').replace(',', '.'));
          if (Number.isFinite(weight) && weight > 0) sum += weight;
        });
        totalEl.textContent = formatNumber(sum);
      };

      const applyGradingPreset = (presetKey) => {
        const presets = {
          balanced: {
            homework: { enabled: 1, max: 10, weight: 20 },
            seminar: { enabled: 1, max: 10, weight: 20 },
            exam: { enabled: 1, max: 40, weight: 40 },
            credit: { enabled: 1, max: 20, weight: 10 },
            custom: { enabled: 1, max: 10, weight: 10 },
          },
          exam_focus: {
            homework: { enabled: 1, max: 10, weight: 15 },
            seminar: { enabled: 1, max: 10, weight: 15 },
            exam: { enabled: 1, max: 40, weight: 60 },
            credit: { enabled: 1, max: 20, weight: 10 },
            custom: { enabled: 0, max: 10, weight: 0 },
          },
          continuous: {
            homework: { enabled: 1, max: 15, weight: 35 },
            seminar: { enabled: 1, max: 15, weight: 35 },
            exam: { enabled: 1, max: 30, weight: 20 },
            credit: { enabled: 1, max: 20, weight: 10 },
            custom: { enabled: 0, max: 10, weight: 0 },
          },
          homework_only: {
            homework: { enabled: 1, max: 15, weight: 100 },
            seminar: { enabled: 0, max: 10, weight: 0 },
            exam: { enabled: 0, max: 40, weight: 0 },
            credit: { enabled: 0, max: 20, weight: 0 },
            custom: { enabled: 0, max: 10, weight: 0 },
          },
        };
        const preset = presets[presetKey];
        if (!preset) return;
        Object.keys(preset).forEach((typeKey) => {
          const cfg = preset[typeKey];
          const enabledInput = document.querySelector(`.journal-enabled-input[data-type-key="${typeKey}"]`);
          const maxInput = document.querySelector(`.journal-max-input[data-type-key="${typeKey}"]`);
          const weightInput = document.querySelector(`.journal-weight-input[data-type-key="${typeKey}"]`);
          if (enabledInput) enabledInput.checked = cfg.enabled === 1;
          if (maxInput && Number.isFinite(Number(cfg.max)) && Number(cfg.max) > 0) maxInput.value = String(cfg.max);
          if (weightInput && Number.isFinite(Number(cfg.weight))) weightInput.value = String(cfg.weight);
        });
        refreshWeightSummary();
      };

      const normalizeWeightsToHundred = () => {
        const enabledInputs = Array.from(document.querySelectorAll('.journal-enabled-input'));
        const active = enabledInputs
          .filter((input) => input.checked)
          .map((input) => {
            const typeKey = input.dataset.typeKey || '';
            const weightInput = document.querySelector(`.journal-weight-input[data-type-key="${typeKey}"]`);
            const value = Number(String(weightInput ? weightInput.value : '0').replace(',', '.'));
            return {
              typeKey,
              weightInput,
              value: Number.isFinite(value) && value >= 0 ? value : 0,
            };
          })
          .filter((item) => item.weightInput);
        if (!active.length) return;

        const sum = active.reduce((acc, item) => acc + item.value, 0);
        if (sum <= 0) {
          const even = Math.round((100 / active.length) * 100) / 100;
          active.forEach((item) => {
            item.weightInput.value = String(even);
          });
          const current = active.reduce((acc, item) => acc + Number(item.weightInput.value), 0);
          const delta = Math.round((100 - current) * 100) / 100;
          if (Math.abs(delta) > 0.0001) {
            active[0].weightInput.value = String(Math.max(0, Number(active[0].weightInput.value) + delta));
          }
          refreshWeightSummary();
          return;
        }

        const normalized = active.map((item) => ({
          ...item,
          scaled: Math.round(((item.value * 100) / sum) * 100) / 100,
        }));
        const current = normalized.reduce((acc, item) => acc + item.scaled, 0);
        const delta = Math.round((100 - current) * 100) / 100;
        if (Math.abs(delta) > 0.0001) {
          normalized[0].scaled = Math.max(0, normalized[0].scaled + delta);
        }
        normalized.forEach((item) => {
          item.weightInput.value = String(Math.round(item.scaled * 100) / 100);
        });
        refreshWeightSummary();
      };

      function setStatusLabel(status) {
        const value = String(status || '').toLowerCase();
        if (value === 'on_time') {
          statusEl.className = 'status-chip status-chip--success';
          statusEl.textContent = 'Здано вчасно';
          return;
        }
        if (value === 'late') {
          statusEl.className = 'status-chip status-chip--warning';
          statusEl.textContent = 'Здано із запізненням';
          return;
        }
        if (value === 'manual') {
          statusEl.className = 'status-chip status-chip--info';
          statusEl.textContent = 'Ручна колонка';
          return;
        }
        statusEl.className = 'status-chip status-chip--neutral';
        statusEl.textContent = 'Ще не здано';
      }

      function renderSubmission(submission, column) {
        const parts = [];
        if (column && column.homework_description) {
          parts.push(`<div class="mb-2"><strong>Завдання:</strong> ${column.homework_description}</div>`);
        }
        if (column && column.due_date) {
          parts.push(`<div class="mb-2 text-muted small">Дедлайн: ${column.due_date}</div>`);
        }
        if (submission && submission.submitted_at) {
          parts.push(`<div class="mb-2 text-muted small">Здано: ${new Date(submission.submitted_at).toLocaleString('uk-UA')}</div>`);
        }
        if (submission && submission.submission_text) {
          parts.push(`<div class="mb-2"><strong>Текст:</strong><div class="journal-submission-text">${submission.submission_text}</div></div>`);
        }
        if (submission && submission.link_url) {
          parts.push(`<div class="mb-2"><a href="${submission.link_url}" target="_blank" rel="noopener">Відкрити посилання</a></div>`);
        }
        if (submission && submission.file_path) {
          const fileLabel = submission.file_name || 'Файл';
          parts.push(`<div class="mb-2"><a href="${submission.file_path}" target="_blank" rel="noopener">${fileLabel}</a></div>`);
        }
        if (!parts.length) {
          submissionBox.innerHTML = '<div class="text-muted">Здача відсутня.</div>';
          return;
        }
        submissionBox.innerHTML = parts.join('');
      }

      function renderRetakes(data) {
        if (!retakeSectionEl || !retakeListEl) return;
        const attempts = Array.isArray(data && data.retake_attempts) ? data.retake_attempts : [];
        const canManage = Boolean(canEditJournal && data && data.can_manage_retakes);
        const retakeMeta = data && data.retake_meta ? data.retake_meta : {};
        const statusOptions = Array.isArray(retakeMeta.statuses) && retakeMeta.statuses.length
          ? retakeMeta.statuses
          : [
              { key: 'planned', label: 'Заплановано' },
              { key: 'submitted', label: 'Здано' },
              { key: 'graded', label: 'Оцінено' },
              { key: 'cancelled', label: 'Скасовано' },
            ];
        const noteMaxLength = Number(retakeMeta.note_max_length || 1200);
        const commentMaxLength = Number(retakeMeta.comment_max_length || 2000);
        const maxScore = Number(data && data.column ? data.column.max_points : 0);

        if (retakeCreateColumnInput) retakeCreateColumnInput.value = String(currentCellColumnId || 0);
        if (retakeCreateStudentInput) retakeCreateStudentInput.value = String(currentCellStudentId || 0);
        if (retakeCreateSubmitBtn) retakeCreateSubmitBtn.disabled = !canManage;
        if (retakeCreateForm) {
          retakeCreateForm.classList.toggle('d-none', !canEditJournal);
          const kindSelect = retakeCreateForm.querySelector('[name="kind"]');
          const dueDateInput = retakeCreateForm.querySelector('[name="due_date"]');
          const noteInput = retakeCreateForm.querySelector('[name="note"]');
          if (kindSelect) kindSelect.disabled = !canManage;
          if (dueDateInput) {
            dueDateInput.disabled = !canManage;
            dueDateInput.value = '';
          }
          if (noteInput) {
            noteInput.disabled = !canManage;
            noteInput.maxLength = noteMaxLength;
            noteInput.value = '';
          }
        }

        if (!attempts.length) {
          retakeListEl.innerHTML = '<div class="text-muted small">Спроб поки немає.</div>';
          return;
        }

        const html = attempts.map((attempt) => {
          const statusKey = String(attempt && attempt.status ? attempt.status : 'planned');
          const statusClass = getRetakeStatusChipClass(statusKey);
          const scoreValue = Number(attempt && attempt.score);
          const scoreDisplay = Number.isFinite(scoreValue) ? formatNumber(scoreValue) : '—';
          const statusOptionsHtml = statusOptions.map((option) => {
            const key = String(option && option.key ? option.key : '');
            const label = String(option && option.label ? option.label : key);
            return `<option value="${escapeHtml(key)}"${key === statusKey ? ' selected' : ''}>${escapeHtml(label)}</option>`;
          }).join('');
          const noteText = String(attempt && attempt.note ? attempt.note : '');
          const commentText = String(attempt && attempt.teacher_comment ? attempt.teacher_comment : '');
          const dueDate = String(attempt && attempt.due_date ? attempt.due_date : '');
          const approvedBy = String(attempt && attempt.approved_by_name ? attempt.approved_by_name : '');
          const gradedBy = String(attempt && attempt.graded_by_name ? attempt.graded_by_name : '');
          const scoreInputValue = Number.isFinite(scoreValue) ? String(scoreValue) : '';

          const readonlyBlock = `
            <div class="journal-retake-readonly small">
              <div>Бал: <strong>${escapeHtml(scoreDisplay)}</strong>${attempt && attempt.count_in_final ? ' · враховано у фіналі' : ''}</div>
              ${commentText ? `<div class="mt-1">${escapeHtml(commentText)}</div>` : ''}
            </div>
          `;

          const formBlock = `
            <form method="POST" action="/journal/retakes/update" class="journal-retake-item-form mt-2" autocomplete="off">
              <input type="hidden" name="attempt_id" value="${Number(attempt && attempt.id ? attempt.id : 0)}" />
              <input type="hidden" name="column_id" value="${currentCellColumnId}" />
              <input type="hidden" name="student_id" value="${currentCellStudentId}" />
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Статус</label>
                  <select class="form-select form-select-sm" name="status">
                    ${statusOptionsHtml}
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Дедлайн</label>
                  <input class="form-control form-control-sm" type="date" name="due_date" value="${escapeHtml(dueDate)}" />
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Бал</label>
                  <input class="form-control form-control-sm" type="number" step="0.01" min="0" max="${escapeHtml(formatNumber(maxScore))}" name="score" value="${escapeHtml(scoreInputValue)}" placeholder="напр. 10" />
                </div>
              </div>
              <div class="row g-2 mt-1">
                <div class="col-12 col-md-6">
                  <label class="form-label form-label-sm mb-1">Нотатка</label>
                  <textarea class="form-control form-control-sm" name="note" rows="2" maxlength="${noteMaxLength}" placeholder="Що потрібно перездати">${escapeHtml(noteText)}</textarea>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label form-label-sm mb-1">Коментар</label>
                  <textarea class="form-control form-control-sm" name="teacher_comment" rows="2" maxlength="${commentMaxLength}" placeholder="Фідбек викладача">${escapeHtml(commentText)}</textarea>
                </div>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                <input type="hidden" name="count_in_final" value="0" />
                <label class="form-check d-inline-flex align-items-center gap-2 m-0">
                  <input class="form-check-input mt-0" type="checkbox" name="count_in_final" value="1"${attempt && attempt.count_in_final ? ' checked' : ''} />
                  <span class="small">Врахувати у фінальному розрахунку</span>
                </label>
                <button class="btn btn-sm btn-primary ms-auto" type="submit">Зберегти спробу</button>
              </div>
            </form>
          `;

          return `
            <article class="journal-retake-item">
              <div class="journal-retake-item-head">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <strong>#${Number(attempt && attempt.attempt_no ? attempt.attempt_no : 1)} · ${escapeHtml(String(attempt && attempt.kind_label ? attempt.kind_label : 'Спроба'))}</strong>
                  <span class="status-chip ${statusClass}">${escapeHtml(String(attempt && attempt.status_label ? attempt.status_label : statusKey))}</span>
                  ${attempt && attempt.count_in_final ? '<span class="status-chip status-chip--success">У фіналі</span>' : ''}
                </div>
                <div class="journal-retake-item-meta">
                  ${dueDate ? `<span>Дедлайн: ${escapeHtml(dueDate)}</span>` : '<span>Дедлайн: —</span>'}
                  ${attempt && attempt.approved_at ? `<span>Додано: ${escapeHtml(formatDateTime(attempt.approved_at))}${approvedBy ? ` · ${escapeHtml(approvedBy)}` : ''}</span>` : ''}
                  ${attempt && attempt.graded_at ? `<span>Оцінено: ${escapeHtml(formatDateTime(attempt.graded_at))}${gradedBy ? ` · ${escapeHtml(gradedBy)}` : ''}</span>` : ''}
                </div>
              </div>
              ${noteText ? `<div class="journal-retake-note small">${escapeHtml(noteText)}</div>` : ''}
              ${canManage ? formBlock : readonlyBlock}
            </article>
          `;
        }).join('');

        retakeListEl.innerHTML = html;
      }

      function renderAppeals(data) {
        if (!appealSectionEl || !appealListEl) return;
        const appeals = Array.isArray(data && data.appeals) ? data.appeals : [];
        const canCreate = Boolean(data && data.can_create_appeals);
        const canManage = Boolean(canEditJournal && data && data.can_manage_appeals);
        const appealMeta = data && data.appeal_meta ? data.appeal_meta : {};
        const reasonMaxLength = Number(appealMeta.reason_max_length || 2400);
        const commentMaxLength = Number(appealMeta.comment_max_length || 2400);
        const maxScore = Number(data && data.column ? data.column.max_points : 0);
        const statusOptions = Array.isArray(appealMeta.statuses) && appealMeta.statuses.length
          ? appealMeta.statuses
          : [
              { key: 'pending', label: 'Нова' },
              { key: 'in_review', label: 'На розгляді' },
              { key: 'approved', label: 'Підтверджено' },
              { key: 'rejected', label: 'Відхилено' },
            ];

        if (appealCreateColumnInput) appealCreateColumnInput.value = String(currentCellColumnId || 0);
        if (appealCreateStudentInput) appealCreateStudentInput.value = String(currentCellStudentId || 0);
        if (appealCreateRequestedScore) {
          appealCreateRequestedScore.max = formatNumber(maxScore);
          appealCreateRequestedScore.disabled = !canCreate;
          appealCreateRequestedScore.value = '';
        }
        if (appealCreateReason) {
          appealCreateReason.maxLength = reasonMaxLength;
          appealCreateReason.disabled = !canCreate;
          appealCreateReason.value = '';
        }
        if (appealCreateSubmitBtn) appealCreateSubmitBtn.disabled = !canCreate;
        if (appealCreateForm) {
          appealCreateForm.classList.toggle('d-none', canEditJournal);
        }

        if (!appeals.length) {
          appealListEl.innerHTML = '<div class="text-muted small">Апеляцій поки немає.</div>';
          return;
        }

        const html = appeals.map((appeal) => {
          const statusKey = String(appeal && appeal.status ? appeal.status : 'pending');
          const statusClass = getAppealStatusChipClass(statusKey);
          const requestedScore = Number(appeal && appeal.requested_score);
          const resolvedScore = Number(appeal && appeal.resolved_score);
          const requestedScoreDisplay = Number.isFinite(requestedScore) ? formatNumber(requestedScore) : '—';
          const resolvedScoreDisplay = Number.isFinite(resolvedScore) ? formatNumber(resolvedScore) : '—';
          const reasonText = String(appeal && appeal.reason ? appeal.reason : '');
          const decisionText = String(appeal && appeal.decision_comment ? appeal.decision_comment : '');
          const statusOptionsHtml = statusOptions.map((option) => {
            const key = String(option && option.key ? option.key : '');
            const label = String(option && option.label ? option.label : key);
            return `<option value="${escapeHtml(key)}"${key === statusKey ? ' selected' : ''}>${escapeHtml(label)}</option>`;
          }).join('');
          const resolvedScoreInputValue = Number.isFinite(resolvedScore) ? String(resolvedScore) : '';
          const createdBy = String(appeal && appeal.created_by_name ? appeal.created_by_name : '');
          const reviewedBy = String(appeal && appeal.reviewed_by_name ? appeal.reviewed_by_name : '');
          const createdAt = appeal && appeal.created_at ? formatDateTime(appeal.created_at) : '';
          const reviewedAt = appeal && appeal.reviewed_at ? formatDateTime(appeal.reviewed_at) : '';
          const slaDueAt = appeal && appeal.sla_due_at ? formatDateTime(appeal.sla_due_at) : '';
          const isOverdue = Boolean(appeal && appeal.is_overdue);

          const readonlyBlock = `
            <div class="journal-appeal-readonly small">
              ${decisionText ? `<div><strong>Коментар:</strong> ${escapeHtml(decisionText)}</div>` : '<div class="text-muted">Рішення ще не додано.</div>'}
              <div class="mt-1"><strong>Результат:</strong> ${escapeHtml(resolvedScoreDisplay)}</div>
            </div>
          `;

          const manageBlock = `
            <form method="POST" action="/journal/appeals/update" class="journal-appeal-item-form mt-2" autocomplete="off">
              <input type="hidden" name="appeal_id" value="${Number(appeal && appeal.id ? appeal.id : 0)}" />
              <input type="hidden" name="column_id" value="${currentCellColumnId}" />
              <input type="hidden" name="student_id" value="${currentCellStudentId}" />
              <div class="row g-2 align-items-end">
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Статус</label>
                  <select class="form-select form-select-sm" name="status">
                    ${statusOptionsHtml}
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Новий бал (опц.)</label>
                  <input class="form-control form-control-sm" type="number" step="0.01" min="0" max="${escapeHtml(formatNumber(maxScore))}" name="resolved_score" value="${escapeHtml(resolvedScoreInputValue)}" />
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label form-label-sm mb-1">Застосувати бал</label>
                  <div class="journal-appeal-apply-wrap">
                    <input type="hidden" name="apply_resolved_score" value="0" />
                    <label class="form-check d-inline-flex align-items-center gap-2 m-0">
                      <input class="form-check-input mt-0" type="checkbox" name="apply_resolved_score" value="1" />
                      <span class="small">Оновити оцінку</span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label form-label-sm mb-1">Коментар до рішення</label>
                <textarea class="form-control form-control-sm" name="decision_comment" rows="2" maxlength="${commentMaxLength}" placeholder="Результат розгляду">${escapeHtml(decisionText)}</textarea>
              </div>
              <div class="d-flex justify-content-end mt-2">
                <button class="btn btn-sm btn-primary" type="submit">Зберегти рішення</button>
              </div>
            </form>
          `;

          return `
            <article class="journal-appeal-item">
              <div class="journal-appeal-item-head">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <strong>Апеляція #${Number(appeal && appeal.id ? appeal.id : 0)}</strong>
                  <span class="status-chip ${statusClass}">${escapeHtml(String(appeal && appeal.status_label ? appeal.status_label : statusKey))}</span>
                  ${isOverdue ? '<span class="status-chip status-chip--danger">SLA прострочено</span>' : ''}
                </div>
                <div class="journal-appeal-item-meta">
                  <span>Запитуваний бал: ${escapeHtml(requestedScoreDisplay)}</span>
                  <span>Поточне рішення: ${escapeHtml(resolvedScoreDisplay)}</span>
                  ${slaDueAt ? `<span>SLA до: ${escapeHtml(slaDueAt)}</span>` : ''}
                  ${createdAt ? `<span>Подано: ${escapeHtml(createdAt)}${createdBy ? ` · ${escapeHtml(createdBy)}` : ''}</span>` : ''}
                  ${reviewedAt ? `<span>Розглянуто: ${escapeHtml(reviewedAt)}${reviewedBy ? ` · ${escapeHtml(reviewedBy)}` : ''}</span>` : ''}
                </div>
              </div>
              <div class="journal-appeal-reason small">${escapeHtml(reasonText)}</div>
              ${canManage ? manageBlock : readonlyBlock}
            </article>
          `;
        }).join('');
        appealListEl.innerHTML = html;
      }

      const navigateCell = (columnStep, studentStep) => {
        const currentColumnIndex = findColumnIndex(currentCellColumnId);
        const currentStudentIndex = findStudentIndex(currentCellStudentId);
        if (currentColumnIndex < 0 || currentStudentIndex < 0) return;
        const nextColumnIndex = Math.max(0, Math.min(journalColumnsData.length - 1, currentColumnIndex + columnStep));
        const nextStudentIndex = Math.max(0, Math.min(journalStudentsData.length - 1, currentStudentIndex + studentStep));
        const nextColumn = journalColumnsData[nextColumnIndex];
        const nextStudent = journalStudentsData[nextStudentIndex];
        if (!nextColumn || !nextStudent) return;
        openJournalCell(nextColumn.id, nextStudent.id);
      };

      async function openJournalCell(columnId, studentId) {
        if (!modal) return;
        try {
          const res = await fetch(`/journal/cell.json?column_id=${encodeURIComponent(columnId)}&student_id=${encodeURIComponent(studentId)}`);
          if (!res.ok) throw new Error('Request failed');
          const data = await res.json();
          titleEl.textContent = data && data.column ? data.column.title : 'Оцінювання';
          studentEl.textContent = data && data.student ? data.student.full_name : '-';
          setStatusLabel(data ? data.submission_status : '');
          renderSubmission(data ? data.submission : null, data ? data.column : null);
          currentCellColumnId = Number(columnId);
          currentCellStudentId = Number(studentId);
          currentCellLocked = Boolean(data && data.column && data.column.is_locked);
          renderRetakes(data || null);
          renderAppeals(data || null);

          columnInput.value = String(columnId);
          studentInput.value = String(studentId);
          if (deleteColumnInput) deleteColumnInput.value = String(columnId);
          if (deleteStudentInput) deleteStudentInput.value = String(studentId);
          scoreEl.max = data && data.column ? String(data.column.max_points || 0) : '';
          scoreEl.value = data && data.grade && Number.isFinite(Number(data.grade.score))
            ? String(data.grade.score)
            : '';
          const existingComment = data && data.grade && data.grade.teacher_comment ? data.grade.teacher_comment : '';
          commentEl.value = existingComment;
          const canEditCurrent = Boolean(canEditJournal && data && data.can_edit && !currentCellLocked);
          scoreEl.disabled = !canEditCurrent;
          commentEl.disabled = !canEditCurrent;
          if (!existingComment && pendingPrefillComment && canEditCurrent) {
            commentEl.value = pendingPrefillComment;
            pendingPrefillComment = '';
          }
          if (gradeForm) {
            const submitBtn = gradeForm.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.style.display = canEditJournal ? '' : 'none';
              submitBtn.disabled = !canEditCurrent;
            }
          }
          if (deleteForm) {
            deleteForm.style.display = canEditJournal ? '' : 'none';
          }
          if (deleteBtn) {
            const hasGrade = Boolean(data && data.grade && Number.isFinite(Number(data.grade.score)));
            deleteBtn.disabled = !canEditCurrent || !hasGrade;
          }
          if (prevCellBtn) {
            prevCellBtn.disabled = !canEditJournal || currentCellLocked;
          }
          if (nextCellBtn) {
            nextCellBtn.disabled = !canEditJournal || currentCellLocked;
          }
          if (lockedNotice) {
            lockedNotice.classList.toggle('d-none', !currentCellLocked);
          }
          modal.show();
        } catch (err) {
          console.error(err);
        }
      }

      const parseBulkInput = () => {
        if (!bulkPasteEl || !bulkPreviewMetaEl || !bulkPreviewEl) return false;
        const lines = String(bulkPasteEl.value || '').replace(/\r/g, '').split('\n');
        const entries = [];
        const errors = [];
        const previewRows = [];
        const maxRows = Math.min(lines.length, journalStudentsData.length);
        for (let index = 0; index < maxRows; index += 1) {
          const student = journalStudentsData[index];
          const rawLine = String(lines[index] || '');
          if (!rawLine.trim()) continue;
          const parts = rawLine.split('\t');
          const scoreRaw = String(parts[0] || '').trim();
          if (!scoreRaw) continue;
          const score = Number(scoreRaw.replace(',', '.'));
          const comment = parts.slice(1).join(' ').trim();
          if (!Number.isFinite(score) || score < 0 || score > bulkCurrentMax) {
            errors.push(`Рядок ${index + 1}: бал має бути від 0 до ${formatNumber(bulkCurrentMax)}`);
            continue;
          }
          const normalizedScore = Math.round(score * 100) / 100;
          entries.push({
            student_id: student.id,
            score: normalizedScore,
            teacher_comment: comment,
          });
          if (previewRows.length < 12) {
            previewRows.push(`${student.full_name}: ${formatNumber(normalizedScore)}${comment ? ` (${comment})` : ''}`);
          }
        }
        const linesExtra = lines.length > journalStudentsData.length
          ? `, зайві рядки: ${lines.length - journalStudentsData.length}`
          : '';
        if (errors.length) {
          bulkPreviewMetaEl.textContent = `Попередній перегляд: помилки (${errors.length})${linesExtra}`;
          bulkPreviewEl.innerHTML = errors.map((line) => `<div class="text-danger small">${line}</div>`).join('');
        } else {
          bulkPreviewMetaEl.textContent = `Попередній перегляд: ${entries.length} записів${linesExtra}`;
          bulkPreviewEl.innerHTML = previewRows.length
            ? previewRows.map((line) => `<div class="small">${line}</div>`).join('')
            : '<div class="text-muted small">Немає даних для збереження.</div>';
        }
        const canSubmit = !bulkCurrentLocked && entries.length > 0 && errors.length === 0;
        if (bulkSubmitBtn) bulkSubmitBtn.disabled = !canSubmit;
        if (bulkEntriesInput) bulkEntriesInput.value = canSubmit ? JSON.stringify(entries) : '';
        return canSubmit;
      };

      const openBulkModal = (buttonEl) => {
        if (!bulkModal || !buttonEl) return;
        const columnId = Number(buttonEl.dataset.columnId || 0);
        const columnTitle = String(buttonEl.dataset.columnTitle || '');
        const maxPoints = Number(buttonEl.dataset.columnMax || 0);
        const isLocked = Number(buttonEl.dataset.columnLocked || 0) === 1;
        if (!columnId) return;
        bulkCurrentLocked = isLocked;
        bulkCurrentMax = Number.isFinite(maxPoints) && maxPoints > 0 ? maxPoints : 100;
        if (bulkColumnIdInput) bulkColumnIdInput.value = String(columnId);
        if (bulkColumnTitleEl) {
          bulkColumnTitleEl.textContent = `${columnTitle || 'Колонка'} · Макс ${formatNumber(bulkCurrentMax)} б.`;
        }
        if (bulkPasteEl) {
          bulkPasteEl.value = '';
          bulkPasteEl.disabled = isLocked;
        }
        if (bulkLockedAlert) {
          bulkLockedAlert.classList.toggle('d-none', !isLocked);
        }
        if (bulkEntriesInput) bulkEntriesInput.value = '';
        if (bulkPreviewMetaEl) bulkPreviewMetaEl.textContent = 'Попередній перегляд: 0 записів';
        if (bulkPreviewEl) bulkPreviewEl.innerHTML = '<div class="text-muted small">Вставте дані для попереднього перегляду.</div>';
        if (bulkSubmitBtn) bulkSubmitBtn.disabled = true;
        bulkModal.show();
      };

      const serializeAttendanceRows = () => {
        if (!attendanceRowEls.length) return [];
        return attendanceRowEls.map((rowEl) => {
          const studentId = Number(rowEl.dataset.studentId || 0);
          const statusEl = rowEl.querySelector('[data-attendance-status]');
          const reasonEl = rowEl.querySelector('[data-attendance-reason]');
          return {
            student_id: studentId,
            status: String(statusEl ? statusEl.value : '').trim(),
            reason: String(reasonEl ? reasonEl.value : '').trim(),
          };
        }).filter((row) => Number.isFinite(row.student_id) && row.student_id > 0);
      };

      const undoBtn = document.getElementById('journalUndoDeleteBtn');
      const undoCountdownEl = document.getElementById('journalUndoCountdown');
      if (undoBtn && undoCountdownEl) {
        const undoUntil = Number(undoBtn.dataset.undoUntil || 0);
        const syncUndoTimer = () => {
          const leftMs = undoUntil - Date.now();
          const leftSec = Math.max(0, Math.ceil(leftMs / 1000));
          undoCountdownEl.textContent = String(leftSec);
          if (leftSec < 1) {
            undoBtn.disabled = true;
            undoBtn.textContent = 'Час минув';
            return false;
          }
          return true;
        };
        syncUndoTimer();
        const timer = setInterval(() => {
          if (!syncUndoTimer()) {
            clearInterval(timer);
          }
        }, 1000);
      }

      const presetSelectEl = document.getElementById('journalPresetSelect');
      const applyPresetBtn = document.getElementById('journalApplyPresetBtn');
      const normalizeBtn = document.getElementById('journalNormalizeWeightsBtn');
      if (applyPresetBtn && presetSelectEl) {
        applyPresetBtn.addEventListener('click', () => {
          if (!presetSelectEl.value) return;
          applyGradingPreset(presetSelectEl.value);
        });
      }
      if (normalizeBtn) {
        normalizeBtn.addEventListener('click', normalizeWeightsToHundred);
      }
      document.querySelectorAll('.journal-enabled-input, .journal-weight-input').forEach((el) => {
        el.addEventListener('input', refreshWeightSummary);
        el.addEventListener('change', refreshWeightSummary);
      });
      refreshWeightSummary();

      if (prevCellBtn) {
        prevCellBtn.addEventListener('click', () => navigateCell(0, -1));
      }
      if (nextCellBtn) {
        nextCellBtn.addEventListener('click', () => navigateCell(0, 1));
      }
      if (modalEl) {
        modalEl.addEventListener('keydown', (event) => {
          if (!modalEl.classList.contains('show')) return;
          if (event.ctrlKey && event.key === 'Enter') {
            if (gradeForm && canEditJournal && !currentCellLocked && !scoreEl.disabled) {
              event.preventDefault();
              gradeForm.requestSubmit();
            }
            return;
          }
          if (!event.altKey) return;
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            navigateCell(0, -1);
          } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            navigateCell(0, 1);
          } else if (event.key === 'ArrowLeft') {
            event.preventDefault();
            navigateCell(-1, 0);
          } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            navigateCell(1, 0);
          }
        });
      }

      document.querySelectorAll('.journal-cell-btn[data-can-open="1"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const columnId = Number(btn.dataset.columnId);
          const studentId = Number(btn.dataset.studentId);
          if (!columnId || !studentId) return;
          openJournalCell(columnId, studentId);
        });
      });
      document.querySelectorAll('.journal-bulk-open-btn').forEach((btn) => {
        btn.addEventListener('click', () => openBulkModal(btn));
      });
      if (bulkPasteEl) {
        bulkPasteEl.addEventListener('input', parseBulkInput);
      }
      if (bulkForm) {
        bulkForm.addEventListener('submit', (event) => {
          const valid = parseBulkInput();
          if (!valid) {
            event.preventDefault();
          }
        });
      }
      if (attendanceForm && attendanceRowsJsonInput) {
        attendanceForm.addEventListener('submit', () => {
          const rows = serializeAttendanceRows();
          attendanceRowsJsonInput.value = JSON.stringify(rows);
        });
      }
      if (feedbackTemplateButtons.length && commentEl) {
        feedbackTemplateButtons.forEach((button) => {
          button.addEventListener('click', () => {
            if (commentEl.disabled) return;
            if (button.dataset.feedbackClear === '1') {
              commentEl.value = '';
              commentEl.focus();
              return;
            }
            const template = String(button.dataset.feedbackTemplate || '').trim();
            if (!template) return;
            const current = String(commentEl.value || '').trim();
            if (!current) {
              commentEl.value = template;
            } else if (!current.includes(template)) {
              commentEl.value = `${current}\n${template}`;
            }
            commentEl.focus();
            commentEl.selectionStart = commentEl.value.length;
            commentEl.selectionEnd = commentEl.value.length;
          });
        });
      }
      if (autoOpenColumnId > 0 && autoOpenStudentId > 0) {
        openJournalCell(autoOpenColumnId, autoOpenStudentId);
      }
    </script>
    <script src="/js/design-system.js" defer></script>
  </body>
</html>
