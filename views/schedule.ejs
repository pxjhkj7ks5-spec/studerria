<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('schedule.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-2: #8b5cf6;
        --accent-3: #22d3ee;
        --radius: 18px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.08);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.7);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
        transition: background 200ms ease, color 200ms ease;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-light {
        background: radial-gradient(1000px 700px at 20% 10%, rgba(191, 219, 254, 0.6), transparent 60%),
          radial-gradient(900px 600px at 80% 20%, rgba(224, 231, 255, 0.6), transparent 60%),
          linear-gradient(150deg, #f8fafc 0%, #f1f5f9 45%, #e2e8f0 100%);
        color: #0f172a;
      }
      body.theme-light .text-white {
        color: #0f172a !important;
      }
      body.theme-light .btn-outline-light {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.2);
      }
      body.theme-light .btn-outline-light:hover {
        background: rgba(15, 23, 42, 0.06);
      }
      .topbar {
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-dark .topbar {
        background: rgba(10, 10, 20, 0.5);
      }
      body.theme-light .topbar {
        background: rgba(255, 255, 255, 0.75);
      }
      .hero-title {
        font-size: clamp(2.2rem, 4vw, 3rem);
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      .hero-sub {
        color: rgba(255, 255, 255, 0.7);
      }
      body.theme-light .hero-sub {
        color: rgba(15, 23, 42, 0.65);
      }
      #daily-phrase {
        transition: opacity 240ms ease;
      }
      #daily-phrase.fade-out {
        opacity: 0;
      }
      .glass {
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .glass {
        background: var(--glass-bg-dark);
        border: 1px solid var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.7) inset;
      }
      .week-hero {
        padding: 22px 26px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 18px;
      }
      @media (max-width: 768px) {
        .week-hero {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      .badge-glow {
        background: linear-gradient(135deg, #93c5fd, #c4b5fd);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.35);
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        font-weight: 700;
        box-shadow: 0 8px 18px rgba(59, 130, 246, 0.22);
      }
      body.theme-light .badge-glow {
        color: #0f172a;
        background: linear-gradient(135deg, rgba(147, 197, 253, 0.55), rgba(196, 181, 253, 0.45));
        border-color: rgba(15, 23, 42, 0.08);
      }
      .hw-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.35);
        color: #dbeafe;
      }
      body.theme-light .hw-chip {
        background: rgba(59, 130, 246, 0.12);
        color: #1e3a8a;
      }
      .tag-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-light .tag-pill {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
        color: #0f172a;
      }
      .react-btn {
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        line-height: 1.2;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      body.theme-dark .react-btn {
        color: rgba(248, 250, 252, 0.92);
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.35);
      }
      body.theme-light .react-btn {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.18);
        background: rgba(15, 23, 42, 0.04);
      }
      .react-btn.active {
        background: rgba(59, 130, 246, 0.25);
        border-color: rgba(59, 130, 246, 0.6);
        color: #e2e8f0;
      }
      body.theme-light .react-btn.active {
        background: rgba(59, 130, 246, 0.18);
        color: #0f172a;
      }
      .hw-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .week-slider {
        position: fixed;
        left: 50%;
        bottom: 64px;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 10px 16px;
        border-radius: 20px;
        backdrop-filter: blur(8px);
        z-index: 1050;
      }
      body.theme-dark .week-slider {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      body.theme-light .week-slider {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
      }
      @media (max-width: 576px) {
        .week-slider {
          bottom: 56px;
        }
      }
      .week-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.4);
        opacity: 0.3;
        cursor: pointer;
        transition: transform 220ms ease, background 220ms ease, width 260ms ease, box-shadow 260ms ease;
      }
      .week-dot:hover {
        transform: scale(1.15);
        opacity: 0.6;
      }
      .week-dot.active {
        width: 28px;
        height: 8px;
        opacity: 1;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
      }
      .week-dot.active {
        transform: scale(1.05);
      }
      body.theme-light .week-dot {
        background: rgba(15, 23, 42, 0.4);
      }
      body.theme-light .week-dot.active {
        background: rgba(15, 23, 42, 0.85);
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        animation: modalIn 260ms ease;
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      .glass-welcome-modal {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        color: #f8fafc;
        max-width: 480px;
        margin: auto;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light .glass-welcome-modal {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
      }
      .welcome-title {
        font-size: 1.6rem;
        font-weight: 800;
      }
      .welcome-subtitle {
        color: rgba(248, 250, 252, 0.75);
      }
      body.theme-light .welcome-subtitle {
        color: rgba(15, 23, 42, 0.7);
      }
      @keyframes modalIn {
        from {
          transform: scale(0.98);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-light .btn-primary.glass {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border-radius: 14px;
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: inherit;
        font-size: 0.95rem;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      select.form-select option {
        background: #0f172a;
        color: #f8fafc;
      }
      body.theme-light select.form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark select.form-select option:checked,
      body.theme-dark select.form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light select.form-select option:checked,
      body.theme-light select.form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      .week-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(20, 20, 30, 0.8);
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .week-nav-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.5);
        border-color: rgba(147, 197, 253, 0.7);
      }
      body.theme-light .week-nav-btn {
        background: rgba(255, 255, 255, 0.85);
        border-color: rgba(15, 23, 42, 0.18);
        color: #0f172a;
      }
      .schedule-content {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .schedule-content.enter {
        opacity: 0;
        transform: translateY(12px);
      }
      .schedule-content.enter-active {
        opacity: 1;
        transform: translateY(0);
      }
      body.welcome-open .schedule-content,
      body.welcome-open .topbar,
      body.welcome-open .week-slider,
      body.welcome-open .app-footer {
        filter: blur(8px);
        transition: filter 200ms ease;
      }
      .day-card .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.16);
        font-weight: 700;
      }
      body.theme-light .day-card .card-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }
      .list-group-item {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 14px;
        margin: 6px 0;
        padding: 16px;
        width: 100%;
        box-sizing: border-box;
        transition: background 200ms ease, box-shadow 200ms ease, transform 200ms ease;
      }
      body.theme-light .list-group-item {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.1);
      }
      .list-group-item-action:hover {
        background: rgba(99, 102, 241, 0.18);
        box-shadow: inset 0 0 0 1px rgba(147, 197, 253, 0.2);
        transform: translateY(-1px);
      }
      body.theme-light .list-group-item-action:hover {
        background: rgba(59, 130, 246, 0.08);
      }
      body.theme-dark .list-group-item-action:focus,
      body.theme-dark .list-group-item-action:active {
        background: rgba(139, 92, 246, 0.22);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) inset;
      }
      .muted {
        color: rgba(255, 255, 255, 0.7);
      }
      body.theme-light .muted {
        color: rgba(15, 23, 42, 0.6);
      }
      body.theme-dark .list-group-item .fw-semibold {
        color: #f8fafc;
      }
      body.theme-dark .day-card .card-header {
        color: #f8fafc;
      }
      .day-card .list-group {
        padding: 10px 12px 12px;
      }
      .day-card .list-group.list-group-flush > .list-group-item {
        border-radius: 14px !important;
      }
      @media (max-width: 768px) {
        .day-card .list-group {
          padding: 8px 10px 10px;
        }
        .list-group-item {
          padding: 14px;
          border-radius: 12px;
        }
      }
      .form-control {
        border-radius: 12px;
      }
      body.theme-dark .form-control {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      body.theme-light .form-control {
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        border: 1px solid rgba(15, 23, 42, 0.16);
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--accent-3);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
      }
      body.theme-dark .modal-content .list-group-item {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content .text-muted {
        color: rgba(248, 250, 252, 0.65) !important;
      }
      body.theme-dark .modal-content .form-label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .modal-content ::placeholder {
        color: rgba(248, 250, 252, 0.6);
      }
      body.theme-dark .modal-content a {
        color: #93c5fd;
      }
      body.theme-dark .modal-content a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border: none;
        border-radius: 12px;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      .theme-toggle {
        border-radius: 999px;
      }
      .msg-btn {
        border-radius: 999px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        position: relative;
      }
      .msg-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 18px;
        height: 18px;
        border-radius: 999px;
        background: #ef4444;
        color: #fff;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      .app-footer {
        font-size: 0.85rem;
        padding-bottom: 90px;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
    </style>
  </head>
  <body class="theme-dark">
    <nav class="navbar navbar-expand-lg topbar">
      <div class="container">
        <span class="navbar-brand text-white">Studerria</span>
        <div class="d-flex align-items-center">
          <span class="me-3 muted">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.student') %>: <%= username %>
            <% } %>
          </span>
          <% if (role === 'admin') { %>
            <form method="POST" action="/admin/switch-to-admin" class="me-2">
              <button class="btn btn-outline-primary btn-sm" type="submit"><%= t('schedule.backToAdmin') %></button>
            </form>
          <% } %>
          <% if (role === 'starosta') { %>
            <a class="btn btn-outline-primary btn-sm me-2" href="/starosta"><%= t('menu.starosta') %></a>
          <% } %>
          <% if (role === 'deanery') { %>
            <a class="btn btn-outline-primary btn-sm me-2" href="/deanery"><%= t('menu.deanery') %></a>
          <% } %>
          <button
            class="btn btn-outline-light btn-sm me-2 theme-toggle"
            type="button"
            id="themeToggle"
            data-light-label="<%= t('theme.light') %>"
            data-dark-label="<%= t('theme.dark') %>"
          >
            <%= t('theme.light') %>
          </button>
          <button class="btn btn-outline-light btn-sm me-2 msg-btn" type="button" id="messagesBtn" aria-label="<%= t('messages.aria') %>">
            üí¨
            <span class="msg-badge d-none" id="messagesBadge">0</span>
          </button>
          <a class="btn btn-outline-light btn-sm me-2" href="/teamwork"><%= t('menu.teamwork') %></a>
          <a class="btn btn-outline-light btn-sm me-2" href="/profile"><%= t('schedule.profile') %></a>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-light btn-sm" type="submit"><%= t('schedule.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4 schedule-content enter">
      <div class="glass week-hero mb-4">
        <div>
          <h1 class="hero-title mb-1"><%= t('schedule.header') %></h1>
          <div class="hero-sub" id="daily-phrase">Your rhythm, your focus ‚Äî let‚Äôs make this week count.</div>
        </div>
        <span class="badge-glow"><%= t('schedule.week') %> <%= currentWeek %></span>
      </div>

      <% if (role === 'admin') { %>
        <div class="alert alert-info glass text-white border-0">
          <%= t('schedule.adminViewNotice') %>
        </div>
      <% } %>

      <% if (subgroupError === 'exists') { %>
        <div class="alert alert-warning glass text-white border-0">
          You are already in a subgroup for this homework.
        </div>
      <% } %>

      <% daysOfWeek.forEach(function(day) { %>
        <% const dateLabel = dayDates && dayDates[day] ? new Date(dayDates[day]).toLocaleDateString('uk-UA') : ''; %>
        <div class="card mb-3 glass day-card">
          <div class="card-header fw-semibold text-white d-flex justify-content-between align-items-center">
            <span><%= day %></span>
            <% if (dateLabel) { %>
              <span class="small muted"><%= dateLabel %></span>
            <% } %>
          </div>
          <div class="list-group list-group-flush">
            <% if (!scheduleByDay[day] || scheduleByDay[day].length === 0) { %>
              <div class="list-group-item muted">No classes</div>
            <% } else { %>
              <% scheduleByDay[day].forEach(function(cls) { %>
                <% const slot = bellSchedule[cls.class_number]; %>
                <% const timeLabel = slot ? `${slot.start} - ${slot.end}` : ''; %>
                <% const hwKey = `${cls.subject_id}|${cls.group_number}|${cls.day_of_week}|${cls.class_number}`; %>
                <% const hwMeta = homeworkMeta ? homeworkMeta[hwKey] : null; %>
                <button
                  class="list-group-item list-group-item-action"
                  type="button"
                  data-bs-toggle="modal"
                  data-bs-target="#homeworkModal"
                  data-class="<%= cls.subject_name %>"
                  data-subjectid="<%= cls.subject_id %>"
                  data-day="<%= cls.day_of_week %>"
                  data-time="<%= timeLabel %>"
                  data-classnum="<%= cls.class_number %>"
                  data-groupnum="<%= cls.group_number %>"
                  data-date="<%= cls.class_date %>"
                  <% if (hwMeta) { %>
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="<%= hwMeta.preview.join(' ‚Ä¢ ') %>"
                  <% } %>
                >
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold"><%= cls.subject_name %></div>
                      <div class="small muted">Group <%= cls.group_number %> ¬∑ Class <%= cls.class_number %></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <% if (hwMeta) { %>
                        <span class="hw-chip">–î–ó <%= hwMeta.count %></span>
                      <% } %>
                      <div class="muted small"><%= timeLabel %></div>
                    </div>
                  </div>
                </button>
              <% }); %>
            <% } %>
          </div>
        </div>
      <% }); %>
    </main>

    <div class="week-slider" id="weekSlider">
      <button class="week-nav-btn" type="button" id="weekPrev" aria-label="Previous week">‚Äπ</button>
      <% for (let w = 1; w <= (totalWeeks || 15); w++) { %>
        <button
          type="button"
          class="week-dot <%= w === currentWeek ? 'active' : '' %>"
          data-week="<%= w %>"
          aria-label="<%= t('schedule.week') %> <%= w %>"
        ></button>
      <% } %>
      <button class="week-nav-btn" type="button" id="weekNext" aria-label="Next week">‚Ä∫</button>
    </div>

    <footer class="app-footer text-center py-4">
      <small>¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %></small>
    </footer>

    <div class="modal fade" id="homeworkModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="homeworkModalTitle">Class details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Selected class:</strong>
              <span id="homeworkModalMeta" class="text-muted"></span>
            </div>

            <h6>Homework list</h6>
            <div class="mb-2">
              <label class="form-label">Filter by tag</label>
              <input
                id="homeworkTagFilter"
                class="form-control"
                list="homeworkTagsList"
                placeholder="#—Ç–µ—Å—Ç –∞–±–æ #–æ–Ω–ª–∞–π–Ω"
              />
            </div>
            <ul id="homeworkList" class="list-group mb-4">
              <li class="list-group-item text-muted">No assignments yet.</li>
            </ul>

            <div id="subgroupSection" class="mb-4 d-none">
              <h6>Subgroups</h6>
              <div id="subgroupList" class="list-group mb-3"></div>

              <div class="card mb-3">
                <div class="card-body">
                  <form method="POST" action="/subgroup/create">
                    <input type="hidden" id="subgroupHomeworkId" name="homework_id" />
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-8">
                        <label for="subgroupName" class="form-label">Create new subgroup</label>
                        <input id="subgroupName" name="name" class="form-control" placeholder="Group name" required />
                      </div>
                      <div class="col-12 col-md-4">
                        <button type="submit" class="btn btn-outline-primary w-100 glass">Create</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <form method="POST" action="/subgroup/join">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-8">
                    <label for="joinSubgroupId" class="form-label">Join existing subgroup</label>
                    <select id="joinSubgroupId" name="subgroup_id" class="form-select" required>
                      <option value="" disabled selected>Select subgroup</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <button type="submit" class="btn btn-outline-secondary w-100 glass">Join</button>
                  </div>
                </div>
              </form>
            </div>

            <h6>Add homework</h6>
            <form method="POST" action="/homework/add" enctype="multipart/form-data">
              <div class="mb-3">
                <label for="hwText" class="form-label">Description</label>
                <textarea id="hwText" name="description" class="form-control" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="hwLink" class="form-label">Link (optional)</label>
                <input id="hwLink" name="link_url" type="url" class="form-control" placeholder="https://example.com" />
              </div>
              <div class="mb-3">
                <label for="hwMeeting" class="form-label">Online class link (Zoom/Teams)</label>
                <input
                  id="hwMeeting"
                  name="meeting_url"
                  type="url"
                  class="form-control"
                  placeholder="https://zoom.us/j/..."
                />
              </div>
              <div class="mb-3">
                <label for="hwTags" class="form-label">Tags (comma separated)</label>
                <input
                  id="hwTags"
                  name="tags"
                  type="text"
                  class="form-control"
                  list="homeworkTagsList"
                  placeholder="#—Ç–µ—Å—Ç, #–ª–µ–∫—Ü—ñ—è"
                />
              </div>
              <div class="mb-3">
                <label for="hwFile" class="form-label">Attachment (optional)</label>
                <input id="hwFile" name="attachment" type="file" class="form-control" />
              </div>
              <input type="hidden" id="hwSubjectId" name="subject_id" />
              <input type="hidden" id="hwGroupNum" name="group_number" />
              <input type="hidden" id="hwDay" name="day_of_week" />
              <input type="hidden" id="hwTime" name="time" />
              <input type="hidden" id="hwClassNum" name="class_number" />
              <input type="hidden" id="hwDate" name="class_date" />
              <button type="submit" class="btn btn-primary glass">Save homework</button>
            </form>
            <datalist id="homeworkTagsList">
              <% (homeworkTags || []).forEach(function(tag) { %>
                <option value="<%= tag %>"></option>
              <% }); %>
            </datalist>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="messagesModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">–§—ñ–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É</label>
              <select class="form-select" id="messagesSubjectFilter">
                <option value="">–£—Å—ñ –ø—Ä–µ–¥–º–µ—Ç–∏</option>
                <% (messageSubjects || []).forEach(function(s) { %>
                  <option value="<%= s.subject_id %>"><%= s.subject_name %></option>
                <% }); %>
              </select>
            </div>
            <ul id="messagesList" class="list-group">
              <li class="list-group-item text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-welcome-modal">
          <div class="modal-body text-center">
            <div class="welcome-title mb-2">üëã –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ Studerria!</div>
            <div class="welcome-subtitle mb-3">
              —ñ–∑ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–Ω—è–º –ø—Ä–µ–∑–µ–Ω—Ç—É—î–º–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É <strong>Studerria</strong>, —Å—Ç–≤–æ—Ä–µ–Ω—É –¥–≤–æ–º–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ ‚Äî –¥–ª—è –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö.
            </div>
            <div class="small mb-4">
              üéØ –û—Ä–≥–∞–Ω—ñ–∑–æ–≤—É–π—Ç–µ –ø–∞—Ä–∏, –¥–æ–º–∞—à–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç–∞ –∫–æ–º–∞–Ω–¥–Ω—É —Ä–æ–±–æ—Ç—É –∑ —î–¥–∏–Ω–æ–≥–æ –∑—Ä—É—á–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä—É.
              <br />
              ‚öôÔ∏è –£—Å—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è, –±–∞–≥–∏ —á–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó ‚Äî –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ –Ω–∞–ø—Ä—è–º—É –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–∏—Å—Ç–µ–º–∏ —á–µ—Ä–µ–∑ "–ü—Ä–æ—Ñ—ñ–ª—å ‚Üí –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è".
            </div>
            <button type="button" class="btn btn-primary glass" data-bs-dismiss="modal">–ü–æ—á–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      const welcomeKey = `studerria:welcome:${<%- JSON.stringify(appVersion) %>}`;
      const welcomeModalEl = document.getElementById('welcomeModal');
      if (welcomeModalEl && !localStorage.getItem(welcomeKey)) {
        const welcomeModal = new bootstrap.Modal(welcomeModalEl, { backdrop: true });
        welcomeModal.show();
        localStorage.setItem(welcomeKey, '1');
        document.body.classList.add('welcome-open');
        welcomeModalEl.addEventListener('hidden.bs.modal', () => {
          document.body.classList.remove('welcome-open');
        });
      }

      const homeworkModal = document.getElementById('homeworkModal');
      const homeworkData = <%- JSON.stringify(homework || []) %>;
      const listEl = document.getElementById('homeworkList');
      const subgroupSection = document.getElementById('subgroupSection');
      const subgroupList = document.getElementById('subgroupList');
      const subgroupHomeworkId = document.getElementById('subgroupHomeworkId');
      const joinSubgroupId = document.getElementById('joinSubgroupId');
      const currentUser = <%- JSON.stringify(username) %>;
      const homeworkTagFilter = document.getElementById('homeworkTagFilter');
      const currentUserId = <%- JSON.stringify(userId || null) %>;
      let currentHomeworkItems = [];

      function updateReactionButtons(container, reactions, reacted) {
        const buttons = container.querySelectorAll('.react-btn');
        buttons.forEach((btn) => {
          const emoji = btn.dataset.emoji;
          const count = reactions && reactions[emoji] ? reactions[emoji] : 0;
          const countEl = btn.querySelector('.react-count');
          if (countEl) countEl.textContent = count;
          if (reacted && reacted[emoji]) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      async function toggleHomeworkReaction(homeworkId, emoji, container) {
        if (!currentUserId) return;
        try {
          const res = await fetch('/homework/react', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ homework_id: homeworkId, emoji }),
          });
          if (!res.ok) return;
          const data = await res.json();
          updateReactionButtons(container, data.reactions, data.reacted);
        } catch (err) {
          console.error(err);
        }
      }

      function renderHomework(items) {
        listEl.innerHTML = '';
        if (!items.length) {
          const empty = document.createElement('li');
          empty.className = 'list-group-item text-muted';
          empty.textContent = 'No assignments yet.';
          listEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'list-group-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold mb-1';
          title.textContent = item.description;
          li.appendChild(title);

          const meta = document.createElement('div');
          meta.className = 'text-muted small mb-2';
          const created = new Date(item.created_at).toLocaleString();
          meta.textContent = `${item.created_by} ‚Ä¢ ${created}`;
          li.appendChild(meta);

          if (item.tags && item.tags.length) {
            const tagWrap = document.createElement('div');
            tagWrap.className = 'hw-tags mb-2';
            item.tags.forEach((tag) => {
              const tagEl = document.createElement('span');
              tagEl.className = 'tag-pill';
              tagEl.textContent = tag;
              tagWrap.appendChild(tagEl);
            });
            li.appendChild(tagWrap);
          }

          if (item.link_url) {
            const link = document.createElement('a');
            link.href = item.link_url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = 'Open link';
            link.className = 'me-3';
            li.appendChild(link);
          }
          if (item.meeting_url) {
            const meet = document.createElement('a');
            meet.href = item.meeting_url;
            meet.target = '_blank';
            meet.rel = 'noopener';
            meet.textContent = 'Online class';
            meet.className = 'me-3';
            li.appendChild(meet);
          }

          if (item.file_path) {
            const fileLink = document.createElement('a');
            fileLink.href = item.file_path;
            fileLink.textContent = item.file_name || 'Download file';
            fileLink.className = 'd-inline-block';
            li.appendChild(fileLink);
          }

          const reactWrap = document.createElement('div');
          reactWrap.className = 'd-flex gap-2 mt-2';
          ['üî•', 'üëç'].forEach((emoji) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-secondary react-btn';
            btn.dataset.emoji = emoji;
            btn.dataset.homeworkId = item.id;
            const count = item.reactions && item.reactions[emoji] ? item.reactions[emoji] : 0;
            btn.innerHTML = `<span>${emoji}</span><span class="react-count">${count}</span>`;
            if (item.reacted && item.reacted[emoji]) {
              btn.classList.add('active');
            }
            btn.addEventListener('click', () => toggleHomeworkReaction(item.id, emoji, reactWrap));
            reactWrap.appendChild(btn);
          });
          li.appendChild(reactWrap);

          listEl.appendChild(li);
        });
      }

      function renderSubgroups(items) {
        subgroupList.innerHTML = '';
        joinSubgroupId.innerHTML = '<option value="" disabled selected>Select subgroup</option>';

        if (!items.length) {
          subgroupSection.classList.add('d-none');
          return;
        }

        subgroupSection.classList.remove('d-none');

        items.forEach((item) => {
          const container = document.createElement('div');
          container.className = 'list-group-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold';
          title.textContent = item.name;
          container.appendChild(title);

          const members = document.createElement('div');
          members.className = 'small text-muted';
          if (item.members.includes(currentUser)) {
            members.textContent = `Members: ${item.members.join(', ')} (you)`;
            container.classList.add('border', 'border-primary');
          } else {
            members.textContent = item.members.length ? item.members.join(', ') : 'No members yet';
          }
          container.appendChild(members);

          subgroupList.appendChild(container);

          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          joinSubgroupId.appendChild(opt);
        });
      }

      homeworkModal.addEventListener('show.bs.modal', (event) => {
        const button = event.relatedTarget;
        const subject = button.getAttribute('data-class');
        const subjectId = Number(button.getAttribute('data-subjectid'));
        const day = button.getAttribute('data-day');
        const time = button.getAttribute('data-time');
        const classNum = Number(button.getAttribute('data-classnum'));
        const groupNum = Number(button.getAttribute('data-groupnum'));
        const classDate = button.getAttribute('data-date');

        document.getElementById('homeworkModalTitle').textContent = subject;
        document.getElementById('homeworkModalMeta').textContent = `${day} ¬∑ ${time}`;

        document.getElementById('hwDay').value = day;
        document.getElementById('hwTime').value = time;
        document.getElementById('hwSubjectId').value = subjectId;
        document.getElementById('hwGroupNum').value = groupNum;
        document.getElementById('hwClassNum').value = classNum;
        document.getElementById('hwDate').value = classDate || '';

        const filtered = homeworkData.filter((item) => {
          return (
            Number(item.subject_id) === subjectId &&
            Number(item.group_number) === groupNum &&
            item.day === day &&
            Number(item.class_number) === classNum &&
            item.class_date === classDate
          );
        });
        currentHomeworkItems = filtered;
        if (homeworkTagFilter) {
          homeworkTagFilter.value = '';
        }
        renderHomework(filtered);
        const first = filtered[0];
        if (first) {
          subgroupHomeworkId.value = first.id;
          renderSubgroups(first.subgroups || []);
        } else {
          subgroupSection.classList.add('d-none');
        }
        const hashValue = encodeURIComponent(`${subjectId}|${day}|${classNum}|${groupNum}`);
        if (location.hash !== `#class=${hashValue}`) {
          history.replaceState(null, '', `#class=${hashValue}`);
        }
      });

      homeworkModal.addEventListener('hidden.bs.modal', () => {
        if (location.hash.startsWith('#class=')) {
          history.replaceState(null, '', location.pathname + location.search);
        }
      });

      if (homeworkTagFilter) {
        homeworkTagFilter.addEventListener('input', () => {
          const tag = homeworkTagFilter.value.trim().toLowerCase();
          if (!tag) {
            renderHomework(currentHomeworkItems);
            return;
          }
          const filtered = currentHomeworkItems.filter((item) => {
            const tags = item.tags || [];
            return tags.some((t) => t.toLowerCase() === tag);
          });
          renderHomework(filtered);
        });
      }

      function openModalFromHash() {
        if (!location.hash.startsWith('#class=')) return;
        const payload = decodeURIComponent(location.hash.replace('#class=', ''));
        const [subjectId, day, classNum, groupNum] = payload.split('|');
        if (!subjectId || !day || !classNum || !groupNum) return;

        const match = document.querySelector(
          `[data-subjectid="${subjectId}"][data-day="${day}"][data-classnum="${classNum}"][data-groupnum="${groupNum}"]`
        );
        if (match) {
          match.click();
        }
      }

      window.addEventListener('hashchange', openModalFromHash);
      window.addEventListener('load', openModalFromHash);

      const weekSlider = document.getElementById('weekSlider');
      const messagesBtn = document.getElementById('messagesBtn');
      const messagesList = document.getElementById('messagesList');
      const messagesBadge = document.getElementById('messagesBadge');
      const messagesSubjectFilter = document.getElementById('messagesSubjectFilter');
      const weekPrev = document.getElementById('weekPrev');
      const weekNext = document.getElementById('weekNext');
      const totalWeeks = <%= totalWeeks || 15 %>;
      let currentWeek = <%= currentWeek %>;
      function updateSchedule(week) {
        const safe = Math.max(1, Math.min(totalWeeks, week));
        const params = new URLSearchParams(window.location.search);
        params.set('week', safe);
        window.location.search = params.toString();
      }
      function animateWeekChange(nextWeek) {
        const safe = Math.max(1, Math.min(totalWeeks, nextWeek));
        const active = weekSlider ? weekSlider.querySelector('.week-dot.active') : null;
        const target = weekSlider
          ? weekSlider.querySelector(`.week-dot[data-week="${safe}"]`)
          : null;
        if (active && target && active !== target) {
          active.classList.remove('active');
          target.classList.add('active');
        }
        setTimeout(() => updateSchedule(safe), 220);
      }
      if (weekSlider) {
        weekSlider.addEventListener('click', (event) => {
          const btn = event.target.closest('.week-dot');
          if (!btn) return;
          const week = Number(btn.dataset.week);
          if (!Number.isNaN(week)) animateWeekChange(week);
        });
        if (weekPrev) {
          weekPrev.addEventListener('click', () => animateWeekChange(currentWeek - 1));
        }
        if (weekNext) {
          weekNext.addEventListener('click', () => animateWeekChange(currentWeek + 1));
        }

        let startX = 0;
        weekSlider.addEventListener('touchstart', (event) => {
          startX = event.touches[0].clientX;
        }, { passive: true });
        weekSlider.addEventListener('touchend', (event) => {
          const endX = event.changedTouches[0].clientX;
          const delta = endX - startX;
          if (Math.abs(delta) < 40) return;
          if (delta < 0) animateWeekChange(currentWeek + 1);
          if (delta > 0) animateWeekChange(currentWeek - 1);
        });
      }

      window.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowRight') {
          animateWeekChange(currentWeek + 1);
        }
        if (event.key === 'ArrowLeft') {
          animateWeekChange(currentWeek - 1);
        }
      });

      window.addEventListener('load', () => {
        const content = document.querySelector('.schedule-content');
        if (!content) return;
        requestAnimationFrame(() => {
          content.classList.add('enter-active');
          content.classList.remove('enter');
        });
      });

      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach((el) => {
        new bootstrap.Tooltip(el);
      });

      async function loadMessages() {
        if (!messagesList) return;
        messagesList.innerHTML = '<li class="list-group-item text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</li>';
        try {
          const subjectId = messagesSubjectFilter && messagesSubjectFilter.value
            ? `?subject_id=${encodeURIComponent(messagesSubjectFilter.value)}`
            : '';
          const res = await fetch(`/messages.json${subjectId}`);
          if (!res.ok) throw new Error('bad');
          const data = await res.json();
          if (!data.messages || !data.messages.length) {
            messagesList.innerHTML = '<li class="list-group-item text-muted">–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</li>';
            if (messagesBadge) {
              messagesBadge.classList.add('d-none');
            }
            return;
          }
          messagesList.innerHTML = data.messages
            .map((m) => {
              const meta = m.target_all
                ? '–í—Å—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏'
                : `${m.subject_name || '–ü—Ä–µ–¥–º–µ—Ç'} ¬∑ Group ${m.group_number}`;
              const unreadClass = m.read_id ? '' : 'fw-semibold';
              const reactions = m.reactions || {};
              const reacted = m.reacted || {};
              const makeBtn = (emoji) => {
                const count = reactions[emoji] || 0;
                const active = reacted[emoji] ? 'active' : '';
                return `<button class="btn btn-sm btn-outline-secondary react-btn ${active}" data-message-id="${m.id}" data-emoji="${emoji}">
                  <span>${emoji}</span><span class="react-count">${count}</span>
                </button>`;
              };
              return `
                <li class="list-group-item">
                  <div class="${unreadClass} mb-1">${m.body}</div>
                  <div class="text-muted small">${meta} ¬∑ ${m.created_by || 'Admin'} ¬∑ ${new Date(m.created_at).toLocaleString()}</div>
                  <div class="d-flex gap-2 mt-2 msg-reactions">
                    ${makeBtn('üî•')}
                    ${makeBtn('üëç')}
                  </div>
                </li>
              `;
            })
            .join('');
          if (messagesBadge) {
            const unread = data.unread_count || 0;
            if (unread > 0) {
              messagesBadge.textContent = unread > 99 ? '99+' : String(unread);
              messagesBadge.classList.remove('d-none');
            } else {
              messagesBadge.classList.add('d-none');
            }
          }
          const unreadIds = data.messages.filter((m) => !m.read_id).map((m) => m.id);
          if (unreadIds.length) {
            fetch('/messages/read', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message_ids: unreadIds }),
            });
          }
          const reactionButtons = messagesList.querySelectorAll('.msg-reactions .react-btn');
          reactionButtons.forEach((btn) => {
            btn.addEventListener('click', async () => {
              const messageId = Number(btn.dataset.messageId);
              const emoji = btn.dataset.emoji;
              if (Number.isNaN(messageId) || !emoji) return;
              try {
                const res = await fetch('/messages/react', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message_id: messageId, emoji }),
                });
                if (!res.ok) return;
                const data = await res.json();
                const container = btn.closest('.msg-reactions');
                if (!container) return;
                updateReactionButtons(container, data.reactions, data.reacted);
              } catch (err) {
                console.error(err);
              }
            });
          });
        } catch (err) {
          messagesList.innerHTML = '<li class="list-group-item text-muted">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</li>';
        }
      }

      if (messagesBtn) {
        messagesBtn.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
          modal.show();
          loadMessages();
        });
      }
      if (messagesSubjectFilter) {
        messagesSubjectFilter.addEventListener('change', loadMessages);
      }

      loadMessages();

      const phrases = [
        "Start fresh ‚Äî today is full of potential.",
        "Small steps, big progress.",
        "Focus on now ‚Äî the rest will follow.",
        "One thing at a time ‚Äî and that‚Äôs enough.",
        "You‚Äôve got more in you than you think.",
        "Let clarity lead your day.",
        "Stay present, stay steady.",
        "Keep going ‚Äî you‚Äôre getting closer.",
        "Be kind to your focus.",
        "Today is a great day to grow.",
        "Balance over burnout.",
        "Show up ‚Äî even a little is progress.",
        "A clear mind gets more done.",
        "You set the tone ‚Äî begin with calm.",
        "Progress, not perfection.",
        "Let effort be your win today.",
        "This hour matters ‚Äî make it count.",
        "Energy follows attention.",
        "You‚Äôre building momentum.",
        "Stay grounded, keep moving.",
        "Let your actions match your goals.",
        "Your best today is enough.",
        "Choose one goal, and give it space.",
        "Rest is part of the rhythm.",
        "Trust your pace ‚Äî fast or slow.",
        "You don‚Äôt need to rush to be great.",
        "Small focus. Big ripple.",
        "The day is yours ‚Äî use it gently.",
        "Notice what fuels you today.",
        "Begin again ‚Äî always welcome."
      ];

      function getKyivDayOfYear() {
        const now = new Date();
        const dateString = now.toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
        const [year, month, day] = dateString.split('-').map(Number);
        const start = Date.UTC(year, 0, 1);
        const current = Date.UTC(year, month - 1, day);
        return Math.floor((current - start) / 86400000);
      }

      function updateDailyPhrase() {
        const el = document.getElementById('daily-phrase');
        if (!el) return;
        const dayOfYear = getKyivDayOfYear();
        const phrase = phrases[dayOfYear % phrases.length];
        if (el.textContent === phrase) return;
        el.classList.add('fade-out');
        setTimeout(() => {
          el.textContent = phrase;
          el.classList.remove('fade-out');
        }, 240);
      }

      function scheduleNextMidnight() {
        const now = new Date();
        const kyivNow = new Date(
          now.toLocaleString('en-US', { timeZone: 'Europe/Kyiv' })
        );
        const nextMidnight = new Date(kyivNow);
        nextMidnight.setHours(24, 0, 0, 0);
        const ms = nextMidnight.getTime() - kyivNow.getTime();
        setTimeout(() => {
          updateDailyPhrase();
          scheduleNextMidnight();
        }, ms + 500);
      }

      updateDailyPhrase();
      scheduleNextMidnight();

      const themeToggle = document.getElementById('themeToggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      themeToggle.textContent =
        storedTheme === 'theme-dark' ? themeToggle.dataset.lightLabel : themeToggle.dataset.darkLabel;
      themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.contains('theme-dark');
        const next = isDark ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-dark', 'theme-light');
        document.body.classList.add(next);
        localStorage.setItem('ui-theme', next);
        themeToggle.textContent = next === 'theme-dark' ? themeToggle.dataset.lightLabel : themeToggle.dataset.darkLabel;
      });
    </script>
  </body>
</html>
