<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('schedule.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-2: #8b5cf6;
        --accent-3: #22d3ee;
        --radius: 18px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.12);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.35);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
        transition: background 200ms ease, color 200ms ease;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.22), transparent 60%),
          linear-gradient(135deg, #e6eef8 0%, #e9f0fb 45%, #eef2ff 100%);
        color: #0f172a;
      }
      body.theme-light .text-white {
        color: #0f172a !important;
      }
      body.theme-light .btn-outline-light {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.2);
      }
      body.theme-light .btn-outline-light:hover {
        background: rgba(15, 23, 42, 0.06);
      }
      .topbar {
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.75rem 0;
      }
      body.theme-dark .topbar {
        background: rgba(10, 10, 20, 0.5);
      }
      body.theme-light .topbar {
        background: rgba(255, 255, 255, 0.75);
      }
      .topbar .container-fluid {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .topbar .navbar-brand {
        font-weight: 700;
        font-size: 1.25rem;
        margin-right: auto;
      }
      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .topbar-actions form {
        display: contents;
      }
      @media (max-width: 991px) {
        .topbar-actions {
          flex-basis: 100%;
          order: 3;
          gap: 0.3rem;
        }
      }
      .hero-title {
        font-size: clamp(2.2rem, 4vw, 3rem);
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      .hero-sub {
        color: rgba(255, 255, 255, 0.35);
      }
      body.theme-light .hero-sub {
        color: rgba(15, 23, 42, 0.65);
      }
      #daily-phrase {
        transition: opacity 240ms ease;
      }
      #daily-phrase.fade-out {
        opacity: 0;
      }
      .glass {
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .glass {
        background: var(--glass-bg-dark);
        border: 1px solid var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18), 0 0 0 1px rgba(255, 255, 255, 0.35) inset;
      }
      .week-hero {
        padding: 22px 26px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 18px;
      }
      @media (max-width: 768px) {
        .week-hero {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      .badge-glow {
        background: linear-gradient(135deg, #93c5fd, #c4b5fd);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.35);
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        font-weight: 700;
        box-shadow: 0 8px 18px rgba(59, 130, 246, 0.22);
      }
      .hero-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      @media (min-width: 769px) {
        .hero-actions {
          flex-direction: column;
          align-items: flex-end;
        }
      }
      .btn-glass {
        border-radius: 999px;
        padding: 0.42rem 0.9rem;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .btn-glass:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.35);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      }
      body.theme-light .badge-glow {
        color: #0f172a;
        background: linear-gradient(135deg, rgba(147, 197, 253, 0.55), rgba(196, 181, 253, 0.45));
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-light .btn-glass {
        color: #0f172a;
        background: rgba(255, 255, 255, 0.35);
        border-color: rgba(15, 23, 42, 0.15);
      }
      body.theme-light .btn-glass:hover {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
      }
      .hw-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.35);
        color: #dbeafe;
      }
      body.theme-light .hw-chip {
        background: rgba(59, 130, 246, 0.12);
        color: #1e3a8a;
      }
      .tag-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-light .tag-pill {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
        color: #0f172a;
      }
      .react-btn {
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        line-height: 1.2;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      body.theme-dark .react-btn {
        color: rgba(248, 250, 252, 0.92);
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.35);
      }
      body.theme-light .react-btn {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.18);
        background: rgba(15, 23, 42, 0.04);
      }
      .react-btn.active {
        background: rgba(59, 130, 246, 0.25);
        border-color: rgba(59, 130, 246, 0.6);
        color: #e2e8f0;
      }
      body.theme-light .react-btn.active {
        background: rgba(59, 130, 246, 0.18);
        color: #0f172a;
      }
      .hw-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .week-slider {
        position: fixed;
        left: 50%;
        bottom: 20px;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 10px 16px;
        border-radius: 20px;
        backdrop-filter: blur(8px);
        z-index: 1050;
      }
      body.theme-dark .week-slider {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      body.theme-light .week-slider {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(15, 23, 42, 0.12);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
      }
      @media (max-width: 576px) {
        .week-slider {
          bottom: 16px;
        }
      }
      .week-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.4);
        opacity: 0.3;
        cursor: pointer;
        transition: transform 220ms ease, background 220ms ease, width 260ms ease, box-shadow 260ms ease;
      }
      .week-dot:hover {
        transform: scale(1.15);
        opacity: 0.6;
      }
      .week-dot.active {
        width: 28px;
        height: 8px;
        opacity: 1;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
      }
      .week-dot.active {
        transform: scale(1.05);
      }
      body.theme-light .week-dot {
        background: rgba(15, 23, 42, 0.4);
      }
      body.theme-light .week-dot.active {
        background: rgba(15, 23, 42, 0.85);
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        animation: modalIn 260ms ease;
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      .glass-welcome-modal {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        color: #f8fafc;
        max-width: 480px;
        margin: auto;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light .glass-welcome-modal {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
      }
      .welcome-title {
        font-size: 1.6rem;
        font-weight: 800;
      }
      .welcome-subtitle {
        color: rgba(248, 250, 252, 0.75);
      }
      body.theme-light .welcome-subtitle {
        color: rgba(15, 23, 42, 0.7);
      }
      .custom-tooltip {
        position: fixed;
        z-index: 2000;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 220ms ease, transform 220ms ease;
      }
      .custom-tooltip.show {
        opacity: 1;
        transform: translateY(0);
      }
      .custom-tooltip::before {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 20px;
        border: 6px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.08);
      }
      .custom-tooltip.below::before {
        top: -6px;
        bottom: auto;
        border-top-color: transparent;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-light .custom-tooltip {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      body.theme-light .custom-tooltip::before {
        border-top-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-light .custom-tooltip.below::before {
        border-bottom-color: rgba(255, 255, 255, 0.85);
      }
      .tooltip .tooltip-inner {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-size: 0.95rem;
      }
      body.theme-light .tooltip .tooltip-inner {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      .tooltip .tooltip-arrow::before {
        border-top-color: rgba(255, 255, 255, 0.18);
      }
      body.theme-light .tooltip .tooltip-arrow::before {
        border-top-color: rgba(255, 255, 255, 0.9);
      }
      @keyframes modalIn {
        from {
          transform: scale(0.98);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-light .btn-primary.glass {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border-radius: 14px;
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: inherit;
        font-size: 0.95rem;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      select.form-select option {
        background: #0f172a;
        color: #f8fafc;
      }
      body.theme-light select.form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark select.form-select option:checked,
      body.theme-dark select.form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light select.form-select option:checked,
      body.theme-light select.form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      .week-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .week-nav-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.5);
        border-color: rgba(147, 197, 253, 0.7);
        background: rgba(255, 255, 255, 0.14);
      }
      .week-nav-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35);
      }
      body.theme-light .week-nav-btn {
        background: rgba(255, 255, 255, 0.85);
        border-color: rgba(15, 23, 42, 0.18);
        color: #0f172a;
      }
      .schedule-content {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .schedule-content.enter {
        opacity: 0;
        transform: translateY(12px);
        animation: scheduleIn 320ms ease forwards;
      }
      .schedule-content.enter-active {
        opacity: 1;
        transform: translateY(0);
      }
      @keyframes scheduleIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      body.welcome-open .schedule-content,
      body.welcome-open .topbar,
      body.welcome-open .week-slider,
      body.welcome-open .app-footer {
        filter: blur(8px);
        transition: filter 200ms ease;
      }
      body.welcome-open .schedule-content {
        pointer-events: none;
      }
      .day-card .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.16);
        font-weight: 700;
      }
      body.theme-light .day-card .card-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      .list-group-item {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 14px;
        margin: 6px 0;
        padding: 16px;
        width: 100%;
        box-sizing: border-box;
        transition: background 200ms ease, box-shadow 200ms ease, transform 200ms ease;
      }
      body.theme-light .list-group-item {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.18);
      }
      .deadline-block {
        background: rgba(250, 204, 21, 0.12);
        border: 1px solid rgba(250, 204, 21, 0.35);
        border-radius: 14px;
        padding: 14px 16px;
        margin: 10px 0;
      }
      .deadline-title {
        font-weight: 700;
        color: #fde68a;
        margin-bottom: 8px;
      }
      .deadline-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(15, 23, 42, 0.2);
        transition: background 160ms ease, transform 160ms ease;
      }
      body.theme-dark .deadline-item {
        color: #f8fafc;
      }
      .deadline-item + .deadline-item {
        margin-top: 6px;
      }
      .deadline-item:hover {
        transform: translateY(-1px);
        background: rgba(250, 204, 21, 0.18);
      }
      .deadline-meta {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.75);
      }
      body.theme-light .deadline-block {
        background: rgba(250, 204, 21, 0.18);
        border-color: rgba(250, 204, 21, 0.35);
      }
      body.theme-light .deadline-title {
        color: #92400e;
      }
      body.theme-light .deadline-item {
        background: rgba(255, 255, 255, 0.8);
      }
      body.theme-light .deadline-meta {
        color: rgba(15, 23, 42, 0.7);
      }
      .list-group-item-action:hover {
        box-shadow: inset 0 0 0 2px rgba(147, 197, 253, 0.3);
        transform: translateY(-1px);
      }
      body.theme-light .list-group-item-action:hover {
        box-shadow: inset 0 0 0 2px rgba(59, 130, 246, 0.3);
      }
      body.theme-dark .list-group-item-action:focus,
      body.theme-dark .list-group-item-action:active {
        background: rgba(139, 92, 246, 0.22);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) inset;
      }
      .muted {
        color: rgba(255, 255, 255, 0.35);
      }
      body.theme-light .muted {
        color: rgba(15, 23, 42, 0.6);
      }
      body.theme-dark .list-group-item .fw-semibold {
        color: #f8fafc;
      }
      body.theme-dark .day-card .card-header {
        color: #f8fafc;
      }
      .day-card .list-group {
        padding: 10px 12px 12px;
      }
      .day-card .list-group.list-group-flush > .list-group-item {
        border-radius: 14px !important;
      }
      @media (max-width: 768px) {
        .day-card .list-group {
          padding: 8px 10px 10px;
        }
        .list-group-item {
          padding: 14px;
          border-radius: 12px;
        }
      }
      .form-control {
        border-radius: 12px;
      }
      body.theme-dark .form-control {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      body.theme-light .form-control {
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        border: 1px solid rgba(15, 23, 42, 0.16);
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--accent-3);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
      }
      body.theme-dark .modal-content .list-group-item {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content .text-muted {
        color: rgba(248, 250, 252, 0.65) !important;
      }
      body.theme-dark .modal-content .form-label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .modal-content ::placeholder {
        color: rgba(248, 250, 252, 0.6);
      }
      body.theme-dark .modal-content a {
        color: #93c5fd;
      }
      body.theme-dark .modal-content a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border: none;
        border-radius: 12px;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      .theme-toggle {
        border-radius: 999px;
      }
      .msg-btn {
        border-radius: 999px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        position: relative;
      }
      .msg-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 18px;
        height: 18px;
        border-radius: 999px;
        background: #ef4444;
        color: #fff;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      .mobile-menu-btn {
        border-radius: 999px;
        width: 38px;
        height: 38px;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .mobile-menu-action {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.92);
        text-align: left;
        font-size: 0.95rem;
        padding: 12px 14px;
        width: 100%;
      }
      .mobile-menu-action:hover {
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(255, 255, 255, 0.3);
      }
            body.theme-dark .mobile-menu-action {
        color: #f8fafc;
      }
body.theme-light .mobile-menu-action {
        background: rgba(255, 255, 255, 0.82);
        border-color: rgba(15, 23, 42, 0.14);
        color: #0f172a;
      }
      body.theme-light .mobile-menu-action:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(15, 23, 42, 0.2);
      }
      #mobileMenuModal .modal-content {
        border-radius: 18px;
        background: rgba(20, 24, 36, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-light #mobileMenuModal .modal-content {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(15, 23, 42, 0.1);
      }
      #mobileMenuModal .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        padding: 14px 16px;
      }
      body.theme-light #mobileMenuModal .modal-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      #mobileMenuModal .modal-title {
        font-size: 1.05rem;
        font-weight: 700;
      }
      #mobileMenuModal .modal-body {
        padding: 12px 16px 16px;
      }
      #mobileMenuModal .btn-close {
        filter: brightness(1.35);
        opacity: 0.9;
      }
      body.theme-dark #mobileMenuModal .btn-close {
        filter: brightness(1.8);
        opacity: 0.95;
      }
      body.theme-light #mobileMenuModal .btn-close {
        filter: none;
        opacity: 0.75;
      }
      @media (max-width: 768px) {
        .topbar-actions .desktop-only {
          display: none !important;
        }
        .topbar-actions .mobile-menu-btn {
          display: inline-flex !important;
        }
        .topbar-actions {
          gap: 8px;
        }
        .week-slider {
          gap: 10px;
          padding: 8px 12px;
        }
        .week-nav-btn {
          width: 46px;
          height: 46px;
          font-size: 18px;
        }
        .week-dot.hidden-mobile {
          display: none !important;
        }
        .schedule-content {
          padding-left: 12px;
          padding-right: 12px;
        }
        .week-hero {
          padding: 16px 18px;
        }
        .hero-title {
          font-size: 1.9rem;
        }
        body {
          font-size: 0.95rem;
        }
        .btn,
        .btn-glass {
          min-height: 38px;
        }
      }
      .app-footer {
        font-size: 0.85rem;
        padding-bottom: 120px;
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
      :root {
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 10px;
        --s-1: 8px;
        --s-2: 12px;
        --s-3: 16px;
        --s-4: 24px;
        --border-subtle: 1px solid rgba(255, 255, 255, 0.12);
        --border-hover: 1px solid rgba(255, 255, 255, 0.18);
        --glass-bg: rgba(20, 24, 32, 0.45);
        --glass-bg-light: rgba(255, 255, 255, 0.55);
        --glass-blur: 18px;
        --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        --text-primary: rgba(255, 255, 255, 0.92);
        --text-secondary: rgba(255, 255, 255, 0.68);
        --text-muted: rgba(255, 255, 255, 0.52);
        --focus-ring: 0 0 0 3px rgba(90, 140, 255, 0.25);
        --focus-border: rgba(90, 140, 255, 0.65);
      }
      body.theme-light {
        --text-primary: rgba(15, 23, 42, 0.92);
        --text-secondary: rgba(15, 23, 42, 0.68);
        --text-muted: rgba(15, 23, 42, 0.52);
      }
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image:
          repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 2px),
          repeating-linear-gradient(90deg, rgba(0,0,0,0.03) 0, rgba(0,0,0,0.03) 1px, transparent 1px, transparent 2px);
        opacity: 0.05;
        mix-blend-mode: soft-light;
        z-index: -1;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.18), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.14), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #121a2b 100%);
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.18), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.18), transparent 60%),
          linear-gradient(135deg, #ecf2fb 0%, #eef3fb 45%, #f5f7ff 100%);
      }
      .glass {
        border-radius: var(--radius-lg);
        backdrop-filter: blur(var(--glass-blur));
        background: var(--glass-bg);
        border: var(--border-subtle);
        box-shadow: var(--glass-shadow);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      }
      .hero-title {
        font-weight: 600;
      }
      .hero-sub {
        color: var(--text-secondary);
      }
      .form-label {
        color: var(--text-secondary);
      }
      .form-control,
      .form-select {
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
      }
      body.theme-light .form-control,
      body.theme-light .form-select {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.12);
        color: var(--text-primary);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--focus-border);
        box-shadow: var(--focus-ring);
      }
      .btn-primary {
        background: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.6);
        border-radius: var(--radius-md);
        height: 44px;
      }
      .btn-outline-light {
        border-radius: var(--radius-md);
      }
      .btn-ghost {
        border: none;
        background: transparent;
        color: var(--text-secondary);
      }
      .theme-toggle-min {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
      }
      body.theme-light .theme-toggle-min {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      .modal-backdrop.show {
        opacity: 0.48;
      }
      .modal-content {
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: var(--glass-bg);
        border: var(--border-subtle);
        backdrop-filter: blur(var(--glass-blur));
      }
      body.theme-light .modal-content {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
      .modal-header,
      .modal-footer {
        position: sticky;
        z-index: 2;
        background: inherit;
        backdrop-filter: blur(var(--glass-blur));
      }
      .modal-header {
        top: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-footer {
        bottom: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-body {
        overflow-y: auto;
      }
      .btn-close {
        filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.2));
      }
      .file-field {
        display: grid;
        gap: 8px;
        position: relative;
      }
      .file-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .file-ui {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-light .file-ui {
        border-color: rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
      }
      .file-name {
        color: var(--text-muted);
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body class="theme-dark">
    <nav class="navbar navbar-expand-lg topbar">
      <div class="container-fluid px-3 px-lg-4">
        <span class="navbar-brand text-white me-auto">Studerria</span>
        <div class="d-flex align-items-center gap-2 topbar-actions flex-wrap justify-content-end">
          <span class="me-2 muted desktop-only text-nowrap">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.student') %>: <%= username %>
            <% } %>
          </span>
          <% if (role === 'admin') { %>
            <form method="POST" action="/admin/switch-to-admin" class="me-1 desktop-only">
              <button class="btn btn-outline-primary btn-sm" type="submit"><%= t('schedule.backToAdmin') %></button>
            </form>
          <% } %>
          <% if (role === 'starosta') { %>
            <a class="btn btn-outline-primary btn-sm me-1 desktop-only" href="/starosta"><%= t('menu.starosta') %></a>
          <% } %>
          <% if (role === 'deanery') { %>
            <a class="btn btn-outline-primary btn-sm me-1 desktop-only" href="/deanery"><%= t('menu.deanery') %></a>
          <% } %>
          <button class="btn btn-outline-light btn-sm me-1 msg-btn desktop-only" type="button" id="messagesBtn" aria-label="<%= t('messages.aria') %>">
            ðŸ’¬
            <span class="msg-badge d-none" id="messagesBadge">0</span>
          </button>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/teamwork"><%= t('menu.teamwork') %></a>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/my-day">ÐœÑ–Ð¹ Ð´ÐµÐ½ÑŒ</a>
          <button
            class="theme-toggle theme-toggle-min me-1 desktop-only"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="â˜€ï¸"
            data-dark-label="ðŸŒ™"
          >
            ðŸŒ™
          </button>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/profile"><%= t('schedule.profile') %></a>
          <form method="POST" action="/logout" class="desktop-only">
            <button class="btn btn-outline-light btn-sm" type="submit"><%= t('schedule.logout') %></button>
          </form>
          <button
            class="btn btn-outline-light btn-sm mobile-menu-btn"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#mobileMenuModal"
            aria-label="Menu"
          >
            â˜°
          </button>
        </div>
      </div>
    </nav>

    <main class="container py-4 schedule-content enter">
      <div class="glass week-hero mb-4">
        <div>
          <h1 class="hero-title mb-1"><%= t('schedule.header') %></h1>
          <div class="hero-sub" id="daily-phrase">Your rhythm, your focus â€” letâ€™s make this week count.</div>
        </div>
        <div class="hero-actions">
          <span class="badge-glow"><%= t('schedule.week') %> <%= currentWeek %></span>
          <% if (role === 'student' || role === 'starosta' || viewAs === 'student') { %>
            <button class="btn btn-glass btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#customDeadlineModal">
              ðŸª„ Ð”Ð¸Ð²Ð½Ñ– Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¸
            </button>
          <% } %>
        </div>
      </div>

      <% if (role === 'admin') { %>
        <div class="alert alert-info glass text-white border-0">
          <%= t('schedule.adminViewNotice') %>
        </div>
      <% } %>

      <% if (subgroupError === 'exists') { %>
        <div class="alert alert-warning glass text-white border-0">
          You are already in a subgroup for this homework.
        </div>
      <% } %>

      <% daysOfWeek.forEach(function(day) { %>
        <% const dateLabel = dayDates && dayDates[day] ? new Date(dayDates[day]).toLocaleDateString('uk-UA') : ''; %>
        <div class="card mb-3 glass day-card">
          <div class="card-header fw-semibold text-white d-flex justify-content-between align-items-center">
            <span><%= day %></span>
            <% if (dateLabel) { %>
              <span class="small muted"><%= dateLabel %></span>
            <% } %>
          </div>
          <div class="list-group list-group-flush">
            <% if (!scheduleByDay[day] || scheduleByDay[day].length === 0) { %>
              <div class="list-group-item muted">No classes</div>
            <% } else { %>
              <% scheduleByDay[day].forEach(function(cls) { %>
                <% const slot = bellSchedule[cls.class_number]; %>
                <% const timeLabel = slot ? `${slot.start} - ${slot.end}` : ''; %>
                <% const legacyKey = `${cls.subject_id}|${cls.group_number}|${cls.day_of_week}|${cls.class_number}`; %>
                <% const datedKey = cls.class_date ? `${legacyKey}|${cls.class_date}` : null; %>
                <% const hwMeta = homeworkMeta ? (datedKey ? homeworkMeta[datedKey] : homeworkMeta[legacyKey]) : null; %>
                <button
                  class="list-group-item list-group-item-action"
                  type="button"
                  data-bs-toggle="modal"
                  data-bs-target="#homeworkModal"
                  data-class="<%= cls.subject_name %>"
                  data-subjectid="<%= cls.subject_id %>"
                  data-day="<%= cls.day_of_week %>"
                  data-time="<%= timeLabel %>"
                  data-classnum="<%= cls.class_number %>"
                  data-groupnum="<%= cls.group_number %>"
                  data-date="<%= cls.class_date %>"
                  <% if (hwMeta) { %>
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="<%= hwMeta.preview.join(' â€¢ ') %>"
                  <% } %>
                >
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold"><%= cls.subject_name %></div>
                      <div class="small muted">Group <%= cls.group_number %> Â· Class <%= cls.class_number %></div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <% if (hwMeta) { %>
                        <span class="hw-chip">Ð”Ð— <%= hwMeta.count %></span>
                      <% } %>
                      <div class="muted small"><%= timeLabel %></div>
                    </div>
                  </div>
                </button>
              <% }); %>
            <% } %>
          </div>
          <% const dateKey = dayDates && dayDates[day] ? dayDates[day] : null; %>
          <% const customItems = dateKey && customDeadlinesByDate ? customDeadlinesByDate[dateKey] : null; %>
          <% if (customItems && customItems.length) { %>
            <div class="deadline-block">
              <div class="deadline-title">ðŸª„ Ð”Ð¸Ð²Ð½Ñ– Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¸</div>
              <% customItems.forEach(function(item) { %>
                <% const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : ''; %>
                <% const shortDesc = item.description ? (item.description.length > 80 ? item.description.slice(0, 80) + 'â€¦' : item.description) : ''; %>
                <div
                  class="deadline-item"
                  data-custom-id="<%= item.id %>"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="<%= shortDesc %>"
                >
                  <div>
                    <div class="fw-semibold"><%= item.subject_name %></div>
                    <div class="deadline-meta">Ð”ÐµÐ´Ð»Ð°Ð¹Ð½: <%= dueLabel %></div>
                  </div>
                </div>
              <% }); %>
            </div>
          <% } %>
        </div>
      <% }); %>
      <% const activeDaySet = new Set(daysOfWeek || []); %>
      <% if (weekendDeadlineCards && weekendDeadlineCards.length) { %>
        <% weekendDeadlineCards.forEach(function(card) { %>
          <% if (activeDaySet.has(card.day)) { return; } %>
          <% const dateLabel = card.date ? new Date(card.date).toLocaleDateString('uk-UA') : ''; %>
          <div class="card mb-3 glass day-card">
            <div class="card-header fw-semibold text-white d-flex justify-content-between align-items-center">
              <span><%= card.day %></span>
              <% if (dateLabel) { %>
                <span class="small muted"><%= dateLabel %></span>
              <% } %>
            </div>
            <div class="deadline-block">
              <div class="deadline-title">ðŸª„ Ð”Ð¸Ð²Ð½Ñ– Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¸</div>
              <% card.items.forEach(function(item) { %>
                <% const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : ''; %>
                <% const shortDesc = item.description ? (item.description.length > 80 ? item.description.slice(0, 80) + 'â€¦' : item.description) : ''; %>
                <div
                  class="deadline-item"
                  data-custom-id="<%= item.id %>"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="<%= shortDesc %>"
                >
                  <div>
                    <div class="fw-semibold"><%= item.subject_name %></div>
                    <div class="deadline-meta">Ð”ÐµÐ´Ð»Ð°Ð¹Ð½: <%= dueLabel %></div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        <% }); %>
      <% } %>
    </main>

    <div class="week-slider" id="weekSlider">
      <button class="week-nav-btn" type="button" id="weekPrev" aria-label="Previous week">â€¹</button>
      <% for (let w = 1; w <= (totalWeeks || 15); w++) { %>
        <button
          type="button"
          class="week-dot <%= w === currentWeek ? 'active' : '' %>"
          data-week="<%= w %>"
          aria-label="<%= t('schedule.week') %> <%= w %>"
        ></button>
      <% } %>
      <button class="week-nav-btn" type="button" id="weekNext" aria-label="Next week">â€º</button>
    </div>

    <footer class="app-footer text-center py-4">
      <small>Â© <%= new Date().getFullYear() %> <%= authorName %> Â· v<%= appVersion %> Â· <%= buildStamp %></small>
    </footer>

    <div class="modal fade" id="homeworkModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="homeworkModalTitle">Class details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Selected class:</strong>
              <span id="homeworkModalMeta" class="text-muted"></span>
            </div>

            <h6>Homework list</h6>
            <div class="mb-2">
              <label class="form-label">Filter by tag</label>
              <input
                id="homeworkTagFilter"
                class="form-control"
                list="homeworkTagsList"
                placeholder="#Ñ‚ÐµÑÑ‚ Ð°Ð±Ð¾ #Ð¾Ð½Ð»Ð°Ð¹Ð½"
              />
            </div>
            <ul id="homeworkList" class="list-group mb-4">
              <li class="list-group-item text-muted">No assignments yet.</li>
            </ul>

            <div id="subgroupSection" class="mb-4 d-none">
              <h6>Subgroups</h6>
              <div id="subgroupList" class="list-group mb-3"></div>

              <div class="card mb-3">
                <div class="card-body">
                  <form method="POST" action="/subgroup/create">
                    <input type="hidden" id="subgroupHomeworkId" name="homework_id" />
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-8">
                        <label for="subgroupName" class="form-label">Create new subgroup</label>
                        <input id="subgroupName" name="name" class="form-control" placeholder="Group name" required />
                      </div>
                      <div class="col-12 col-md-4">
                        <button type="submit" class="btn btn-outline-primary w-100 glass">Create</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <form method="POST" action="/subgroup/join">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-8">
                    <label for="joinSubgroupId" class="form-label">Join existing subgroup</label>
                    <select id="joinSubgroupId" name="subgroup_id" class="form-select" required>
                      <option value="" disabled selected>Select subgroup</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <button type="submit" class="btn btn-outline-secondary w-100 glass">Join</button>
                  </div>
                </div>
              </form>
            </div>

            <h6>Add homework</h6>
            <form method="POST" action="/homework/add" enctype="multipart/form-data" autocomplete="off">
              <div class="mb-3">
                <label for="hwText" class="form-label">Description</label>
                <textarea id="hwText" name="description" class="form-control" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="hwLink" class="form-label">Link (optional)</label>
                <input id="hwLink" name="link_url" type="url" class="form-control" placeholder="https://example.com" autocomplete="off" />
              </div>
              <div class="mb-3">
                <label for="hwMeeting" class="form-label">Online class link (Zoom/Teams)</label>
                <input
                  id="hwMeeting"
                  name="meeting_url"
                  type="url"
                  class="form-control"
                  placeholder="https://zoom.us/j/..."
                  autocomplete="off"
                />
              </div>
              <div class="mb-3">
                <label for="hwTags" class="form-label">Tags (comma separated)</label>
                <input
                  id="hwTags"
                  name="tags"
                  type="text"
                  class="form-control"
                  list="homeworkTagsList"
                  placeholder="#Ñ‚ÐµÑÑ‚, #Ð»ÐµÐºÑ†Ñ–Ñ"
                />
              </div>
              <div class="mb-3">
                <label for="hwFile" class="form-label">Attachment (optional)</label>
                <div class="file-field">
                  <input id="hwFile" name="attachment" type="file" class="file-input" />
                  <div class="file-ui">
                    <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="hwFile">ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ</button>
                    <span class="file-name" data-file-name="hwFile">Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ð¸Ð±Ñ€Ð°Ð½Ð¾</span>
                  </div>
                </div>
              </div>
              <% if (role && role !== 'student') { %>
                <div class="row g-2 mb-3">
                  <div class="col-12 col-md-4">
                    <label for="hwStatus" class="form-label">Publication</label>
                    <select id="hwStatus" name="status" class="form-select">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-5">
                    <label for="hwScheduledAt" class="form-label">Publish at</label>
                    <input id="hwScheduledAt" name="scheduled_at" type="datetime-local" class="form-control" />
                  </div>
                </div>
              <% } %>
              <input type="hidden" id="hwSubjectId" name="subject_id" />
              <input type="hidden" id="hwGroupNum" name="group_number" />
              <input type="hidden" id="hwDay" name="day_of_week" />
              <input type="hidden" id="hwTime" name="time" />
              <input type="hidden" id="hwClassNum" name="class_number" />
              <input type="hidden" id="hwDate" name="class_date" />
              <button type="submit" class="btn btn-primary glass">Save homework</button>
            </form>
            <datalist id="homeworkTagsList">
              <% (homeworkTags || []).forEach(function(tag) { %>
                <option value="<%= tag %>"></option>
              <% }); %>
            </datalist>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="customDeadlineModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <form method="POST" action="/homework/custom" enctype="multipart/form-data" autocomplete="off">
            <div class="modal-header">
              <h5 class="modal-title">ðŸª„ Ð”Ð¸Ð²Ð½Ñ– Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¸</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <% if (!customDeadlineSubjects || !customDeadlineSubjects.length) { %>
                <div class="alert alert-warning">Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð¾Ð±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¸ Ñƒ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»Ñ–, Ñ‰Ð¾Ð± Ð´Ð¾Ð´Ð°Ñ‚Ð¸ Ð´ÐµÐ´Ð»Ð°Ð¹Ð½.</div>
              <% } %>
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚</label>
                  <select class="form-select" name="subject_id" <%= (!customDeadlineSubjects || !customDeadlineSubjects.length) ? 'disabled' : '' %> required>
                    <option value="" disabled selected>ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚</option>
                    <% (customDeadlineSubjects || []).forEach(function(subj) { %>
                      <option value="<%= subj.id %>"><%= subj.name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Ð”ÐµÐ´Ð»Ð°Ð¹Ð½</label>
                  <input type="date" class="form-control" name="custom_due_date" required />
                </div>
                <% if (role && role !== 'student') { %>
                  <div class="col-12 col-md-4">
                    <label class="form-label">Publication</label>
                    <select id="customHwStatus" name="status" class="form-select">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-5">
                    <label class="form-label">Publish at</label>
                    <input id="customHwScheduledAt" name="scheduled_at" type="datetime-local" class="form-control" />
                  </div>
                <% } %>
                <div class="col-12">
                  <label class="form-label">ÐžÐ¿Ð¸Ñ</label>
                  <textarea class="form-control" name="description" rows="3" required></textarea>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">ÐŸÐ¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ (Ð¾Ð¿Ñ†.)</label>
                  <input type="url" class="form-control" name="link_url" placeholder="https://example.com" autocomplete="off" />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">ÐžÐ½Ð»Ð°Ð¹Ð½-Ð·ÑƒÑÑ‚Ñ€Ñ–Ñ‡ (Ð¾Ð¿Ñ†.)</label>
                  <input type="url" class="form-control" name="meeting_url" placeholder="https://zoom.us/j/..." autocomplete="off" />
                </div>
                <div class="col-12">
                  <label class="form-label">Ð¤Ð°Ð¹Ð» (Ð¾Ð¿Ñ†.)</label>
                  <div class="file-field">
                    <input id="customFile" type="file" class="file-input" name="attachment" />
                    <div class="file-ui">
                      <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="customFile">ÐžÐ±ÐµÑ€Ñ–Ñ‚ÑŒ</button>
                      <span class="file-name" data-file-name="customFile">Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ð¸Ð±Ñ€Ð°Ð½Ð¾</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Ð—Ð°ÐºÑ€Ð¸Ñ‚Ð¸</button>
              <button type="submit" class="btn btn-primary glass" <%= (!customDeadlineSubjects || !customDeadlineSubjects.length) ? 'disabled' : '' %>>
                Ð—Ð±ÐµÑ€ÐµÐ³Ñ‚Ð¸
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="customDeadlineViewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ðŸª„ Ð”Ð¸Ð²Ð½Ñ– Ð´ÐµÐ´Ð»Ð°Ð¹Ð½Ð¸</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <div class="fw-semibold" id="customDeadlineSubject"></div>
              <div class="text-muted" id="customDeadlineDue"></div>
            </div>
            <div class="mb-3" id="customDeadlineDescription"></div>
            <div class="mb-2" id="customDeadlineLinks"></div>
            <div class="d-flex align-items-center gap-2" id="customDeadlineReactions">
              <button class="react-btn" type="button" data-emoji="ðŸ”¥">ðŸ”¥ <span class="react-count">0</span></button>
              <button class="react-btn" type="button" data-emoji="ðŸ‘">ðŸ‘ <span class="react-count">0</span></button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="mobileMenuModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ÐœÐµÐ½ÑŽ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <% if (role === 'admin') { %>
                <form method="POST" action="/admin/switch-to-admin">
                  <button class="btn w-100 glass mobile-menu-action" type="submit"><%= t('schedule.backToAdmin') %></button>
                </form>
              <% } %>
              <% if (role === 'starosta') { %>
                <a class="btn w-100 glass mobile-menu-action" href="/starosta"><%= t('menu.starosta') %></a>
              <% } %>
              <% if (role === 'deanery') { %>
                <a class="btn w-100 glass mobile-menu-action" href="/deanery"><%= t('menu.deanery') %></a>
              <% } %>
              <button class="btn w-100 glass mobile-menu-action" type="button" id="messagesBtnMobile" aria-label="<%= t('messages.aria') %>">
                ðŸ’¬ ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ
              </button>
              <a class="btn w-100 glass mobile-menu-action" href="/my-day">ÐœÑ–Ð¹ Ð´ÐµÐ½ÑŒ</a>
              <a class="btn w-100 glass mobile-menu-action" href="/teamwork"><%= t('menu.teamwork') %></a>
              <button
                class="btn w-100 glass mobile-menu-action theme-toggle"
                type="button"
                data-light-label="â˜€ï¸"
                data-dark-label="ðŸŒ™"
              >
                ðŸŒ™
              </button>
              <a class="btn w-100 glass mobile-menu-action" href="/profile"><%= t('schedule.profile') %></a>
              <form method="POST" action="/logout">
                <button class="btn w-100 glass mobile-menu-action" type="submit"><%= t('schedule.logout') %></button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="messagesModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Ð¤Ñ–Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñƒ</label>
              <select class="form-select" id="messagesSubjectFilter">
                <option value="">Ð£ÑÑ– Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¸</option>
                <% (messageSubjects || []).forEach(function(s) { %>
                  <option value="<%= s.subject_id %>"><%= s.subject_name %></option>
                <% }); %>
              </select>
            </div>
            <ul id="messagesList" class="list-group">
              <li class="list-group-item text-muted">Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-welcome-modal">
          <div class="modal-body text-center">
            <div class="welcome-title mb-2">ðŸ‘‹ Ð›Ð°ÑÐºÐ°Ð²Ð¾ Ð¿Ñ€Ð¾ÑÐ¸Ð¼Ð¾ Ð´Ð¾ Studerria!</div>
            <div class="welcome-subtitle mb-3">
              Ñ–Ð· Ð·Ð°Ð´Ð¾Ð²Ð¾Ð»ÐµÐ½Ð½ÑÐ¼ Ð¿Ñ€ÐµÐ·ÐµÐ½Ñ‚ÑƒÑ”Ð¼Ð¾ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñƒ <strong>Studerria</strong>, ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ñƒ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¾Ð¼ - Ð´Ð»Ñ ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ñ–Ð².
            </div>
            <div class="small mb-4">
              ðŸŽ¯ ÐžÑ€Ð³Ð°Ð½Ñ–Ð·Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ Ð¿Ð°Ñ€Ð¸, Ð´Ð¾Ð¼Ð°ÑˆÐ½Ñ– Ð·Ð°Ð²Ð´Ð°Ð½Ð½Ñ Ñ‚Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ñƒ Ñ€Ð¾Ð±Ð¾Ñ‚Ñƒ Ð· Ñ”Ð´Ð¸Ð½Ð¾Ð³Ð¾ Ð·Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ñ€Ñƒ.
              <br />
              âš™ï¸ Ð£ÑÑ– Ð·Ð°ÑƒÐ²Ð°Ð¶ÐµÐ½Ð½Ñ, Ð±Ð°Ð³Ð¸ Ñ‡Ð¸ Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ— â€” Ð½Ð°Ð´ÑÐ¸Ð»Ð°Ð¹Ñ‚Ðµ Ð½Ð°Ð¿Ñ€ÑÐ¼Ñƒ Ð°Ð´Ð¼Ñ–Ð½Ñ–ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¸.
            </div>
            <button type="button" class="btn btn-primary glass" data-bs-dismiss="modal">ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¸ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ</button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      function showCustomTooltip(el, message) {
        document.querySelectorAll('.custom-tooltip').forEach((t) => t.remove());
        const anchor = el.closest('.form-check') || el.closest('.input-group') || el;
        const key = el.id || el.name || anchor.id || '';
        const tip = document.createElement('div');
        tip.className = 'custom-tooltip';
        tip.textContent = message || 'ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ Ð¿Ð¾Ð»Ðµ';
        if (key) tip.dataset.for = key;
        document.body.appendChild(tip);

        const rect = anchor.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        const margin = 10;
        let top = rect.bottom + margin;
        let left = rect.left;
        let placeBelow = true;
        if (top + tipRect.height > window.innerHeight - 8) {
          top = rect.top - tipRect.height - margin;
          placeBelow = false;
        }
        if (left + tipRect.width > window.innerWidth - 8) {
          left = window.innerWidth - tipRect.width - 8;
        }
        if (left < 8) left = 8;
        tip.style.top = `${Math.round(top)}px`;
        tip.style.left = `${Math.round(left)}px`;
        if (placeBelow) tip.classList.add('below');
        requestAnimationFrame(() => tip.classList.add('show'));
        const remove = () => tip.remove();
        tip.addEventListener('click', remove);
        setTimeout(remove, 3500);
      }

      function attachValidationTooltips(root = document) {
        root.querySelectorAll('input, select, textarea').forEach((el) => {
          el.addEventListener('invalid', (event) => {
            event.preventDefault();
            showCustomTooltip(el, el.validationMessage);
          });
          el.addEventListener('input', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
          el.addEventListener('blur', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
        });
      }

      attachValidationTooltips();

      function bindScheduleStatus(selectId, inputId) {
        const statusSelect = document.getElementById(selectId);
        const scheduleInput = document.getElementById(inputId);
        if (!statusSelect || !scheduleInput) return;
        const sync = () => {
          const isScheduled = statusSelect.value === 'scheduled';
          scheduleInput.disabled = !isScheduled;
          scheduleInput.required = isScheduled;
          if (!isScheduled) {
            scheduleInput.value = '';
          }
        };
        statusSelect.addEventListener('change', sync);
        sync();
      }

      bindScheduleStatus('hwStatus', 'hwScheduledAt');
      bindScheduleStatus('customHwStatus', 'customHwScheduledAt');

      const currentUserId = <%- JSON.stringify(userId || null) %>;
      const welcomeModalEl = document.getElementById('welcomeModal');
      if (welcomeModalEl) {
        const params = new URLSearchParams(window.location.search);
        const shouldWelcome = params.get('welcome') === '1';
        const welcomeKey = `studerria:welcome:registered:${currentUserId || 'guest'}`;
        if (shouldWelcome && !localStorage.getItem(welcomeKey)) {
          const welcomeModal = new bootstrap.Modal(welcomeModalEl, { backdrop: true });
          welcomeModal.show();
          localStorage.setItem(welcomeKey, '1');
          document.body.classList.add('welcome-open');
          if (window.history && window.history.replaceState) {
            params.delete('welcome');
            const query = params.toString();
            const nextUrl = `${window.location.pathname}${query ? `?${query}` : ''}`;
            window.history.replaceState({}, document.title, nextUrl);
          }
          welcomeModalEl.addEventListener('hidden.bs.modal', () => {
            document.body.classList.remove('welcome-open');
          });
        } else if (shouldWelcome && window.history && window.history.replaceState) {
          params.delete('welcome');
          const query = params.toString();
          const nextUrl = `${window.location.pathname}${query ? `?${query}` : ''}`;
          window.history.replaceState({}, document.title, nextUrl);
        }
      }

      const homeworkModal = document.getElementById('homeworkModal');
      const homeworkData = <%- JSON.stringify(homework || []) %>;
      const customDeadlineItems = <%- JSON.stringify(customDeadlineItems || []) %>;
      const listEl = document.getElementById('homeworkList');
      const subgroupSection = document.getElementById('subgroupSection');
      const subgroupList = document.getElementById('subgroupList');
      const subgroupHomeworkId = document.getElementById('subgroupHomeworkId');
      const joinSubgroupId = document.getElementById('joinSubgroupId');
      const currentUser = <%- JSON.stringify(username) %>;
      const homeworkTagFilter = document.getElementById('homeworkTagFilter');
      let currentHomeworkItems = [];

      function updateReactionButtons(container, reactions, reacted) {
        const buttons = container.querySelectorAll('.react-btn');
        buttons.forEach((btn) => {
          const emoji = btn.dataset.emoji;
          const count = reactions && reactions[emoji] ? reactions[emoji] : 0;
          const countEl = btn.querySelector('.react-count');
          if (countEl) countEl.textContent = count;
          if (reacted && reacted[emoji]) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      async function toggleHomeworkReaction(homeworkId, emoji, container) {
        if (!currentUserId) return;
        try {
          const res = await fetch('/homework/react', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ homework_id: homeworkId, emoji }),
          });
          if (!res.ok) return;
          const data = await res.json();
          updateReactionButtons(container, data.reactions, data.reacted);
        } catch (err) {
          console.error(err);
        }
      }

      function renderHomework(items) {
        listEl.innerHTML = '';
        if (!items.length) {
          const empty = document.createElement('li');
          empty.className = 'list-group-item text-muted';
          empty.textContent = 'No assignments yet.';
          listEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'list-group-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold mb-1';
          title.textContent = item.description;
          li.appendChild(title);

          const meta = document.createElement('div');
          meta.className = 'text-muted small mb-2';
          const created = new Date(item.created_at).toLocaleString();
          meta.textContent = `${item.created_by} â€¢ ${created}`;
          li.appendChild(meta);

          if (item.tags && item.tags.length) {
            const tagWrap = document.createElement('div');
            tagWrap.className = 'hw-tags mb-2';
            item.tags.forEach((tag) => {
              const tagEl = document.createElement('span');
              tagEl.className = 'tag-pill';
              tagEl.textContent = tag;
              tagWrap.appendChild(tagEl);
            });
            li.appendChild(tagWrap);
          }

          if (item.link_url) {
            const link = document.createElement('a');
            link.href = item.link_url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = 'Open link';
            link.className = 'me-3';
            li.appendChild(link);
          }
          if (item.meeting_url) {
            const meet = document.createElement('a');
            meet.href = item.meeting_url;
            meet.target = '_blank';
            meet.rel = 'noopener';
            meet.textContent = 'Online class';
            meet.className = 'me-3';
            li.appendChild(meet);
          }

          if (item.file_path) {
            const fileLink = document.createElement('a');
            fileLink.href = item.file_path;
            fileLink.textContent = item.file_name || 'Download file';
            fileLink.className = 'd-inline-block';
            li.appendChild(fileLink);
          }

          const reactWrap = document.createElement('div');
          reactWrap.className = 'd-flex gap-2 mt-2';
          ['ðŸ”¥', 'ðŸ‘'].forEach((emoji) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-secondary react-btn';
            btn.dataset.emoji = emoji;
            btn.dataset.homeworkId = item.id;
            const count = item.reactions && item.reactions[emoji] ? item.reactions[emoji] : 0;
            btn.innerHTML = `<span>${emoji}</span><span class="react-count">${count}</span>`;
            if (item.reacted && item.reacted[emoji]) {
              btn.classList.add('active');
            }
            btn.addEventListener('click', () => toggleHomeworkReaction(item.id, emoji, reactWrap));
            reactWrap.appendChild(btn);
          });
          li.appendChild(reactWrap);

          listEl.appendChild(li);
        });
      }

      function renderSubgroups(items) {
        subgroupList.innerHTML = '';
        joinSubgroupId.innerHTML = '<option value="" disabled selected>Select subgroup</option>';

        if (!items.length) {
          subgroupSection.classList.add('d-none');
          return;
        }

        subgroupSection.classList.remove('d-none');

        items.forEach((item) => {
          const container = document.createElement('div');
          container.className = 'list-group-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold';
          title.textContent = item.name;
          container.appendChild(title);

          const members = document.createElement('div');
          members.className = 'small text-muted';
          if (item.members.includes(currentUser)) {
            members.textContent = `Members: ${item.members.join(', ')} (you)`;
            container.classList.add('border', 'border-primary');
          } else {
            members.textContent = item.members.length ? item.members.join(', ') : 'No members yet';
          }
          container.appendChild(members);

          subgroupList.appendChild(container);

          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          joinSubgroupId.appendChild(opt);
        });
      }

      homeworkModal.addEventListener('show.bs.modal', (event) => {
        const button = event.relatedTarget;
        const subject = button.getAttribute('data-class');
        const subjectId = Number(button.getAttribute('data-subjectid'));
        const day = button.getAttribute('data-day');
        const time = button.getAttribute('data-time');
        const classNum = Number(button.getAttribute('data-classnum'));
        const groupNum = Number(button.getAttribute('data-groupnum'));
        const classDate = button.getAttribute('data-date');

        document.getElementById('homeworkModalTitle').textContent = subject;
        document.getElementById('homeworkModalMeta').textContent = `${day} Â· ${time}`;

        document.getElementById('hwDay').value = day;
        document.getElementById('hwTime').value = time;
        document.getElementById('hwSubjectId').value = subjectId;
        document.getElementById('hwGroupNum').value = groupNum;
        document.getElementById('hwClassNum').value = classNum;
        document.getElementById('hwDate').value = classDate || '';

        const filtered = homeworkData.filter((item) => {
          return (
            Number(item.subject_id) === subjectId &&
            Number(item.group_number) === groupNum &&
            item.day === day &&
            Number(item.class_number) === classNum &&
            item.class_date === classDate
          );
        });
        currentHomeworkItems = filtered;
        if (homeworkTagFilter) {
          homeworkTagFilter.value = '';
        }
        renderHomework(filtered);
        const first = filtered[0];
        if (first) {
          subgroupHomeworkId.value = first.id;
          renderSubgroups(first.subgroups || []);
        } else {
          subgroupSection.classList.add('d-none');
        }
        const hashValue = encodeURIComponent(`${subjectId}|${day}|${classNum}|${groupNum}`);
        if (location.hash !== `#class=${hashValue}`) {
          history.replaceState(null, '', `#class=${hashValue}`);
        }
      });

      homeworkModal.addEventListener('hidden.bs.modal', () => {
        if (location.hash.startsWith('#class=')) {
          history.replaceState(null, '', location.pathname + location.search);
        }
      });

      if (homeworkTagFilter) {
        homeworkTagFilter.addEventListener('input', () => {
          const tag = homeworkTagFilter.value.trim().toLowerCase();
          if (!tag) {
            renderHomework(currentHomeworkItems);
            return;
          }
          const filtered = currentHomeworkItems.filter((item) => {
            const tags = item.tags || [];
            return tags.some((t) => t.toLowerCase() === tag);
          });
          renderHomework(filtered);
        });
      }

      function openModalFromHash() {
        if (!location.hash.startsWith('#class=')) return;
        const payload = decodeURIComponent(location.hash.replace('#class=', ''));
        const [subjectId, day, classNum, groupNum] = payload.split('|');
        if (!subjectId || !day || !classNum || !groupNum) return;

        const match = document.querySelector(
          `[data-subjectid="${subjectId}"][data-day="${day}"][data-classnum="${classNum}"][data-groupnum="${groupNum}"]`
        );
        if (match) {
          match.click();
        }
      }

      window.addEventListener('hashchange', openModalFromHash);
      window.addEventListener('load', openModalFromHash);

      const weekSlider = document.getElementById('weekSlider');
      const messagesBtn = document.getElementById('messagesBtn');
      const messagesBtnMobile = document.getElementById('messagesBtnMobile');
      const messagesList = document.getElementById('messagesList');
      const messagesBadge = document.getElementById('messagesBadge');
      const messagesSubjectFilter = document.getElementById('messagesSubjectFilter');
      const weekPrev = document.getElementById('weekPrev');
      const weekNext = document.getElementById('weekNext');
      const totalWeeks = <%= totalWeeks || 15 %>;
      let currentWeek = <%= currentWeek %>;
      function updateMobileWeekDots() {
        if (!weekSlider) return;
        const dots = weekSlider.querySelectorAll('.week-dot');
        if (window.innerWidth > 768) {
          dots.forEach((dot) => dot.classList.remove('hidden-mobile'));
          return;
        }
        dots.forEach((dot) => {
          const week = Number(dot.dataset.week);
          const visible = week === currentWeek || week === currentWeek - 1 || week === currentWeek + 1;
          dot.classList.toggle('hidden-mobile', !visible);
        });
      }
      function updateSchedule(week) {
        const safe = Math.max(1, Math.min(totalWeeks, week));
        const params = new URLSearchParams(window.location.search);
        params.set('week', safe);
        window.location.search = params.toString();
      }
      function animateWeekChange(nextWeek) {
        const safe = Math.max(1, Math.min(totalWeeks, nextWeek));
        const active = weekSlider ? weekSlider.querySelector('.week-dot.active') : null;
        const target = weekSlider
          ? weekSlider.querySelector(`.week-dot[data-week="${safe}"]`)
          : null;
        if (active && target && active !== target) {
          active.classList.remove('active');
          target.classList.add('active');
        }
        currentWeek = safe;
        updateMobileWeekDots();
        setTimeout(() => updateSchedule(safe), 220);
      }
      if (weekSlider) {
        weekSlider.addEventListener('click', (event) => {
          const btn = event.target.closest('.week-dot');
          if (!btn) return;
          const week = Number(btn.dataset.week);
          if (!Number.isNaN(week)) animateWeekChange(week);
        });
        if (weekPrev) {
          weekPrev.addEventListener('click', () => animateWeekChange(currentWeek - 1));
        }
        if (weekNext) {
          weekNext.addEventListener('click', () => animateWeekChange(currentWeek + 1));
        }

        let startX = 0;
        weekSlider.addEventListener('touchstart', (event) => {
          startX = event.touches[0].clientX;
        }, { passive: true });
        weekSlider.addEventListener('touchend', (event) => {
          const endX = event.changedTouches[0].clientX;
          const delta = endX - startX;
          if (Math.abs(delta) < 40) return;
          if (delta < 0) animateWeekChange(currentWeek + 1);
          if (delta > 0) animateWeekChange(currentWeek - 1);
        });
      }

      if (messagesBtnMobile) {
        messagesBtnMobile.addEventListener('click', () => {
          const mobileMenu = document.getElementById('mobileMenuModal');
          if (mobileMenu) {
            const menuInstance = bootstrap.Modal.getInstance(mobileMenu) || new bootstrap.Modal(mobileMenu);
            menuInstance.hide();
          }
          const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
          modal.show();
        });
      }

      const customDeadlineModal = document.getElementById('customDeadlineViewModal');
      const customDeadlineSubject = document.getElementById('customDeadlineSubject');
      const customDeadlineDue = document.getElementById('customDeadlineDue');
      const customDeadlineDescription = document.getElementById('customDeadlineDescription');
      const customDeadlineLinks = document.getElementById('customDeadlineLinks');
      const customDeadlineReactions = document.getElementById('customDeadlineReactions');

      function renderCustomDeadline(item) {
        if (!item) return;
        if (customDeadlineSubject) customDeadlineSubject.textContent = item.subject_name || '';
        if (customDeadlineDue) {
          const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : '';
          customDeadlineDue.textContent = dueLabel ? `Ð”ÐµÐ´Ð»Ð°Ð¹Ð½: ${dueLabel}` : '';
        }
        if (customDeadlineDescription) {
          customDeadlineDescription.textContent = item.description || '';
        }
        if (customDeadlineLinks) {
          customDeadlineLinks.innerHTML = '';
          const links = [];
          if (item.link_url) {
            links.push(`<a href="${item.link_url}" target="_blank" rel="noopener">ÐŸÐ¾ÑÐ¸Ð»Ð°Ð½Ð½Ñ</a>`);
          }
          if (item.meeting_url) {
            links.push(`<a href="${item.meeting_url}" target="_blank" rel="noopener">ÐžÐ½Ð»Ð°Ð¹Ð½-Ð·ÑƒÑÑ‚Ñ€Ñ–Ñ‡</a>`);
          }
          if (item.file_path) {
            links.push(`<a href="${item.file_path}" target="_blank" rel="noopener">${item.file_name || 'Ð¤Ð°Ð¹Ð»'}</a>`);
          }
          if (links.length) {
            customDeadlineLinks.innerHTML = links.join(' Â· ');
          }
        }
        if (customDeadlineReactions) {
          updateReactionButtons(customDeadlineReactions, item.reactions || {}, item.reacted || {});
          customDeadlineReactions.querySelectorAll('.react-btn').forEach((btn) => {
            btn.onclick = () => toggleHomeworkReaction(item.id, btn.dataset.emoji, customDeadlineReactions);
          });
        }
      }

      if (customDeadlineItems && customDeadlineItems.length) {
        const customMap = new Map(customDeadlineItems.map((item) => [String(item.id), item]));
        document.querySelectorAll('.deadline-item[data-custom-id]').forEach((el) => {
          el.addEventListener('click', () => {
            const item = customMap.get(String(el.dataset.customId));
            if (!item || !customDeadlineModal) return;
            renderCustomDeadline(item);
            const modal = new bootstrap.Modal(customDeadlineModal);
            modal.show();
          });
        });
      }
      updateMobileWeekDots();
      window.addEventListener('resize', updateMobileWeekDots);

      const scheduleContent = document.querySelector('.schedule-content');
      if (scheduleContent) {
        let touchStartX = 0;
        let touchStartY = 0;
        scheduleContent.addEventListener('touchstart', (event) => {
          if (document.body.classList.contains('modal-open')) return;
          const t = event.touches[0];
          touchStartX = t.clientX;
          touchStartY = t.clientY;
        }, { passive: true });
        scheduleContent.addEventListener('touchend', (event) => {
          if (document.body.classList.contains('modal-open')) return;
          const t = event.changedTouches[0];
          const dx = t.clientX - touchStartX;
          const dy = t.clientY - touchStartY;
          if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy)) return;
          if (dx < 0) animateWeekChange(currentWeek + 1);
          if (dx > 0) animateWeekChange(currentWeek - 1);
        });
      }

      window.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowRight') {
          animateWeekChange(currentWeek + 1);
        }
        if (event.key === 'ArrowLeft') {
          animateWeekChange(currentWeek - 1);
        }
      });

      window.addEventListener('load', () => {
        const content = document.querySelector('.schedule-content');
        if (!content) return;
        requestAnimationFrame(() => {
          content.classList.add('enter-active');
          content.classList.remove('enter');
        });
      });

      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach((el) => {
        new bootstrap.Tooltip(el);
      });

      async function loadMessages() {
        if (!messagesList) return;
        messagesList.innerHTML = '<li class="list-group-item text-muted">Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ...</li>';
        try {
          const subjectId = messagesSubjectFilter && messagesSubjectFilter.value
            ? `?subject_id=${encodeURIComponent(messagesSubjectFilter.value)}`
            : '';
          const res = await fetch(`/messages.json${subjectId}`);
          if (!res.ok) throw new Error('bad');
          const data = await res.json();
          if (!data.messages || !data.messages.length) {
            messagesList.innerHTML = '<li class="list-group-item text-muted">ÐÐµÐ¼Ð°Ñ” Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½ÑŒ</li>';
            if (messagesBadge) {
              messagesBadge.classList.add('d-none');
            }
            return;
          }
          messagesList.innerHTML = data.messages
            .map((m) => {
              const meta = m.target_all
                ? 'Ð’ÑÑ– ÑÑ‚ÑƒÐ´ÐµÐ½Ñ‚Ð¸'
                : `${m.subject_name || 'ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚'} Â· Group ${m.group_number}`;
              const unreadClass = m.read_id ? '' : 'fw-semibold';
              const reactions = m.reactions || {};
              const reacted = m.reacted || {};
              const makeBtn = (emoji) => {
                const count = reactions[emoji] || 0;
                const active = reacted[emoji] ? 'active' : '';
                return `<button class="btn btn-sm btn-outline-secondary react-btn ${active}" data-message-id="${m.id}" data-emoji="${emoji}">
                  <span>${emoji}</span><span class="react-count">${count}</span>
                </button>`;
              };
              return `
                <li class="list-group-item">
                  <div class="${unreadClass} mb-1">${m.body}</div>
                  <div class="text-muted small">${meta} Â· ${m.created_by || 'Admin'} Â· ${new Date(m.created_at).toLocaleString()}</div>
                  <div class="d-flex gap-2 mt-2 msg-reactions">
                    ${makeBtn('ðŸ”¥')}
                    ${makeBtn('ðŸ‘')}
                  </div>
                </li>
              `;
            })
            .join('');
          if (messagesBadge) {
            const unread = data.unread_count || 0;
            if (unread > 0) {
              messagesBadge.textContent = unread > 99 ? '99+' : String(unread);
              messagesBadge.classList.remove('d-none');
            } else {
              messagesBadge.classList.add('d-none');
            }
          }
          const unreadIds = data.messages.filter((m) => !m.read_id).map((m) => m.id);
          if (unreadIds.length) {
            fetch('/messages/read', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message_ids: unreadIds }),
            });
          }
          const reactionButtons = messagesList.querySelectorAll('.msg-reactions .react-btn');
          reactionButtons.forEach((btn) => {
            btn.addEventListener('click', async () => {
              const messageId = Number(btn.dataset.messageId);
              const emoji = btn.dataset.emoji;
              if (Number.isNaN(messageId) || !emoji) return;
              try {
                const res = await fetch('/messages/react', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message_id: messageId, emoji }),
                });
                if (!res.ok) return;
                const data = await res.json();
                const container = btn.closest('.msg-reactions');
                if (!container) return;
                updateReactionButtons(container, data.reactions, data.reacted);
              } catch (err) {
                console.error(err);
              }
            });
          });
        } catch (err) {
          messagesList.innerHTML = '<li class="list-group-item text-muted">ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ</li>';
        }
      }

      if (messagesBtn) {
        messagesBtn.addEventListener('click', () => {
          const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
          modal.show();
          loadMessages();
        });
      }
      if (messagesSubjectFilter) {
        messagesSubjectFilter.addEventListener('change', loadMessages);
      }

      loadMessages();

      const phrases = [
        "Start fresh â€” today is full of potential.",
        "Small steps, big progress.",
        "Focus on now â€” the rest will follow.",
        "One thing at a time â€” and thatâ€™s enough.",
        "Youâ€™ve got more in you than you think.",
        "Let clarity lead your day.",
        "Stay present, stay steady.",
        "Keep going â€” youâ€™re getting closer.",
        "Be kind to your focus.",
        "Today is a great day to grow.",
        "Balance over burnout.",
        "Show up â€” even a little is progress.",
        "A clear mind gets more done.",
        "You set the tone â€” begin with calm.",
        "Progress, not perfection.",
        "Let effort be your win today.",
        "This hour matters â€” make it count.",
        "Energy follows attention.",
        "Youâ€™re building momentum.",
        "Stay grounded, keep moving.",
        "Let your actions match your goals.",
        "Your best today is enough.",
        "Choose one goal, and give it space.",
        "Rest is part of the rhythm.",
        "Trust your pace â€” fast or slow.",
        "You donâ€™t need to rush to be great.",
        "Small focus. Big ripple.",
        "The day is yours â€” use it gently.",
        "Notice what fuels you today.",
        "Begin again â€” always welcome."
      ];

      function getKyivDayOfYear() {
        const now = new Date();
        const dateString = now.toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
        const [year, month, day] = dateString.split('-').map(Number);
        const start = Date.UTC(year, 0, 1);
        const current = Date.UTC(year, month - 1, day);
        return Math.floor((current - start) / 86400000);
      }

      function updateDailyPhrase() {
        const el = document.getElementById('daily-phrase');
        if (!el) return;
        const dayOfYear = getKyivDayOfYear();
        const phrase = phrases[dayOfYear % phrases.length];
        if (el.textContent === phrase) return;
        el.classList.add('fade-out');
        setTimeout(() => {
          el.textContent = phrase;
          el.classList.remove('fade-out');
        }, 240);
      }

      function scheduleNextMidnight() {
        const now = new Date();
        const kyivNow = new Date(
          now.toLocaleString('en-US', { timeZone: 'Europe/Kyiv' })
        );
        const nextMidnight = new Date(kyivNow);
        nextMidnight.setHours(24, 0, 0, 0);
        const ms = nextMidnight.getTime() - kyivNow.getTime();
        setTimeout(() => {
          updateDailyPhrase();
          scheduleNextMidnight();
        }, ms + 500);
      }

      updateDailyPhrase();
      scheduleNextMidnight();

      const themeToggles = document.querySelectorAll('.theme-toggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      themeToggles.forEach((btn) => {
        btn.textContent = storedTheme === 'theme-dark' ? btn.dataset.lightLabel : btn.dataset.darkLabel;
        btn.addEventListener('click', () => {
          const isDark = document.body.classList.contains('theme-dark');
          const next = isDark ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-dark', 'theme-light');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggles.forEach((b) => {
            b.textContent = next === 'theme-dark' ? b.dataset.lightLabel : b.dataset.darkLabel;
          });
        });
      });

      document.querySelectorAll('.file-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.fileTarget;
          const input = target ? document.getElementById(target) : null;
          if (input) input.click();
        });
      });
      document.querySelectorAll('.file-input').forEach((input) => {
        input.addEventListener('change', () => {
          const label = document.querySelector(`[data-file-name="${input.id}"]`);
          if (!label) return;
          const name = input.files && input.files.length ? input.files[0].name : 'Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð²Ð¸Ð±Ñ€Ð°Ð½Ð¾';
          label.textContent = name;
        });
      });

      window.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;
        const instance = bootstrap.Modal.getInstance(openModal);
        if (instance) instance.hide();
      });
    </script>
  </body>
</html>
