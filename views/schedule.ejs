<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title><%= t('schedule.title') %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-2: #8b5cf6;
        --accent-3: #22d3ee;
        --radius: 18px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.12);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.35);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
        transition: background 200ms ease, color 200ms ease;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.22), transparent 60%),
          linear-gradient(135deg, #e6eef8 0%, #e9f0fb 45%, #eef2ff 100%);
        color: #0f172a;
      }
      body.theme-light .text-white {
        color: #0f172a !important;
      }
      body.theme-light .btn-outline-light {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.2);
      }
      body.theme-light .btn-outline-light:hover {
        background: rgba(15, 23, 42, 0.06);
      }
      .topbar {
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.75rem 0;
      }
      body.theme-dark .topbar {
        background: rgba(10, 10, 20, 0.5);
      }
      body.theme-light .topbar {
        background: rgba(255, 255, 255, 0.75);
      }
      .topbar .container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 44px;
      }
      .topbar .navbar-brand {
        font-weight: 700;
        font-size: 1.25rem;
        margin-right: auto;
        display: flex;
        align-items: center;
        height: 36px;
        line-height: 1;
        padding: 0;
      }
      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
        min-height: 36px;
      }
      .topbar-actions form {
        display: contents;
      }
      @media (max-width: 991px) {
        .topbar-actions {
          flex-basis: auto;
          order: 2;
          gap: 0.3rem;
        }
      }
      .hero-title {
        font-size: clamp(2.2rem, 4vw, 3rem);
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      .hero-sub {
        color: rgba(255, 255, 255, 0.35);
      }
      body.theme-light .hero-sub {
        color: rgba(15, 23, 42, 0.65);
      }
      #daily-phrase {
        transition: opacity 240ms ease;
      }
      #daily-phrase.fade-out {
        opacity: 0;
      }
      .glass {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }

      /* Disable hover lift on background cards; keep hover on classes */
      .glass.week-hero:hover,
      .glass.day-card:hover,
      .alert.glass:hover {
        transform: none;
        box-shadow: var(--glass-shadow);
      }
      body.theme-dark .glass {
        background: var(--glass-bg-dark);
        border: 1px solid var(--glass-border-dark);
        box-shadow: 0 18px 45px rgba(8, 8, 20, 0.55), 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid var(--glass-border-light);
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.18), 0 0 0 1px rgba(255, 255, 255, 0.35) inset;
      }
      .week-hero {
        padding: 22px 26px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 18px;
      }
      @media (max-width: 768px) {
        .week-hero {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      .badge-glow {
        background: linear-gradient(135deg, #93c5fd, #c4b5fd);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.35);
        padding: 0.45rem 0.9rem;
        border-radius: 999px;
        font-weight: 700;
        box-shadow: 0 8px 18px rgba(59, 130, 246, 0.22);
      }
      .hero-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      @media (min-width: 769px) {
        .hero-actions {
          flex-direction: column;
          align-items: flex-end;
        }
      }
      .btn-glass {
        border-radius: 999px;
        padding: 0.42rem 0.9rem;
        font-weight: 600;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .btn-glass:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.35);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      }
      body.theme-light .badge-glow {
        color: #0f172a;
        background: linear-gradient(135deg, rgba(147, 197, 253, 0.55), rgba(196, 181, 253, 0.45));
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-light .btn-glass {
        color: #0f172a;
        background: rgba(255, 255, 255, 0.35);
        border-color: rgba(15, 23, 42, 0.15);
      }
      body.theme-light .btn-glass:hover {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
      }
      .hw-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(59, 130, 246, 0.18);
        border: 1px solid rgba(59, 130, 246, 0.35);
        color: #dbeafe;
      }
      .control-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        color: rgba(248, 113, 113, 0.95);
        background: rgba(248, 113, 113, 0.16);
        border: 1px solid rgba(248, 113, 113, 0.35);
      }
      body.theme-light .hw-chip {
        background: rgba(59, 130, 246, 0.12);
        color: #1e3a8a;
      }
      body.theme-light .control-chip {
        color: #b91c1c;
        background: rgba(248, 113, 113, 0.18);
        border-color: rgba(185, 28, 28, 0.2);
      }
      .tag-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-light .tag-pill {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
        color: #0f172a;
      }
      .react-btn {
        border-radius: 999px;
        padding: 2px 10px;
        font-size: 12px;
        line-height: 1.2;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      body.theme-dark .react-btn {
        color: rgba(248, 250, 252, 0.92);
        border-color: rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.35);
      }
      body.theme-light .react-btn {
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.18);
        background: rgba(15, 23, 42, 0.04);
      }
      .react-btn.active {
        background: rgba(59, 130, 246, 0.25);
        border-color: rgba(59, 130, 246, 0.6);
        color: #e2e8f0;
      }
      body.theme-light .react-btn.active {
        background: rgba(59, 130, 246, 0.18);
        color: #0f172a;
      }
      .hw-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .week-slider {
        position: fixed;
        left: 50%;
        bottom: 22px;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 10px 16px;
        border-radius: 20px;
        backdrop-filter: blur(8px);
        z-index: 1050;
      }
      body.theme-dark .week-slider {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45);
      }
      body.theme-light .week-slider {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(15, 23, 42, 0.12);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
      }
      @media (max-width: 576px) {
        .week-slider {
          bottom: 16px;
        }
      }
      .week-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.4);
        opacity: 0.3;
        cursor: pointer;
        transition: transform 220ms ease, background 220ms ease, width 260ms ease, box-shadow 260ms ease;
      }
      .week-dot:hover {
        transform: scale(1.15);
        opacity: 0.6;
      }
      .week-dot.active {
        width: 28px;
        height: 8px;
        opacity: 1;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
      }
      .week-dot.active {
        transform: scale(1.05);
      }
      body.theme-light .week-dot {
        background: rgba(15, 23, 42, 0.4);
      }
      body.theme-light .week-dot.active {
        background: rgba(15, 23, 42, 0.85);
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-backdrop {
        backdrop-filter: blur(12px);
        background-color: rgba(0, 0, 0, 0.3);
        transition: opacity 0.3s ease-in-out;
        opacity: 0;
        pointer-events: none;
      }
      body.theme-dark .modal-backdrop {
        background-color: rgba(20, 20, 20, 0.5);
        backdrop-filter: blur(16px);
      }
      body.theme-light .modal-backdrop {
        background-color: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(8px);
      }
      .modal.fade .modal-dialog {
        transform: scale(0.98);
        transition: transform 240ms ease, opacity 240ms ease;
        opacity: 0;
      }
      .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
      }
      .modal-content {
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        animation: modalIn 260ms ease;
      }
      body.theme-dark .modal-content {
        background: rgba(30, 30, 30, 0.5);
        color: #f8fafc;
      }
      body.theme-light .modal-content {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        box-shadow: 0 0 24px rgba(15, 23, 42, 0.18);
      }
      .glass-welcome-modal {
        backdrop-filter: blur(16px);
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        color: #f8fafc;
        max-width: 480px;
        margin: auto;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light .glass-welcome-modal {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
      }
      .welcome-title {
        font-size: 1.6rem;
        font-weight: 800;
      }
      .welcome-subtitle {
        color: rgba(248, 250, 252, 0.75);
      }
      body.theme-light .welcome-subtitle {
        color: rgba(15, 23, 42, 0.7);
      }
      .custom-tooltip {
        position: fixed;
        z-index: 2000;
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 0.95rem;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        opacity: 0;
        transform: translateY(6px);
        transition: opacity 220ms ease, transform 220ms ease;
      }
      .custom-tooltip.show {
        opacity: 1;
        transform: translateY(0);
      }
      .custom-tooltip::before {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 20px;
        border: 6px solid transparent;
        border-top-color: rgba(255, 255, 255, 0.08);
      }
      .custom-tooltip.below::before {
        top: -6px;
        bottom: auto;
        border-top-color: transparent;
        border-bottom-color: rgba(255, 255, 255, 0.08);
      }
      body.theme-light .custom-tooltip {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      body.theme-light .custom-tooltip::before {
        border-top-color: rgba(255, 255, 255, 0.85);
      }
      body.theme-light .custom-tooltip.below::before {
        border-bottom-color: rgba(255, 255, 255, 0.85);
      }
      .tooltip .tooltip-inner {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border-radius: 12px;
        padding: 10px 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        font-size: 0.95rem;
      }
      body.theme-light .tooltip .tooltip-inner {
        background: rgba(255, 255, 255, 0.85);
        color: #0f172a;
      }
      .tooltip .tooltip-arrow::before {
        border-top-color: rgba(255, 255, 255, 0.18);
      }
      body.theme-light .tooltip .tooltip-arrow::before {
        border-top-color: rgba(255, 255, 255, 0.9);
      }
      @keyframes modalIn {
        from {
          transform: scale(0.98);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      button.glass {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 12px;
        padding: 10px 20px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light button.glass {
        background: rgba(15, 23, 42, 0.06);
        border-color: rgba(15, 23, 42, 0.12);
      }
      button.glass:hover {
        transform: scale(1.02);
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
      }
      body.theme-light .btn-primary.glass {
        background: linear-gradient(135deg, #2563eb, #3b82f6);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
      }
      select.form-select {
        appearance: none;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(12px);
        border-radius: 14px;
        padding: 10px 40px 10px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: inherit;
        font-size: 0.95rem;
        transition: background-image 160ms ease, box-shadow 0.2s ease, background 0.2s ease;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select[multiple] {
        background-image: none;
        padding-right: 16px;
      }
      body.theme-light select.form-select {
        background: rgba(255, 255, 255, 0.75);
        color: #0f172a;
        border-color: rgba(15, 23, 42, 0.12);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select[multiple] {
        background-image: none;
      }
      select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      body.theme-light select.form-select.select-open {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' viewBox='0 0 24 24'%3E%3Cpath stroke='%230f172a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='m18 15-6-6-6 6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 16px;
      }
      select.form-select:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }
      body.theme-light select.form-select:focus {
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.2);
      }
      select.form-select option {
        background: #0f172a;
        color: #f8fafc;
      }
      body.theme-light select.form-select option {
        background: #ffffff;
        color: #0f172a;
      }
      body.theme-dark select.form-select option:checked,
      body.theme-dark select.form-select option:hover {
        background: rgba(59, 130, 246, 0.6);
        color: #fff;
      }
      body.theme-light select.form-select option:checked,
      body.theme-light select.form-select option:hover {
        background: rgba(59, 130, 246, 0.15);
        color: #0f172a;
      }
      .week-nav-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .week-nav-btn:hover {
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.5);
        border-color: rgba(147, 197, 253, 0.7);
        background: rgba(255, 255, 255, 0.14);
      }
      .week-nav-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35);
      }
      body.theme-light .week-nav-btn {
        background: rgba(255, 255, 255, 0.85);
        border-color: rgba(15, 23, 42, 0.18);
        color: #0f172a;
      }
      .schedule-content {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .schedule-content.enter {
        opacity: 0;
        transform: translateY(12px);
        animation: scheduleIn 320ms ease forwards;
      }
      .schedule-content.enter-active {
        opacity: 1;
        transform: translateY(0);
      }
      @keyframes scheduleIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      body.welcome-open .schedule-content,
      body.welcome-open .topbar,
      body.welcome-open .week-slider,
      body.welcome-open .app-footer {
        filter: blur(8px);
        transition: filter 200ms ease;
      }
      body.welcome-open .schedule-content {
        pointer-events: none;
      }
      .day-card .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.16);
        font-weight: 700;
      }
      body.theme-light .day-card .card-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      .list-group-item {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        border-radius: 14px;
        margin: 6px 0;
        padding: 16px;
        width: 100%;
        box-sizing: border-box;
        transition: background 200ms ease, border-color 200ms ease;
      }
      body.theme-light .list-group-item {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.18);
      }
      .list-group-item-action:hover {
        background: rgba(99, 102, 241, 0.18);
        border-color: rgba(147, 197, 253, 0.35);
      }
      body.theme-light .list-group-item-action:hover {
        background: rgba(59, 130, 246, 0.08);
      }
      body.theme-dark .list-group-item-action:focus,
      body.theme-dark .list-group-item-action:active {
        background: rgba(139, 92, 246, 0.22);
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.25) inset;
      }
      .muted {
        color: rgba(255, 255, 255, 0.35);
      }
      body.theme-light .muted {
        color: rgba(15, 23, 42, 0.6);
      }
      body.theme-dark .list-group-item .fw-semibold {
        color: #f8fafc;
      }
      body.theme-dark .day-card .card-header {
        color: #f8fafc;
      }
      .day-card .list-group {
        padding: 10px 12px 12px;
      }
      .day-card .list-group.list-group-flush > .list-group-item {
        border-radius: 14px !important;
      }
      @media (max-width: 768px) {
        .day-card .list-group {
          padding: 8px 10px 10px;
        }
        .list-group-item {
          padding: 14px;
          border-radius: 12px;
        }
      }
      .form-control {
        border-radius: 12px;
      }
      body.theme-dark .form-control {
        background: rgba(255, 255, 255, 0.08);
        color: #f8fafc;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      body.theme-light .form-control {
        background: rgba(255, 255, 255, 0.9);
        color: #0f172a;
        border: 1px solid rgba(15, 23, 42, 0.16);
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--accent-3);
        box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
      }
      body.theme-dark .modal-content .list-group-item {
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.12);
      }
      body.theme-dark .modal-content .text-muted {
        color: rgba(248, 250, 252, 0.65) !important;
      }
      body.theme-dark .modal-content .form-label {
        color: rgba(248, 250, 252, 0.85);
      }
      body.theme-dark .modal-content ::placeholder {
        color: rgba(248, 250, 252, 0.6);
      }
      body.theme-dark .modal-content a {
        color: #93c5fd;
      }
      body.theme-dark .modal-content a:hover {
        color: #bfdbfe;
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        border: none;
        border-radius: 12px;
      }
      .btn-outline-light,
      .btn-outline-primary,
      .btn-outline-secondary {
        border-radius: 999px;
      }
      .btn {
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease, background 140ms ease;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.18);
      }
      body.theme-dark .btn:hover {
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.45);
      }
      .topbar .btn,
      .topbar .theme-toggle-min,
      .topbar .msg-btn,
      .topbar .mobile-menu-btn {
        transition: background 160ms ease, border-color 160ms ease, color 160ms ease;
        transform: none;
        box-shadow: none;
      }
      .topbar .btn:hover,
      .topbar .theme-toggle-min:hover,
      .topbar .msg-btn:hover,
      .topbar .mobile-menu-btn:hover {
        transform: none;
        box-shadow: none;
      }
      .btn:active {
        transform: translateY(0);
        box-shadow: none;
      }
      .theme-toggle {
        border-radius: 999px;
      }
      .msg-btn {
        border-radius: 999px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        position: relative;
      }
      .msg-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        min-width: 18px;
        height: 18px;
        border-radius: 999px;
        background: #ef4444;
        color: #fff;
        font-size: 11px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
      }
      button.mobile-menu-btn {
        border-radius: 999px;
        width: 38px;
        height: 38px;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .mobile-menu-action {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.92);
        text-align: left;
        font-size: 0.95rem;
        padding: 12px 14px;
        width: 100%;
      }
      .mobile-menu-action:hover {
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(255, 255, 255, 0.3);
      }
      body.theme-dark .mobile-menu-action {
        color: #f8fafc !important;
      }
      body.theme-dark .mobile-menu-action:hover {
        color: #f8fafc !important;
      }
      body.theme-light .mobile-menu-action {
        background: rgba(255, 255, 255, 0.82);
        border-color: rgba(15, 23, 42, 0.14);
        color: #0f172a;
      }
      body.theme-light .mobile-menu-action:hover {
        background: rgba(255, 255, 255, 0.9);
        border-color: rgba(15, 23, 42, 0.2);
      }
      #mobileMenuModal .modal-content {
        border-radius: 18px;
        background: rgba(20, 24, 36, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-light #mobileMenuModal .modal-content {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(15, 23, 42, 0.1);
      }
      #mobileMenuModal .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        padding: 14px 16px;
      }
      body.theme-light #mobileMenuModal .modal-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      #mobileMenuModal .modal-title {
        font-size: 1.05rem;
        font-weight: 700;
      }
      #mobileMenuModal .modal-body {
        padding: 12px 16px 16px;
      }
      #mobileMenuModal .btn-close {
        filter: brightness(1.35);
        opacity: 0.9;
      }
      body.theme-dark #mobileMenuModal .btn-close {
        filter: invert(1) brightness(1.2);
        opacity: 0.95;
      }
      body.theme-light #mobileMenuModal .btn-close {
        filter: none;
        opacity: 0.75;
      }
      @media (max-width: 768px) {
        .topbar-actions .desktop-only {
          display: none !important;
        }
        .topbar-actions .mobile-menu-btn {
          display: inline-flex !important;
        }
        .topbar-actions {
          gap: 8px;
        }
        .week-slider {
          gap: 10px;
          padding: 8px 12px;
        }
        .week-nav-btn {
          width: 46px;
          height: 46px;
          font-size: 18px;
        }
        .week-dot.hidden-mobile {
          display: none !important;
        }
        .schedule-content {
          padding-left: 12px;
          padding-right: 12px;
        }
        .week-hero {
          padding: 16px 18px;
        }
        .hero-title {
          font-size: 1.9rem;
        }
        body {
          font-size: 0.95rem;
        }
        .btn,
        .btn-glass {
          min-height: 38px;
        }
      }
      .app-footer {
        font-size: 0.85rem;
        padding-bottom: 120px;
        padding-bottom: calc(120px + env(safe-area-inset-bottom));
        padding-bottom: calc(120px + constant(safe-area-inset-bottom));
      }
      body.theme-dark .app-footer {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .app-footer {
        color: rgba(15, 23, 42, 0.6);
      }
      :root {
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 10px;
        --s-1: 8px;
        --s-2: 12px;
        --s-3: 16px;
        --s-4: 24px;
        --border-subtle: 1px solid rgba(255, 255, 255, 0.12);
        --border-hover: 1px solid rgba(255, 255, 255, 0.18);
        --glass-bg: rgba(20, 24, 32, 0.45);
        --glass-bg-light: rgba(255, 255, 255, 0.55);
        --glass-blur: 18px;
        --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        --text-primary: rgba(255, 255, 255, 0.92);
        --text-secondary: rgba(255, 255, 255, 0.68);
        --text-muted: rgba(255, 255, 255, 0.52);
        --focus-ring: 0 0 0 3px rgba(90, 140, 255, 0.25);
        --focus-border: rgba(90, 140, 255, 0.65);
      }
      body.theme-light {
        --text-primary: rgba(15, 23, 42, 0.92);
        --text-secondary: rgba(15, 23, 42, 0.68);
        --text-muted: rgba(15, 23, 42, 0.52);
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.18), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.14), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #121a2b 100%);
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.18), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.18), transparent 60%),
          linear-gradient(135deg, #ecf2fb 0%, #eef3fb 45%, #f5f7ff 100%);
      }
      .glass {
        border-radius: var(--radius-lg);
        backdrop-filter: blur(var(--glass-blur));
        background: var(--glass-bg);
        border: var(--border-subtle);
        box-shadow: var(--glass-shadow);
      }
      body.theme-light .glass {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      }
      .hero-title {
        font-weight: 600;
      }
      .hero-sub {
        color: var(--text-secondary);
      }
      .schedule-panel {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 12px 18px;
      }
      .schedule-panel.single-panel {
        justify-content: flex-end;
      }
      .panel-section {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .panel-title {
        font-size: 0.78rem;
        color: var(--text-muted);
        letter-spacing: 0.01em;
      }
      .panel-body {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel-divider {
        width: 1px;
        align-self: stretch;
        background: rgba(255, 255, 255, 0.12);
      }
      body.theme-light .panel-divider {
        background: rgba(15, 23, 42, 0.12);
      }
      .panel-legend {
        position: relative;
      }
      .legend-trigger {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-secondary);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 160ms ease, border-color 160ms ease, color 160ms ease;
      }
      .legend-trigger:hover {
        border-color: rgba(148, 163, 184, 0.45);
        color: var(--text-primary);
      }
      body.theme-light .legend-trigger {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(15, 23, 42, 0.12);
        color: rgba(15, 23, 42, 0.6);
      }
      body.theme-light .legend-trigger:hover {
        color: rgba(15, 23, 42, 0.85);
      }
      .legend-modal .modal-content {
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .legend-modal .modal-dialog {
        max-width: 360px;
      }
      body.theme-light .legend-modal .modal-content {
        background: rgba(255, 255, 255, 0.96);
        border-color: rgba(15, 23, 42, 0.12);
      }
      .legend-modal .modal-header {
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      body.theme-light .legend-modal .modal-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.12);
      }
      .legend-title {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }
      .legend-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 280px;
        overflow-y: auto;
        padding-right: 4px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.82rem;
        color: var(--text-secondary);
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: hsla(var(--subject-h, 220), 60%, 65%, 0.85);
        box-shadow: 0 0 0 3px hsla(var(--subject-h, 220), 60%, 65%, 0.15);
        flex-shrink: 0;
      }
      body.theme-light .legend-dot {
        box-shadow: 0 0 0 3px hsla(var(--subject-h, 220), 60%, 45%, 0.12);
      }
      .legend-empty {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .sync-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-primary);
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.16);
      }
      body.theme-light .sync-pill {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(15, 23, 42, 0.12);
      }
      .sync-pill .sync-sep {
        color: var(--text-muted);
      }
      .sync-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
      }
      .sync-dot.offline {
        background: #f97316;
        box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
      }
      .test-view-banner {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        background: rgba(59, 130, 246, 0.16);
        border: 1px solid rgba(59, 130, 246, 0.35);
        margin-bottom: 16px;
      }
      body.theme-light .test-view-banner {
        background: rgba(59, 130, 246, 0.12);
        border-color: rgba(59, 130, 246, 0.25);
      }
      .day-card {
        padding: 0;
      }
      .day-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 18px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.12);
      }
      body.theme-light .day-header {
        border-bottom: 1px solid rgba(15, 23, 42, 0.1);
      }
      .day-title {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .day-name {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--text-primary);
      }
      .day-date {
        font-size: 0.82rem;
        color: var(--text-muted);
      }
      .day-indicators {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .day-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
      }
      .day-chip--load {
        background: rgba(251, 191, 36, 0.18);
        color: #fef3c7;
        border-color: rgba(251, 191, 36, 0.4);
      }
      body.theme-light .day-chip--load {
        color: #92400e;
        background: rgba(251, 191, 36, 0.25);
        border-color: rgba(251, 191, 36, 0.5);
      }
      .day-chip--ghost {
        color: var(--text-muted);
        border-color: rgba(148, 163, 184, 0.2);
        background: transparent;
        opacity: 0.35;
      }
      .day-card .list-group {
        padding: 14px 18px 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        position: relative;
      }
      .day-card .list-group::before {
        content: '';
        position: absolute;
        left: 18px;
        right: 18px;
        top: 10px;
        bottom: 18px;
        background-image: repeating-linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 64px
        );
        opacity: 0.18;
        pointer-events: none;
      }
      body.theme-light .day-card .list-group::before {
        background-image: repeating-linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.08) 0px,
          rgba(15, 23, 42, 0.08) 1px,
          transparent 1px,
          transparent 64px
        );
        opacity: 0.12;
      }
      .schedule-card {
        position: relative;
        z-index: 1;
        border-radius: 16px;
        padding: 16px 18px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.45);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 0;
        transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease, background 160ms ease;
        backdrop-filter: none;
        --subject-h: 220;
      }
      body.theme-light .schedule-card {
        background: rgba(255, 255, 255, 0.92);
        border-color: rgba(15, 23, 42, 0.15);
      }
      .schedule-card::after {
        content: '';
        position: absolute;
        inset: 0;
        border-left: 4px solid hsla(var(--subject-h), 65%, 65%, 0.55);
        border-radius: inherit;
        pointer-events: none;
      }
      body.theme-light .schedule-card::after {
        border-left-color: hsla(var(--subject-h), 55%, 45%, 0.6);
      }
      body.theme-dark .schedule-card {
        background: hsla(var(--subject-h), 30%, 18%, 0.6);
        border-color: hsla(var(--subject-h), 35%, 35%, 0.35);
        color: var(--text-primary);
      }
      body.theme-light .schedule-card {
        background: hsla(var(--subject-h), 60%, 88%, 0.95);
        border-color: hsla(var(--subject-h), 45%, 70%, 0.65);
        color: #0f172a;
      }
      .schedule-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.18);
        border-color: hsla(var(--subject-h), 55%, 65%, 0.5);
        color: var(--text-primary);
      }
      body.theme-dark .schedule-card:hover {
        background: hsla(var(--subject-h), 30%, 20%, 0.72);
        color: #f8fafc;
      }
      body.theme-light .schedule-card:hover {
        background: hsla(var(--subject-h), 60%, 90%, 0.98);
        color: #0f172a;
      }
      body.theme-dark .schedule-card:hover {
        box-shadow: 0 18px 34px rgba(0, 0, 0, 0.4);
      }
      .schedule-card:active {
        transform: translateY(0);
        box-shadow: none;
      }
      body.theme-dark .schedule-card:active {
        background: hsla(var(--subject-h), 30%, 18%, 0.6);
      }
      body.theme-light .schedule-card:active {
        background: hsla(var(--subject-h), 55%, 92%, 0.9);
      }
      .schedule-card.is-now {
        border-color: rgba(34, 197, 94, 0.6);
        box-shadow: 0 18px 40px rgba(34, 197, 94, 0.18);
      }
      .schedule-card.is-now::after {
        border-left-color: rgba(34, 197, 94, 0.9);
      }
      .schedule-card.is-next {
        border-color: rgba(59, 130, 246, 0.35);
        box-shadow: 0 12px 24px rgba(59, 130, 246, 0.12);
      }
      .schedule-card.is-next::after {
        border-left-color: rgba(59, 130, 246, 0.6);
      }
      .schedule-card.chain-prev {
        margin-top: -8px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      .schedule-card.chain-next {
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
      }
      .schedule-card-inner {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 14px;
      }
      .schedule-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
        flex: 1;
      }
      .schedule-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .schedule-title {
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.3;
      }
      .lesson-pill {
        font-size: 0.72rem;
        font-weight: 600;
        padding: 2px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        color: #e2e8f0;
      }
      body.theme-light .lesson-pill {
        background: rgba(15, 23, 42, 0.08);
        color: #1e293b;
      }
      .schedule-meta {
        font-size: 0.82rem;
        color: var(--text-muted);
      }
      .schedule-aside {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        flex-shrink: 0;
      }
      .schedule-time {
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        font-variant-numeric: tabular-nums;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }
      .schedule-flags {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .schedule-chip {
        display: none;
        font-size: 0.68rem;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid transparent;
      }
      .schedule-card.is-now .chip-now {
        display: inline-flex;
        background: rgba(34, 197, 94, 0.2);
        color: #bbf7d0;
        border-color: rgba(34, 197, 94, 0.45);
      }
      .schedule-card.is-next .chip-next {
        display: inline-flex;
        background: rgba(59, 130, 246, 0.16);
        color: #dbeafe;
        border-color: rgba(59, 130, 246, 0.4);
      }
      body.theme-light .schedule-card.is-now .chip-now {
        color: #166534;
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.4);
      }
      body.theme-light .schedule-card.is-next .chip-next {
        color: #1e3a8a;
        background: rgba(59, 130, 246, 0.18);
        border-color: rgba(59, 130, 246, 0.4);
      }
      .conflict-badge {
        display: none;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px dashed rgba(148, 163, 184, 0.4);
        color: var(--text-muted);
      }
      .empty-state {
        text-align: center;
        padding: 18px 16px;
        border-radius: 16px;
        border: 1px dashed rgba(148, 163, 184, 0.4);
        background: rgba(148, 163, 184, 0.08);
        color: var(--text-muted);
        margin: 0;
      }
      body.theme-light .empty-state {
        background: rgba(15, 23, 42, 0.04);
      }
      .week-slider {
        gap: 10px;
        padding: 10px 14px;
      }
      .week-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        border: none;
        background: rgba(255, 255, 255, 0.4);
        opacity: 0.3;
        cursor: pointer;
        transition: transform 220ms ease, background 220ms ease, width 260ms ease, box-shadow 260ms ease;
      }
      .week-dot:hover {
        transform: scale(1.15);
        opacity: 0.6;
      }
      .week-dot.active {
        width: 28px;
        height: 8px;
        opacity: 1;
        background: rgba(255, 255, 255, 0.85);
        box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
      }
      body.theme-light .week-dot {
        background: rgba(15, 23, 42, 0.4);
      }
      body.theme-light .week-dot.active {
        background: rgba(15, 23, 42, 0.85);
      }
      .schedule-content.is-exiting {
        opacity: 0;
        transform: translateY(8px);
      }
      @media (max-width: 768px) {
        .day-card .list-group {
          padding: 12px 14px 16px;
          gap: 12px;
        }
        .day-header {
          padding: 14px 14px 10px;
        }
        .schedule-card {
          padding: 14px 14px;
        }
        .schedule-time {
          font-size: 0.8rem;
        }
      }
      .form-label {
        color: var(--text-secondary);
      }
      .form-control,
      .form-select {
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
      }
      body.theme-light .form-control,
      body.theme-light .form-select {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.12);
        color: var(--text-primary);
      }
      .form-control:focus,
      .form-select:focus {
        border-color: var(--focus-border);
        box-shadow: var(--focus-ring);
      }
      .control-toggle {
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }
      .toggle-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .toggle {
        width: 46px;
        height: 26px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: inline-flex;
        align-items: center;
        padding: 2px;
        cursor: pointer;
        transition: background 160ms ease, border-color 160ms ease;
      }
      .toggle-knob {
        width: 20px;
        height: 20px;
        border-radius: 999px;
        background: #fff;
        transform: translateX(0);
        transition: transform 160ms ease;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
      }
      .toggle-input:checked + .toggle {
        background: rgba(76, 141, 255, 0.55);
        border-color: rgba(76, 141, 255, 0.7);
      }
      .toggle-input:checked + .toggle .toggle-knob {
        transform: translateX(20px);
      }
      .toggle-text {
        font-weight: 600;
        color: var(--text-primary);
      }
      .btn-primary {
        background: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.6);
        border-radius: var(--radius-md);
        height: 44px;
      }
      .btn-outline-light {
        border-radius: var(--radius-md);
      }
      .btn-ghost {
        border: none;
        background: transparent;
        color: var(--text-secondary);
      }
      .theme-toggle-min {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
        backdrop-filter: blur(10px);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease, border-color 160ms ease;
      }
      .mobile-menu-btn {
        line-height: 1;
        align-self: center;
        margin-top: 0;
      }
      .theme-toggle-min:hover {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.35);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      }
      body.theme-light .theme-toggle-min {
        border-color: rgba(15, 23, 42, 0.12);
        background: rgba(255, 255, 255, 0.7);
      }
      body.theme-light .theme-toggle-min:hover {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
      }
      .modal-backdrop.show {
        opacity: 0.48;
      }
      .modal-content {
        display: flex;
        flex-direction: column;
        max-height: 80vh;
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: var(--glass-bg);
        border: var(--border-subtle);
        backdrop-filter: blur(var(--glass-blur));
      }
      body.theme-light .modal-content {
        background: var(--glass-bg-light);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }
      .modal-header,
      .modal-footer {
        position: sticky;
        z-index: 2;
        background: inherit;
        backdrop-filter: blur(var(--glass-blur));
      }
      .modal-header {
        top: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-footer {
        bottom: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      .modal-body {
        overflow-y: auto;
      }
      .file-field {
        display: grid;
        gap: 8px;
        position: relative;
      }
      .file-input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }
      .file-ui {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        border: 1px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.06);
      }
      body.theme-light .file-ui {
        border-color: rgba(15, 23, 42, 0.14);
        background: rgba(15, 23, 42, 0.04);
      }
      .week-hero.glass,
      .alert.glass {
        transition: none;
      }
      .file-name {
        color: var(--text-muted);
        font-size: 0.9rem;
      }
</style>
      <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/schedule.css" />
</head>
  <body class="theme-dark">
    <%- include('partials/topbar', { role, username, t, activePage: 'schedule' }) %>
    <aside class="schedule-drawer" id="scheduleActionDrawer" aria-hidden="true">
      <div class="drawer-head">
        <div class="drawer-title"></div>
        <button class="drawer-close" type="button" id="scheduleDrawerClose" aria-label="Close menu"></button>
      </div>
      <div class="drawer-actions">
        <% if (role === 'admin') { %>
          <form method="POST" action="/admin/switch-to-admin" class="drawer-action-wrap">
            <button class="drawer-action" type="submit"><%= t('schedule.backToAdmin') %></button>
          </form>
        <% } %>
        <% if (role === 'starosta') { %>
          <a class="drawer-action" href="/starosta"><%= t('menu.starosta') %></a>
        <% } %>
        <% if (role === 'deanery') { %>
          <a class="drawer-action" href="/deanery"><%= t('menu.deanery') %></a>
        <% } %>
        <% if (settings && settings.allow_messages) { %>
          <button class="drawer-action" type="button" id="messagesBtn" aria-label="<%= t('messages.aria') %>"> </button>
        <% } %>
        <a class="drawer-action" href="/teamwork"><%= t('menu.teamwork') %></a>
        <a class="drawer-action" href="/my-day"> </a>
        <a class="drawer-action" href="/profile"><%= t('schedule.profile') %></a>
        <button
          class="drawer-action theme-toggle"
          type="button"
          data-light-label=""
          data-dark-label=""
        >
          
        </button>
        <form method="POST" action="/logout" class="drawer-action-wrap">
          <button class="drawer-action" type="submit"><%= t('schedule.logout') %></button>
        </form>
      </div>
    </aside>

    <div class="schedule-shell" id="scheduleShell">
      <main class="container py-4 schedule-content enter">
        <div class="glass week-hero mb-4">
          <div>
            <h1 class="hero-title mb-1"><%= t('schedule.header') %></h1>
            <div class="hero-sub" id="daily-phrase">Your rhythm, your focus  lets make this week count.</div>
          </div>
          <div class="hero-actions">
            <span class="badge-glow"><%= t('schedule.week') %> <%= currentWeek %></span>
            <% if ((role === 'student' || role === 'starosta' || role === 'teacher' || viewAs === 'student') && settings && settings.allow_custom_deadlines) { %>
              <button class="btn btn-glass btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#customDeadlineModal">
                 
              </button>
            <% } %>
          </div>
        </div>

        <% const hasCourseFilters = role === 'teacher' && teacherCourses && teacherCourses.length > 1; %>
        <div class="glass schedule-panel mb-4 <%= hasCourseFilters ? '' : 'single-panel' %>">
          <% if (hasCourseFilters) { %>
            <div class="panel-section">
              <div class="panel-title"></div>
              <div class="panel-body">
                <form method="GET" action="/schedule" class="d-inline">
                  <input type="hidden" name="week" value="<%= currentWeek %>" />
                  <select class="form-select form-select-sm" name="course" onchange="this.form.submit()">
                    <option value=""> </option>
                    <% teacherCourses.forEach(function(c) { %>
                      <option value="<%= c.id %>" <%= selectedCourseId === c.id ? 'selected' : '' %>><%= c.name %></option>
                    <% }); %>
                  </select>
                </form>
              </div>
            </div>
            <div class="panel-divider"></div>
          <% } %>
          <div class="panel-section panel-sync">
            <div class="panel-body">
              <div class="sync-pill">
                <span class="sync-dot" id="syncDot"></span>
                <span id="syncStatusLabel"></span>
                <span class="sync-sep"></span>
                <span id="syncStatusMeta"></span>
              </div>
              <label class="control-toggle focus-toggle panel-focus-inline" for="focusWeekToggle">
                <input class="toggle-input" type="checkbox" id="focusWeekToggle" />
                <span class="toggle">
                  <span class="toggle-knob"></span>
                </span>
                <span class="toggle-text">Focus week</span>
              </label>
            </div>
          </div>
        </div>

        <section class="status-stack mb-4" id="densityBlock">
          <details class="density-summary" id="densitySummary">
            <summary>
              <span>Week pulse</span>
              <span class="density-summary-hint">Hover chips for details</span>
            </summary>
            <div class="density-summary-copy">
              <span>Calm view of the week density without aggressive warning colors.</span>
            </div>
            <div class="density-chip-row">
              <span class="density-chip" id="densityChipBalance" data-bs-toggle="tooltip" data-bs-placement="top">Day balance</span>
              <span class="density-chip" id="densityChipEvening" data-bs-toggle="tooltip" data-bs-placement="top">Evening intensity</span>
              <span class="density-chip" id="densityChipPeak" data-bs-toggle="tooltip" data-bs-placement="top">Most intense day</span>
            </div>
          </details>
        </section>

        <% if (viewAs === 'student') { %>
          <div class="test-view-banner">
             : <%= viewAsCourse && viewAsCourse.name ? viewAsCourse.name : '' %>  <%= viewAsLabel || (` ${viewAsGroupNumber || 1}`) %>
          </div>
        <% } else if (role === 'admin') { %>
          <div class="test-view-banner">
            <%= t('schedule.adminViewNotice') %>
          </div>
        <% } %>

        <% if (subgroupError === 'exists') { %>
          <div class="alert alert-warning glass text-white border-0">
            You are already in a subgroup for this homework.
          </div>
        <% } %>

        <div id="scheduleWeekGrid">
        <% daysOfWeek.forEach(function(day) { %>
          <% const dateLabel = dayDates && dayDates[day] ? new Date(dayDates[day]).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'Europe/Kyiv' }) : ''; %>
          <% const dayEntries = scheduleByDay[day] || []; %>
          <% let maxStreak = 0; let currentStreak = 0; let hasOverlap = false; const seenSlots = {}; %>
          <% for (let i = 0; i < dayEntries.length; i++) { %>
            <% const slotKey = String(dayEntries[i].class_number || ''); %>
            <% seenSlots[slotKey] = (seenSlots[slotKey] || 0) + 1; %>
            <% if (seenSlots[slotKey] > 1) { hasOverlap = true; } %>
            <% if (i === 0 || dayEntries[i].class_number === dayEntries[i - 1].class_number + 1) { %>
              <% currentStreak += 1; %>
            <% } else { %>
              <% currentStreak = 1; %>
            <% } %>
            <% if (currentStreak > maxStreak) { maxStreak = currentStreak; } %>
          <% } %>
          <% const isDenseDay = maxStreak >= 3; %>
          <div class="card mb-3 glass day-card" data-day-date="<%= dayDates && dayDates[day] ? dayDates[day] : '' %>">
            <div class="day-header">
              <div class="day-title">
                <span class="day-name"><%= day %></span>
                <% if (dateLabel) { %>
                  <span class="day-date"><%= dateLabel %></span>
                <% } %>
              </div>
              <div class="day-indicators">
                <% if (isDenseDay) { %>
                  <span class="day-chip day-chip--primary">Dense day</span>
                <% } %>
                <% if (hasOverlap) { %>
                  <button
                    class="day-secondary-signal"
                    type="button"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    data-bs-title="Overlapping slots detected"
                    aria-label="Overlapping slots detected"
                  >
                    i
                  </button>
                <% } %>
              </div>
            </div>
            <div class="list-group list-group-flush">
              <% if (!dayEntries || dayEntries.length === 0) { %>
                <div class="list-group-item empty-state">No classes</div>
              <% } else { %>
                <% dayEntries.forEach(function(cls, idx) { %>
                  <% const slot = bellSchedule[cls.class_number]; %>
                  <% const timeLabel = slot ? `${slot.start} - ${slot.end}` : ''; %>
                  <% const subjectName = cls.subject_name || ''; %>
                  <% const subjectNameLower = subjectName.toLowerCase(); %>
                  <% const inlineType = /(||||lecture|seminar|lab|practice)/.test(subjectNameLower); %>
                  <% const typeLabel = cls.lesson_type === 'lecture' ? '' : cls.lesson_type === 'seminar' ? '' : cls.lesson_type === 'lab' ? '' : cls.lesson_type === 'practice' ? '' : ''; %>
                  <% const showTypeBadge = cls.lesson_type && !inlineType && typeLabel; %>
                  <% const legacyKey = `${cls.subject_id}|${cls.group_number}|${cls.day_of_week}|${cls.class_number}`; %>
                  <% const datedKey = cls.class_date ? `${legacyKey}|${cls.class_date}` : null; %>
                  <% const baseKey = cls.class_date ? `${cls.subject_id}|${cls.day_of_week}|${cls.class_number}|${cls.class_date}` : `${cls.subject_id}|${cls.day_of_week}|${cls.class_number}`; %>
                  <% const hwMeta = cls.is_general && homeworkMetaAll ? homeworkMetaAll[baseKey] : (homeworkMeta ? (datedKey ? homeworkMeta[datedKey] : homeworkMeta[legacyKey]) : null); %>
                  <% const groupLabel = cls.group_label ? cls.group_label : `Group ${cls.group_number}`; %>
                  <% const courseLabel = cls.course_name ? `  ${cls.course_name}` : ''; %>
                  <% const prev = idx > 0 ? dayEntries[idx - 1] : null; %>
                  <% const next = idx < dayEntries.length - 1 ? dayEntries[idx + 1] : null; %>
                  <% const chainPrev = prev && prev.subject_id === cls.subject_id && cls.class_number === prev.class_number + 1; %>
                  <% const chainNext = next && next.subject_id === cls.subject_id && next.class_number === cls.class_number + 1; %>
                  <% const tooltipParts = [subjectName, groupLabel, `Class ${cls.class_number}`, timeLabel]; %>
                  <% if (showTypeBadge) { tooltipParts.push(typeLabel); } %>
                  <% if (cls.course_name) { tooltipParts.push(cls.course_name); } %>
                  <% if (hwMeta && hwMeta.preview && hwMeta.preview.length) { tooltipParts.push(...hwMeta.preview); } %>
                  <div
                    class="list-group-item schedule-card <%= chainPrev ? 'chain-prev' : '' %> <%= chainNext ? 'chain-next' : '' %>"
                    role="button"
                    tabindex="0"
                    data-bs-toggle="modal"
                    data-bs-target="#homeworkModal"
                    data-class="<%= cls.subject_name %>"
                    data-subject="<%= subjectName %>"
                    data-subjectid="<%= cls.subject_id %>"
                    data-day="<%= cls.day_of_week %>"
                    data-time="<%= timeLabel %>"
                    data-time-base="<%= timeLabel %>"
                    data-classnum="<%= cls.class_number %>"
                    data-groupnum="<%= cls.group_number %>"
                    data-courseid="<%= cls.course_id || '' %>"
                    data-date="<%= cls.class_date %>"
                    data-is-general="<%= cls.is_general ? 1 : 0 %>"
                    data-use-local-time="<%= cls.use_local_time ? 1 : 0 %>"
                    data-detail="<%= tooltipParts.join('  ') %>"
                  >
                    <div class="schedule-card-inner">
                      <div class="schedule-main">
                        <div class="schedule-title-row">
                          <div class="schedule-title"><%= subjectName %></div>
                          <% if (showTypeBadge) { %>
                            <span class="lesson-pill"><%= typeLabel %></span>
                          <% } %>
                        </div>
                        <div class="schedule-meta"><%= groupLabel %>   <%= cls.class_number %><%= courseLabel %></div>
                      </div>
                      <div class="schedule-aside">
                        <div class="schedule-time"><%= timeLabel %></div>
                        <div class="schedule-flags">
                          <% if (hwMeta && hwMeta.control) { %>
                            <span class="control-chip"></span>
                          <% } %>
                          <% if (hwMeta) { %>
                            <span class="hw-chip"> <%= hwMeta.count %></span>
                          <% } %>
                          <span class="schedule-chip chip-now"></span>
                          <span class="schedule-chip chip-next"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              <% } %>
            </div>
            <% const dateKey = dayDates && dayDates[day] ? dayDates[day] : null; %>
            <% const customItems = dateKey && customDeadlinesByDate ? customDeadlinesByDate[dateKey] : null; %>
            <% if (settings && settings.allow_custom_deadlines && customItems && customItems.length) { %>
              <details class="deadline-block">
                <summary class="deadline-title"> </summary>
                <div class="deadline-content">
                  <% customItems.forEach(function(item) { %>
                    <% const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : ''; %>
                    <% const shortDesc = item.description ? (item.description.length > 80 ? item.description.slice(0, 80) + '' : item.description) : ''; %>
                    <div
                      class="deadline-item"
                      data-custom-id="<%= item.id %>"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="<%= shortDesc %>"
                    >
                      <div>
                        <div class="fw-semibold"><%= item.subject_name %></div>
                        <% const groupNote = role === 'teacher' && item.group_number ? `   ${item.group_number}` : ''; %>
                        <div class="deadline-meta">: <%= dueLabel %><%= groupNote %></div>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </details>
            <% } %>
          </div>
        <% }); %>
        <% const activeDaySet = new Set(daysOfWeek || []); %>
        <% if (settings && settings.allow_custom_deadlines && weekendDeadlineCards && weekendDeadlineCards.length) { %>
          <% weekendDeadlineCards.forEach(function(card) { %>
            <% if (activeDaySet.has(card.day)) { return; } %>
            <% const dateLabel = card.date ? new Date(card.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'Europe/Kyiv' }) : ''; %>
            <div class="card mb-3 glass day-card" data-day-date="<%= card.date || '' %>">
              <div class="day-header">
                <div class="day-title">
                  <span class="day-name"><%= card.day %></span>
                  <% if (dateLabel) { %>
                    <span class="day-date"><%= dateLabel %></span>
                  <% } %>
                </div>
              </div>
              <details class="deadline-block">
                <summary class="deadline-title"> </summary>
                <div class="deadline-content">
                  <% card.items.forEach(function(item) { %>
                    <% const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : ''; %>
                    <% const shortDesc = item.description ? (item.description.length > 80 ? item.description.slice(0, 80) + '' : item.description) : ''; %>
                    <div
                      class="deadline-item"
                      data-custom-id="<%= item.id %>"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="<%= shortDesc %>"
                    >
                      <div>
                        <div class="fw-semibold"><%= item.subject_name %></div>
                        <% const groupNote = role === 'teacher' && item.group_number ? `   ${item.group_number}` : ''; %>
                        <div class="deadline-meta">: <%= dueLabel %><%= groupNote %></div>
                      </div>
                    </div>
                  <% }); %>
                </div>
              </details>
            </div>
          <% }); %>
        <% } %>
        </div>
      </main>

      <div class="week-rail" id="weekRail">
        <button class="week-nav-btn" type="button" id="weekPrev" aria-label="Previous week"></button>
        <div class="week-slider" id="weekSlider">
          <div class="week-indicator-layer" id="weekIndicatorLayer" aria-hidden="true">
            <span class="week-active-indicator" id="weekActiveIndicator" aria-hidden="true"></span>
          </div>
          <div class="week-window" id="weekWindow">
            <div class="week-dot-rail" id="weekDotRail" role="tablist" aria-label="Week selector">
          <% const weekTotal = totalWeeks || 15; %>
          <% const currentIndex = Math.max(0, Math.min(weekTotal - 1, (currentWeek || 1) - 1)); %>
          <% for (let weekIndex = 0; weekIndex < weekTotal; weekIndex++) { %>
            <% const weekNumber = weekIndex + 1; %>
            <button
              type="button"
              class="week-dot"
              data-week="<%= weekNumber %>"
              data-week-index="<%= weekIndex %>"
              data-active="<%= weekIndex === currentIndex ? 'true' : 'false' %>"
              data-visible="true"
              role="tab"
              aria-selected="<%= weekNumber === currentWeek ? 'true' : 'false' %>"
              tabindex="<%= weekIndex === currentIndex ? '0' : '-1' %>"
              aria-label="<%= t('schedule.week') %> <%= weekNumber %>"
            ></button>
          <% } %>
            </div>
          </div>
        </div>
        <button class="week-nav-btn" type="button" id="weekNext" aria-label="Next week"></button>
      </div>

      <footer class="app-footer text-center py-4">
        <small class="footer-meta">
          <span class="footer-version">v<%= appVersion %></span>
          <button
            type="button"
            class="footer-build"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            data-bs-title="<%= buildStamp %>"
            aria-label="Build timestamp"
          >
            build
          </button>
          <button
            type="button"
            class="footer-link"
            data-bs-toggle="modal"
            data-bs-target="#changelogModal"
          >
            Changelog
          </button>
        </small>
      </footer>
    </div>

    <%- include('partials/changelog-modal') %>
    <div class="modal fade" id="homeworkModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="homeworkModalTitle">Class details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <strong>Selected class:</strong>
              <span id="homeworkModalMeta" class="text-muted"></span>
            </div>

            <h6>Homework list</h6>
            <ul id="homeworkList" class="list-group mb-4">
              <li class="list-group-item text-muted">No assignments yet.</li>
            </ul>

            <div id="subgroupSection" class="mb-4 d-none">
              <h6>Subgroups</h6>
              <div id="subgroupList" class="list-group mb-3"></div>

              <div class="card mb-3">
                <div class="card-body">
                  <form method="POST" action="/subgroup/create">
                    <input type="hidden" id="subgroupHomeworkId" name="homework_id" />
                    <div class="row g-2 align-items-end">
                      <div class="col-12 col-md-8">
                        <label for="subgroupName" class="form-label">Create new subgroup</label>
                        <input id="subgroupName" name="name" class="form-control" placeholder="Group name" required />
                      </div>
                      <div class="col-12 col-md-4">
                        <button type="submit" class="btn btn-outline-primary w-100 glass">Create</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>

              <form method="POST" action="/subgroup/join">
                <div class="row g-2 align-items-end">
                  <div class="col-12 col-md-8">
                    <label for="joinSubgroupId" class="form-label">Join existing subgroup</label>
                    <select id="joinSubgroupId" name="subgroup_id" class="form-select" required>
                      <option value="" disabled selected>Select subgroup</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-4">
                    <button type="submit" class="btn btn-outline-secondary w-100 glass">Join</button>
                  </div>
                </div>
              </form>
            </div>

            <h6>Add homework</h6>
            <form method="POST" action="/homework/add" enctype="multipart/form-data" autocomplete="off">
              <div class="mb-3">
                <label for="hwText" class="form-label">Description</label>
                <textarea id="hwText" name="description" class="form-control" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="hwLink" class="form-label">Link (optional)</label>
                <input
                  id="hwLink"
                  name="link_url"
                  type="text"
                  inputmode="url"
                  autocapitalize="none"
                  class="form-control"
                  placeholder="https://example.com"
                  autocomplete="off"
                />
              </div>
              <div class="mb-3">
                <label for="hwMeeting" class="form-label">Online class link (Zoom/Teams)</label>
                <input
                  id="hwMeeting"
                  name="meeting_url"
                  type="text"
                  inputmode="url"
                  autocapitalize="none"
                  class="form-control"
                  placeholder="https://zoom.us/j/..."
                  autocomplete="off"
                />
              </div>
              <div class="mb-3">
                <div class="control-toggle">
                  <input class="toggle-input" type="checkbox" id="hwControl" name="is_control" value="1" />
                  <label class="toggle" for="hwControl">
                    <span class="toggle-knob"></span>
                  </label>
                  <span class="toggle-text"></span>
                </div>
              </div>
              <div class="mb-3">
                <label for="hwFile" class="form-label">Attachment (optional)</label>
                <div class="file-field">
                  <input id="hwFile" name="attachment" type="file" class="file-input" />
                  <div class="file-ui">
                    <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="hwFile"></button>
                    <span class="file-name" data-file-name="hwFile">  </span>
                  </div>
                </div>
              </div>
              <% if (role && role !== 'student') { %>
                <div class="row g-2 mb-3">
                  <div class="col-12 col-md-4">
                    <label for="hwStatus" class="form-label">Publication</label>
                    <select id="hwStatus" name="status" class="form-select">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-5">
                    <label for="hwScheduledAt" class="form-label">Publish at</label>
                    <input id="hwScheduledAt" name="scheduled_at" type="datetime-local" class="form-control" />
                  </div>
                </div>
              <% } %>
              <input type="hidden" id="hwSubjectId" name="subject_id" />
              <input type="hidden" id="hwGroupNum" name="group_number" />
              <input type="hidden" id="hwDay" name="day_of_week" />
              <input type="hidden" id="hwTime" name="time" />
              <input type="hidden" id="hwClassNum" name="class_number" />
              <input type="hidden" id="hwDate" name="class_date" />
              <input type="hidden" id="hwCourseId" name="course_id" />
              <button type="submit" class="btn btn-primary glass">Save homework</button>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <% if (settings && settings.allow_custom_deadlines) { %>
    <div class="modal fade" id="customDeadlineModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <form method="POST" action="/homework/custom" enctype="multipart/form-data" autocomplete="off">
            <div class="modal-header">
              <h5 class="modal-title"> </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <% if (!customDeadlineSubjects || !customDeadlineSubjects.length) { %>
                <div class="alert alert-warning">    ,   .</div>
              <% } %>
              <div class="row g-3">
                <% if (role === 'teacher') { %>
                  <div class="col-12 col-md-6">
                    <label class="form-label"></label>
                    <select class="form-select" id="customCourseSelect" name="course_id" required>
                      <option value="" disabled selected> </option>
                      <% (teacherCourses || []).forEach(function(c) { %>
                        <option value="<%= c.id %>" <%= selectedCourseId === c.id ? 'selected' : '' %>><%= c.name %></option>
                      <% }); %>
                    </select>
                  </div>
                <% } %>
                <div class="col-12 col-md-6">
                  <label class="form-label"></label>
                  <select
                    class="form-select"
                    id="customSubjectSelect"
                    name="subject_id"
                    <%= (!customDeadlineSubjects || !customDeadlineSubjects.length) ? 'disabled' : '' %>
                    required
                  >
                    <option value="" disabled selected> </option>
                    <% (customDeadlineSubjects || []).forEach(function(subj) { %>
                      <option
                        value="<%= subj.id %>"
                        data-course-id="<%= subj.course_id || '' %>"
                        data-group-number="<%= typeof subj.group_number === 'number' ? subj.group_number : '' %>"
                        data-group-count="<%= subj.group_count || '' %>"
                        data-is-general="<%= subj.is_general ? 1 : 0 %>"
                      >
                        <%= subj.name %><%= subj.course_name ? ` (${subj.course_name})` : '' %>
                      </option>
                    <% }); %>
                  </select>
                </div>
                <% if (role === 'teacher') { %>
                  <div class="col-12 col-md-6">
                    <label class="form-label"></label>
                    <select class="form-select" id="customGroupSelect" name="group_number">
                      <option value=""> </option>
                    </select>
                  </div>
                <% } %>
                <div class="col-12 col-md-6">
                  <label class="form-label"></label>
                  <input type="date" class="form-control" name="custom_due_date" required />
                </div>
                <% if (role && role !== 'student') { %>
                  <div class="col-12 col-md-4">
                    <label class="form-label">Publication</label>
                    <select id="customHwStatus" name="status" class="form-select">
                      <option value="published" selected>Publish now</option>
                      <option value="scheduled">Schedule</option>
                      <option value="draft">Draft</option>
                    </select>
                  </div>
                  <div class="col-12 col-md-5">
                    <label class="form-label">Publish at</label>
                    <input id="customHwScheduledAt" name="scheduled_at" type="datetime-local" class="form-control" />
                  </div>
                <% } %>
                <div class="col-12">
                  <label class="form-label"></label>
                  <textarea class="form-control" name="description" rows="3" required></textarea>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label"> (.)</label>
                  <input
                    type="text"
                    inputmode="url"
                    autocapitalize="none"
                    class="form-control"
                    name="link_url"
                    placeholder="https://example.com"
                    autocomplete="off"
                  />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">- (.)</label>
                  <input
                    type="text"
                    inputmode="url"
                    autocapitalize="none"
                    class="form-control"
                    name="meeting_url"
                    placeholder="https://zoom.us/j/..."
                    autocomplete="off"
                  />
                </div>
                <div class="col-12">
                  <label class="form-label"> (.)</label>
                  <div class="file-field">
                    <input id="customFile" type="file" class="file-input" name="attachment" />
                    <div class="file-ui">
                      <button class="btn btn-ghost btn-sm file-btn" type="button" data-file-target="customFile"></button>
                      <span class="file-name" data-file-name="customFile">  </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal"></button>
              <button type="submit" class="btn btn-primary glass" <%= (!customDeadlineSubjects || !customDeadlineSubjects.length) ? 'disabled' : '' %>>
                
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal fade" id="customDeadlineViewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"> </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <div class="fw-semibold" id="customDeadlineSubject"></div>
              <div class="text-muted" id="customDeadlineDue"></div>
            </div>
            <div class="mb-3" id="customDeadlineDescription"></div>
            <div class="mb-2" id="customDeadlineLinks"></div>
            <div class="d-flex align-items-center gap-2" id="customDeadlineReactions">
              <button class="react-btn" type="button" data-emoji=""> <span class="react-count">0</span></button>
              <button class="react-btn" type="button" data-emoji=""> <span class="react-count">0</span></button>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary glass" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <%- include('partials/mobile-menu-modal', { role, t, activePage: 'schedule' }) %>

    <% if (settings && settings.allow_messages) { %>
    <div class="modal fade" id="messagesModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">  </label>
              <select class="form-select" id="messagesSubjectFilter">
                <option value=""> </option>
                <% (messageSubjects || []).forEach(function(s) { %>
                  <option value="<%= s.subject_id %>"><%= s.subject_name %></option>
                <% }); %>
              </select>
            </div>
            <ul id="messagesList" class="list-group">
              <li class="list-group-item text-muted">...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-welcome-modal">
          <div class="modal-body text-center">
            <div class="welcome-title mb-2">    Studerria!</div>
            <div class="welcome-subtitle mb-3">
                  <strong>Studerria</strong>,   -  .
            </div>
            <div class="small mb-4">
                ,         .
              <br />
                ,        .
            </div>
            <button type="button" class="btn btn-primary glass" data-bs-dismiss="modal"> </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      function showCustomTooltip(el, message) {
        document.querySelectorAll('.custom-tooltip').forEach((t) => t.remove());
        const anchor = el.closest('.form-check') || el.closest('.input-group') || el;
        const key = el.id || el.name || anchor.id || '';
        const tip = document.createElement('div');
        tip.className = 'custom-tooltip';
        tip.textContent = message || ' ';
        if (key) tip.dataset.for = key;
        document.body.appendChild(tip);

        const rect = anchor.getBoundingClientRect();
        const tipRect = tip.getBoundingClientRect();
        const margin = 10;
        let top = rect.bottom + margin;
        let left = rect.left;
        let placeBelow = true;
        if (top + tipRect.height > window.innerHeight - 8) {
          top = rect.top - tipRect.height - margin;
          placeBelow = false;
        }
        if (left + tipRect.width > window.innerWidth - 8) {
          left = window.innerWidth - tipRect.width - 8;
        }
        if (left < 8) left = 8;
        tip.style.top = `${Math.round(top)}px`;
        tip.style.left = `${Math.round(left)}px`;
        if (placeBelow) tip.classList.add('below');
        requestAnimationFrame(() => tip.classList.add('show'));
        const remove = () => tip.remove();
        tip.addEventListener('click', remove);
        setTimeout(remove, 3500);
      }

      function attachValidationTooltips(root = document) {
        root.querySelectorAll('input, select, textarea').forEach((el) => {
          el.addEventListener('invalid', (event) => {
            event.preventDefault();
            showCustomTooltip(el, el.validationMessage);
          });
          el.addEventListener('input', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
          el.addEventListener('blur', () => {
            const existing = document.querySelector(`.custom-tooltip[data-for="${el.id}"]`);
            if (existing) existing.remove();
          });
        });
      }

      attachValidationTooltips();

      function bindScheduleStatus(selectId, inputId) {
        const statusSelect = document.getElementById(selectId);
        const scheduleInput = document.getElementById(inputId);
        if (!statusSelect || !scheduleInput) return;
        const sync = () => {
          const isScheduled = statusSelect.value === 'scheduled';
          scheduleInput.disabled = !isScheduled;
          scheduleInput.required = isScheduled;
          if (!isScheduled) {
            scheduleInput.value = '';
          }
        };
        statusSelect.addEventListener('change', sync);
        sync();
      }

      bindScheduleStatus('hwStatus', 'hwScheduledAt');
      bindScheduleStatus('customHwStatus', 'customHwScheduledAt');

      const customCourseSelect = document.getElementById('customCourseSelect');
      const customSubjectSelect = document.getElementById('customSubjectSelect');
      const customGroupSelect = document.getElementById('customGroupSelect');

      function syncCustomDeadlineSubjects() {
        if (!customSubjectSelect || !customCourseSelect) return;
        const selectedCourse = customCourseSelect.value;
        let hasVisible = false;
        Array.from(customSubjectSelect.options).forEach((opt) => {
          if (!opt.value) return;
          const courseId = opt.dataset.courseId;
          const visible = !selectedCourse || courseId === selectedCourse;
          opt.hidden = !visible;
          opt.disabled = !visible;
          if (visible) hasVisible = true;
        });
        if (customSubjectSelect.value) {
          const current = customSubjectSelect.selectedOptions[0];
          if (current && current.hidden) {
            customSubjectSelect.value = '';
          }
        }
        if (!hasVisible) {
          customSubjectSelect.value = '';
        }
        syncCustomDeadlineGroups();
      }

      function syncCustomDeadlineGroups() {
        if (!customGroupSelect || !customSubjectSelect) return;
        const opt = customSubjectSelect.selectedOptions[0];
        customGroupSelect.innerHTML = '';
        if (!opt || !opt.value) {
          customGroupSelect.disabled = true;
          customGroupSelect.innerHTML = '<option value=""> </option>';
          return;
        }
        const isGeneral = opt.dataset.isGeneral === '1';
        const groupNum = opt.dataset.groupNumber;
        const groupCount = Number(opt.dataset.groupCount || 0);
        if (isGeneral) {
          customGroupSelect.disabled = true;
          customGroupSelect.innerHTML = '<option value=""> </option>';
          return;
        }
        if (groupNum) {
          customGroupSelect.disabled = false;
          customGroupSelect.innerHTML = `<option value="${groupNum}"> ${groupNum}</option>`;
          customGroupSelect.value = groupNum;
          return;
        }
        if (groupCount > 0) {
          customGroupSelect.disabled = false;
          customGroupSelect.innerHTML = '<option value="" disabled selected> </option>';
          for (let i = 1; i <= groupCount; i += 1) {
            const option = document.createElement('option');
            option.value = String(i);
            option.textContent = ` ${i}`;
            customGroupSelect.appendChild(option);
          }
          return;
        }
        customGroupSelect.disabled = true;
        customGroupSelect.innerHTML = '<option value=""> </option>';
      }

      if (customCourseSelect) {
        customCourseSelect.addEventListener('change', syncCustomDeadlineSubjects);
        syncCustomDeadlineSubjects();
      }
      if (customSubjectSelect) {
        customSubjectSelect.addEventListener('change', syncCustomDeadlineGroups);
        syncCustomDeadlineGroups();
      }

      const currentUserId = <%- JSON.stringify(userId || null) %>;
      const welcomeModalEl = document.getElementById('welcomeModal');
      if (welcomeModalEl) {
        const params = new URLSearchParams(window.location.search);
        const shouldWelcome = params.get('welcome') === '1';
        const welcomeKey = `studerria:welcome:registered:${currentUserId || 'guest'}`;
        if (shouldWelcome && !localStorage.getItem(welcomeKey)) {
          const welcomeModal = new bootstrap.Modal(welcomeModalEl, { backdrop: true });
          welcomeModal.show();
          localStorage.setItem(welcomeKey, '1');
          document.body.classList.add('welcome-open');
          if (window.history && window.history.replaceState) {
            params.delete('welcome');
            const query = params.toString();
            const nextUrl = `${window.location.pathname}${query ? `?${query}` : ''}`;
            window.history.replaceState({}, document.title, nextUrl);
          }
          welcomeModalEl.addEventListener('hidden.bs.modal', () => {
            document.body.classList.remove('welcome-open');
          });
        } else if (shouldWelcome && window.history && window.history.replaceState) {
          params.delete('welcome');
          const query = params.toString();
          const nextUrl = `${window.location.pathname}${query ? `?${query}` : ''}`;
          window.history.replaceState({}, document.title, nextUrl);
        }
      }

      const isTeacherView = <%- JSON.stringify(role === 'teacher') %>;
      const homeworkModal = document.getElementById('homeworkModal');
      const homeworkData = <%- JSON.stringify(homework || []) %>;
      const customDeadlineItems = <%- JSON.stringify(customDeadlineItems || []) %>;
      const listEl = document.getElementById('homeworkList');
      const subgroupSection = document.getElementById('subgroupSection');
      const subgroupList = document.getElementById('subgroupList');
      const subgroupHomeworkId = document.getElementById('subgroupHomeworkId');
      const joinSubgroupId = document.getElementById('joinSubgroupId');
      const currentUser = <%- JSON.stringify(username) %>;
      const hwControlToggle = document.getElementById('hwControl');
      let currentHomeworkItems = [];

      function updateReactionButtons(container, reactions, reacted) {
        const buttons = container.querySelectorAll('.react-btn');
        buttons.forEach((btn) => {
          const emoji = btn.dataset.emoji;
          const count = reactions && reactions[emoji] ? reactions[emoji] : 0;
          const countEl = btn.querySelector('.react-count');
          if (countEl) countEl.textContent = count;
          if (reacted && reacted[emoji]) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      async function toggleHomeworkReaction(homeworkId, emoji, container) {
        if (!currentUserId) return;
        try {
          const res = await fetch('/homework/react', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ homework_id: homeworkId, emoji }),
          });
          if (!res.ok) return;
          const data = await res.json();
          updateReactionButtons(container, data.reactions, data.reacted);
        } catch (err) {
          console.error(err);
        }
      }

      function renderHomework(items) {
        listEl.innerHTML = '';
        if (!items.length) {
          const empty = document.createElement('li');
          empty.className = 'list-group-item text-muted';
          empty.textContent = 'No assignments yet.';
          listEl.appendChild(empty);
          return;
        }

        items.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'list-group-item';

          const tooltipParts = [];
          if (item.custom_due_date || item.class_date) {
            const dueDate = item.custom_due_date || item.class_date;
            const dueLabel = new Date(dueDate).toLocaleDateString('uk-UA');
            tooltipParts.push(`: ${dueLabel}`);
          }
          if (item.tags && item.tags.length) {
            tooltipParts.push(`: ${item.tags.join(', ')}`);
          }
          if (item.link_url) tooltipParts.push(' ');
          if (item.meeting_url) tooltipParts.push(' -');
          if (item.file_path) tooltipParts.push(' ');
          if (tooltipParts.length) {
            li.setAttribute('data-bs-toggle', 'tooltip');
            li.setAttribute('data-bs-placement', 'top');
            li.setAttribute('data-bs-title', tooltipParts.join('  '));
          }

          const title = document.createElement('div');
          title.className = 'fw-semibold mb-1';
          title.textContent = item.description;
          li.appendChild(title);

          const meta = document.createElement('div');
          meta.className = 'text-muted small mb-2';
          const created = new Date(item.created_at).toLocaleString();
          meta.textContent = `${item.created_by}  ${created}`;
          if (isTeacherView && item.group_number) {
            meta.textContent += `   ${item.group_number}`;
          }
          li.appendChild(meta);

          const dueDate = item.custom_due_date || item.class_date;
          let isUrgent = false;
          if (dueDate) {
            const due = new Date(dueDate);
            const now = new Date();
            const diffDays = Math.ceil((due - now) / (1000 * 60 * 60 * 24));
            isUrgent = diffDays >= 0 && diffDays <= 2;
          }
          const priorityWrap = document.createElement('div');
          priorityWrap.className = 'd-flex flex-wrap gap-2 mb-2';
          if (item.is_control) {
            const control = document.createElement('span');
            control.className = 'priority-chip priority-control';
            control.textContent = '';
            priorityWrap.appendChild(control);
          } else if (isUrgent) {
            const urgent = document.createElement('span');
            urgent.className = 'priority-chip priority-urgent';
            urgent.textContent = '';
            priorityWrap.appendChild(urgent);
          } else {
            const normal = document.createElement('span');
            normal.className = 'priority-chip priority-normal';
            normal.textContent = '';
            priorityWrap.appendChild(normal);
          }
          if (dueDate) {
            const dueLabel = new Date(dueDate).toLocaleDateString('uk-UA');
            const due = document.createElement('span');
            due.className = 'priority-chip priority-normal';
            due.textContent = `: ${dueLabel}`;
            priorityWrap.appendChild(due);
          }
          li.appendChild(priorityWrap);

          if (item.link_url) {
            const link = document.createElement('a');
            link.href = item.link_url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = 'Open link';
            link.className = 'me-3';
            li.appendChild(link);
          }
          if (item.meeting_url) {
            const meet = document.createElement('a');
            meet.href = item.meeting_url;
            meet.target = '_blank';
            meet.rel = 'noopener';
            meet.textContent = 'Online class';
            meet.className = 'me-3';
            li.appendChild(meet);
          }

          if (item.file_path) {
            const fileLink = document.createElement('a');
            fileLink.href = item.file_path;
            fileLink.textContent = item.file_name || 'Download file';
            fileLink.className = 'd-inline-block';
            li.appendChild(fileLink);
          }

          const reactWrap = document.createElement('div');
          reactWrap.className = 'd-flex gap-2 mt-2';
          ['', ''].forEach((emoji) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-secondary react-btn';
            btn.dataset.emoji = emoji;
            btn.dataset.homeworkId = item.id;
            const count = item.reactions && item.reactions[emoji] ? item.reactions[emoji] : 0;
            btn.innerHTML = `<span>${emoji}</span><span class="react-count">${count}</span>`;
            if (item.reacted && item.reacted[emoji]) {
              btn.classList.add('active');
            }
            btn.addEventListener('click', () => toggleHomeworkReaction(item.id, emoji, reactWrap));
            reactWrap.appendChild(btn);
          });
          li.appendChild(reactWrap);

          listEl.appendChild(li);

          if (tooltipParts.length) {
            new bootstrap.Tooltip(li);
          }
        });
      }

      function renderSubgroups(items) {
        subgroupList.innerHTML = '';
        joinSubgroupId.innerHTML = '<option value="" disabled selected>Select subgroup</option>';

        if (!items.length) {
          subgroupSection.classList.add('d-none');
          return;
        }

        subgroupSection.classList.remove('d-none');

        items.forEach((item) => {
          const container = document.createElement('div');
          container.className = 'list-group-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold';
          title.textContent = item.name;
          container.appendChild(title);

          const members = document.createElement('div');
          members.className = 'small text-muted';
          if (item.members.includes(currentUser)) {
            members.textContent = `Members: ${item.members.join(', ')} (you)`;
            container.classList.add('border', 'border-primary');
          } else {
            members.textContent = item.members.length ? item.members.join(', ') : 'No members yet';
          }
          container.appendChild(members);

          subgroupList.appendChild(container);

          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          joinSubgroupId.appendChild(opt);
        });
      }

      homeworkModal.addEventListener('show.bs.modal', (event) => {
        const button = event.relatedTarget;
        const subject = button.getAttribute('data-class');
        const subjectId = Number(button.getAttribute('data-subjectid'));
        const day = button.getAttribute('data-day');
        const time = button.getAttribute('data-time');
        const timeBase = button.getAttribute('data-time-base') || time;
        const classNum = Number(button.getAttribute('data-classnum'));
        const groupNum = Number(button.getAttribute('data-groupnum'));
        const courseId = Number(button.getAttribute('data-courseid'));
        const classDate = button.getAttribute('data-date');
        const isGeneral = button.getAttribute('data-is-general') === '1';

        document.getElementById('homeworkModalTitle').textContent = subject;
        document.getElementById('homeworkModalMeta').textContent = `${day}  ${time}`;

        document.getElementById('hwDay').value = day;
        document.getElementById('hwTime').value = timeBase;
        document.getElementById('hwSubjectId').value = subjectId;
        document.getElementById('hwGroupNum').value = groupNum;
        document.getElementById('hwClassNum').value = classNum;
        document.getElementById('hwDate').value = classDate || '';
        const courseField = document.getElementById('hwCourseId');
        if (courseField) {
          courseField.value = Number.isNaN(courseId) ? '' : String(courseId);
        }
        if (hwControlToggle) {
          hwControlToggle.checked = false;
        }

        const filtered = homeworkData.filter((item) => {
          return (
            Number(item.subject_id) === subjectId &&
            (!isGeneral ? Number(item.group_number) === groupNum : true) &&
            item.day === day &&
            Number(item.class_number) === classNum &&
            (Number.isNaN(courseId) ? true : Number(item.course_id) === courseId) &&
            item.class_date === classDate
          );
        });
        currentHomeworkItems = filtered;
        renderHomework(filtered);
        const first = filtered[0];
        if (first) {
          subgroupHomeworkId.value = first.id;
          renderSubgroups(first.subgroups || []);
        } else {
          subgroupSection.classList.add('d-none');
        }
        const hashValue = encodeURIComponent(`${subjectId}|${day}|${classNum}|${groupNum}`);
        if (location.hash !== `#class=${hashValue}`) {
          history.replaceState(null, '', `#class=${hashValue}`);
        }
      });

      homeworkModal.addEventListener('hidden.bs.modal', () => {
        if (location.hash.startsWith('#class=')) {
          history.replaceState(null, '', location.pathname + location.search);
        }
      });

      function openModalFromHash() {
        if (!location.hash.startsWith('#class=')) return;
        const payload = decodeURIComponent(location.hash.replace('#class=', ''));
        const [subjectId, day, classNum, groupNum] = payload.split('|');
        if (!subjectId || !day || !classNum || !groupNum) return;

        const match = document.querySelector(
          `[data-subjectid="${subjectId}"][data-day="${day}"][data-classnum="${classNum}"][data-groupnum="${groupNum}"]`
        );
        if (match) {
          match.click();
        }
      }

      window.addEventListener('hashchange', openModalFromHash);
      window.addEventListener('load', openModalFromHash);

      const weekSlider = document.getElementById('weekSlider');
      const weekWindow = document.getElementById('weekWindow');
      const weekDotRail = document.getElementById('weekDotRail');
      const weekIndicatorLayer = document.getElementById('weekIndicatorLayer');
      const weekActiveIndicator = document.getElementById('weekActiveIndicator');
      const messagesBtn = document.getElementById('messagesBtn');
      const messagesBtnMobile = document.getElementById('messagesBtnMobile');
      const messagesList = document.getElementById('messagesList');
      const messagesBadge = document.getElementById('messagesBadge');
      const mobileMenuBadge = document.getElementById('mobileMenuBadge');
      const messagesSubjectFilter = document.getElementById('messagesSubjectFilter');
      const weekPrev = document.getElementById('weekPrev');
      const weekNext = document.getElementById('weekNext');
      const scheduleDrawer = document.getElementById('scheduleActionDrawer');
      const scheduleDrawerToggle = document.getElementById('scheduleDrawerToggle');
      const scheduleDrawerClose = document.getElementById('scheduleDrawerClose');
      const focusWeekToggle = document.getElementById('focusWeekToggle');
      const densityChipBalance = document.getElementById('densityChipBalance');
      const densityChipEvening = document.getElementById('densityChipEvening');
      const densityChipPeak = document.getElementById('densityChipPeak');
      const totalWeeks = <%= totalWeeks || 15 %>;
      let currentWeek = <%= currentWeek %>;
      function setDrawerOpen(open) {
        if (!scheduleDrawer) return;
        document.body.classList.toggle('schedule-drawer-open', open);
        scheduleDrawer.setAttribute('aria-hidden', open ? 'false' : 'true');
        if (scheduleDrawerToggle) {
          scheduleDrawerToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        }
      }

      if (scheduleDrawerToggle && scheduleDrawer) {
        scheduleDrawerToggle.addEventListener('click', () => {
          const isOpen = document.body.classList.contains('schedule-drawer-open');
          setDrawerOpen(!isOpen);
        });
      }

      if (scheduleDrawerClose && scheduleDrawer) {
        scheduleDrawerClose.addEventListener('click', () => setDrawerOpen(false));
      }

      document.addEventListener('click', (event) => {
        if (!scheduleDrawer || !document.body.classList.contains('schedule-drawer-open')) return;
        const insideDrawer = scheduleDrawer.contains(event.target);
        const onToggle = scheduleDrawerToggle && scheduleDrawerToggle.contains(event.target);
        if (!insideDrawer && !onToggle) {
          setDrawerOpen(false);
        }
      });

      const carouselGeometry = {
        dotSize: 8,
        gap: 10,
        midGap: 14,
        visibleCount: 5,
        rowHeight: 16,
        ovalWidth: 28,
        ovalHeight: 8,
        step: 18,
        railWindowWidth: 0,
        totalDotsWidth: 0,
        windowCenterX: 0,
        indicatorX: 0,
        indicatorY: 0,
        padX: 10,
        padY: 4,
        ready: false,
      };

      let carouselState = {
        activeIndex: 0,
        totalCount: Math.max(1, totalWeeks),
        railX: 0,
      };

      let isCarouselAnimating = false;
      let carouselDebounceUntil = 0;
      const carouselDebounceMs = 250;
      let carouselUnlockTimer = null;
      let carouselMorphPhaseTimer = null;

      function clampValue(value, min, max) {
        return Math.max(min, Math.min(max, value));
      }

      function alignToDevicePixel(value) {
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        return Math.round(value * dpr) / dpr;
      }

      function getWeekDots() {
        if (!weekDotRail) return [];
        return Array.from(weekDotRail.querySelectorAll('.week-dot'));
      }

      function readCarouselGeometryTokens() {
        if (!weekDotRail || !weekWindow) return;

        const rootStyles = window.getComputedStyle(document.documentElement);
        const dotSize = parseFloat(rootStyles.getPropertyValue('--wc-dot')) || 8;
        const gap = parseFloat(rootStyles.getPropertyValue('--wc-gap')) || 10;
        const midGap = parseFloat(rootStyles.getPropertyValue('--wc-mid-gap')) || 14;
        const visibleCountToken = parseInt(rootStyles.getPropertyValue('--wc-visible'), 10) || 5;
        const rowHeight = parseFloat(rootStyles.getPropertyValue('--wc-row-h')) || 16;
        const ovalWidth = parseFloat(rootStyles.getPropertyValue('--wc-oval-w')) || 28;
        const padX = parseFloat(rootStyles.getPropertyValue('--week-pad-x')) || 10;
        const padY = parseFloat(rootStyles.getPropertyValue('--week-pad-y')) || 4;

        const renderedDots = getWeekDots();
        carouselState.totalCount = Math.max(1, renderedDots.length || totalWeeks);

        carouselGeometry.dotSize = Number.isFinite(dotSize) ? dotSize : 8;
        carouselGeometry.gap = Number.isFinite(gap) ? gap : 10;
        carouselGeometry.midGap = Number.isFinite(midGap) ? midGap : 14;
        carouselGeometry.visibleCount = Math.max(1, Number.isFinite(visibleCountToken) ? visibleCountToken : 5);
        carouselGeometry.rowHeight = Number.isFinite(rowHeight) ? rowHeight : 16;
        carouselGeometry.ovalHeight = carouselGeometry.dotSize;
        carouselGeometry.ovalWidth = Number.isFinite(ovalWidth)
          ? ovalWidth
          : ((carouselGeometry.dotSize * 3) + (carouselGeometry.gap * 2));
        carouselGeometry.step = carouselGeometry.dotSize + carouselGeometry.gap;
        carouselGeometry.railWindowWidth =
          (carouselGeometry.dotSize * carouselGeometry.visibleCount) +
          (carouselGeometry.gap * Math.max(0, carouselGeometry.visibleCount - 1));
        carouselGeometry.totalDotsWidth =
          (carouselGeometry.dotSize * carouselState.totalCount) +
          (carouselGeometry.gap * Math.max(0, carouselState.totalCount - 1));
        carouselGeometry.windowCenterX = carouselGeometry.railWindowWidth / 2;
        carouselGeometry.padX = padX;
        carouselGeometry.padY = padY;
        carouselGeometry.indicatorX = alignToDevicePixel(
          clampValue(
            (carouselGeometry.railWindowWidth - carouselGeometry.ovalWidth) / 2,
            0,
            Math.max(0, carouselGeometry.railWindowWidth - carouselGeometry.ovalWidth)
          )
        );
        carouselGeometry.indicatorY = alignToDevicePixel(
          Math.max(0, (carouselGeometry.rowHeight - carouselGeometry.ovalHeight) / 2)
        );

        const railWidth = `${Math.max(0, carouselGeometry.totalDotsWidth)}px`;
        const windowWidth = `${Math.max(0, carouselGeometry.railWindowWidth)}px`;

        weekDotRail.style.width = railWidth;
        weekDotRail.style.minWidth = railWidth;
        weekDotRail.style.maxWidth = railWidth;

        weekWindow.style.width = windowWidth;
        weekWindow.style.minWidth = windowWidth;
        weekWindow.style.maxWidth = windowWidth;

        if (weekIndicatorLayer) {
          weekIndicatorLayer.style.width = windowWidth;
          weekIndicatorLayer.style.minWidth = windowWidth;
          weekIndicatorLayer.style.maxWidth = windowWidth;
          weekIndicatorLayer.style.height = `${carouselGeometry.rowHeight}px`;
          weekIndicatorLayer.style.minHeight = `${carouselGeometry.rowHeight}px`;
          weekIndicatorLayer.style.maxHeight = `${carouselGeometry.rowHeight}px`;
          weekIndicatorLayer.style.left = `${padX}px`;
          weekIndicatorLayer.style.top = `${padY}px`;
        }

        carouselGeometry.ready = true;
      }

      function ensureCarouselGeometry(force = false) {
        if (!force && carouselGeometry.ready) return;
        readCarouselGeometryTokens();
      }

      function computeRailX(activeIndex = carouselState.activeIndex) {
        const safeIndex = clampValue(activeIndex, 0, Math.max(0, carouselState.totalCount - 1));
        const dotCenterX = (safeIndex * carouselGeometry.step) + (carouselGeometry.dotSize / 2);
        const rawRailX = carouselGeometry.windowCenterX - dotCenterX;
        const maxRailX = 0;
        const minRailX = Math.min(0, carouselGeometry.railWindowWidth - carouselGeometry.totalDotsWidth);
        return alignToDevicePixel(clampValue(rawRailX, minRailX, maxRailX));
      }

      function getCenterDotIndex(railX = carouselState.railX) {
        let nearestIndex = 0;
        let nearestDistance = Number.POSITIVE_INFINITY;
        for (let index = 0; index < carouselState.totalCount; index += 1) {
          const dotCenter = (index * carouselGeometry.step) + (carouselGeometry.dotSize / 2) + railX;
          const distance = Math.abs(dotCenter - carouselGeometry.windowCenterX);
          if (distance < nearestDistance) {
            nearestDistance = distance;
            nearestIndex = index;
          }
        }
        return nearestIndex;
      }

      function updateMidSplitDots(railX = carouselState.railX) {
        const dots = getWeekDots();
        if (!dots.length) return;

        const visibleIndices = [];
        for (let index = 0; index < carouselState.totalCount; index += 1) {
          const dotLeft = (index * carouselGeometry.step) + railX;
          const dotRight = dotLeft + carouselGeometry.dotSize;
          if (dotRight > 0 && dotLeft < carouselGeometry.railWindowWidth) {
            visibleIndices.push(index);
          }
        }

        const centerDotIndex = getCenterDotIndex(railX);
        const nonCenterVisible = visibleIndices.filter((index) => index !== centerDotIndex);
        const leftSplitPos = Math.floor((nonCenterVisible.length - 1) / 2);
        const rightSplitPos = leftSplitPos + 1;
        const leftSplitIndex = nonCenterVisible[leftSplitPos];
        const rightSplitIndex = nonCenterVisible[rightSplitPos];
        const halfShift = alignToDevicePixel((carouselGeometry.midGap || 14) / 2);

        dots.forEach((dot, index) => {
          dot.classList.remove('mid-split-left', 'mid-split-right');
          dot.style.removeProperty('--week-dot-shift-x');
          if (index === leftSplitIndex) {
            dot.classList.add('mid-split-left');
            dot.style.setProperty('--week-dot-shift-x', `${-halfShift}px`);
          } else if (index === rightSplitIndex) {
            dot.classList.add('mid-split-right');
            dot.style.setProperty('--week-dot-shift-x', `${halfShift}px`);
          }
        });
      }

      function applyCarouselFrame(railX, animate = true) {
        if (!weekDotRail || !weekActiveIndicator) return;
        const snappedRailX = alignToDevicePixel(railX);
        const snappedIndicatorX = alignToDevicePixel(carouselGeometry.indicatorX);
        const snappedIndicatorY = alignToDevicePixel(carouselGeometry.indicatorY);

        if (!animate) {
          weekDotRail.classList.add('no-motion');
          weekActiveIndicator.classList.add('no-motion');
        }

        requestAnimationFrame(() => {
          weekDotRail.style.transform = `translate3d(${snappedRailX}px, 0, 0)`;
          weekActiveIndicator.style.setProperty('--indicator-x', `${snappedIndicatorX}px`);
          weekActiveIndicator.style.setProperty('--indicator-y', `${snappedIndicatorY}px`);
          updateMidSplitDots(snappedRailX);

          if (!animate) {
            requestAnimationFrame(() => {
              weekDotRail.classList.remove('no-motion');
              weekActiveIndicator.classList.remove('no-motion');
            });
          }
        });
      }

      function setActiveDot(targetIndex) {
        const safeTarget = clampValue(targetIndex, 0, Math.max(0, carouselState.totalCount - 1));
        getWeekDots().forEach((dot, index) => {
          const isActive = index === safeTarget;
          dot.dataset.active = isActive ? 'true' : 'false';
          dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
          dot.tabIndex = isActive ? 0 : -1;
        });
      }

      function clearCarouselUnlockTimer() {
        if (carouselUnlockTimer) {
          clearTimeout(carouselUnlockTimer);
          carouselUnlockTimer = null;
        }
      }

      function clearMorphState() {
        if (carouselMorphPhaseTimer) {
          clearTimeout(carouselMorphPhaseTimer);
          carouselMorphPhaseTimer = null;
        }
        if (weekActiveIndicator) {
          weekActiveIndicator.classList.remove('is-morph-shrink');
        }
      }

      function updateSchedule(week) {
        const safe = Math.max(1, Math.min(carouselState.totalCount, week));
        const params = new URLSearchParams(window.location.search);
        params.set('week', safe);
        window.location.search = params.toString();
      }

      function updateWeekContent(targetIndex = carouselState.activeIndex) {
        const safeTarget = clampValue(Number(targetIndex), 0, carouselState.totalCount - 1);
        currentWeek = safeTarget + 1;
        requestAnimationFrame(() => updateSchedule(currentWeek));
      }

      function goToWeek(targetIndex) {
        ensureCarouselGeometry(false);
        const safeTarget = clampValue(Number(targetIndex), 0, carouselState.totalCount - 1);
        if (Number.isNaN(safeTarget) || safeTarget === carouselState.activeIndex) return;
        if (isCarouselAnimating) return;

        const now = Date.now();
        if (now < carouselDebounceUntil) return;
        carouselDebounceUntil = now + carouselDebounceMs;
        isCarouselAnimating = true;

        const nextRailX = computeRailX(safeTarget);
        carouselState.railX = nextRailX;

        clearMorphState();
        if (weekActiveIndicator) {
          weekActiveIndicator.classList.add('is-morph-shrink');
        }

        const scheduleContent = document.querySelector('.schedule-content');
        if (scheduleContent) {
          scheduleContent.classList.add('is-exiting');
        }

        const unlock = () => {
          if (!isCarouselAnimating) return;
          clearCarouselUnlockTimer();
          weekDotRail?.removeEventListener('transitionend', onRailTransitionEnd);

          if (weekActiveIndicator) {
            weekActiveIndicator.classList.remove('is-morph-shrink');
          }
          carouselState.activeIndex = safeTarget;
          setActiveDot(safeTarget);
          updateMidSplitDots(carouselState.railX);

          carouselMorphPhaseTimer = setTimeout(() => {
            if (!isCarouselAnimating) return;
            isCarouselAnimating = false;
            clearMorphState();
          }, 140);
        };

        const onRailTransitionEnd = (event) => {
          if (event.target !== weekDotRail || event.propertyName !== 'transform') return;
          unlock();
        };

        weekDotRail?.addEventListener('transitionend', onRailTransitionEnd);
        carouselUnlockTimer = setTimeout(unlock, 240);

        applyCarouselFrame(nextRailX, true);

        setTimeout(() => {
          updateWeekContent(safeTarget);
        }, 170);
      }

      function syncWeekCarousel(week, options = {}) {
        const { animate = true } = options;
        if (!weekSlider || !weekDotRail || !weekWindow) return;
        ensureCarouselGeometry(false);

        carouselState.activeIndex = clampValue(Number(week) - 1, 0, carouselState.totalCount - 1);
        setActiveDot(carouselState.activeIndex);
        carouselState.railX = computeRailX(carouselState.activeIndex);
        applyCarouselFrame(carouselState.railX, animate);
      }

      function animateWeekChange(nextWeek) {
        const safeWeek = clampValue(Number(nextWeek), 1, carouselState.totalCount);
        goToWeek(safeWeek - 1);
      }

      if (weekSlider) {
        if (weekDotRail) {
          weekDotRail.addEventListener('click', (event) => {
            const dot = event.target.closest('.week-dot');
            if (!dot || !weekDotRail.contains(dot)) return;
            const index = Number(dot.dataset.weekIndex);
            if (Number.isNaN(index)) return;
            goToWeek(index);
          });
        }

        if (weekPrev) {
          weekPrev.addEventListener('click', () => {
            goToWeek(carouselState.activeIndex - 1);
          });
        }

        if (weekNext) {
          weekNext.addEventListener('click', () => {
            goToWeek(carouselState.activeIndex + 1);
          });
        }

        let startX = 0;
        weekSlider.addEventListener('touchstart', (event) => {
          startX = event.touches[0].clientX;
        }, { passive: true });
        weekSlider.addEventListener('touchend', (event) => {
          const endX = event.changedTouches[0].clientX;
          const delta = endX - startX;
          if (Math.abs(delta) < 40) return;
          if (delta < 0) {
            goToWeek(carouselState.activeIndex + 1);
          }
          if (delta > 0) {
            goToWeek(carouselState.activeIndex - 1);
          }
        });

        syncWeekCarousel(currentWeek, { animate: false });
      }

      window.addEventListener('resize', () => {
        if (window.innerWidth < 992) {
          setDrawerOpen(false);
        }
        carouselGeometry.ready = false;
        ensureCarouselGeometry(true);
        syncWeekCarousel(currentWeek, { animate: false });
      });
      if (messagesBtnMobile) {
        messagesBtnMobile.addEventListener('click', () => {
          const mobileMenu = document.getElementById('mobileMenuModal');
          if (mobileMenu) {
            const menuInstance = bootstrap.Modal.getInstance(mobileMenu) || new bootstrap.Modal(mobileMenu);
            menuInstance.hide();
          }
          const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
          modal.show();
        });
      }

      const customDeadlineModal = document.getElementById('customDeadlineViewModal');
      const customDeadlineSubject = document.getElementById('customDeadlineSubject');
      const customDeadlineDue = document.getElementById('customDeadlineDue');
      const customDeadlineDescription = document.getElementById('customDeadlineDescription');
      const customDeadlineLinks = document.getElementById('customDeadlineLinks');
      const customDeadlineReactions = document.getElementById('customDeadlineReactions');

      function renderCustomDeadline(item) {
        if (!item) return;
        if (customDeadlineSubject) customDeadlineSubject.textContent = item.subject_name || '';
        if (customDeadlineDue) {
          const dueLabel = item.custom_due_date ? new Date(item.custom_due_date).toLocaleDateString('uk-UA') : '';
          customDeadlineDue.textContent = dueLabel ? `: ${dueLabel}` : '';
        }
        if (customDeadlineDescription) {
          customDeadlineDescription.textContent = item.description || '';
        }
        if (customDeadlineLinks) {
          customDeadlineLinks.innerHTML = '';
          const links = [];
          if (item.link_url) {
            links.push(`<a href="${item.link_url}" target="_blank" rel="noopener"></a>`);
          }
          if (item.meeting_url) {
            links.push(`<a href="${item.meeting_url}" target="_blank" rel="noopener">-</a>`);
          }
          if (item.file_path) {
            links.push(`<a href="${item.file_path}" target="_blank" rel="noopener">${item.file_name || ''}</a>`);
          }
          if (links.length) {
            customDeadlineLinks.innerHTML = links.join('  ');
          }
        }
        if (customDeadlineReactions) {
          updateReactionButtons(customDeadlineReactions, item.reactions || {}, item.reacted || {});
          customDeadlineReactions.querySelectorAll('.react-btn').forEach((btn) => {
            btn.onclick = () => toggleHomeworkReaction(item.id, btn.dataset.emoji, customDeadlineReactions);
          });
        }
      }

      const customMap = customDeadlineItems && customDeadlineItems.length
        ? new Map(customDeadlineItems.map((item) => [String(item.id), item]))
        : null;

      function bindCustomDeadlineCards(root = document) {
        if (!customMap) return;
        root.querySelectorAll('.deadline-item[data-custom-id]').forEach((el) => {
          if (el.dataset.deadlineBound === '1') return;
          el.dataset.deadlineBound = '1';
          el.addEventListener('click', () => {
            const item = customMap.get(String(el.dataset.customId));
            if (!item || !customDeadlineModal) return;
            renderCustomDeadline(item);
            const modal = new bootstrap.Modal(customDeadlineModal);
            modal.show();
          });
        });
      }

      bindCustomDeadlineCards();

      function applyFocusMode(enabled) {
        document.body.classList.toggle('focus-week', enabled);
      }

      if (focusWeekToggle) {
        const storedFocus = localStorage.getItem('schedule-focus-week') === '1';
        focusWeekToggle.checked = storedFocus;
        applyFocusMode(storedFocus);
        focusWeekToggle.addEventListener('change', () => {
          const enabled = focusWeekToggle.checked;
          localStorage.setItem('schedule-focus-week', enabled ? '1' : '0');
          applyFocusMode(enabled);
        });
      }

      function updateUnreadBadges(count) {
        const targets = [messagesBadge, mobileMenuBadge].filter(Boolean);
        if (!targets.length) return;
        if (count > 0) {
          const value = count > 99 ? '99+' : String(count);
          targets.forEach((badge) => {
            badge.textContent = value;
            badge.classList.remove('d-none');
          });
        } else {
          targets.forEach((badge) => badge.classList.add('d-none'));
        }
      }

      const scheduleContent = document.querySelector('.schedule-content');
      if (scheduleContent) {
        let touchStartX = 0;
        let touchStartY = 0;
        scheduleContent.addEventListener('touchstart', (event) => {
          if (document.body.classList.contains('modal-open')) return;
          const t = event.touches[0];
          touchStartX = t.clientX;
          touchStartY = t.clientY;
        }, { passive: true });
        scheduleContent.addEventListener('touchend', (event) => {
          if (document.body.classList.contains('modal-open')) return;
          const t = event.changedTouches[0];
          const dx = t.clientX - touchStartX;
          const dy = t.clientY - touchStartY;
          if (Math.abs(dx) < 50 || Math.abs(dx) < Math.abs(dy)) return;
          if (dx < 0) animateWeekChange(currentWeek + 1);
          if (dx > 0) animateWeekChange(currentWeek - 1);
        });
      }

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && document.body.classList.contains('schedule-drawer-open')) {
          setDrawerOpen(false);
          return;
        }
        if (event.key === 'ArrowRight') {
          animateWeekChange(currentWeek + 1);
        }
        if (event.key === 'ArrowLeft') {
          animateWeekChange(currentWeek - 1);
        }
      });

      let scrollTimer = null;
      window.addEventListener('scroll', () => {
        document.body.classList.add('is-scrolling');
        if (scrollTimer) clearTimeout(scrollTimer);
        scrollTimer = setTimeout(() => {
          document.body.classList.remove('is-scrolling');
        }, 140);
      }, { passive: true });

      window.addEventListener('load', () => {
        // --- FORCE REFLOW HACK ---
        // This is a workaround for a stubborn rendering bug where hover effects
        // cause artifacts on other elements. Forcing a reflow after the page
        // loads seems to fix the browser's initial faulty rendering state,
        // similar to how opening a modal fixes it.
        document.body.style.transform = 'translateZ(0)';
        void document.body.offsetHeight;
        document.body.style.transform = '';
        // --- END HACK ---

        const content = document.querySelector('.schedule-content');
        if (!content) return;
        requestAnimationFrame(() => {
          content.classList.add('enter-active');
          content.classList.remove('enter');
        });
      });

      const scheduleTimeZone = 'Europe/Kyiv';

      function getTimeZoneOffsetMinutes(timeZone, date) {
        const dtf = new Intl.DateTimeFormat('en-US', {
          timeZone,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
        });
        const parts = dtf.formatToParts(date);
        const values = {};
        parts.forEach((part) => {
          values[part.type] = part.value;
        });
        const asUTC = Date.UTC(
          Number(values.year),
          Number(values.month) - 1,
          Number(values.day),
          Number(values.hour),
          Number(values.minute),
          Number(values.second)
        );
        return (asUTC - date.getTime()) / 60000;
      }

      function buildLocalTime(dateStr, timeStr, timeZone) {
        if (!dateStr || !timeStr) return null;
        const [y, m, d] = dateStr.split('-').map((n) => Number(n));
        const [hh, mm] = timeStr.split(':').map((n) => Number(n));
        if (!y || !m || !d || Number.isNaN(hh) || Number.isNaN(mm)) return null;
        const naiveUTC = Date.UTC(y, m - 1, d, hh, mm);
        const offsetMin = getTimeZoneOffsetMinutes(timeZone, new Date(naiveUTC));
        return new Date(naiveUTC - offsetMin * 60000);
      }

      function formatLocalRange(dateStr, start, end, timeZone) {
        const startDate = buildLocalTime(dateStr, start, timeZone);
        const endDate = buildLocalTime(dateStr, end, timeZone);
        if (!startDate || !endDate) return null;
        const opts = { hour: '2-digit', minute: '2-digit', hour12: false };
        const startLabel = startDate.toLocaleTimeString(undefined, opts);
        const endLabel = endDate.toLocaleTimeString(undefined, opts);
        return `${startLabel} - ${endLabel}`;
      }

      function applyLocalWeekTimes() {
        const items = document.querySelectorAll('[data-time-base][data-date]');
        items.forEach((btn) => {
          if (btn.dataset.useLocalTime !== '1') return;
          const baseRange = btn.dataset.timeBase || '';
          const dateStr = btn.dataset.date;
          const [start, end] = baseRange.split('-').map((s) => s.trim());
          if (!start || !end || !dateStr) return;
          const localRange = formatLocalRange(dateStr, start, end, scheduleTimeZone);
          if (!localRange) return;
          const label = btn.querySelector('.schedule-time');
          if (label) label.textContent = localRange;
          btn.dataset.time = localRange;
          const detail = btn.dataset.detail || '';
          if (detail) {
            const parts = detail.split('  ');
            if (parts.length >= 4) {
              parts[3] = localRange;
              btn.dataset.detail = parts.join('  ');
            }
          }
        });
      }

      applyLocalWeekTimes();

      const weekGrid = document.getElementById('scheduleWeekGrid');
      const syncDot = document.getElementById('syncDot');
      const syncStatusLabel = document.getElementById('syncStatusLabel');
      const syncStatusMeta = document.getElementById('syncStatusMeta');
      const scheduleCacheKey = `schedule-cache:<%= currentWeek || 1 %>:<%= selectedCourseId || 'all' %>:<%= userId || 'guest' %>:<%= role || 'user' %>`;
      let lastSyncTs = Date.now();

      function initTooltips(root = document) {
        root.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
          if (bootstrap.Tooltip.getInstance(el)) return;
          new bootstrap.Tooltip(el);
        });
      }

      function formatRelativeTime(ts) {
        if (!ts) return '';
        const diff = Math.max(0, Date.now() - ts);
        if (diff < 60000) return '';
        const minutes = Math.round(diff / 60000);
        if (minutes < 60) return `${minutes}  `;
        const hours = Math.round(minutes / 60);
        if (hours < 24) return `${hours}  `;
        const days = Math.round(hours / 24);
        return `${days}  `;
      }

      function updateSyncStatus(state = {}) {
        const online = navigator.onLine;
        const failed = state.failed === true;
        if (syncDot) {
          syncDot.classList.toggle('offline', !online);
        }
        if (syncStatusLabel) {
          syncStatusLabel.textContent = online ? '' : '';
        }
        if (syncStatusMeta) {
          const prefix = failed
            ? '     '
            : online
              ? ' '
              : '   ';
          syncStatusMeta.textContent = `${prefix}${formatRelativeTime(lastSyncTs)}`;
        }
      }

      function readScheduleCache() {
        try {
          const raw = localStorage.getItem(scheduleCacheKey);
          return raw ? JSON.parse(raw) : null;
        } catch (err) {
          return null;
        }
      }

      function writeScheduleCache(html) {
        if (!html) return;
        lastSyncTs = Date.now();
        try {
          localStorage.setItem(scheduleCacheKey, JSON.stringify({ ts: lastSyncTs, html }));
        } catch (err) {
          // ignore storage failures
        }
        updateSyncStatus();
      }

      function updateSmartHighlights() {
        const now = new Date();
        const kyivToday = now.toLocaleDateString('en-CA', { timeZone: scheduleTimeZone });
        document.querySelectorAll('.day-card').forEach((card) => {
          const dayDate = card.dataset.dayDate || '';
          card.classList.toggle('is-today', dayDate && dayDate === kyivToday);
        });
        const entries = [];
        document.querySelectorAll('.schedule-card[data-time-base][data-date]').forEach((btn) => {
          btn.classList.remove('is-now', 'is-next');
          const baseRange = btn.dataset.timeBase || '';
          const dateStr = btn.dataset.date;
          const [start, end] = baseRange.split('-').map((s) => s.trim());
          if (!start || !end || !dateStr) return;
          const startDate = buildLocalTime(dateStr, start, scheduleTimeZone);
          const endDate = buildLocalTime(dateStr, end, scheduleTimeZone);
          if (!startDate || !endDate) return;
          entries.push({ start: startDate.getTime(), end: endDate.getTime(), el: btn });
        });
        if (!entries.length) return;
        entries.sort((a, b) => a.start - b.start);
        const nowMs = now.getTime();
        const current = entries.find((entry) => nowMs >= entry.start && nowMs < entry.end);
        const next = entries.find((entry) => entry.start > nowMs);
        if (current) current.el.classList.add('is-now');
        if (next) next.el.classList.add('is-next');
      }

      function bindScheduleCardInteractions(root = document) {
        root.querySelectorAll('.schedule-card[role="button"]').forEach((card) => {
          if (card.dataset.keyboardBound === '1') return;
          card.dataset.keyboardBound = '1';
          card.addEventListener('keydown', (event) => {
            if (event.key !== 'Enter' && event.key !== ' ') return;
            event.preventDefault();
            card.click();
          });
        });
      }

      function applySubjectTones(root = document) {
        const dayCards = root.querySelectorAll('.day-card');
        dayCards.forEach((dayCard) => {
          const cards = Array.from(dayCard.querySelectorAll('.schedule-card'));
          const groups = new Map();
          cards.forEach((card) => {
            card.style.setProperty('--subject-shift', '0');
            const subjectKey = (card.dataset.subject || card.dataset.class || '').trim().toLowerCase();
            if (!subjectKey) return;
            if (!groups.has(subjectKey)) groups.set(subjectKey, []);
            groups.get(subjectKey).push(card);
          });
          groups.forEach((subjectCards) => {
            const total = subjectCards.length;
            subjectCards.forEach((card, index) => {
              let shift = 0;
              if (total > 1) {
                const progress = total === 1 ? 0 : index / (total - 1);
                shift = Math.round((progress - 0.5) * 6);
              }
              card.style.setProperty('--subject-shift', String(shift));
            });
          });
        });
      }

      function setDensityChip(chip, label, detail, opacity) {
        if (!chip) return;
        chip.textContent = label;
        chip.style.setProperty('--chip-opacity', String(Math.max(0.12, Math.min(0.36, opacity))));
        chip.setAttribute('data-bs-title', detail);
        const tooltip = bootstrap.Tooltip.getInstance(chip);
        if (tooltip) tooltip.dispose();
        new bootstrap.Tooltip(chip);
      }

      function updateDensitySummary(root = document) {
        const dayCards = Array.from(root.querySelectorAll('.day-card'));
        const dayStats = dayCards.map((card) => {
          const dayName = card.querySelector('.day-name') ? card.querySelector('.day-name').textContent.trim() : 'Day';
          const classCards = Array.from(card.querySelectorAll('.schedule-card'));
          const count = classCards.length;
          const eveningCount = classCards.filter((entry) => Number(entry.dataset.classnum || 0) >= 6).length;
          return { dayName, count, eveningCount };
        }).filter((stat) => stat.count > 0);

        if (!dayStats.length) {
          setDensityChip(densityChipBalance, 'Day balance: no classes yet', 'No classes are scheduled for this week.', 0.14);
          setDensityChip(densityChipEvening, 'Evenings feel light this week', 'Evening intensity appears after classes are added.', 0.14);
          setDensityChip(densityChipPeak, 'Most intense day: ', 'Most intense day appears once there are classes.', 0.14);
          return;
        }

        const counts = dayStats.map((stat) => stat.count);
        const totalClasses = counts.reduce((sum, value) => sum + value, 0);
        const average = totalClasses / dayStats.length;
        const maxCount = Math.max(...counts);
        const minCount = Math.min(...counts);
        const spread = maxCount - minCount;
        const eveningClasses = dayStats.reduce((sum, stat) => sum + stat.eveningCount, 0);
        const eveningRatio = totalClasses ? eveningClasses / totalClasses : 0;
        const peak = dayStats.reduce((best, stat) => (stat.count > best.count ? stat : best), dayStats[0]);

        let balanceLabel = 'Day balance: steady rhythm';
        if (spread >= 3) {
          balanceLabel = 'Day balance: uneven rhythm';
        } else if (spread >= 2) {
          balanceLabel = 'Day balance: mixed rhythm';
        }

        let eveningLabel = 'Evenings feel light this week';
        if (eveningRatio >= 0.28) {
          eveningLabel = 'Evenings feel heavy this week';
        } else if (eveningRatio >= 0.14) {
          eveningLabel = 'Evenings feel moderate this week';
        }

        setDensityChip(
          densityChipBalance,
          balanceLabel,
          `Average ${average.toFixed(1)} classes/day. Spread: ${minCount} to ${maxCount}.`,
          0.14 + Math.min(0.18, spread * 0.06)
        );
        setDensityChip(
          densityChipEvening,
          eveningLabel,
          `${eveningClasses} of ${totalClasses} classes are in 6th7th slots.`,
          0.14 + Math.min(0.2, eveningRatio * 0.6)
        );
        setDensityChip(
          densityChipPeak,
          `Most intense day: ${peak.dayName}`,
          `${peak.dayName} has ${peak.count} classes this week.`,
          0.14 + Math.min(0.18, peak.count / Math.max(1, maxCount) * 0.18)
        );
      }

      async function refreshSchedule() {
        if (!weekGrid) return;
        if (document.hidden) return;
        if (document.body.classList.contains('modal-open')) return;
        if (!navigator.onLine) {
          updateSyncStatus();
          return;
        }
        const url = `${window.location.pathname}${window.location.search}${window.location.search ? '&' : '?'}refresh=1&_=${Date.now()}`;
        try {
          const res = await fetch(url, { headers: { 'X-Requested-With': 'schedule-refresh' } });
          if (!res.ok) throw new Error('bad');
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const nextGrid = doc.getElementById('scheduleWeekGrid');
          if (nextGrid) {
            weekGrid.innerHTML = nextGrid.innerHTML;
            applyLocalWeekTimes();
            bindCustomDeadlineCards(weekGrid);
            bindScheduleCardInteractions(weekGrid);
            updateSmartHighlights();
            applySubjectTones(weekGrid);
            updateDensitySummary(weekGrid);
            initTooltips(weekGrid);
            writeScheduleCache(weekGrid.innerHTML);
          }
        } catch (err) {
          updateSyncStatus({ failed: true });
          return;
        }
        updateSyncStatus();
      }

      const cachedSchedule = readScheduleCache();
      if (cachedSchedule && cachedSchedule.ts) {
        lastSyncTs = cachedSchedule.ts;
      }
      if (weekGrid) {
        writeScheduleCache(weekGrid.innerHTML);
      }
      bindScheduleCardInteractions();
      updateSmartHighlights();
      applySubjectTones();
      updateDensitySummary();
      initTooltips();

      setInterval(updateSmartHighlights, 30000);
      setInterval(() => updateSyncStatus(), 60000);
      const scheduleRefreshMinutes = Number(<%= (settings && settings.schedule_refresh_minutes) ? settings.schedule_refresh_minutes : 5 %>);
      const scheduleRefreshMs = Math.max(60000, scheduleRefreshMinutes * 60 * 1000);
      setInterval(refreshSchedule, scheduleRefreshMs);
      window.addEventListener('online', () => refreshSchedule());
      window.addEventListener('offline', () => updateSyncStatus());

      async function loadMessages() {
        if (!messagesList) return;
        messagesList.innerHTML = '<li class="list-group-item text-muted">...</li>';
        try {
          const subjectId = messagesSubjectFilter && messagesSubjectFilter.value
            ? `?subject_id=${encodeURIComponent(messagesSubjectFilter.value)}`
            : '';
          const res = await fetch(`/messages.json${subjectId}`);
          if (!res.ok) throw new Error('bad');
          const data = await res.json();
          if (!data.messages || !data.messages.length) {
            messagesList.innerHTML = '<li class="list-group-item text-muted"> </li>';
            updateUnreadBadges(0);
            return;
          }
          messagesList.innerHTML = data.messages
            .map((m) => {
              const meta = m.target_all
                ? ' '
                : `${m.subject_name || ''}  Group ${m.group_number}`;
              const unreadClass = m.read_id ? '' : 'fw-semibold';
              const reactions = m.reactions || {};
              const reacted = m.reacted || {};
              const makeBtn = (emoji) => {
                const count = reactions[emoji] || 0;
                const active = reacted[emoji] ? 'active' : '';
                return `<button class="btn btn-sm btn-outline-secondary react-btn ${active}" data-message-id="${m.id}" data-emoji="${emoji}">
                  <span>${emoji}</span><span class="react-count">${count}</span>
                </button>`;
              };
              return `
                <li class="list-group-item">
                  <div class="${unreadClass} mb-1">${m.body}</div>
                  <div class="text-muted small">${meta}  ${m.created_by || 'Admin'}  ${new Date(m.created_at).toLocaleString()}</div>
                  <div class="d-flex gap-2 mt-2 msg-reactions">
                    ${makeBtn('')}
                    ${makeBtn('')}
                  </div>
                </li>
              `;
            })
            .join('');
          updateUnreadBadges(data.unread_count || 0);
          const unreadIds = data.messages.filter((m) => !m.read_id).map((m) => m.id);
          if (unreadIds.length) {
            const nextUnread = Math.max(0, (data.unread_count || 0) - unreadIds.length);
            fetch('/messages/read', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message_ids: unreadIds }),
            })
              .then(() => updateUnreadBadges(nextUnread))
              .catch(() => {});
          }
          const reactionButtons = messagesList.querySelectorAll('.msg-reactions .react-btn');
          reactionButtons.forEach((btn) => {
            btn.addEventListener('click', async () => {
              const messageId = Number(btn.dataset.messageId);
              const emoji = btn.dataset.emoji;
              if (Number.isNaN(messageId) || !emoji) return;
              try {
                const res = await fetch('/messages/react', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ message_id: messageId, emoji }),
                });
                if (!res.ok) return;
                const data = await res.json();
                const container = btn.closest('.msg-reactions');
                if (!container) return;
                updateReactionButtons(container, data.reactions, data.reacted);
              } catch (err) {
                console.error(err);
              }
            });
          });
        } catch (err) {
          messagesList.innerHTML = '<li class="list-group-item text-muted"> </li>';
        }
      }

      if (messagesBtn) {
        messagesBtn.addEventListener('click', () => {
          setDrawerOpen(false);
          const modal = new bootstrap.Modal(document.getElementById('messagesModal'));
          modal.show();
          loadMessages();
        });
      }
      if (messagesSubjectFilter) {
        messagesSubjectFilter.addEventListener('change', loadMessages);
      }

      loadMessages();

      const phrases = [
        "Start fresh  today is full of potential.",
        "Small steps, big progress.",
        "Focus on now  the rest will follow.",
        "One thing at a time  and thats enough.",
        "Youve got more in you than you think.",
        "Let clarity lead your day.",
        "Stay present, stay steady.",
        "Keep going  youre getting closer.",
        "Be kind to your focus.",
        "Today is a great day to grow.",
        "Balance over burnout.",
        "Show up  even a little is progress.",
        "A clear mind gets more done.",
        "You set the tone  begin with calm.",
        "Progress, not perfection.",
        "Let effort be your win today.",
        "This hour matters  make it count.",
        "Energy follows attention.",
        "Youre building momentum.",
        "Stay grounded, keep moving.",
        "Let your actions match your goals.",
        "Your best today is enough.",
        "Choose one goal, and give it space.",
        "Rest is part of the rhythm.",
        "Trust your pace  fast or slow.",
        "You dont need to rush to be great.",
        "Small focus. Big ripple.",
        "The day is yours  use it gently.",
        "Notice what fuels you today.",
        "Begin again  always welcome."
      ];

      function getKyivDayOfYear() {
        const now = new Date();
        const dateString = now.toLocaleDateString('en-CA', { timeZone: 'Europe/Kyiv' });
        const [year, month, day] = dateString.split('-').map(Number);
        const start = Date.UTC(year, 0, 1);
        const current = Date.UTC(year, month - 1, day);
        return Math.floor((current - start) / 86400000);
      }

      function updateDailyPhrase() {
        const el = document.getElementById('daily-phrase');
        if (!el) return;
        const dayOfYear = getKyivDayOfYear();
        const phrase = phrases[dayOfYear % phrases.length];
        if (el.textContent === phrase) return;
        el.classList.add('fade-out');
        setTimeout(() => {
          el.textContent = phrase;
          el.classList.remove('fade-out');
        }, 240);
      }

      function scheduleNextMidnight() {
        const now = new Date();
        const kyivNow = new Date(
          now.toLocaleString('en-US', { timeZone: 'Europe/Kyiv' })
        );
        const nextMidnight = new Date(kyivNow);
        nextMidnight.setHours(24, 0, 0, 0);
        const ms = nextMidnight.getTime() - kyivNow.getTime();
        setTimeout(() => {
          updateDailyPhrase();
          scheduleNextMidnight();
        }, ms + 500);
      }

      updateDailyPhrase();
      scheduleNextMidnight();

      const themeToggles = document.querySelectorAll('.theme-toggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      themeToggles.forEach((btn) => {
        btn.textContent = storedTheme === 'theme-dark' ? btn.dataset.lightLabel : btn.dataset.darkLabel;
        btn.addEventListener('click', () => {
          const isDark = document.body.classList.contains('theme-dark');
          const next = isDark ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-dark', 'theme-light');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggles.forEach((b) => {
            b.textContent = next === 'theme-dark' ? b.dataset.lightLabel : b.dataset.darkLabel;
          });
        });
      });

      document.querySelectorAll('.file-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.fileTarget;
          const input = target ? document.getElementById(target) : null;
          if (input) input.click();
        });
      });
      document.querySelectorAll('.file-input').forEach((input) => {
        input.addEventListener('change', () => {
          const label = document.querySelector(`[data-file-name="${input.id}"]`);
          if (!label) return;
          const name = input.files && input.files.length ? input.files[0].name : '  ';
          label.textContent = name;
        });
      });

      window.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        const openModal = document.querySelector('.modal.show');
        if (!openModal) return;
        const instance = bootstrap.Modal.getInstance(openModal);
        if (instance) instance.hide();
      });
    </script>
  </body>
</html>
