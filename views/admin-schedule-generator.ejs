<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–∫–ª–∞–¥—É</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/admin.css" />
    <link rel="stylesheet" href="/css/pages/admin-schedule-generator.css" />
  </head>
  <body class="theme-light schedule-generator-page">
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <span class="navbar-brand">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–∫–ª–∞–¥—É</span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted"><%= t('role.admin') %>: <%= username %></span>
          <button
            class="theme-toggle theme-toggle-min me-2"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="‚òÄÔ∏è"
            data-dark-label="üåô"
          >
            üåô
          </button>
          <a class="btn btn-outline-primary btn-sm me-2" href="/admin">–ù–∞–∑–∞–¥ –≤ –∞–¥–º—ñ–Ω–∫—É</a>
          <form method="POST" action="/admin/schedule-generator/new" class="me-2">
            <button class="btn btn-outline-secondary btn-sm" type="submit">–ù–æ–≤–∏–π –¥—Ä–∞—Ñ—Ç</button>
          </form>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <% if (messages && messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>

      <% const disableRunKyiv = validationByLocation && validationByLocation.kyiv ? validationByLocation.kyiv.hasCritical : false; %>
      <% const disableRunMunich = validationByLocation && validationByLocation.munich ? validationByLocation.munich.hasCritical : false; %>

      <div class="generator-hero glass mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
          <div>
            <h1 class="h3 mb-2">–°–µ–º–µ—Å—Ç—Ä–æ–≤–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
            <div class="text-muted">
              –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –ø–æ –∫–∏—ó–≤—Å—å–∫–∏—Ö –∫—É—Ä—Å–∞—Ö: —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ —Å–ª–æ—Ç–∏, –¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ —Ç–∏–∂–Ω—ñ, –æ–±–º–µ–∂–µ–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤.
            </div>
          </div>
          <div class="generator-status">
            <span class="generator-chip">Run #<%= run.id %></span>
            <span class="badge bg-<%= run.status === 'published' ? 'success' : 'secondary' %>">
              <%= run.status === 'published' ? '–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–µ—Ç–∫–∞' %>
            </span>
          </div>
        </div>
        <div class="generator-actions mt-3">
          <form method="POST" action="/admin/schedule-generator/run">
            <input type="hidden" name="run_id" value="<%= run.id %>" />
            <input type="hidden" name="active_location" id="runLocationInput" value="<%= activeLocation %>" />
            <button
              class="btn btn-primary"
              type="submit"
              id="generatePreviewBtn"
              data-disable-kyiv="<%= disableRunKyiv ? 'true' : 'false' %>"
              data-disable-munich="<%= disableRunMunich ? 'true' : 'false' %>"
              <%= (activeLocation === 'kyiv' ? disableRunKyiv : disableRunMunich) ? 'disabled' : '' %>
            >
              –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä–µ–≤ º—é
            </button>
          </form>
          <% const activeCourseList = (courseSemestersByLocation && courseSemestersByLocation[activeLocation]) || []; %>
          <% const firstCourseId = activeCourseList.length ? activeCourseList[0].course.id : null; %>
          <% if (firstCourseId) { %>
            <a class="btn btn-outline-primary" href="/admin/schedule-generator/<%= run.id %>/preview?course=<%= firstCourseId %>&week=1">–í—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–µ–≤ º—é</a>
          <% } %>
        </div>
        <div class="generator-actions mt-2">
          <% ['kyiv', 'munich'].forEach(function(location) { %>
            <% const locationCourses = (courseSemestersByLocation && courseSemestersByLocation[location]) || []; %>
            <% if (locationCourses.length) { %>
              <form method="POST" action="/admin/schedule-generator/run" class="d-flex flex-wrap align-items-center gap-2" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                <input type="hidden" name="run_id" value="<%= run.id %>" />
                <input type="hidden" name="active_location" value="<%= location %>" />
                <input type="hidden" name="scope" value="course" />
                <select name="course_id" class="form-select form-select-sm w-auto">
                  <% locationCourses.forEach(function(row) { %>
                    <option value="<%= row.course.id %>"><%= row.course.name %></option>
                  <% }); %>
                </select>
                <button
                  class="btn btn-outline-primary btn-sm"
                  type="submit"
                  data-disable-kyiv="<%= disableRunKyiv ? 'true' : 'false' %>"
                  data-disable-munich="<%= disableRunMunich ? 'true' : 'false' %>"
                  <%= (location === 'kyiv' ? disableRunKyiv : disableRunMunich) ? 'disabled' : '' %>
                >
                  –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫—É—Ä—Å
                </button>
              </form>
            <% } %>
          <% }); %>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-12 col-xl-4">
          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="generator-section-title">–ö—É—Ä—Å–∏</div>
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary location-toggle <%= activeLocation === 'kyiv' ? 'active' : '' %>" type="button" data-location="kyiv">Kyiv</button>
                  <button class="btn btn-outline-primary location-toggle <%= activeLocation === 'munich' ? 'active' : '' %>" type="button" data-location="munich">Munich</button>
                </div>
              </div>
              <% ['kyiv', 'munich'].forEach(function(location) { %>
                <% const courseList = courseSemestersByLocation[location] || []; %>
                <div class="d-grid gap-2" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                  <% if (courseList.length) { %>
                    <% courseList.forEach(function(row) { %>
                      <div class="glass-inset p-3">
                        <div class="fw-semibold"><%= row.course.name %></div>
                        <div class="small text-muted">
                          <%= row.semester ? row.semester.title : '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–º–µ—Å—Ç—Ä—É' %>
                          <% if (row.semester) { %> ¬∑ <%= row.semester.weeks_count %> —Ç–∏–∂–Ω—ñ–≤ <% } %>
                        </div>
                        <div class="small text-muted">
                          –ê–∫—Ç–∏–≤–Ω—ñ –¥–Ω—ñ: <%= (courseDaysByLocation[location][row.course.id] || []).join(', ') %>
                        </div>
                      </div>
                    <% }); %>
                  <% } else { %>
                    <div class="generator-empty">–ù–µ–º–∞—î –∫—É—Ä—Å—ñ–≤ –¥–ª—è <%= location === 'kyiv' ? 'Kyiv' : 'Munich' %>.</div>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</div>
              <form method="POST" action="/admin/schedule-generator/config" class="row g-3">
                <input type="hidden" name="run_id" value="<%= run.id %>" />
                <input type="hidden" name="active_location" id="activeLocationInput" value="<%= activeLocation %>" />
                <div class="col-12">
                  <label class="form-label">–†–æ–∑–ø–æ–¥—ñ–ª –ø–∞—Ä</label>
                  <select class="form-select" name="distribution">
                    <option value="start" <%= config.distribution === 'start' ? 'selected' : '' %>>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É</option>
                    <option value="even" <%= config.distribution === 'even' ? 'selected' : '' %>>–†—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ</option>
                    <option value="end" <%= config.distribution === 'end' ? 'selected' : '' %>>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –≤ –∫—ñ–Ω—Ü—ñ</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">–°–µ–º—ñ–Ω–∞—Ä–∏</label>
                  <select class="form-select" name="seminar_distribution">
                    <option value="start" <%= config.seminar_distribution === 'start' ? 'selected' : '' %>>–ù–∞ –ø–æ—á–∞—Ç–∫—É</option>
                    <option value="even" <%= config.seminar_distribution === 'even' ? 'selected' : '' %>>–†—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ</option>
                    <option value="end" <%= config.seminar_distribution === 'end' ? 'selected' : '' %>>–í –∫—ñ–Ω—Ü—ñ</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Max –ø–∞—Ä/–¥–µ–Ω—å</label>
                  <input class="form-control" type="number" name="max_daily_pairs" min="1" max="7" value="<%= config.max_daily_pairs || 7 %>" />
                </div>
                <div class="col-6">
                  <label class="form-label">–¶—ñ–ª—å –ø–∞—Ä/–¥–µ–Ω—å</label>
                  <input class="form-control" type="number" name="target_daily_pairs" min="1" max="7" value="<%= config.target_daily_pairs || 4 %>" />
                </div>
                <div class="col-12">
                  <% const evennessValue = Number.isFinite(Number(config.evenness_bias)) ? Number(config.evenness_bias) : 50; %>
                  <label class="form-label d-flex justify-content-between align-items-center">
                    <span>–ë–∞–ª–∞–Ω—Å —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ—Å—Ç—ñ</span>
                    <span class="badge bg-secondary" id="evennessBiasValue"><%= evennessValue %>%</span>
                  </label>
                  <input
                    class="form-range"
                    type="range"
                    name="evenness_bias"
                    id="evennessBiasRange"
                    min="0"
                    max="100"
                    value="<%= evennessValue %>"
                  />
                  <div class="small text-muted">0 ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ñ—à–µ, 100 ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ.</div>
                </div>
                <div class="col-12">
                  <% const lateSlotValue = Number.isFinite(Number(config.late_slot_weight)) ? Number(config.late_slot_weight) : 60; %>
                  <label class="form-label d-flex justify-content-between align-items-center">
                    <span>–£–Ω–∏–∫–∞—Ç–∏ –≤–µ—á—ñ—Ä–Ω—ñ—Ö —Å–ª–æ—Ç—ñ–≤</span>
                    <span class="badge bg-secondary" id="lateSlotWeightValue"><%= lateSlotValue %>%</span>
                  </label>
                  <input
                    class="form-range"
                    type="range"
                    name="late_slot_weight"
                    id="lateSlotWeightRange"
                    min="0"
                    max="100"
                    value="<%= lateSlotValue %>"
                  />
                  <div class="small text-muted">0 ‚Äî –Ω–µ –≤—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏, 100 ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–Ω–∏–∫–∞—Ç–∏ 5‚Äì7 –ø–∞—Ä.</div>
                </div>
                <div class="col-12">
                  <label class="form-label">–û—Å–æ–±–ª–∏–≤—ñ —Ç–∏–∂–Ω—ñ (1-3,8)</label>
                  <input class="form-control" name="blocked_weeks" value="<%= config.blocked_weeks || '' %>" placeholder="1-2,6,9" />
                </div>
                <div class="col-12">
                  <label class="form-label">–†–µ–∂–∏–º –æ—Å–æ–±–ª–∏–≤–∏—Ö —Ç–∏–∂–Ω—ñ–≤</label>
                  <select class="form-select" name="special_weeks_mode">
                    <option value="block" <%= config.special_weeks_mode !== 'overlay' ? 'selected' : '' %>>–ë–ª–æ–∫—É–≤–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</option>
                    <option value="overlay" <%= config.special_weeks_mode === 'overlay' ? 'selected' : '' %>>–ù–∞–∫–ª–∞–¥–∞—Ç–∏ –ø–æ–≤–µ—Ä—Ö</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">–°–µ–º–µ—Å—Ç—Ä–∏ –∫—É—Ä—Å—ñ–≤</label>
                  <% ['kyiv', 'munich'].forEach(function(location) { %>
                    <div class="d-grid gap-2" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                      <% (courseSemestersByLocation[location] || []).forEach(function(row) { %>
                        <% const semList = semestersByCourse[row.course.id] || []; %>
                        <% const selectedSemId = (selectedSemestersByLocation[location] && selectedSemestersByLocation[location][row.course.id]) || (row.semester ? row.semester.id : null); %>
                        <div class="glass-inset p-3">
                          <div class="fw-semibold"><%= row.course.name %></div>
                          <select class="form-select form-select-sm mt-2" name="course_semesters[<%= row.course.id %>]">
                            <% semList.forEach(function(sem) { %>
                              <option value="<%= sem.id %>" <%= Number(sem.id) === Number(selectedSemId) ? 'selected' : '' %>>
                                <%= sem.title %> ¬∑ <%= sem.weeks_count %> —Ç–∏–∂–Ω—ñ–≤
                              </option>
                            <% }); %>
                          </select>
                        </div>
                      <% }); %>
                    </div>
                  <% }); %>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="auto_subject_days" id="autoSubjectDays" <%= config.auto_subject_days ? 'checked' : '' %> />
                    <label class="form-check-label" for="autoSubjectDays">–ê–≤—Ç–æ-—Ä–æ–∑–∫–ª–∞–¥ –¥–Ω—ñ–≤ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</label>
                  </div>
                  <div class="small text-muted">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ñ–ø–ª—é—î–º–æ –ø—Ä–µ–¥–º–µ—Ç –∑–∞ –æ–¥–Ω–∏–º –¥–Ω–µ–º, —â–æ–± –ø–∞—Ä–∏ –Ω–µ —Ä–æ–∑–ø–æ–≤–∑–∞–ª–∏—Å—å.</div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="subject_single_day" id="subjectSingleDay" <%= config.subject_single_day !== false ? 'checked' : '' %> />
                    <label class="form-check-label" for="subjectSingleDay">–û–¥–∏–Ω –¥–µ–Ω—å –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç (–æ–∫—Ä—ñ–º —Ä—ñ–∑–Ω–∏—Ö –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤)</label>
                  </div>
                  <div class="small text-muted">–î–ª—è –º–æ–≤ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –≤–∏–∫–ª–∞–¥–∞—á–∞–º–∏ –¥–æ–∑–≤–æ–ª—è—î–º–æ —Ä–æ–∑–±–∏—Ç—Ç—è –Ω–∞ –∫—ñ–ª—å–∫–∞ –¥–Ω—ñ–≤.</div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="lecture_seminar_same_day" id="lectureSeminarSameDay" <%= config.lecture_seminar_same_day !== false ? 'checked' : '' %> />
                    <label class="form-check-label" for="lectureSeminarSameDay">–õ–µ–∫—Ü—ñ—è + —Å–µ–º—ñ–Ω–∞—Ä –≤ –æ–¥–∏–Ω –¥–µ–Ω—å</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="prefer_compactness" id="preferCompactness" <%= config.prefer_compactness ? 'checked' : '' %> />
                    <label class="form-check-label" for="preferCompactness">–ú–µ–Ω—à–µ –≤—ñ–∫–æ–Ω –º—ñ–∂ –ø–∞—Ä–∞–º–∏</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="mirror_groups" id="mirrorGroups" <%= config.mirror_groups ? 'checked' : '' %> />
                    <label class="form-check-label" for="mirrorGroups">–®–≤–∏–¥–∫–µ –¥–∑–µ—Ä–∫–∞–ª–æ –≥—Ä—É–ø (A/B)</label>
                  </div>
                  <div class="small text-muted">–ü–∞—Ä–Ω–æ –∑ º—î–¥–Ω—É—î–º–æ –≥—Ä—É–ø–∏ 1/2 –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º –∫–ª—é—á–µ–º –¥–∑–µ—Ä–∫–∞–ª–∞ —Ç–∞ —á–µ—Ä–≥—É—î–º–æ –ø–æ —Ç–∏–∂–Ω—è—Ö.</div>
                </div>
                <div class="col-12 d-grid">
                  <button class="btn btn-outline-primary" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º</div>
              <% ['kyiv', 'munich'].forEach(function(location) { %>
                <% const validation = validationByLocation && validationByLocation[location]; %>
                <div data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                  <% if (!validation || !validation.issues.length) { %>
                    <div class="validation-empty">–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó.</div>
                  <% } else { %>
                    <div class="validation-summary mb-2">
                      <span class="validation-chip <%= validation.hasCritical ? 'is-error' : 'is-warn' %>">
                        <%= validation.hasCritical ? '–ö—Ä–∏—Ç–∏—á–Ω–æ' : '–£–≤–∞–≥–∞' %>
                      </span>
                      <span class="small text-muted"><%= validation.issues.length %> –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫</span>
                    </div>
                    <div class="d-grid gap-2">
                      <% validation.issues.slice(0, 6).forEach(function(issue) { %>
                        <div class="validation-issue <%= issue.level === 'error' ? 'is-error' : 'is-warn' %>">
                          <span class="validation-dot"></span>
                          <div>
                            <div class="small fw-semibold"><%= issue.message %></div>
                            <div class="small text-muted"><%= issue.level === 'error' ? '–ë–ª–æ–∫—É—î –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é' : '–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è' %></div>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                    <% if (validation.issues.length > 6) { %>
                      <div class="small text-muted mt-2">–©–µ <%= validation.issues.length - 6 %> –ø—É–Ω–∫—Ç—ñ–≤.</div>
                    <% } %>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">Dry-run –∑–ª–∏—Ç—Ç—è –ø—Ä–µ–¥–º–µ—Ç—ñ–≤</div>
              <div class="small text-muted mb-3">
                –ü–æ–∫–∞–∑—É—î, —è–∫—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ –±—É–¥—É—Ç—å –∑–ª–∏—Ç—ñ –ø–µ—Ä–µ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—î—é. –î–∞–Ω—ñ –ª–∏—à–µ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É ‚Äî –±–∞–∑—É –Ω–µ –∑–º—ñ–Ω—é—î.
              </div>
              <div class="d-flex flex-wrap align-items-center gap-2">
                <select class="form-select form-select-sm w-auto" id="mergePreviewCourse">
                  <option value="">–£—Å—ñ –∫—É—Ä—Å–∏</option>
                  <% ['kyiv', 'munich'].forEach(function(location) { %>
                    <% const courseList = courseSemestersByLocation[location] || []; %>
                    <% courseList.forEach(function(row) { %>
                      <option value="<%= row.course.id %>" data-location="<%= location %>"><%= row.course.name %></option>
                    <% }); %>
                  <% }); %>
                </select>
                <button class="btn btn-outline-primary btn-sm" type="button" id="mergePreviewBtn">–ü–æ–∫–∞–∑–∞—Ç–∏ dry-run</button>
              </div>
              <div id="mergePreviewMeta" class="small text-muted mt-2"></div>
              <div id="mergePreviewList" class="merge-preview-list mt-3 d-grid gap-2"></div>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–û—Å—Ç–∞–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è</div>
              <% if (lastStats) { %>
                <div class="d-grid gap-2 mb-3">
                  <div class="glass-inset p-3">
                    <div class="small text-muted">–ó–∞–ø–∏—Å—ñ–≤</div>
                    <div class="fw-semibold"><%= lastStats.entries %> –ø–∞—Ä</div>
                  </div>
                  <div class="glass-inset p-3">
                    <div class="small text-muted">–ö–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤</div>
                    <div class="fw-semibold"><%= lastStats.conflicts %></div>
                  </div>
                  <div class="small text-muted">–û–Ω–æ–≤–ª–µ–Ω–æ: <%= lastStats.generated_at ? new Date(lastStats.generated_at).toLocaleString('uk-UA') : '' %></div>
                  <% if (lastStats.scope) { %>
                    <div class="small text-muted">
                      <% if (lastStats.scope.type === 'course') { %>
                        –ö—É—Ä—Å: <%= courseById[lastStats.scope.course_id] || '–ù–µ–≤—ñ–¥–æ–º–∏–π' %>
                      <% } else { %>
                        –õ–æ–∫–∞—Ü—ñ—è: <%= lastStats.scope.location === 'munich' ? 'Munich' : 'Kyiv' %>
                      <% } %>
                    </div>
                  <% } %>
                </div>
              <% } else { %>
                <div class="generator-empty mb-3">–©–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é.</div>
              <% } %>
              <% if (lastConflicts && lastConflicts.length) { %>
                <div class="small text-muted mb-2">–ü—Ä–æ–±–ª–µ–º–∏:</div>
                <div class="d-grid gap-2">
                  <% lastConflicts.slice(0, 5).forEach(function(conflict) { %>
                    <div class="glass-inset p-2">
                      <div class="fw-semibold"><%= conflict.subject || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞' %></div>
                      <div class="small text-muted"><%= conflict.reason %></div>
                    </div>
                  <% }); %>
                </div>
              <% } %>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–©—ñ–ª—å–Ω—ñ—Å—Ç—å —Ä–æ–∑–∫–ª–∞–¥—É</div>
              <% ['kyiv', 'munich'].forEach(function(location) { %>
                <% const heatmap = heatmapByLocation && heatmapByLocation[location]; %>
                <div class="heatmap" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                  <% if (!heatmap || !heatmap.max) { %>
                    <div class="generator-empty">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è —Ç–µ–ø–ª–æ–≤–æ—ó –∫–∞—Ä—Ç–∏.</div>
                  <% } else { %>
                    <div class="heatmap-grid">
                      <div class="heatmap-row heatmap-head">
                        <span class="heatmap-label"></span>
                        <% classOptions.forEach(function(slot) { %>
                          <span class="heatmap-head-cell"><%= slot %></span>
                        <% }); %>
                      </div>
                      <% dayOptions.forEach(function(day) { %>
                        <div class="heatmap-row">
                          <span class="heatmap-label"><%= dayLabels[dayOptions.indexOf(day)] || day.slice(0, 2) %></span>
                          <% classOptions.forEach(function(slot) { %>
                            <% const count = heatmap.counts && heatmap.counts[day] ? heatmap.counts[day][slot] : 0; %>
                            <% const intensity = heatmap.max ? (count / heatmap.max) : 0; %>
                            <span
                              class="heatmap-cell"
                              style="--heat:<%= intensity.toFixed(2) %>;"
                              title="<%= day %>, –ø–∞—Ä–∞ <%= slot %>: <%= count %> –∑–∞–ø–∏—Å—ñ–≤"
                            >
                              <%= count ? count : '' %>
                            </span>
                          <% }); %>
                        </div>
                      <% }); %>
                    </div>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="card glass-panel">
            <div class="card-body">
              <div class="generator-section-title mb-2">–í–∏–∫–ª–∞–¥–∞—á—ñ</div>
              <% if (teachers && teachers.length) { %>
                <div class="d-grid gap-3">
                  <% teachers.forEach(function(teacher) { %>
                    <% const limit = limitsByTeacher[teacher.id] || {}; %>
                    <form method="POST" action="/admin/schedule-generator/teachers/save" class="glass-inset p-3">
                      <input type="hidden" name="run_id" value="<%= run.id %>" />
                      <input type="hidden" name="teacher_id" value="<%= teacher.id %>" />
                      <div class="fw-semibold mb-2"><%= teacher.full_name %></div>
                      <div class="teacher-days mb-2">
                        <% dayOptions.forEach(function(day, idx) { %>
                          <% const label = dayLabels[idx] || day.slice(0, 2); %>
                          <label class="teacher-day-pill">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              name="allowed_days"
                              value="<%= day %>"
                              <%= (limit.allowed_weekdays || []).includes(day) ? 'checked' : '' %>
                            />
                            <span><%= label %></span>
                          </label>
                        <% }); %>
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <div class="flex-grow-1">
                          <label class="form-label small">Max –ø–∞—Ä/—Ç–∏–∂–¥–µ–Ω—å</label>
                          <input
                            class="form-control form-control-sm"
                            type="number"
                            name="max_pairs_per_week"
                            min="1"
                            placeholder="–ë–µ–∑ –ª—ñ–º—ñ—Ç—É"
                            value="<%= limit.max_pairs_per_week || '' %>"
                          />
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                      </div>
                    </form>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="generator-empty">–ù–µ–º–∞—î –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤.</div>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-12 col-xl-8">
          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</div>
              <form method="POST" action="/admin/schedule-generator/items/add" class="row g-3">
                <input type="hidden" name="run_id" value="<%= run.id %>" />
                <div class="col-12 col-md-4">
                  <label class="form-label">–ö—É—Ä—Å</label>
                  <select class="form-select" name="course_id" id="genCourseSelect" required>
                    <% Object.values(coursesByLocation).flat().forEach(function(course) { %>
                      <option value="<%= course.id %>" data-location="<%= course.location || 'kyiv' %>"><%= course.name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                  <select class="form-select" name="subject_id" id="genSubjectSelect" required>
                    <% Object.values(coursesByLocation).flat().forEach(function(course) { %>
                      <optgroup label="<%= course.name %>" data-location="<%= course.location || 'kyiv' %>">
                        <% (subjectsByCourse[course.id] || []).forEach(function(subject) { %>
                          <option value="<%= subject.id %>" data-course="<%= course.id %>" data-group-count="<%= subject.group_count %>">
                            <%= subject.name %>
                          </option>
                        <% }); %>
                      </optgroup>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                  <select class="form-select" name="lesson_type">
                    <option value="lecture">–õ–µ–∫—Ü—ñ—è</option>
                    <option value="seminar">–°–µ–º—ñ–Ω–∞—Ä</option>
                    <option value="lab">–õ–∞–±</option>
                    <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–ì—Ä—É–ø–∞</label>
                  <select class="form-select" name="group_number" id="genGroupSelect">
                    <option value="all">–£—Å—ñ –≥—Ä—É–ø–∏</option>
                    <option value="1" data-group="1">1</option>
                    <option value="2" data-group="2">2</option>
                    <option value="3" data-group="3">3</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–ö-—Å—Ç—å –ø–∞—Ä</label>
                  <input class="form-control" type="number" name="pairs_count" min="1" value="1" required />
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                  <select class="form-select" name="teacher_id">
                    <option value="">–ë–µ–∑ –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                    <% teachers.forEach(function(teacher) { %>
                      <option value="<%= teacher.id %>"><%= teacher.full_name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">–ö–ª—é—á –¥–∑–µ—Ä–∫–∞–ª–∞</label>
                  <input class="form-control" name="mirror_key" id="mirrorKeyInput" placeholder="A1" />
                  <div class="mirror-key-actions mt-2">
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="mirrorKeyGenerate">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="mirrorKeyCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                  </div>
                  <div class="form-text text-muted">–û–¥–Ω–∞–∫–æ–≤–∏–π –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø 1/2.</div>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">–¢–∏–∂–Ω—ñ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label>
                  <input class="form-control" name="weeks_set" placeholder="1-2,5,7" />
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">–§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –¥–µ–Ω—å</label>
                  <select class="form-select" name="fixed_day">
                    <option value="">–ë—É–¥—å-—è–∫–∏–π</option>
                    <% dayOptions.forEach(function(day) { %>
                      <option value="<%= day %>"><%= day %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">–§—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å–ª–æ—Ç</label>
                  <select class="form-select" name="fixed_class_number">
                    <option value="">–ë—É–¥—å-—è–∫–∏–π</option>
                    <% classOptions.forEach(function(n) { %>
                      <option value="<%= n %>"><%= n %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-grid">
                  <button class="btn btn-primary" type="submit">–î–æ–¥–∞—Ç–∏ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="generator-section-title">–î–∑–µ—Ä–∫–∞–ª—å–Ω—ñ –∫–ª—é—á—ñ</div>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#mirrorAutoModal">
                  –ê–≤—Ç–æ-–ø–∞—Ä–∏ A/B
                </button>
              </div>
              <% ['kyiv', 'munich'].forEach(function(location) { %>
                <% const mirrorSummary = mirrorSummaryByLocation && mirrorSummaryByLocation[location]; %>
                <div class="d-grid gap-2" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                  <% if (!mirrorSummary || !mirrorSummary.length) { %>
                    <div class="generator-empty">–ù–µ–º–∞—î –¥–∑–µ—Ä–∫–∞–ª—å–Ω–∏—Ö –∫–ª—é—á—ñ–≤.</div>
                  <% } else { %>
                    <% mirrorSummary.forEach(function(group) { %>
                      <div class="glass-inset p-3 mirror-row <%= group.status === 'ok' ? '' : 'mirror-warn' %>">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="fw-semibold"><%= group.key %></div>
                          <span class="badge <%= group.status === 'ok' ? 'bg-success' : group.status === 'warn' ? 'bg-warning text-dark' : 'bg-secondary' %>">
                            <%= group.status === 'ok' ? 'OK' : group.status === 'warn' ? '–ù–µ—Ä—ñ–≤–Ω–æ' : '–ù–µ–º–∞—î –ø–∞—Ä–∏' %>
                          </span>
                        </div>
                        <div class="small text-muted">
                          –ì—Ä—É–ø–∞ 1: <%= group.group1 %> ¬∑ –ì—Ä—É–ø–∞ 2: <%= group.group2 %>
                        </div>
                        <% if (group.subjects && group.subjects.length) { %>
                          <div class="small text-muted">–ü—Ä–µ–¥–º–µ—Ç–∏: <%= group.subjects.join(', ') %></div>
                        <% } %>
                        <% if (group.courses && group.courses.length) { %>
                          <div class="small text-muted">–ö—É—Ä—Å–∏: <%= group.courses.join(', ') %></div>
                        <% } %>
                      </div>
                    <% }); %>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø—ñ—Å–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</div>
              <% const conflictLabels = { missing_course_context: '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–º–µ—Å—Ç—Ä—É', missing_weeks_count: '–ù–µ –∑–∞–¥–∞–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∏–∂–Ω—ñ–≤', no_available_weeks: '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–∏–∂–Ω—ñ–≤', no_allowed_days: '–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –¥–Ω—ñ–≤', no_slot_found: '–ù–µ–º–∞—î —Å–ª–æ—Ç–∞', partial_schedule: '–ß–∞—Å—Ç–∫–æ–≤–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è', subject_day_mismatch: '–ü—Ä–µ–¥–º–µ—Ç –º–∞—î —Ä—ñ–∑–Ω—ñ –¥–Ω—ñ', unknown: '–ù–µ–≤—ñ–¥–æ–º–∞ –ø—Ä–∏—á–∏–Ω–∞' }; %>
              <% ['kyiv', 'munich'].forEach(function(location) { %>
                <% const conflicts = conflictDetails && conflictDetails[location]; %>
                <div class="d-grid gap-2" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                  <% if (!conflicts || !conflicts.length) { %>
                    <div class="generator-empty">–ö–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –Ω–µ–º–∞—î.</div>
                  <% } else { %>
                    <% conflicts.slice(0, 6).forEach(function(conflict) { %>
                      <div class="glass-inset p-3 conflict-row">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <div class="fw-semibold"><%= conflict.subject || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞' %></div>
                          <span class="badge bg-danger">–ü—Ä–æ–±–ª–µ–º–∞</span>
                        </div>
                        <div class="small text-muted">
                          <%= conflictLabels[conflict.reason] || conflict.reason || conflictLabels.unknown %>
                          <% if (conflict.scheduled) { %> ¬∑ <%= conflict.scheduled %><% } %>
                          <% if (conflict.target) { %> / <%= conflict.target %><% } %>
                        </div>
                        <% if (conflict.items && conflict.items.length) { %>
                          <div class="small text-muted mt-1">
                            <% conflict.items.forEach(function(item, idx) { %>
                              <span><%= item.course %> ¬∑ <%= item.group %> ¬∑ <%= item.teacher || '–ë–µ–∑ –≤–∏–∫–ª–∞–¥–∞—á–∞' %></span><%= idx < conflict.items.length - 1 ? ' ¬∑ ' : '' %>
                            <% }); %>
                          </div>
                        <% } %>
                      </div>
                    <% }); %>
                    <% if (conflicts.length > 6) { %>
                      <div class="small text-muted">–©–µ <%= conflicts.length - 6 %> –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤.</div>
                    <% } %>
                  <% } %>
                </div>
              <% }); %>
            </div>
          </div>

          <div class="card glass-panel">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="generator-section-title">–ü–ª–∞–Ω –∑–∞–Ω—è—Ç—å</div>
                <% ['kyiv', 'munich'].forEach(function(location) { %>
                  <% const problemCount = problemItemLookupByLocation && problemItemLookupByLocation[location] ? Object.keys(problemItemLookupByLocation[location]).length : 0; %>
                  <div class="form-check form-switch m-0 problem-toggle" data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                    <input class="form-check-input" type="checkbox" id="problemToggle-<%= location %>" <%= problemCount ? '' : 'disabled' %> />
                    <label class="form-check-label small" for="problemToggle-<%= location %>">
                      –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ñ (<%= problemCount %>)
                    </label>
                  </div>
                <% }); %>
              </div>
              <% if (items && items.length) { %>
                <div class="table-responsive">
                  <table class="table generator-table align-middle">
                    <thead>
                      <tr>
                        <th>–ö—É—Ä—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–¢–∏–ø</th>
                        <th>–ì—Ä—É–ø–∞</th>
                        <th>–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th>–ü–∞—Ä</th>
                        <th>–¢–∏–∂–Ω—ñ</th>
                        <th>–î–∑–µ—Ä–∫–∞–ª–æ</th>
                        <th>–§—ñ–∫—Å. –¥–µ–Ω—å</th>
                        <th>–§—ñ–∫—Å. —Å–ª–æ—Ç</th>
                        <th>–î—ñ—ó</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% items.forEach(function(item) { %>
                        <% const rowLocation = courseLocationMap[item.course_id] || 'kyiv'; %>
                        <% const problemLevel = problemItemLookupByLocation && problemItemLookupByLocation[rowLocation] ? problemItemLookupByLocation[rowLocation][item.id] : null; %>
                        <% const hasConflict = conflictItemIds && conflictItemIds[rowLocation] ? conflictItemIds[rowLocation].has(item.id) : false; %>
                        <% const isFixed = item.fixed_day || item.fixed_class_number; %>
                        <tr
                          data-location-row
                          data-location="<%= rowLocation %>"
                          data-item-id="<%= item.id %>"
                          data-problem="<%= problemLevel ? 'true' : 'false' %>"
                          data-problem-level="<%= problemLevel || '' %>"
                          data-conflict="<%= hasConflict ? 'true' : 'false' %>"
                          data-fixed="<%= isFixed ? 'true' : 'false' %>"
                          class="<%= problemLevel ? 'problem-row' : '' %>"
                        >
                          <td>
                            <select class="form-select form-select-sm" name="course_id" form="gen-item-<%= item.id %>">
                              <% Object.values(coursesByLocation).flat().forEach(function(course) { %>
                                <option value="<%= course.id %>" <%= Number(item.course_id) === Number(course.id) ? 'selected' : '' %>><%= course.name %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="subject_id" form="gen-item-<%= item.id %>">
                              <% Object.values(coursesByLocation).flat().forEach(function(course) { %>
                                <optgroup label="<%= course.name %>">
                                  <% (subjectsByCourse[course.id] || []).forEach(function(subject) { %>
                                    <option value="<%= subject.id %>" <%= Number(item.subject_id) === Number(subject.id) ? 'selected' : '' %>>
                                      <%= subject.name %>
                                    </option>
                                  <% }); %>
                                </optgroup>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="lesson_type" form="gen-item-<%= item.id %>">
                              <option value="lecture" <%= item.lesson_type === 'lecture' ? 'selected' : '' %>>–õ–µ–∫—Ü—ñ—è</option>
                              <option value="seminar" <%= item.lesson_type === 'seminar' ? 'selected' : '' %>>–°–µ–º—ñ–Ω–∞—Ä</option>
                              <option value="lab" <%= item.lesson_type === 'lab' ? 'selected' : '' %>>–õ–∞–±</option>
                              <option value="practice" <%= item.lesson_type === 'practice' ? 'selected' : '' %>>–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="group_number" form="gen-item-<%= item.id %>">
                              <option value="all" <%= item.group_number === null || typeof item.group_number === 'undefined' ? 'selected' : '' %>>–£—Å—ñ</option>
                              <option value="1" <%= Number(item.group_number) === 1 ? 'selected' : '' %>>1</option>
                              <option value="2" <%= Number(item.group_number) === 2 ? 'selected' : '' %>>2</option>
                              <option value="3" <%= Number(item.group_number) === 3 ? 'selected' : '' %>>3</option>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="teacher_id" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% teachers.forEach(function(teacher) { %>
                                <option value="<%= teacher.id %>" <%= Number(item.teacher_id) === Number(teacher.id) ? 'selected' : '' %>>
                                  <%= teacher.full_name %>
                                </option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <input class="form-control form-control-sm" type="number" name="pairs_count" min="1" form="gen-item-<%= item.id %>" value="<%= item.pairs_count %>" />
                          </td>
                          <td>
                            <input class="form-control form-control-sm" name="weeks_set" form="gen-item-<%= item.id %>" value="<%= item.weeks_set || '' %>" />
                          </td>
                          <td>
                            <div class="mirror-key-field">
                              <input
                                class="form-control form-control-sm"
                                name="mirror_key"
                                id="mirror-key-<%= item.id %>"
                                form="gen-item-<%= item.id %>"
                                value="<%= item.mirror_key || '' %>"
                              />
                              <button
                                class="btn btn-outline-secondary btn-sm mirror-key-copy"
                                type="button"
                                data-target="mirror-key-<%= item.id %>"
                              >
                                –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                              </button>
                            </div>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="fixed_day" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% dayOptions.forEach(function(day) { %>
                                <option value="<%= day %>" <%= item.fixed_day === day ? 'selected' : '' %>><%= day %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="fixed_class_number" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% classOptions.forEach(function(n) { %>
                                <option value="<%= n %>" <%= Number(item.fixed_class_number) === Number(n) ? 'selected' : '' %>><%= n %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td class="d-flex flex-wrap gap-2">
                            <form id="gen-item-<%= item.id %>" method="POST" action="/admin/schedule-generator/items/edit/<%= item.id %>">
                              <input type="hidden" name="run_id" value="<%= run.id %>" />
                            </form>
                            <button class="btn btn-sm btn-outline-primary" type="submit" form="gen-item-<%= item.id %>">Save</button>
                            <% if (isFixed) { %>
                              <form method="POST" action="/admin/schedule-generator/items/unfreeze/<%= item.id %>">
                                <input type="hidden" name="run_id" value="<%= run.id %>" />
                                <button class="btn btn-sm btn-outline-secondary" type="submit">Unlock</button>
                              </form>
                            <% } else { %>
                              <form method="POST" action="/admin/schedule-generator/items/freeze/<%= item.id %>">
                                <input type="hidden" name="run_id" value="<%= run.id %>" />
                                <button class="btn btn-sm btn-outline-secondary" type="submit">Lock</button>
                              </form>
                            <% } %>
                            <form method="POST" action="/admin/schedule-generator/items/delete/<%= item.id %>">
                              <input type="hidden" name="run_id" value="<%= run.id %>" />
                              <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?');">Delete</button>
                            </form>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="generator-empty">–î–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞–Ω.</div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="app-footer text-center py-4">
      <small>
        ¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %> ¬∑
        <button
          type="button"
          class="btn btn-link btn-sm p-0 align-baseline"
          data-bs-toggle="modal"
          data-bs-target="#changelogModal"
        >
          Changelog
        </button>
      </small>
    </footer>

      <%- include('partials/changelog-modal') %>

      <div class="modal fade" id="mirrorAutoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content glass-panel">
            <div class="modal-header">
              <h5 class="modal-title">–ê–≤—Ç–æ-–ø–∞—Ä–∏ –¥–ª—è –¥–∑–µ—Ä–∫–∞–ª–∞</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="/admin/schedule-generator/mirror-auto">
              <input type="hidden" name="run_id" value="<%= run.id %>" />
              <div class="modal-body">
                <div class="text-muted small mb-3">
                  –ú–∏ –ø—ñ–¥–±–µ—Ä–µ–º–æ –ø–∞—Ä–∏ –¥–ª—è –≥—Ä—É–ø 1/2 –∑ –æ–¥–Ω–∞–∫–æ–≤–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –ø–∞—Ä —ñ –±–µ–∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏—Ö —Ç–∏–∂–Ω—ñ–≤/—Å–ª–æ—Ç—ñ–≤.
                  –ó–∞–≥–∞–ª—å–Ω—ñ –ø—Ä–µ–¥–º–µ—Ç–∏ —Ç–∞ –ø—Ä–µ–¥–º–µ—Ç–∏ –∑ —É–∂–µ –∑–∞–¥–∞–Ω–∏–º–∏ –¥–∑–µ—Ä–∫–∞–ª–∞–º–∏ –Ω–µ –≤–∫–ª—é—á–∞—î–º–æ.
                </div>
                <div class="d-flex flex-wrap gap-2 mb-3">
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-mirror-select="all">–í–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ</button>
                  <button class="btn btn-outline-secondary btn-sm" type="button" data-mirror-select="none">–ó–Ω—è—Ç–∏ –≤—Å—ñ</button>
                </div>
                <% ['kyiv', 'munich'].forEach(function(location) { %>
                  <% const candidates = autoMirrorCandidatesByLocation && autoMirrorCandidatesByLocation[location]; %>
                  <div data-location-section="<%= location %>" style="<%= activeLocation === location ? '' : 'display: none;' %>">
                    <% if (!candidates || !candidates.length) { %>
                      <div class="validation-empty">–ù–µ–º–∞—î –∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ –¥–ª—è –∞–≤—Ç–æ–ø–∞—Ä —É —Ü—ñ–π –ª–æ–∫–∞—Ü—ñ—ó.</div>
                    <% } else { %>
                      <div class="list-group mirror-auto-list">
                        <% candidates.forEach(function(pair) { %>
                          <label class="list-group-item d-flex gap-3 align-items-start">
                            <input
                              class="form-check-input mt-1"
                              type="checkbox"
                              name="mirror_pairs[]"
                              value="<%= pair.a.id %>:<%= pair.b.id %>"
                              data-location="<%= location %>"
                              <%= activeLocation === location ? '' : 'disabled' %>
                              checked
                            />
                            <div>
                              <div class="fw-semibold">
                                –ì—Ä—É–ø–∞ 1: <%= pair.a.subject_name %> ‚Üí –ì—Ä—É–ø–∞ 2: <%= pair.b.subject_name %>
                              </div>
                              <div class="small text-muted">
                                <%= pair.course_name %> ¬∑ <%= pair.lesson_type === 'seminar' ? '–°–µ–º—ñ–Ω–∞—Ä' : pair.lesson_type %> ¬∑ <%= pair.pairs_count %> –ø–∞—Ä
                              </div>
                            </div>
                          </label>
                        <% }); %>
                      </div>
                    <% } %>
                    <% const exclusions = autoMirrorExclusionsByLocation && autoMirrorExclusionsByLocation[location]; %>
                    <% if (exclusions && exclusions.length) { %>
                      <% const shown = exclusions.slice(0, 60); %>
                      <details class="mirror-auto-exclusions mt-3">
                        <summary>–ß–æ–º—É –Ω–µ –ø–æ–ø–∞–ª–æ –≤ –∞–≤—Ç–æ‚Äë–ø–∞—Ä–∏ (<%= exclusions.length %>)</summary>
                        <div class="list-group mirror-exclusion-list mt-2">
                          <% shown.forEach(function(item) { %>
                            <div class="list-group-item">
                              <div class="fw-semibold">
                                <%= item.subject_name %>
                                <span class="small text-muted">¬∑ –ì—Ä—É–ø–∞ <%= item.group_number || '‚Äî' %></span>
                              </div>
                              <div class="small text-muted">
                                <%= item.course_name %> ¬∑ <%= item.lesson_type === 'seminar' ? '–°–µ–º—ñ–Ω–∞—Ä' : item.lesson_type %> ¬∑ <%= item.pairs_count %> –ø–∞—Ä
                              </div>
                              <div class="d-flex flex-wrap gap-2 mt-2">
                                <% item.reasons.forEach(function(reason) { %>
                                  <span class="mirror-reason-chip"><%= reason %></span>
                                <% }); %>
                              </div>
                            </div>
                          <% }); %>
                          <% if (exclusions.length > shown.length) { %>
                            <div class="small text-muted">
                              –©–µ <%= exclusions.length - shown.length %> –∑–∞–ø–∏—Å—ñ–≤.
                            </div>
                          <% } %>
                        </div>
                      </details>
                    <% } %>
                  </div>
                <% }); %>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="submit" class="btn btn-primary">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–∞—Ä–∏</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        const applyTheme = (theme) => {
          document.body.classList.toggle('theme-light', theme === 'light');
          document.body.classList.toggle('theme-dark', theme === 'dark');
          themeToggle.textContent = theme === 'light' ? themeToggle.dataset.darkLabel : themeToggle.dataset.lightLabel;
        };
        const stored = localStorage.getItem('theme') || 'light';
        applyTheme(stored);
        themeToggle.addEventListener('click', () => {
          const next = document.body.classList.contains('theme-light') ? 'dark' : 'light';
          localStorage.setItem('theme', next);
          applyTheme(next);
        });
      }

      const locationButtons = document.querySelectorAll('.location-toggle');
      const locationInput = document.getElementById('activeLocationInput');
      const runLocationInput = document.getElementById('runLocationInput');
      const locationSections = document.querySelectorAll('[data-location-section]');
      const locationRows = document.querySelectorAll('[data-location-row]');

      const courseSelect = document.getElementById('genCourseSelect');
      const subjectSelect = document.getElementById('genSubjectSelect');
      const groupSelect = document.getElementById('genGroupSelect');
      const courseOptions = courseSelect ? Array.from(courseSelect.options) : [];
      const subjectGroups = subjectSelect ? Array.from(subjectSelect.querySelectorAll('optgroup')) : [];
      const runButtons = document.querySelectorAll('[data-disable-kyiv]');
      const mirrorAutoModal = document.getElementById('mirrorAutoModal');
      const mirrorAutoInputs = mirrorAutoModal
        ? Array.from(mirrorAutoModal.querySelectorAll('input[name="mirror_pairs[]"]'))
        : [];
      const mergePreviewBtn = document.getElementById('mergePreviewBtn');
      const mergePreviewCourse = document.getElementById('mergePreviewCourse');
      const mergePreviewList = document.getElementById('mergePreviewList');
      const mergePreviewMeta = document.getElementById('mergePreviewMeta');
      const mergePreviewOptions = mergePreviewCourse ? Array.from(mergePreviewCourse.options) : [];

      const evennessRange = document.getElementById('evennessBiasRange');
      const evennessValue = document.getElementById('evennessBiasValue');
      if (evennessRange && evennessValue) {
        const syncEvenness = () => {
          evennessValue.textContent = `${evennessRange.value}%`;
        };
        syncEvenness();
        evennessRange.addEventListener('input', syncEvenness);
      }

      const lateSlotRange = document.getElementById('lateSlotWeightRange');
      const lateSlotValue = document.getElementById('lateSlotWeightValue');
      if (lateSlotRange && lateSlotValue) {
        const syncLateSlots = () => {
          lateSlotValue.textContent = `${lateSlotRange.value}%`;
        };
        syncLateSlots();
        lateSlotRange.addEventListener('input', syncLateSlots);
      }

      const mirrorKeyInput = document.getElementById('mirrorKeyInput');
      const mirrorKeyGenerate = document.getElementById('mirrorKeyGenerate');
      const mirrorKeyCopy = document.getElementById('mirrorKeyCopy');

      const generateMirrorKey = () => {
        const seed = Math.random().toString(36).slice(2, 5).toUpperCase();
        const time = Date.now().toString(36).slice(-3).toUpperCase();
        return `M-${time}${seed}`;
      };

      const copyText = async (text) => {
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return;
        }
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
      };

      if (mirrorKeyGenerate && mirrorKeyInput) {
        mirrorKeyGenerate.addEventListener('click', () => {
          mirrorKeyInput.value = generateMirrorKey();
          mirrorKeyInput.focus();
        });
      }
      if (mirrorKeyCopy && mirrorKeyInput) {
        mirrorKeyCopy.addEventListener('click', () => copyText(mirrorKeyInput.value));
      }
      document.querySelectorAll('.mirror-key-copy').forEach((btn) => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const input = targetId ? document.getElementById(targetId) : null;
          if (input) copyText(input.value);
        });
      });

      const problemToggles = {
        kyiv: document.getElementById('problemToggle-kyiv'),
        munich: document.getElementById('problemToggle-munich'),
      };

      const applyProblemFilter = (location) => {
        const toggle = problemToggles[location];
        const onlyProblem = toggle && toggle.checked;
        locationRows.forEach((row) => {
          if (row.dataset.location !== location) return;
          if (!onlyProblem) {
            row.style.display = '';
            return;
          }
          row.style.display = row.dataset.problem === 'true' ? '' : 'none';
        });
      };

      Object.entries(problemToggles).forEach(([location, toggle]) => {
        if (!toggle) return;
        toggle.addEventListener('change', () => applyProblemFilter(location));
      });

      const updateRunButtons = (location) => {
        runButtons.forEach((btn) => {
          const disable = location === 'munich' ? btn.dataset.disableMunich === 'true' : btn.dataset.disableKyiv === 'true';
          btn.disabled = disable;
        });
      };

      const setMergePreviewMeta = (text) => {
        if (mergePreviewMeta) {
          mergePreviewMeta.textContent = text || '';
        }
      };

      const clearMergePreview = () => {
        if (mergePreviewList) mergePreviewList.innerHTML = '';
      };

      const renderMergePreview = (payload) => {
        clearMergePreview();
        const total = Number(payload?.total || 0);
        setMergePreviewMeta(total ? `–ó–Ω–∞–π–¥–µ–Ω–æ ${total} –∑–ª–∏—Ç—Ç—ñ–≤` : '–ù–µ–º–∞—î –ø—Ä–µ–¥–º–µ—Ç—ñ–≤ –¥–ª—è –∑–ª–∏—Ç—Ç—è.');
        if (!total || !mergePreviewList) return;
        (payload.merges || []).forEach((item) => {
          const card = document.createElement('div');
          card.className = 'glass-inset p-3 merge-preview-item';

          const title = document.createElement('div');
          title.className = 'fw-semibold';
          title.textContent = item.base_name || item.canonical_name || '–ë–µ–∑ –Ω–∞–∑–≤–∏';

          const meta = document.createElement('div');
          meta.className = 'small text-muted';
          const courseLabel = item.course_name ? `${item.course_name} ‚Ä¢ ` : '';
          const lectureName = item.lecture?.name || '-';
          const seminarName = item.seminar?.name || '-';
          meta.textContent = `${courseLabel}–õ–µ–∫—Ü—ñ—è: ${lectureName} ‚Ä¢ –°–µ–º—ñ–Ω–∞—Ä: ${seminarName}`;

          const canonical = document.createElement('div');
          canonical.className = 'small';
          const sourceLabel = item.canonical_source || 'base';
          canonical.textContent = `–ö–∞–Ω–æ–Ω—ñ—á–Ω–∏–π: ${item.canonical_name || ''} (${sourceLabel})`;

          card.append(title, meta, canonical);

          if (item.rename && item.rename.from && item.rename.to) {
            const rename = document.createElement('div');
            rename.className = 'small text-muted';
            rename.textContent = `–ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è: ${item.rename.from} ‚Üí ${item.rename.to}`;
            card.append(rename);
          }
          if (item.rename_conflict) {
            const warn = document.createElement('div');
            warn.className = 'small text-warning';
            warn.textContent = '–ö–æ–Ω—Ñ–ª—ñ–∫—Ç –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è: –Ω–∞–∑–≤–∞ –≤–∂–µ —ñ—Å–Ω—É—î.';
            card.append(warn);
          }

          mergePreviewList.appendChild(card);
        });
      };

      if (mergePreviewBtn) {
        mergePreviewBtn.addEventListener('click', async () => {
          const originalText = mergePreviewBtn.textContent;
          mergePreviewBtn.disabled = true;
          mergePreviewBtn.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
          setMergePreviewMeta('–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫...');
          clearMergePreview();
          try {
            const params = new URLSearchParams();
            const selectedCourse = mergePreviewCourse ? String(mergePreviewCourse.value || '') : '';
            if (selectedCourse) params.set('course_id', selectedCourse);
            const url = `/admin/schedule-generator/merge-preview${params.toString() ? `?${params.toString()}` : ''}`;
            const response = await fetch(url, { headers: { Accept: 'application/json' } });
            if (!response.ok) {
              throw new Error('Request failed');
            }
            const data = await response.json();
            renderMergePreview(data);
          } catch (err) {
            setMergePreviewMeta('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ dry-run. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
          } finally {
            mergePreviewBtn.disabled = false;
            mergePreviewBtn.textContent = originalText;
          }
        });
      }

      function syncSubjects() {
        if (!courseSelect || !subjectSelect) return;
        const courseId = courseSelect.value;
        const options = Array.from(subjectSelect.querySelectorAll('option'));
        options.forEach((opt) => {
          const optCourse = opt.dataset.course;
          const show = !optCourse || optCourse === courseId;
          opt.hidden = !show;
        });
        const visible = options.find((opt) => !opt.hidden);
        if (visible) {
          subjectSelect.value = visible.value;
        }
        syncGroupOptions();
      }

      function syncGroupOptions() {
        if (!subjectSelect || !groupSelect) return;
        const selected = subjectSelect.options[subjectSelect.selectedIndex];
        const groupCount = Number(selected?.dataset?.groupCount || 1);
        Array.from(groupSelect.querySelectorAll('option[data-group]')).forEach((opt) => {
          const num = Number(opt.dataset.group);
          opt.disabled = num > groupCount;
        });
      }

      function applyLocation(location) {
        const safe = location === 'munich' ? 'munich' : 'kyiv';
        if (locationInput) locationInput.value = safe;
        if (runLocationInput) runLocationInput.value = safe;
        updateRunButtons(safe);
        locationButtons.forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.location === safe);
        });
        locationSections.forEach((section) => {
          const isActive = section.dataset.locationSection === safe;
          section.style.display = isActive ? '' : 'none';
          section.querySelectorAll('select[name^="course_semesters["]').forEach((select) => {
            select.disabled = !isActive;
          });
        });
        locationRows.forEach((row) => {
          row.style.display = row.dataset.location === safe ? '' : 'none';
        });
        applyProblemFilter(safe);
        if (courseOptions.length) {
          courseOptions.forEach((opt) => {
            const optLocation = opt.dataset.location || 'kyiv';
            opt.hidden = optLocation !== safe;
          });
          const firstVisible = courseOptions.find((opt) => !opt.hidden);
          if (firstVisible) {
            courseSelect.value = firstVisible.value;
          }
        }
        if (subjectGroups.length) {
          subjectGroups.forEach((group) => {
            const groupLocation = group.dataset.location || 'kyiv';
            const show = groupLocation === safe;
            group.hidden = !show;
            group.disabled = !show;
          });
        }
        syncSubjects();
        if (mirrorAutoInputs.length) {
          mirrorAutoInputs.forEach((input) => {
            const targetLocation = input.dataset.location || 'kyiv';
            input.disabled = targetLocation !== safe;
          });
        }
        if (mergePreviewOptions.length) {
          mergePreviewOptions.forEach((opt) => {
            if (!opt.value) {
              opt.hidden = false;
              return;
            }
            const optLocation = opt.dataset.location || 'kyiv';
            opt.hidden = optLocation !== safe;
          });
          if (mergePreviewCourse && mergePreviewCourse.selectedOptions.length) {
            const selected = mergePreviewCourse.selectedOptions[0];
            if (selected && selected.hidden) {
              mergePreviewCourse.value = '';
            }
          }
        }
      }

      if (courseSelect) {
        courseSelect.addEventListener('change', syncSubjects);
      }
      if (subjectSelect) {
        subjectSelect.addEventListener('change', syncGroupOptions);
      }
      if (locationButtons.length) {
        locationButtons.forEach((btn) => {
          btn.addEventListener('click', () => applyLocation(btn.dataset.location));
        });
      }

      if (mirrorAutoModal) {
        mirrorAutoModal.querySelectorAll('[data-mirror-select]').forEach((btn) => {
          btn.addEventListener('click', () => {
            const mode = btn.dataset.mirrorSelect;
            const safe = locationInput ? locationInput.value : 'kyiv';
            mirrorAutoInputs.forEach((input) => {
              if (input.dataset.location !== safe || input.disabled) return;
              input.checked = mode === 'all';
            });
          });
        });
      }

      applyLocation(locationInput ? locationInput.value : 'kyiv');
    </script>
  </body>
</html>
