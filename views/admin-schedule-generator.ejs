<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–∫–ª–∞–¥—É</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/admin.css" />
    <link rel="stylesheet" href="/css/pages/admin-schedule-generator.css" />
  </head>
  <body class="theme-light schedule-generator-page">
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <span class="navbar-brand">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–æ–∑–∫–ª–∞–¥—É</span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted"><%= t('role.admin') %>: <%= username %></span>
          <button
            class="theme-toggle theme-toggle-min me-2"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="‚òÄÔ∏è"
            data-dark-label="üåô"
          >
            üåô
          </button>
          <a class="btn btn-outline-primary btn-sm me-2" href="/admin">–ù–∞–∑–∞–¥ –≤ –∞–¥–º—ñ–Ω–∫—É</a>
          <form method="POST" action="/admin/schedule-generator/new" class="me-2">
            <button class="btn btn-outline-secondary btn-sm" type="submit">–ù–æ–≤–∏–π –¥—Ä–∞—Ñ—Ç</button>
          </form>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <% if (messages && messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>

      <div class="generator-hero glass mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
          <div>
            <h1 class="h3 mb-2">–°–µ–º–µ—Å—Ç—Ä–æ–≤–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</h1>
            <div class="text-muted">
              –§–æ—Ä–º—É—î–º–æ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –ø–æ –∫–∏—ó–≤—Å—å–∫–∏—Ö –∫—É—Ä—Å–∞—Ö: —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ —Å–ª–æ—Ç–∏, –¥–∑–µ—Ä–∫–∞–ª—å–Ω—ñ —Ç–∏–∂–Ω—ñ, –æ–±–º–µ–∂–µ–Ω–Ω—è –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤.
            </div>
          </div>
          <div class="generator-status">
            <span class="generator-chip">Run #<%= run.id %></span>
            <span class="badge bg-<%= run.status === 'published' ? 'success' : 'secondary' %>">
              <%= run.status === 'published' ? '–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–µ—Ç–∫–∞' %>
            </span>
          </div>
        </div>
        <div class="generator-actions mt-3">
          <form method="POST" action="/admin/schedule-generator/run">
            <input type="hidden" name="run_id" value="<%= run.id %>" />
            <button class="btn btn-primary" type="submit">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä–µ–≤ º—é</button>
          </form>
          <% const firstCourseId = (courseSemesters && courseSemesters.length) ? courseSemesters[0].course.id : null; %>
          <% if (firstCourseId) { %>
            <a class="btn btn-outline-primary" href="/admin/schedule-generator/<%= run.id %>/preview?course=<%= firstCourseId %>&week=1">–í—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–µ–≤ º—é</a>
          <% } %>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-12 col-xl-4">
          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ö–∏—ó–≤—Å—å–∫—ñ –∫—É—Ä—Å–∏</div>
              <% if (courseSemesters && courseSemesters.length) { %>
                <div class="d-grid gap-2">
                  <% courseSemesters.forEach(function(row) { %>
                    <div class="glass-inset p-3">
                      <div class="fw-semibold"><%= row.course.name %></div>
                      <div class="small text-muted">
                        <%= row.semester ? row.semester.title : '–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–º–µ—Å—Ç—Ä—É' %>
                        <% if (row.semester) { %> ¬∑ <%= row.semester.weeks_count %> —Ç–∏–∂–Ω—ñ–≤ <% } %>
                      </div>
                      <div class="small text-muted">
                        –ê–∫—Ç–∏–≤–Ω—ñ –¥–Ω—ñ: <%= (courseDays[row.course.id] || []).join(', ') %>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="generator-empty">–ù–µ–º–∞—î –∫—É—Ä—Å—ñ–≤ –∑ –º—ñ—Ç–∫–æ—é Kyiv.</div>
              <% } %>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</div>
              <form method="POST" action="/admin/schedule-generator/config" class="row g-3">
                <input type="hidden" name="run_id" value="<%= run.id %>" />
                <div class="col-12">
                  <label class="form-label">–†–æ–∑–ø–æ–¥—ñ–ª –ø–∞—Ä</label>
                  <select class="form-select" name="distribution">
                    <option value="start" <%= config.distribution === 'start' ? 'selected' : '' %>>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –Ω–∞ –ø–æ—á–∞—Ç–∫—É</option>
                    <option value="even" <%= config.distribution === 'even' ? 'selected' : '' %>>–†—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ</option>
                    <option value="end" <%= config.distribution === 'end' ? 'selected' : '' %>>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—è –≤ –∫—ñ–Ω—Ü—ñ</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">–°–µ–º—ñ–Ω–∞—Ä–∏</label>
                  <select class="form-select" name="seminar_distribution">
                    <option value="start" <%= config.seminar_distribution === 'start' ? 'selected' : '' %>>–ù–∞ –ø–æ—á–∞—Ç–∫—É</option>
                    <option value="even" <%= config.seminar_distribution === 'even' ? 'selected' : '' %>>–†—ñ–≤–Ω–æ–º—ñ—Ä–Ω–æ</option>
                    <option value="end" <%= config.seminar_distribution === 'end' ? 'selected' : '' %>>–í –∫—ñ–Ω—Ü—ñ</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Max –ø–∞—Ä/–¥–µ–Ω—å</label>
                  <input class="form-control" type="number" name="max_daily_pairs" min="1" max="7" value="<%= config.max_daily_pairs || 7 %>" />
                </div>
                <div class="col-6">
                  <label class="form-label">–¶—ñ–ª—å –ø–∞—Ä/–¥–µ–Ω—å</label>
                  <input class="form-control" type="number" name="target_daily_pairs" min="1" max="7" value="<%= config.target_daily_pairs || 4 %>" />
                </div>
                <div class="col-12">
                  <label class="form-label">–û—Å–æ–±–ª–∏–≤—ñ —Ç–∏–∂–Ω—ñ (1-3,8)</label>
                  <input class="form-control" name="blocked_weeks" value="<%= config.blocked_weeks || '' %>" placeholder="1-2,6,9" />
                </div>
                <div class="col-12">
                  <label class="form-label">–†–µ–∂–∏–º –æ—Å–æ–±–ª–∏–≤–∏—Ö —Ç–∏–∂–Ω—ñ–≤</label>
                  <select class="form-select" name="special_weeks_mode">
                    <option value="block" <%= config.special_weeks_mode !== 'overlay' ? 'selected' : '' %>>–ë–ª–æ–∫—É–≤–∞—Ç–∏ –∑–∞–Ω—è—Ç—Ç—è</option>
                    <option value="overlay" <%= config.special_weeks_mode === 'overlay' ? 'selected' : '' %>>–ù–∞–∫–ª–∞–¥–∞—Ç–∏ –ø–æ–≤–µ—Ä—Ö</option>
                  </select>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="prefer_compactness" id="preferCompactness" <%= config.prefer_compactness ? 'checked' : '' %> />
                    <label class="form-check-label" for="preferCompactness">–ú–µ–Ω—à–µ –≤—ñ–∫–æ–Ω –º—ñ–∂ –ø–∞—Ä–∞–º–∏</label>
                  </div>
                </div>
                <div class="col-12 d-grid">
                  <button class="btn btn-outline-primary" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–û—Å—Ç–∞–Ω–Ω—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è</div>
              <% if (lastStats) { %>
                <div class="d-grid gap-2 mb-3">
                  <div class="glass-inset p-3">
                    <div class="small text-muted">–ó–∞–ø–∏—Å—ñ–≤</div>
                    <div class="fw-semibold"><%= lastStats.entries %> –ø–∞—Ä</div>
                  </div>
                  <div class="glass-inset p-3">
                    <div class="small text-muted">–ö–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤</div>
                    <div class="fw-semibold"><%= lastStats.conflicts %></div>
                  </div>
                  <div class="small text-muted">–û–Ω–æ–≤–ª–µ–Ω–æ: <%= lastStats.generated_at ? new Date(lastStats.generated_at).toLocaleString('uk-UA') : '' %></div>
                </div>
              <% } else { %>
                <div class="generator-empty mb-3">–©–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é.</div>
              <% } %>
              <% if (lastConflicts && lastConflicts.length) { %>
                <div class="small text-muted mb-2">–ü—Ä–æ–±–ª–µ–º–∏:</div>
                <div class="d-grid gap-2">
                  <% lastConflicts.slice(0, 5).forEach(function(conflict) { %>
                    <div class="glass-inset p-2">
                      <div class="fw-semibold"><%= conflict.subject || '–ë–µ–∑ –ø—Ä–µ–¥–º–µ—Ç–∞' %></div>
                      <div class="small text-muted"><%= conflict.reason %></div>
                    </div>
                  <% }); %>
                </div>
              <% } %>
            </div>
          </div>

          <div class="card glass-panel">
            <div class="card-body">
              <div class="generator-section-title mb-2">–í–∏–∫–ª–∞–¥–∞—á—ñ</div>
              <% if (teachers && teachers.length) { %>
                <div class="d-grid gap-3">
                  <% teachers.forEach(function(teacher) { %>
                    <% const limit = limitsByTeacher[teacher.id] || {}; %>
                    <form method="POST" action="/admin/schedule-generator/teachers/save" class="glass-inset p-3">
                      <input type="hidden" name="run_id" value="<%= run.id %>" />
                      <input type="hidden" name="teacher_id" value="<%= teacher.id %>" />
                      <div class="fw-semibold mb-2"><%= teacher.full_name %></div>
                      <div class="teacher-days mb-2">
                        <% dayOptions.forEach(function(day, idx) { %>
                          <% const label = dayLabels[idx] || day.slice(0, 2); %>
                          <label class="teacher-day-pill">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              name="allowed_days"
                              value="<%= day %>"
                              <%= (limit.allowed_weekdays || []).includes(day) ? 'checked' : '' %>
                            />
                            <span><%= label %></span>
                          </label>
                        <% }); %>
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <div class="flex-grow-1">
                          <label class="form-label small">Max –ø–∞—Ä/—Ç–∏–∂–¥–µ–Ω—å</label>
                          <input
                            class="form-control form-control-sm"
                            type="number"
                            name="max_pairs_per_week"
                            min="1"
                            placeholder="–ë–µ–∑ –ª—ñ–º—ñ—Ç—É"
                            value="<%= limit.max_pairs_per_week || '' %>"
                          />
                        </div>
                        <button class="btn btn-outline-primary btn-sm" type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                      </div>
                    </form>
                  <% }); %>
                </div>
              <% } else { %>
                <div class="generator-empty">–ù–µ–º–∞—î –≤–∏–∫–ª–∞–¥–∞—á—ñ–≤.</div>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-12 col-xl-8">
          <div class="card glass-panel mb-4">
            <div class="card-body">
              <div class="generator-section-title mb-2">–î–æ–¥–∞—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç</div>
              <form method="POST" action="/admin/schedule-generator/items/add" class="row g-3">
                <input type="hidden" name="run_id" value="<%= run.id %>" />
                <div class="col-12 col-md-4">
                  <label class="form-label">–ö—É—Ä—Å</label>
                  <select class="form-select" name="course_id" id="genCourseSelect" required>
                    <% kyivCourses.forEach(function(course) { %>
                      <option value="<%= course.id %>"><%= course.name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">–ü—Ä–µ–¥–º–µ—Ç</label>
                  <select class="form-select" name="subject_id" id="genSubjectSelect" required>
                    <% kyivCourses.forEach(function(course) { %>
                      <optgroup label="<%= course.name %>">
                        <% (subjectsByCourse[course.id] || []).forEach(function(subject) { %>
                          <option value="<%= subject.id %>" data-course="<%= course.id %>" data-group-count="<%= subject.group_count %>">
                            <%= subject.name %>
                          </option>
                        <% }); %>
                      </optgroup>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">–¢–∏–ø –∑–∞–Ω—è—Ç—Ç—è</label>
                  <select class="form-select" name="lesson_type">
                    <option value="lecture">–õ–µ–∫—Ü—ñ—è</option>
                    <option value="seminar">–°–µ–º—ñ–Ω–∞—Ä</option>
                    <option value="lab">–õ–∞–±</option>
                    <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–ì—Ä—É–ø–∞</label>
                  <select class="form-select" name="group_number" id="genGroupSelect">
                    <option value="all">–£—Å—ñ –≥—Ä—É–ø–∏</option>
                    <option value="1" data-group="1">1</option>
                    <option value="2" data-group="2">2</option>
                    <option value="3" data-group="3">3</option>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–ö-—Å—Ç—å –ø–∞—Ä</label>
                  <input class="form-control" type="number" name="pairs_count" min="1" value="1" required />
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">–í–∏–∫–ª–∞–¥–∞—á</label>
                  <select class="form-select" name="teacher_id">
                    <option value="">–ë–µ–∑ –≤–∏–∫–ª–∞–¥–∞—á–∞</option>
                    <% teachers.forEach(function(teacher) { %>
                      <option value="<%= teacher.id %>"><%= teacher.full_name %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label">–¢–∏–∂–Ω—ñ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label>
                  <input class="form-control" name="weeks_set" placeholder="1-2,5,7" />
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–§—ñ–∫—Å–æ–≤–∞–Ω–∏–π –¥–µ–Ω—å</label>
                  <select class="form-select" name="fixed_day">
                    <option value="">–ë—É–¥—å-—è–∫–∏–π</option>
                    <% dayOptions.forEach(function(day) { %>
                      <option value="<%= day %>"><%= day %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">–§—ñ–∫—Å–æ–≤–∞–Ω–∏–π —Å–ª–æ—Ç</label>
                  <select class="form-select" name="fixed_class_number">
                    <option value="">–ë—É–¥—å-—è–∫–∏–π</option>
                    <% classOptions.forEach(function(n) { %>
                      <option value="<%= n %>"><%= n %></option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-12 col-md-6 d-grid">
                  <button class="btn btn-primary" type="submit">–î–æ–¥–∞—Ç–∏ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card glass-panel">
            <div class="card-body">
              <div class="generator-section-title mb-2">–ü–ª–∞–Ω –∑–∞–Ω—è—Ç—å</div>
              <% if (items && items.length) { %>
                <div class="table-responsive">
                  <table class="table generator-table align-middle">
                    <thead>
                      <tr>
                        <th>–ö—É—Ä—Å</th>
                        <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                        <th>–¢–∏–ø</th>
                        <th>–ì—Ä—É–ø–∞</th>
                        <th>–í–∏–∫–ª–∞–¥–∞—á</th>
                        <th>–ü–∞—Ä</th>
                        <th>–¢–∏–∂–Ω—ñ</th>
                        <th>–§—ñ–∫—Å. –¥–µ–Ω—å</th>
                        <th>–§—ñ–∫—Å. —Å–ª–æ—Ç</th>
                        <th>–î—ñ—ó</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% items.forEach(function(item) { %>
                        <tr>
                          <td>
                            <select class="form-select form-select-sm" name="course_id" form="gen-item-<%= item.id %>">
                              <% kyivCourses.forEach(function(course) { %>
                                <option value="<%= course.id %>" <%= Number(item.course_id) === Number(course.id) ? 'selected' : '' %>><%= course.name %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="subject_id" form="gen-item-<%= item.id %>">
                              <% kyivCourses.forEach(function(course) { %>
                                <optgroup label="<%= course.name %>">
                                  <% (subjectsByCourse[course.id] || []).forEach(function(subject) { %>
                                    <option value="<%= subject.id %>" <%= Number(item.subject_id) === Number(subject.id) ? 'selected' : '' %>>
                                      <%= subject.name %>
                                    </option>
                                  <% }); %>
                                </optgroup>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="lesson_type" form="gen-item-<%= item.id %>">
                              <option value="lecture" <%= item.lesson_type === 'lecture' ? 'selected' : '' %>>–õ–µ–∫—Ü—ñ—è</option>
                              <option value="seminar" <%= item.lesson_type === 'seminar' ? 'selected' : '' %>>–°–µ–º—ñ–Ω–∞—Ä</option>
                              <option value="lab" <%= item.lesson_type === 'lab' ? 'selected' : '' %>>–õ–∞–±</option>
                              <option value="practice" <%= item.lesson_type === 'practice' ? 'selected' : '' %>>–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="group_number" form="gen-item-<%= item.id %>">
                              <option value="all" <%= item.group_number === null || typeof item.group_number === 'undefined' ? 'selected' : '' %>>–£—Å—ñ</option>
                              <option value="1" <%= Number(item.group_number) === 1 ? 'selected' : '' %>>1</option>
                              <option value="2" <%= Number(item.group_number) === 2 ? 'selected' : '' %>>2</option>
                              <option value="3" <%= Number(item.group_number) === 3 ? 'selected' : '' %>>3</option>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="teacher_id" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% teachers.forEach(function(teacher) { %>
                                <option value="<%= teacher.id %>" <%= Number(item.teacher_id) === Number(teacher.id) ? 'selected' : '' %>>
                                  <%= teacher.full_name %>
                                </option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <input class="form-control form-control-sm" type="number" name="pairs_count" min="1" form="gen-item-<%= item.id %>" value="<%= item.pairs_count %>" />
                          </td>
                          <td>
                            <input class="form-control form-control-sm" name="weeks_set" form="gen-item-<%= item.id %>" value="<%= item.weeks_set || '' %>" />
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="fixed_day" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% dayOptions.forEach(function(day) { %>
                                <option value="<%= day %>" <%= item.fixed_day === day ? 'selected' : '' %>><%= day %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td>
                            <select class="form-select form-select-sm" name="fixed_class_number" form="gen-item-<%= item.id %>">
                              <option value="">‚Äî</option>
                              <% classOptions.forEach(function(n) { %>
                                <option value="<%= n %>" <%= Number(item.fixed_class_number) === Number(n) ? 'selected' : '' %>><%= n %></option>
                              <% }); %>
                            </select>
                          </td>
                          <td class="d-flex gap-2">
                            <form id="gen-item-<%= item.id %>" method="POST" action="/admin/schedule-generator/items/edit/<%= item.id %>">
                              <input type="hidden" name="run_id" value="<%= run.id %>" />
                            </form>
                            <button class="btn btn-sm btn-outline-primary" type="submit" form="gen-item-<%= item.id %>">Save</button>
                            <form method="POST" action="/admin/schedule-generator/items/delete/<%= item.id %>">
                              <input type="hidden" name="run_id" value="<%= run.id %>" />
                              <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?');">Delete</button>
                            </form>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="generator-empty">–î–æ–¥–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç–∏, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–ª–∞–Ω.</div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="app-footer text-center py-4">
      <small>
        ¬© <%= new Date().getFullYear() %> <%= authorName %> ¬∑ v<%= appVersion %> ¬∑ <%= buildStamp %> ¬∑
        <button
          type="button"
          class="btn btn-link btn-sm p-0 align-baseline"
          data-bs-toggle="modal"
          data-bs-target="#changelogModal"
        >
          Changelog
        </button>
      </small>
    </footer>

    <%- include('partials/changelog-modal') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        const applyTheme = (theme) => {
          document.body.classList.toggle('theme-light', theme === 'light');
          document.body.classList.toggle('theme-dark', theme === 'dark');
          themeToggle.textContent = theme === 'light' ? themeToggle.dataset.darkLabel : themeToggle.dataset.lightLabel;
        };
        const stored = localStorage.getItem('theme') || 'light';
        applyTheme(stored);
        themeToggle.addEventListener('click', () => {
          const next = document.body.classList.contains('theme-light') ? 'dark' : 'light';
          localStorage.setItem('theme', next);
          applyTheme(next);
        });
      }

      const courseSelect = document.getElementById('genCourseSelect');
      const subjectSelect = document.getElementById('genSubjectSelect');
      const groupSelect = document.getElementById('genGroupSelect');

      function syncSubjects() {
        if (!courseSelect || !subjectSelect) return;
        const courseId = courseSelect.value;
        const options = Array.from(subjectSelect.querySelectorAll('option'));
        options.forEach((opt) => {
          const optCourse = opt.dataset.course;
          const show = !optCourse || optCourse === courseId;
          opt.hidden = !show;
        });
        const visible = options.find((opt) => !opt.hidden);
        if (visible) {
          subjectSelect.value = visible.value;
        }
        syncGroupOptions();
      }

      function syncGroupOptions() {
        if (!subjectSelect || !groupSelect) return;
        const selected = subjectSelect.options[subjectSelect.selectedIndex];
        const groupCount = Number(selected?.dataset?.groupCount || 1);
        Array.from(groupSelect.querySelectorAll('option[data-group]')).forEach((opt) => {
          const num = Number(opt.dataset.group);
          opt.disabled = num > groupCount;
        });
      }

      if (courseSelect) {
        courseSelect.addEventListener('change', syncSubjects);
      }
      if (subjectSelect) {
        subjectSelect.addEventListener('change', syncGroupOptions);
      }
      syncSubjects();
    </script>
  </body>
</html>
