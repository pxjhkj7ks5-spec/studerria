<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–†–æ–∑–∫–ª–∞–¥ ¬∑ —Å–ø–∏—Å–æ–∫</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --accent: #3b82f6;
        --accent-dark: #2563eb;
        --radius: 16px;
        --glass-border-dark: rgba(255, 255, 255, 0.14);
        --glass-border-light: rgba(15, 23, 42, 0.12);
        --glass-bg-dark: rgba(255, 255, 255, 0.06);
        --glass-bg-light: rgba(255, 255, 255, 0.35);
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Helvetica Neue", "Inter", Arial, sans-serif;
        min-height: 100vh;
      }
      body.theme-light {
        background: radial-gradient(1200px 800px at 20% 10%, rgba(147, 197, 253, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 90% 20%, rgba(196, 181, 253, 0.22), transparent 60%),
          linear-gradient(135deg, #e6eef8 0%, #e9f0fb 45%, #eef2ff 100%);
        color: #0f172a;
      }
      body.theme-dark {
        background: radial-gradient(1200px 800px at 15% 10%, rgba(59, 130, 246, 0.22), transparent 60%),
          radial-gradient(1000px 700px at 80% 20%, rgba(14, 165, 233, 0.18), transparent 60%),
          linear-gradient(160deg, #0b0f1a 0%, #141b30 100%);
        color: #f8fafc;
      }
      body.theme-dark .text-dark {
        color: #f8fafc !important;
      }
      .admin-nav {
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .admin-nav {
        background: rgba(255, 255, 255, 0.8);
        border-bottom-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-dark .admin-nav {
        background: rgba(10, 10, 20, 0.6);
      }
      .card {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        border-radius: var(--radius);
        backdrop-filter: blur(20px);
        transition: background 220ms ease, border-color 220ms ease, box-shadow 220ms ease, transform 220ms ease;
      }
      body.theme-dark .card {
        background: rgba(18, 24, 40, 0.72);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      }
      body.theme-light .card {
        background: rgba(255, 255, 255, 0.72);
        border-color: var(--glass-border-light);
        box-shadow: 0 16px 36px rgba(15, 23, 42, 0.14), 0 0 0 1px rgba(255, 255, 255, 0.4) inset;
      }
    </style>
    <link rel="stylesheet" href="/css/tokens.css" />
    <link rel="stylesheet" href="/css/components.css" />
    <link rel="stylesheet" href="/css/pages/admin.css" />
  </head>
  <body class="theme-light schedule-list-page">
    <nav class="navbar navbar-expand-lg admin-nav">
      <div class="container">
        <span class="navbar-brand">–†–æ–∑–∫–ª–∞–¥ (—Å–ø–∏—Å–æ–∫)</span>
        <div class="d-flex align-items-center">
          <span class="me-3 text-muted">
            <%= t('role.admin') %>: <%= username %>
          </span>
          <button
            class="theme-toggle theme-toggle-min me-2"
            type="button"
            id="themeToggle"
            aria-label="Toggle theme"
            data-light-label="‚òÄÔ∏è"
            data-dark-label="üåô"
          >
            üåô
          </button>
          <a class="btn btn-outline-primary btn-sm me-2" href="/admin">–ù–∞–∑–∞–¥ –≤ –∞–¥–º—ñ–Ω–∫—É</a>
          <form method="POST" action="/logout">
            <button class="btn btn-outline-secondary btn-sm" type="submit"><%= t('admin.logout') %></button>
          </form>
        </div>
      </div>
    </nav>

    <main class="container py-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <h1 class="h3 mb-0">–°–ø–∏—Å–æ–∫ –ø–∞—Ä</h1>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-secondary btn-sm" href="/admin/schedule-summary">–°–≤–æ–¥–∫–∞ —Å–µ–º–µ—Å—Ç—Ä—É</a>
          <div class="text-muted">–ü–æ–∫–∞–∑—É—î–º–æ –ø–æ <%= perPage %> –∑–∞–ø–∏—Å—ñ–≤</div>
        </div>
      </div>

      <form class="mb-3" method="GET" action="/admin/schedule-list">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0"><%= t('admin.course') %></label>
          <select name="course" class="form-select w-auto" onchange="this.form.submit()">
            <% (courses || []).forEach(function(c) { %>
              <option value="<%= c.id %>" <%= Number(selectedCourseId) === Number(c.id) ? 'selected' : '' %>>
                <%= c.name %>
              </option>
            <% }); %>
          </select>
        </div>
      </form>

      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3"><%= t('admin.filters') %></h5>
          <form method="GET" action="/admin/schedule-list">
            <input type="hidden" name="course" value="<%= selectedCourseId %>" />
            <div class="row g-2">
              <div class="col-12 col-md-3">
                <input class="form-control" name="group_number" placeholder="Group number" value="<%= (filters && filters.group_number) || '' %>" />
              </div>
              <div class="col-12 col-md-3">
                <select class="form-select" name="day">
                  <option value="">All days</option>
                  <% (activeScheduleDays || ['Monday','Tuesday','Wednesday','Thursday','Friday']).forEach(function(d) { %>
                    <option value="<%= d %>" <%= filters && filters.day === d ? 'selected' : '' %>><%= d %></option>
                  <% }); %>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <input class="form-control" name="subject" placeholder="Subject" value="<%= (filters && filters.subject) || '' %>" />
              </div>
              <div class="col-12 col-md-3">
                <input class="form-control" type="date" name="schedule_date" value="<%= (filters && filters.schedule_date) || '' %>" />
              </div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-12 col-md-3 d-grid">
                <button class="btn btn-outline-primary" type="submit"><%= t('admin.apply') %></button>
              </div>
              <div class="col-12 col-md-3">
                <select class="form-select" name="sort_schedule">
                  <option value=""><%= t('admin.sortSchedule') %></option>
                  <option value="group" <%= sorts && sorts.schedule === 'group' ? 'selected' : '' %>><%= t('admin.sortGroup') %></option>
                  <option value="day" <%= sorts && sorts.schedule === 'day' ? 'selected' : '' %>><%= t('admin.sortDay') %></option>
                  <option value="time" <%= sorts && sorts.schedule === 'time' ? 'selected' : '' %>><%= t('admin.sortTime') %></option>
                </select>
              </div>
              <div class="col-12 col-md-3 d-grid">
                <button class="btn btn-outline-secondary" type="submit"><%= t('admin.applySort') %></button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-outline-danger btn-sm" type="submit" form="deleteScheduleForm">Delete Selected</button>
            <form id="clearScheduleForm" method="POST" action="/admin/schedule/clear-all">
              <button
                class="btn btn-danger btn-sm"
                type="submit"
                onclick="return confirm('Clear ALL schedule entries?');"
              >
                Clear All
              </button>
            </form>
          </div>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAllSchedule" /></th>
                  <th>ID</th>
                  <th>Subject</th>
                  <th>Type</th>
                  <th>Group #</th>
                  <th>Day</th>
                  <th>Semester</th>
                  <th>Class #</th>
                  <th>Week</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% (schedule || []).forEach(function(item) { %>
                  <tr>
                    <td><input type="checkbox" name="delete_ids" value="<%= item.id %>" form="deleteScheduleForm" /></td>
                    <td><%= item.id %></td>
                    <td>
                      <select class="form-select form-select-sm" name="subject_id" form="edit-<%= item.id %>" required>
                        <% (subjects || []).forEach(function(s) { %>
                          <option value="<%= s.id %>" <%= item.subject_id === s.id ? 'selected' : '' %>><%= s.name %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm schedule-lesson-type" name="lesson_type" form="edit-<%= item.id %>">
                        <option value="" <%= !item.lesson_type ? 'selected' : '' %>>Auto</option>
                        <option value="lecture" <%= item.lesson_type === 'lecture' ? 'selected' : '' %>>–õ–µ–∫—Ü—ñ—è</option>
                        <option value="seminar" <%= item.lesson_type === 'seminar' ? 'selected' : '' %>>–°–µ–º—ñ–Ω–∞—Ä</option>
                        <option value="lab" <%= item.lesson_type === 'lab' ? 'selected' : '' %>>–õ–∞–±</option>
                        <option value="practice" <%= item.lesson_type === 'practice' ? 'selected' : '' %>>–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
                      </select>
                    </td>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <input class="form-control form-control-sm schedule-group-input" name="group_number" form="edit-<%= item.id %>" value="<%= item.group_number %>" type="number" min="1" max="3" required />
                        <% if (Number(item.slot_group_count || 0) > 1) { %>
                          <span
                            class="badge text-bg-primary"
                            title="–ì—Ä—É–ø–∏: <%= item.slot_group_list || '' %>"
                            data-bs-toggle="tooltip"
                          >
                            –ú—É–ª—å—Ç–∏‚Äë–≥—Ä—É–ø–∏
                          </span>
                        <% } %>
                      </div>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="day_of_week" form="edit-<%= item.id %>" required>
                        <% (activeScheduleDays || ['Monday','Tuesday','Wednesday','Thursday','Friday']).forEach(function(d) { %>
                          <option value="<%= d %>" <%= item.day_of_week === d ? 'selected' : '' %>><%= d %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="semester_id" form="edit-<%= item.id %>" required>
                        <% (semesters || []).forEach(function(sem) { %>
                          <option value="<%= sem.id %>" <%= item.semester_id === sem.id ? 'selected' : '' %>><%= sem.title %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <select class="form-select form-select-sm" name="class_number" form="edit-<%= item.id %>" required>
                        <% [1,2,3,4,5,6,7].forEach(function(n) { %>
                          <option value="<%= n %>" <%= item.class_number === n ? 'selected' : '' %>><%= n %></option>
                        <% }); %>
                      </select>
                    </td>
                    <td>
                      <input class="form-control form-control-sm" name="week_number" form="edit-<%= item.id %>" value="<%= item.week_number %>" type="number" min="1" max="<%= activeSemester && activeSemester.weeks_count ? activeSemester.weeks_count : 15 %>" required />
                    </td>
                    <td class="d-flex gap-2">
                      <form id="edit-<%= item.id %>" method="POST" action="/admin/schedule/edit/<%= item.id %>" class="d-inline"></form>
                      <button class="btn btn-sm btn-outline-secondary" type="submit" form="edit-<%= item.id %>">Save</button>
                      <form method="POST" action="/admin/schedule/delete/<%= item.id %>" class="d-inline">
                        <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Delete this class from schedule?');">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
                <% if (!(schedule || []).length) { %>
                  <tr><td colspan="10" class="text-muted">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td></tr>
                <% } %>
              </tbody>
            </table>
            <form id="deleteScheduleForm" method="POST" action="/admin/schedule/delete-multiple">
              <% if (pagination && pagination.pageBase) { %>
                <input type="hidden" name="return_to" value="<%= pagination.pageBase %><%= pagination.page %>" />
              <% } %>
            </form>
          </div>
        </div>
      </div>

      <nav class="d-flex justify-content-between align-items-center">
        <div class="text-muted">–°—Ç–æ—Ä—ñ–Ω–∫–∞ <%= pagination.page %> –∑ <%= pagination.totalPages %></div>
        <ul class="pagination mb-0">
          <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
            <a class="page-link" href="<%= pagination.pageBase %><%= pagination.page - 1 %>">–ù–∞–∑–∞–¥</a>
          </li>
          <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="<%= pagination.pageBase %><%= pagination.page + 1 %>">–î–∞–ª—ñ</a>
          </li>
        </ul>
      </nav>
    </main>

    <script>
      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      const labelLight = themeToggle.dataset.lightLabel || 'Light';
      const labelDark = themeToggle.dataset.darkLabel || 'Dark';
      document.body.classList.remove('theme-light', 'theme-dark');
      document.body.classList.add(savedTheme);
      themeToggle.textContent = savedTheme === 'theme-dark' ? labelLight : labelDark;
      themeToggle.addEventListener('click', () => {
        const next = document.body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
        document.body.classList.remove('theme-light', 'theme-dark');
        document.body.classList.add(next);
        localStorage.setItem('ui-theme', next);
        themeToggle.textContent = next === 'theme-dark' ? labelLight : labelDark;
      });

      function wireSelectOpenState(root = document) {
        root.querySelectorAll('select.form-select').forEach((select) => {
          select.addEventListener('pointerdown', () => {
            select.classList.add('select-open');
          });
          select.addEventListener('keydown', (event) => {
            if ([' ', 'Enter', 'ArrowDown'].includes(event.key)) {
              select.classList.add('select-open');
            }
          });
          select.addEventListener('change', () => {
            select.classList.remove('select-open');
          });
          select.addEventListener('blur', () => {
            select.classList.remove('select-open');
          });
        });
      }

      wireSelectOpenState();

      function syncScheduleGroupLocks(root = document) {
        const rows = Array.from(root.querySelectorAll('tbody tr'));
        rows.forEach((row) => {
          const typeSelect = row.querySelector('.schedule-lesson-type');
          const groupInput = row.querySelector('.schedule-group-input');
          if (!typeSelect || !groupInput) return;
          const isLecture = String(typeSelect.value || '') === 'lecture';
          if (isLecture) {
            groupInput.value = '1';
            groupInput.readOnly = true;
            groupInput.classList.add('input-locked');
          } else {
            groupInput.readOnly = false;
            groupInput.classList.remove('input-locked');
          }
        });
      }

      document.querySelectorAll('.schedule-lesson-type').forEach((select) => {
        select.addEventListener('change', () => syncScheduleGroupLocks());
      });
      syncScheduleGroupLocks();

      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach((el) => {
        new bootstrap.Tooltip(el);
      });

      const selectAll = document.getElementById('selectAllSchedule');
      if (selectAll) {
        selectAll.addEventListener('change', () => {
          document.querySelectorAll('input[name="delete_ids"]').forEach((checkbox) => {
            checkbox.checked = selectAll.checked;
          });
        });
      }
    </script>
  </body>
</html>
