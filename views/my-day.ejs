<!doctype html>
<html lang="<%= lang %>">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Studeria Cockpit</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/pages/my-day.css" />
  </head>
  <body class="theme-dark">
    <%
      const cockpit = myDay || {};
      const brief = cockpit.brief || {};
      const briefReasons = Array.isArray(brief.reasons) ? brief.reasons : [];
      const deadlineItems = Array.isArray(cockpit.deadline_focus) ? cockpit.deadline_focus : [];
      const classItems = Array.isArray(cockpit.next_classes) ? cockpit.next_classes : [];
      const inboxItems = Array.isArray(cockpit.inbox_items) ? cockpit.inbox_items : [];
      const competencies = Array.isArray(cockpit.competencies) ? cockpit.competencies : [];
      const activity = cockpit.activity_summary || {};
      const reminders = Array.isArray(cockpit.reminders) ? cockpit.reminders : [];
      const reviewQueue = cockpit.review_queue || {};
      const reviewQueueItems = Array.isArray(reviewQueue.items) ? reviewQueue.items : [];
      const reviewQueueTemplates = Array.isArray(reviewQueue.templates) ? reviewQueue.templates : [];
      const reviewQueueCounts = reviewQueue.counts || {};
      const hasReviewQueue = Boolean(reviewQueue.enabled);
      const progressDashboard = cockpit.progress_dashboard || {};
      const progressSubjects = Array.isArray(progressDashboard.subjects) ? progressDashboard.subjects : [];
      const hasProgressDashboard = Boolean(progressDashboard.enabled);
      const whatIfSubjects = Array.isArray(cockpit.what_if_subjects) ? cockpit.what_if_subjects : [];
      const defaultWhatIfSubjectId = Number(cockpit.what_if_default_subject_id || 0);
      const briefToneClass = `brief-tone-${brief.tone || 'calm'}`;

      const formatShortDate = (value) => {
        if (!value) return '-';
        const parsed = new Date(`${value}T00:00:00`);
        if (Number.isNaN(parsed.getTime())) return value;
        return parsed.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit' });
      };
      const formatReminderDate = (value) => {
        if (!value) return '-';
        const parsed = new Date(`${value}T00:00:00`);
        if (Number.isNaN(parsed.getTime())) return value;
        return parsed.toLocaleDateString('uk-UA');
      };
      const formatDateTime = (value) => {
        if (!value) return '-';
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return value;
        return parsed.toLocaleString('uk-UA', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
        });
      };
      const getDeadlineStatus = (item) => {
        if (item && item.submission_status === 'submitted_on_time') {
          return { label: 'Вчасно', className: 'status-on-time' };
        }
        if (item && item.submission_status === 'submitted_late') {
          return { label: 'Із запізненням', className: 'status-late' };
        }
        if (item && item.submission_status === 'overdue') {
          return { label: 'Прострочено', className: 'status-overdue' };
        }
        return { label: 'Відкрито', className: 'status-open' };
      };
      const getDayContext = (item) => (item && item.day_context === 'tomorrow' ? 'Завтра' : 'Сьогодні');
      const getReviewQueueTypeMeta = (item) => {
        const queueType = String(item && item.queue_type ? item.queue_type : 'new');
        if (queueType === 'overdue') {
          return { label: 'Прострочені', className: 'status-overdue' };
        }
        if (queueType === 'no_comment') {
          return { label: 'Без коментаря', className: 'status-late' };
        }
        return { label: 'Нові', className: 'status-open' };
      };
      const getSubmissionStatusMeta = (item) => {
        const status = String(item && item.submission_status ? item.submission_status : '');
        if (status === 'late') return { label: 'Здано пізно', className: 'type-chip type-chip-warning' };
        if (status === 'on_time') return { label: 'Вчасно', className: 'type-chip type-chip-success' };
        if (status === 'manual') return { label: 'Ручна колонка', className: 'type-chip' };
        return null;
      };
      const getProgressRiskMeta = (item) => {
        const level = String(item && item.risk_level ? item.risk_level : 'low');
        if (level === 'high') return { label: 'Високий ризик', className: 'progress-risk-high' };
        if (level === 'medium') return { label: 'Помірний ризик', className: 'progress-risk-medium' };
        return { label: 'Стабільно', className: 'progress-risk-low' };
      };
    %>

    <%- include('partials/topbar', { role, username, t, activePage: 'my-day', pageTitle: 'Studeria Cockpit' }) %>

    <main class="container cockpit-page py-4">
      <% if (okMessage) { %>
        <div class="alert alert-success cockpit-alert" role="alert"><%= okMessage %></div>
      <% } %>
      <% if (errMessage) { %>
        <div class="alert alert-danger cockpit-alert" role="alert"><%= errMessage %></div>
      <% } %>

      <section class="cockpit-card brief-card <%= briefToneClass %>">
        <div class="brief-head">
          <span class="brief-kicker">Leadership Brief</span>
          <span class="brief-meta">Тиждень <%= cockpit.week_number || '-' %></span>
        </div>
        <h1 class="brief-title"><%= brief.title || 'Твій день під контролем' %></h1>
        <p class="brief-message"><%= brief.message || 'Критичних сигналів не знайдено, тримай темп.' %></p>
        <div class="brief-actions">
          <a class="btn btn-glass" href="<%= brief.action_href || '/schedule' %>"><%= brief.action_label || 'Відкрити розклад' %></a>
          <button type="button" class="btn btn-soft" id="briefWhyToggle">Чому я це бачу?</button>
        </div>
        <div class="brief-reasons d-none" id="briefWhyPanel">
          <% if (briefReasons.length) { %>
            <% briefReasons.forEach((reason) => { %>
              <div class="brief-reason-row"><%= reason %></div>
            <% }) %>
          <% } else { %>
            <div class="brief-reason-row">Сигнали ще накопичуються.</div>
          <% } %>
        </div>
      </section>

      <section class="cockpit-grid">
        <article class="cockpit-card section-card" id="deadlinesBlock">
          <div class="section-head">
            <h2 class="section-title">Найближчі дедлайни</h2>
            <span class="section-subtitle">2-3 задачі з найвищим пріоритетом</span>
          </div>
          <% if (!deadlineItems.length) { %>
            <div class="empty-state">
              <div class="empty-state-title">Критичних дедлайнів не знайдено</div>
              <div class="empty-state-subtitle">Система не бачить відкритих ризиків на найближчий період.</div>
            </div>
          <% } else { %>
            <div class="item-list">
              <% deadlineItems.forEach((item) => {
                   const status = getDeadlineStatus(item);
                   const isHomework = item && item.type === 'homework';
                   const canSubmitNow = Boolean(isHomework && item.can_submit);
                   const hasSubmission = Boolean(isHomework && item.submission_id);
                   const creatorName = String(item && item.created_by ? item.created_by : '').trim();
              %>
                <div class="item-row deadline-row">
                  <div class="item-main">
                    <div class="item-title"><%= item.description || 'Завдання' %></div>
                    <div class="item-meta">
                      <span><%= item.subject_name || 'Предмет' %></span>
                      <span>до <%= formatShortDate(item.deadline_date) %></span>
                      <% if (creatorName) { %><span>додав: <%= creatorName %></span><% } %>
                      <% if (item.is_control) { %><span class="type-chip">Контроль</span><% } %>
                      <% if (item.is_credit) { %><span class="type-chip">Залік</span><% } %>
                    </div>
                  </div>
                  <div class="item-side">
                    <span class="status-chip <%= status.className %>"><%= status.label %></span>
                    <% if (canSubmitNow) { %>
                      <button
                        type="button"
                        class="btn btn-submit-now"
                        data-submit-homework-id="<%= item.id %>"
                        data-submit-title="<%= item.description || 'Завдання' %>"
                        data-submit-mode="<%= hasSubmission ? 'update' : 'create' %>"
                      >
                        <%= hasSubmission ? 'Оновити здачу' : 'Здати' %>
                      </button>
                    <% } else if (isHomework && hasSubmission && item.submission_status === 'submitted_on_time') { %>
                      <span class="item-note">Здано <%= item.submitted_date || '' %></span>
                    <% } else if (isHomework && hasSubmission && item.submission_status === 'submitted_late') { %>
                      <span class="item-note">Здано із запізненням</span>
                    <% } else if (item.type === 'teamwork') { %>
                      <a href="/teamwork" class="btn btn-inline-link">Відкрити</a>
                    <% } else { %>
                      <a href="/schedule" class="btn btn-inline-link">Відкрити</a>
                    <% } %>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
          <div class="section-footer-link">
            <a href="/schedule">Відкрити повний список у розкладі</a>
          </div>
        </article>

        <article class="cockpit-card section-card">
          <div class="section-head">
            <h2 class="section-title">Пари найближчим часом</h2>
            <span class="section-subtitle">Сьогодні та завтра</span>
          </div>
          <% if (!classItems.length) { %>
            <div class="empty-state">
              <div class="empty-state-title">Найближчих пар немає</div>
              <div class="empty-state-subtitle">Перевір розклад, якщо очікуєш зміни.</div>
            </div>
          <% } else { %>
            <div class="item-list">
              <% classItems.forEach((item) => { %>
                <div class="item-row class-row">
                  <div class="item-main">
                    <div class="item-title"><%= item.subject_name || 'Предмет' %></div>
                    <div class="item-meta">
                      <span class="type-chip"><%= getDayContext(item) %></span>
                      <span>Пара <%= item.class_number || '-' %></span>
                      <span><%= item.start || '--:--' %> - <%= item.end || '--:--' %></span>
                      <% if (item.group_number) { %><span>Група <%= item.group_number %></span><% } %>
                    </div>
                  </div>
                  <div class="item-side">
                    <a href="/schedule" class="btn btn-inline-link">До розкладу</a>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </article>

        <% if (hasProgressDashboard) { %>
          <article class="cockpit-card section-card" id="progressRiskBlock">
            <div class="section-head">
              <h2 class="section-title">Прогрес і ризик</h2>
              <span class="section-subtitle">Прогноз фіналу та ризик недопуску</span>
            </div>

            <div class="summary-grid progress-summary-grid">
              <div class="summary-pill">
                <span>У ризику</span>
                <strong><%= Number(progressDashboard.at_risk_count || 0) %></strong>
              </div>
              <div class="summary-pill">
                <span>Високий</span>
                <strong><%= Number(progressDashboard.high_risk_count || 0) %></strong>
              </div>
              <div class="summary-pill">
                <span>Ціль</span>
                <strong><%= Number(progressDashboard.admission_target || 60) %></strong>
              </div>
              <div class="summary-pill">
                <span>Вчасно</span>
                <strong><%= progressDashboard.overall_on_time_share === null || typeof progressDashboard.overall_on_time_share === 'undefined' ? '-' : `${progressDashboard.overall_on_time_share}%` %></strong>
              </div>
            </div>

            <% if (!progressSubjects.length) { %>
              <div class="empty-state compact">
                <div class="empty-state-title">Поки немає даних прогресу</div>
                <div class="empty-state-subtitle">Потрібні оцінені активності для побудови прогнозу.</div>
              </div>
            <% } else { %>
              <div class="item-list progress-list">
                <% progressSubjects.slice(0, 8).forEach((item) => {
                     const riskMeta = getProgressRiskMeta(item);
                %>
                  <div class="item-row progress-row">
                    <div class="item-main">
                      <div class="item-title"><%= item.subject_name || 'Предмет' %></div>
                      <div class="item-meta">
                        <span>Фінал: <strong><%= Number(item.current_final_score || 0) %></strong> / 100</span>
                        <span>Стеля: <strong><%= Number(item.max_reachable_final_score || 0) %></strong></span>
                        <span>Прострочок: <%= Number(item.overdue_count || 0) %></span>
                        <span>Вчасно: <%= item.on_time_share === null || typeof item.on_time_share === 'undefined' ? '-' : `${item.on_time_share}%` %></span>
                      </div>
                      <div class="progress-track">
                        <span style="width: <%= Math.max(0, Math.min(100, Number(item.current_final_score || 0))) %>%"></span>
                      </div>
                      <div class="progress-note"><%= item.risk_reason || '' %></div>
                    </div>
                    <div class="item-side">
                      <span class="status-chip <%= riskMeta.className %>"><%= riskMeta.label %></span>
                      <button
                        type="button"
                        class="btn btn-inline-link progress-whatif-btn"
                        data-progress-subject-id="<%= item.subject_id %>"
                      >
                        What-if
                      </button>
                      <a class="btn btn-inline-link" href="<%= item.review_href || '/journal' %>">Журнал</a>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </article>
        <% } %>

        <% if (hasReviewQueue) { %>
          <article class="cockpit-card section-card review-queue-card" id="reviewQueueBlock">
            <div class="section-head">
              <h2 class="section-title">Черга перевірки</h2>
              <span class="section-subtitle">Пріоритет: прострочені, нові, без коментаря</span>
            </div>

            <div class="summary-grid review-summary-grid">
              <div class="summary-pill">
                <span>Всього</span>
                <strong><%= Number(reviewQueue.total || reviewQueueItems.length || 0) %></strong>
              </div>
              <div class="summary-pill">
                <span>Прострочені</span>
                <strong><%= Number(reviewQueueCounts.overdue || 0) %></strong>
              </div>
              <div class="summary-pill">
                <span>Нові</span>
                <strong><%= Number(reviewQueueCounts.new || 0) %></strong>
              </div>
              <div class="summary-pill">
                <span>Без коментаря</span>
                <strong><%= Number(reviewQueueCounts.no_comment || 0) %></strong>
              </div>
            </div>

            <div class="review-queue-toolbar">
              <div class="review-filter-group" id="reviewQueueFilters">
                <button type="button" class="btn btn-soft btn-xs review-filter-btn is-active" data-review-filter="all">Всі</button>
                <button type="button" class="btn btn-soft btn-xs review-filter-btn" data-review-filter="overdue">Прострочені</button>
                <button type="button" class="btn btn-soft btn-xs review-filter-btn" data-review-filter="new">Нові</button>
                <button type="button" class="btn btn-soft btn-xs review-filter-btn" data-review-filter="no_comment">Без коментаря</button>
              </div>
              <% if (reviewQueueTemplates.length) { %>
                <div class="review-template-group" id="reviewQueueTemplates">
                  <span class="review-template-label">Шаблон фідбеку:</span>
                  <% reviewQueueTemplates.forEach((template, index) => { %>
                    <button
                      type="button"
                      class="btn btn-soft btn-xs review-template-btn <%= index === 0 ? 'is-active' : '' %>"
                      data-template-text="<%= template.text %>"
                    >
                      <%= template.label %>
                    </button>
                  <% }) %>
                  <button type="button" class="btn btn-soft btn-xs review-template-btn" data-template-clear="1">Без шаблону</button>
                </div>
              <% } %>
            </div>

            <% if (!reviewQueueItems.length) { %>
              <div class="empty-state compact">
                <div class="empty-state-title">Черга перевірки порожня</div>
                <div class="empty-state-subtitle">Усі здані роботи з коментарями або без задач на ревʼю.</div>
              </div>
            <% } else { %>
              <div class="item-list review-queue-list">
                <% reviewQueueItems.forEach((item) => {
                     const queueMeta = getReviewQueueTypeMeta(item);
                     const submissionMeta = getSubmissionStatusMeta(item);
                     const hasScore = Number.isFinite(Number(item.score));
                %>
                  <div class="item-row review-row" data-queue-type="<%= item.queue_type || 'new' %>">
                    <div class="item-main">
                      <div class="item-title"><%= item.student_name || 'Студент' %></div>
                      <div class="item-meta">
                        <span><%= item.subject_name || 'Предмет' %></span>
                        <% if (item.student_group) { %><span>Група <%= item.student_group %></span><% } %>
                        <span>Колонка: <%= item.column_title || 'Колонка' %></span>
                        <span>Здано: <%= formatDateTime(item.submitted_at) %></span>
                        <% if (item.due_date) { %><span>Дедлайн: <%= formatShortDate(item.due_date) %></span><% } %>
                        <% if (hasScore) { %><span>Бал: <%= String(item.score).replace(/\.00$/, '') %></span><% } %>
                      </div>
                    </div>
                    <div class="item-side">
                      <span class="status-chip <%= queueMeta.className %>"><%= queueMeta.label %></span>
                      <% if (submissionMeta) { %>
                        <span class="<%= submissionMeta.className %>"><%= submissionMeta.label %></span>
                      <% } %>
                      <a class="btn btn-inline-link review-open-link" href="<%= item.review_href %>">Перевірити</a>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
            <% if (reviewQueue.truncated) { %>
              <div class="section-footer-link review-footer-note">
                Показано перші <%= reviewQueueItems.length %> записів. Уточни фільтр або предмет у журналі.
              </div>
            <% } %>
            <div class="section-footer-link">
              <a href="/journal">Перейти в журнал</a>
            </div>
          </article>
        <% } %>

        <article class="cockpit-card section-card" id="inboxBlock">
          <div class="section-head">
            <h2 class="section-title">Пульс та інбокс</h2>
            <span class="section-subtitle">Швидкий зріз прогресу і сигналів</span>
          </div>

          <div class="summary-grid">
            <div class="summary-pill">
              <span>Вчасно</span>
              <strong><%= activity.on_time_share === null || typeof activity.on_time_share === 'undefined' ? '-' : `${activity.on_time_share}%` %></strong>
            </div>
            <div class="summary-pill">
              <span>Прострочки</span>
              <strong><%= activity.overdue || 0 %></strong>
            </div>
            <div class="summary-pill">
              <span>У ризику</span>
              <strong><%= activity.risky_subjects || 0 %></strong>
            </div>
            <div class="summary-pill">
              <span>Новий фідбек</span>
              <strong><%= activity.recent_feedback || 0 %></strong>
            </div>
          </div>

          <div class="inbox-list">
            <% inboxItems.forEach((item) => { %>
              <div class="inbox-item inbox-<%= item.kind || 'info' %>">
                <div class="inbox-main">
                  <div class="inbox-title"><%= item.title || 'Оновлення' %></div>
                  <div class="inbox-meta"><%= item.meta || '' %></div>
                </div>
                <a class="btn btn-inline-link" href="<%= item.action_href || '/schedule' %>"><%= item.action_label || 'Відкрити' %></a>
              </div>
            <% }) %>
          </div>

          <div class="whatif-block" id="whatIfBlock">
            <div class="whatif-header">
              <h3>What-if калькулятор</h3>
              <span>Скільки потрібно на наступних роботах</span>
            </div>
            <% if (!whatIfSubjects.length) { %>
              <div class="empty-state compact">
                <div class="empty-state-title">Немає доступних предметів</div>
                <div class="empty-state-subtitle">Калькулятор працює для твоїх предметів з журналу.</div>
              </div>
            <% } else { %>
              <div class="whatif-controls">
                <select id="whatIfSubject" class="form-select reminder-input">
                  <% whatIfSubjects.forEach((item) => { %>
                    <option value="<%= item.subject_id %>" <%= defaultWhatIfSubjectId === Number(item.subject_id) ? 'selected' : '' %>>
                      <%= item.subject_name %>
                    </option>
                  <% }) %>
                </select>
                <div class="whatif-targets">
                  <button type="button" class="btn btn-soft btn-xs whatif-target-btn" data-whatif-target="60">60</button>
                  <button type="button" class="btn btn-soft btn-xs whatif-target-btn is-active" data-whatif-target="75">75</button>
                  <button type="button" class="btn btn-soft btn-xs whatif-target-btn" data-whatif-target="90">90</button>
                </div>
              </div>
              <div class="whatif-result" id="whatIfResult">
                <div class="whatif-result-line">Обери ціль, щоб побачити потрібний темп.</div>
              </div>
            <% } %>
          </div>

          <div class="reminder-block">
            <div class="reminder-header">
              <h3>Нагадування</h3>
              <button type="button" class="btn btn-soft btn-sm" id="toggleReminderForm">Додати</button>
            </div>
            <form id="reminderForm" class="reminder-form d-none">
              <input type="hidden" id="reminderEditId" value="" />
              <div class="reminder-row">
                <input type="text" id="reminderTitle" class="form-control reminder-input" maxlength="160" placeholder="Назва нагадування" required />
              </div>
              <div class="reminder-row">
                <textarea id="reminderNote" class="form-control reminder-input" rows="2" maxlength="500" placeholder="Нотатка (опційно)"></textarea>
              </div>
              <div class="reminder-row reminder-row-split">
                <input type="date" id="reminderDate" class="form-control reminder-input" required />
                <input type="time" id="reminderTime" class="form-control reminder-input" />
              </div>
              <div class="reminder-actions">
                <button type="submit" class="btn btn-glass btn-sm" id="reminderSubmit">Додати</button>
                <button type="button" class="btn btn-soft btn-sm" id="reminderCancel">Скасувати</button>
              </div>
            </form>
            <div id="reminderList" class="reminder-list">
              <% if (!reminders.length) { %>
                <div class="empty-state compact">
                  <div class="empty-state-title">Нагадувань немає</div>
                  <div class="empty-state-subtitle">Додай перше на найближчий тиждень.</div>
                </div>
              <% } else { %>
                <% reminders.forEach((reminder) => { %>
                  <div class="reminder-item">
                    <div class="reminder-main">
                      <div class="reminder-title <%= reminder.is_done ? 'done' : '' %>"><%= reminder.title %></div>
                      <div class="reminder-meta"><%= formatReminderDate(reminder.remind_date) %><%= reminder.remind_time ? ` · ${reminder.remind_time}` : '' %></div>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            </div>
          </div>
        </article>

        <article class="cockpit-card section-card" id="competencyBlock">
          <div class="section-head">
            <h2 class="section-title">Компас компетентностей</h2>
            <span class="section-subtitle">Портфоліо сильних сторін і точок росту</span>
          </div>

          <div class="competency-hero">
            <div class="competency-orb" id="competencyOrb">
              <div class="competency-orb-core">
                <strong><%= cockpit.competency_total_marks || 0 %></strong>
                <span>відміток</span>
              </div>
            </div>
            <div class="competency-insights">
              <div class="competency-insight">
                <span>Сильна</span>
                <strong><%= cockpit.competency_strongest ? cockpit.competency_strongest.label : 'Накопичуємо дані' %></strong>
              </div>
              <div class="competency-insight">
                <span>Зростає</span>
                <strong>
                  <% if (cockpit.competency_fastest_growth) { %>
                    <%= cockpit.competency_fastest_growth.label %>
                    <% if (cockpit.competency_fastest_growth.delta > 0) { %>+<%= cockpit.competency_fastest_growth.delta %><% } else { %><%= cockpit.competency_fastest_growth.delta %><% } %>
                  <% } else { %>
                    Накопичуємо дані
                  <% } %>
                </strong>
              </div>
              <div class="competency-insight">
                <span>Підтягнути</span>
                <strong><%= cockpit.competency_weakest ? cockpit.competency_weakest.label : 'Накопичуємо дані' %></strong>
              </div>
            </div>
          </div>

          <div class="competency-list">
            <% if (!competencies.length) { %>
              <div class="empty-state compact">
                <div class="empty-state-title">Ще немає достатньо даних</div>
                <div class="empty-state-subtitle">Після оцінених активностей з'явиться портрет компетентностей.</div>
              </div>
            <% } else { %>
              <% competencies.forEach((item, index) => { %>
                <div class="competency-item" data-color-index="<%= index %>">
                  <div class="competency-head">
                    <span class="competency-name"><%= item.label %></span>
                    <span class="competency-score"><%= item.count %></span>
                  </div>
                  <div class="competency-bar">
                    <span style="width: <%= Math.max(0, Math.min(100, Number(item.bar_percent || 0))) %>%"></span>
                  </div>
                  <div class="competency-delta <%= item.trend === 'up' ? 'trend-up' : (item.trend === 'down' ? 'trend-down' : 'trend-neutral') %>">
                    <% if (item.delta > 0) { %>+<%= item.delta %><% } else { %><%= item.delta %><% } %>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </article>
      </section>
    </main>

    <div class="modal fade" id="homeworkSubmitModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-modal">
          <form id="homeworkSubmitForm" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="redirect_to" value="/my-day" />
            <div class="modal-header">
              <h5 class="modal-title">Здати завдання</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="submit-target" id="submitHomeworkTarget">Завдання</div>
              <div class="mb-3">
                <label for="submissionText" class="form-label">Текст</label>
                <textarea id="submissionText" name="submission_text" class="form-control reminder-input" rows="4" maxlength="4000" placeholder="Опиши відповідь або короткий підсумок"></textarea>
              </div>
              <div class="mb-3">
                <label for="submissionLink" class="form-label">Посилання</label>
                <input id="submissionLink" name="link_url" class="form-control reminder-input" type="url" placeholder="https://..." />
              </div>
              <div>
                <label for="submissionAttachment" class="form-label">Файл</label>
                <input id="submissionAttachment" name="submission_attachment" class="form-control reminder-input" type="file" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-soft" data-bs-dismiss="modal">Скасувати</button>
              <button type="submit" class="btn btn-glass">Здати</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <%- include('partials/app-footer') %>
    <%- include('partials/changelog-modal') %>
    <%- include('partials/mobile-menu-modal', { role, t, activePage: 'my-day' }) %>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const myDay = <%- JSON.stringify(myDay || {}) %>;
      const themeToggles = document.querySelectorAll('.theme-toggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-dark';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      themeToggles.forEach((btn) => {
        btn.textContent = storedTheme === 'theme-dark' ? btn.dataset.lightLabel : btn.dataset.darkLabel;
        btn.addEventListener('click', () => {
          const isDark = document.body.classList.contains('theme-dark');
          const next = isDark ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-dark', 'theme-light');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggles.forEach((toggle) => {
            toggle.textContent = next === 'theme-dark' ? toggle.dataset.lightLabel : toggle.dataset.darkLabel;
          });
        });
      });

      const briefWhyToggle = document.getElementById('briefWhyToggle');
      const briefWhyPanel = document.getElementById('briefWhyPanel');
      if (briefWhyToggle && briefWhyPanel) {
        briefWhyToggle.addEventListener('click', () => {
          briefWhyPanel.classList.toggle('d-none');
        });
      }

      const submitModalElement = document.getElementById('homeworkSubmitModal');
      const submitForm = document.getElementById('homeworkSubmitForm');
      const submitModalTitle = submitModalElement ? submitModalElement.querySelector('.modal-title') : null;
      const submitTarget = document.getElementById('submitHomeworkTarget');
      const submissionText = document.getElementById('submissionText');
      const submissionLink = document.getElementById('submissionLink');
      const submissionAttachment = document.getElementById('submissionAttachment');
      const submitFormButton = submitForm ? submitForm.querySelector('button[type="submit"]') : null;
      const submitModal = submitModalElement ? new bootstrap.Modal(submitModalElement) : null;

      document.querySelectorAll('[data-submit-homework-id]').forEach((button) => {
        button.addEventListener('click', () => {
          const homeworkId = Number(button.dataset.submitHomeworkId || 0);
          const homeworkTitle = String(button.dataset.submitTitle || 'Завдання');
          const submitMode = String(button.dataset.submitMode || 'create');
          const isUpdateMode = submitMode === 'update';
          if (!homeworkId || !submitForm) return;
          submitForm.action = `/homework/${homeworkId}/submit`;
          if (submitModalTitle) {
            submitModalTitle.textContent = isUpdateMode ? 'Оновити здачу завдання' : 'Здати завдання';
          }
          if (submitFormButton) {
            submitFormButton.textContent = isUpdateMode ? 'Оновити здачу' : 'Здати';
          }
          if (submitTarget) submitTarget.textContent = homeworkTitle;
          if (submissionText) submissionText.value = '';
          if (submissionLink) submissionLink.value = '';
          if (submissionAttachment) submissionAttachment.value = '';
          if (submitModal) submitModal.show();
        });
      });

      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function formatDate(value) {
        if (!value) return '-';
        const parsed = new Date(`${value}T00:00:00`);
        if (Number.isNaN(parsed.getTime())) return value;
        return parsed.toLocaleDateString('uk-UA');
      }

      function setActiveWhatIfTarget(target) {
        selectedWhatIfTarget = Number(target) || 75;
        whatIfTargetButtons.forEach((button) => {
          button.classList.toggle('is-active', Number(button.dataset.whatifTarget) === selectedWhatIfTarget);
        });
      }

      function renderWhatIfResult(data, target) {
        if (!whatIfResult) return;
        const targetEntry = Array.isArray(data?.targets)
          ? data.targets.find((item) => Number(item.target) === Number(target))
          : null;
        if (!targetEntry) {
          whatIfResult.innerHTML = '<div class="whatif-result-line">Дані для обраної цілі недоступні.</div>';
          return;
        }

        if (targetEntry.reachable) {
          const average = Number(targetEntry.required_avg_percent || 0);
          const rawPoints = Number(targetEntry.required_raw_points || 0);
          whatIfResult.innerHTML = `
            <div class="whatif-result-line">
              Поточний фінал: <strong>${Number(data.current_final_score || 0)}</strong> / 100
            </div>
            <div class="whatif-result-line whatif-positive">
              Для цілі <strong>${Number(targetEntry.target || target)}</strong> потрібно в середньому
              <strong>${average}%</strong> на залишку робіт
              (${rawPoints} з ${Number(data.remaining_raw_max || 0)} сирих балів).
            </div>
            <div class="whatif-result-line muted-line">
              Теоретична стеля: ${Number(data.max_reachable_final_score || 0)} / 100.
            </div>
          `;
          return;
        }

        whatIfResult.innerHTML = `
          <div class="whatif-result-line">
            Поточний фінал: <strong>${Number(data.current_final_score || 0)}</strong> / 100
          </div>
          <div class="whatif-result-line whatif-negative">
            Ціль <strong>${Number(targetEntry.target || target)}</strong> зараз недосяжна
            (бракує ${Number(targetEntry.needed_points || 0)} балів внеску).
          </div>
          <div class="whatif-result-line muted-line">
            Теоретична стеля: ${Number(data.max_reachable_final_score || 0)} / 100.
          </div>
        `;
      }

      async function loadWhatIf(targetValue) {
        if (!whatIfSubject || !whatIfResult) return;
        const subjectId = Number(whatIfSubject.value || 0);
        if (!subjectId) return;
        const target = Number(targetValue || selectedWhatIfTarget || 75);
        setActiveWhatIfTarget(target);
        whatIfResult.innerHTML = '<div class="whatif-result-line">Рахую прогноз...</div>';
        try {
          const params = new URLSearchParams({
            subject_id: String(subjectId),
            target: String(target),
          });
          const response = await fetch(`/api/my-day/what-if?${params.toString()}`);
          if (!response.ok) {
            whatIfResult.innerHTML = '<div class="whatif-result-line">Не вдалося отримати прогноз.</div>';
            return;
          }
          const data = await response.json();
          renderWhatIfResult(data, target);
        } catch (err) {
          console.error(err);
          whatIfResult.innerHTML = '<div class="whatif-result-line">Помилка при розрахунку прогнозу.</div>';
        }
      }

      const reminderForm = document.getElementById('reminderForm');
      const toggleReminderForm = document.getElementById('toggleReminderForm');
      const reminderTitle = document.getElementById('reminderTitle');
      const reminderNote = document.getElementById('reminderNote');
      const reminderDate = document.getElementById('reminderDate');
      const reminderTime = document.getElementById('reminderTime');
      const reminderEditId = document.getElementById('reminderEditId');
      const reminderSubmit = document.getElementById('reminderSubmit');
      const reminderCancel = document.getElementById('reminderCancel');
      const reminderList = document.getElementById('reminderList');
      let reminders = Array.isArray(myDay.reminders) ? myDay.reminders : [];
      const whatIfSubject = document.getElementById('whatIfSubject');
      const whatIfResult = document.getElementById('whatIfResult');
      const whatIfTargetButtons = Array.from(document.querySelectorAll('.whatif-target-btn'));
      const progressWhatIfButtons = Array.from(document.querySelectorAll('.progress-whatif-btn'));
      const reviewFilterButtons = Array.from(document.querySelectorAll('.review-filter-btn'));
      const reviewRows = Array.from(document.querySelectorAll('.review-row'));
      const reviewTemplateButtons = Array.from(document.querySelectorAll('.review-template-btn'));
      const reviewOpenLinks = Array.from(document.querySelectorAll('.review-open-link'));
      let selectedWhatIfTarget = 75;
      let selectedReviewTemplateText = '';

      if (reminderDate && myDay.today) {
        reminderDate.value = myDay.today;
      }

      function resetReminderForm() {
        if (!reminderTitle || !reminderNote || !reminderDate || !reminderTime || !reminderEditId || !reminderSubmit) return;
        reminderTitle.value = '';
        reminderNote.value = '';
        reminderDate.value = myDay.today || '';
        reminderTime.value = '';
        reminderEditId.value = '';
        reminderSubmit.textContent = 'Додати';
      }

      function renderReminders(list) {
        if (!reminderList) return;
        if (!Array.isArray(list) || !list.length) {
          reminderList.innerHTML = `
            <div class="empty-state compact">
              <div class="empty-state-title">Нагадувань немає</div>
              <div class="empty-state-subtitle">Додай перше на найближчий тиждень.</div>
            </div>
          `;
          return;
        }

        reminderList.innerHTML = list.map((reminder) => {
          const dateLabel = formatDate(reminder.remind_date);
          const timeLabel = reminder.remind_time ? ` · ${escapeHtml(reminder.remind_time)}` : '';
          const doneClass = reminder.is_done ? 'done' : '';
          const toggleLabel = reminder.is_done ? 'Відновити' : 'Готово';
          return `
            <div class="reminder-item" data-reminder-id="${reminder.id}">
              <div class="reminder-main">
                <div class="reminder-title ${doneClass}">${escapeHtml(reminder.title)}</div>
                ${reminder.note ? `<div class="reminder-note">${escapeHtml(reminder.note)}</div>` : ''}
                <div class="reminder-meta">${escapeHtml(dateLabel)}${timeLabel}</div>
              </div>
              <div class="reminder-actions-inline">
                <button type="button" class="btn btn-soft btn-xs reminder-toggle" data-id="${reminder.id}" data-done="${reminder.is_done ? '1' : '0'}">${toggleLabel}</button>
                <button type="button" class="btn btn-soft btn-xs reminder-edit" data-id="${reminder.id}">Редагувати</button>
                <button type="button" class="btn btn-soft btn-xs reminder-delete" data-id="${reminder.id}">Видалити</button>
              </div>
            </div>
          `;
        }).join('');

        reminderList.querySelectorAll('.reminder-toggle').forEach((button) => {
          button.addEventListener('click', toggleReminder);
        });
        reminderList.querySelectorAll('.reminder-edit').forEach((button) => {
          button.addEventListener('click', editReminder);
        });
        reminderList.querySelectorAll('.reminder-delete').forEach((button) => {
          button.addEventListener('click', deleteReminder);
        });
      }

      function applyReviewFilter(filterKey) {
        const targetFilter = String(filterKey || 'all');
        reviewRows.forEach((row) => {
          const rowType = String(row.dataset.queueType || 'new');
          const shouldShow = targetFilter === 'all' || rowType === targetFilter;
          row.classList.toggle('d-none', !shouldShow);
        });
        reviewFilterButtons.forEach((button) => {
          button.classList.toggle('is-active', String(button.dataset.reviewFilter || '') === targetFilter);
        });
      }

      function setReviewTemplate(text, clearOnly = false) {
        selectedReviewTemplateText = clearOnly ? '' : String(text || '').trim();
        reviewTemplateButtons.forEach((button) => {
          const isClear = button.dataset.templateClear === '1';
          const buttonText = String(button.dataset.templateText || '').trim();
          const isActive = clearOnly
            ? isClear
            : (!isClear && buttonText && buttonText === selectedReviewTemplateText);
          button.classList.toggle('is-active', isActive);
        });
      }

      async function loadReminders() {
        if (!myDay.today || !myDay.reminders_window_end) return;
        try {
          const params = new URLSearchParams({
            from: myDay.today,
            to: myDay.reminders_window_end,
            status: 'all',
          });
          const response = await fetch(`/api/reminders?${params.toString()}`);
          if (!response.ok) return;
          const data = await response.json();
          reminders = Array.isArray(data.reminders) ? data.reminders : [];
          renderReminders(reminders);
        } catch (err) {
          console.error(err);
        }
      }

      async function toggleReminder(event) {
        const button = event.target.closest('.reminder-toggle');
        if (!button) return;
        const reminderId = button.dataset.id;
        const isDone = button.dataset.done === '1';
        button.disabled = true;
        try {
          const response = await fetch(`/api/reminders/${reminderId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_done: !isDone }),
          });
          if (!response.ok) return;
          await loadReminders();
        } catch (err) {
          console.error(err);
        } finally {
          button.disabled = false;
        }
      }

      function editReminder(event) {
        const button = event.target.closest('.reminder-edit');
        if (!button || !reminderForm) return;
        const reminderId = button.dataset.id;
        const reminder = reminders.find((item) => String(item.id) === String(reminderId));
        if (!reminder) return;
        reminderForm.classList.remove('d-none');
        reminderTitle.value = reminder.title || '';
        reminderNote.value = reminder.note || '';
        reminderDate.value = reminder.remind_date || myDay.today || '';
        reminderTime.value = reminder.remind_time || '';
        reminderEditId.value = reminder.id;
        reminderSubmit.textContent = 'Оновити';
        reminderTitle.focus();
      }

      async function deleteReminder(event) {
        const button = event.target.closest('.reminder-delete');
        if (!button) return;
        const reminderId = button.dataset.id;
        if (!confirm('Видалити нагадування?')) return;
        button.disabled = true;
        try {
          const response = await fetch(`/api/reminders/${reminderId}`, { method: 'DELETE' });
          if (!response.ok) return;
          await loadReminders();
        } catch (err) {
          console.error(err);
        } finally {
          button.disabled = false;
        }
      }

      if (toggleReminderForm && reminderForm) {
        toggleReminderForm.addEventListener('click', () => {
          reminderForm.classList.toggle('d-none');
          if (!reminderForm.classList.contains('d-none')) {
            reminderTitle.focus();
          }
        });
      }

      if (reminderCancel && reminderForm) {
        reminderCancel.addEventListener('click', () => {
          resetReminderForm();
          reminderForm.classList.add('d-none');
        });
      }

      if (reminderForm) {
        reminderForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!reminderTitle.value.trim() || !reminderDate.value) return;
          reminderSubmit.disabled = true;
          try {
            const payload = {
              title: reminderTitle.value.trim(),
              note: reminderNote.value.trim(),
              remind_date: reminderDate.value,
              remind_time: reminderTime.value,
            };
            const editId = reminderEditId.value;
            const response = await fetch(editId ? `/api/reminders/${editId}` : '/api/reminders', {
              method: editId ? 'PATCH' : 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            if (!response.ok) return;
            await loadReminders();
            resetReminderForm();
            reminderForm.classList.add('d-none');
          } catch (err) {
            console.error(err);
          } finally {
            reminderSubmit.disabled = false;
          }
        });
      }

      const palette = ['#4f9dff', '#2dd4bf', '#f59e0b', '#fb7185', '#22c55e', '#a78bfa', '#38bdf8', '#f97316'];
      const competencyOrb = document.getElementById('competencyOrb');
      const competencyItems = document.querySelectorAll('.competency-item');

      function hexToRgba(hex, alpha) {
        const normalized = String(hex || '').replace('#', '');
        if (normalized.length !== 6) return `rgba(79, 157, 255, ${alpha})`;
        const r = Number.parseInt(normalized.slice(0, 2), 16);
        const g = Number.parseInt(normalized.slice(2, 4), 16);
        const b = Number.parseInt(normalized.slice(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      const competencyData = Array.isArray(myDay.competencies) ? myDay.competencies : [];
      if (competencyOrb && competencyData.length) {
        const totalMarks = competencyData.reduce((sum, entry) => (
          sum + Math.max(0, Number(entry && entry.count ? entry.count : 0))
        ), 0);
        const equalStep = competencyData.length ? (100 / competencyData.length) : 0;
        let start = 0;
        const segments = competencyData.map((entry, index) => {
          const count = Math.max(0, Number(entry && entry.count ? entry.count : 0));
          const step = totalMarks > 0
            ? ((count / totalMarks) * 100)
            : equalStep;
          const end = index === competencyData.length - 1 ? 100 : Math.max(start, Math.min(100, start + step));
          const alpha = totalMarks > 0
            ? (0.3 + Math.min(0.65, (step / 100) * 1.3))
            : 0.45;
          const color = hexToRgba(palette[index % palette.length], alpha);
          const segment = `${color} ${start}% ${end}%`;
          start = end;
          return segment;
        });
        competencyOrb.style.setProperty('--orb-gradient', `conic-gradient(${segments.join(',')})`);
      }

      competencyItems.forEach((item, index) => {
        const color = palette[index % palette.length];
        item.style.setProperty('--competency-color', color);
      });

      renderReminders(reminders);
      if (progressWhatIfButtons.length && whatIfSubject && whatIfResult) {
        progressWhatIfButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const subjectId = String(button.dataset.progressSubjectId || '').trim();
            if (!subjectId) return;
            const option = Array.from(whatIfSubject.options || []).find((item) => String(item.value) === subjectId);
            if (!option) return;
            whatIfSubject.value = subjectId;
            loadWhatIf(selectedWhatIfTarget);
            const whatIfBlock = document.getElementById('whatIfBlock');
            if (whatIfBlock) {
              whatIfBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          });
        });
      }
      if (reviewFilterButtons.length && reviewRows.length) {
        reviewFilterButtons.forEach((button) => {
          button.addEventListener('click', () => {
            applyReviewFilter(button.dataset.reviewFilter || 'all');
          });
        });
        applyReviewFilter('all');
      }
      if (reviewTemplateButtons.length) {
        const firstTemplateButton = reviewTemplateButtons.find((button) => button.dataset.templateText);
        if (firstTemplateButton) {
          setReviewTemplate(firstTemplateButton.dataset.templateText || '', false);
        }
        reviewTemplateButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const isClear = button.dataset.templateClear === '1';
            if (isClear) {
              setReviewTemplate('', true);
              return;
            }
            setReviewTemplate(button.dataset.templateText || '', false);
          });
        });
      }
      if (reviewOpenLinks.length) {
        reviewOpenLinks.forEach((link) => {
          link.addEventListener('click', (event) => {
            if (!selectedReviewTemplateText) return;
            if (event.defaultPrevented) return;
            if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
            const href = link.getAttribute('href');
            if (!href) return;
            event.preventDefault();
            const url = new URL(href, window.location.origin);
            if (!url.searchParams.get('prefill_comment')) {
              url.searchParams.set('prefill_comment', selectedReviewTemplateText);
            }
            window.location.assign(`${url.pathname}${url.search}`);
          });
        });
      }
      if (whatIfSubject && whatIfResult) {
        whatIfSubject.addEventListener('change', () => {
          loadWhatIf(selectedWhatIfTarget);
        });
        whatIfTargetButtons.forEach((button) => {
          button.addEventListener('click', () => {
            loadWhatIf(Number(button.dataset.whatifTarget || 75));
          });
        });
        loadWhatIf(selectedWhatIfTarget);
      }
    </script>
    <script src="/js/design-system.js" defer></script>
  </body>
</html>
