<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ú—ñ–π –¥–µ–Ω—å ‚Ä¢ Studerria</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4BWykR7C6E2t5O1io8nqv9xD7ZJ8Q0P0p2Jp8h8cEytx0x8pJ0pC5GmVn2FQ9B8L"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --card-gap: 1.5rem;
        --card-radius: 18px;
        --input-radius: 12px;
      }

      body.theme-dark {
        background: radial-gradient(circle at top, #1b2a52, #0c1224 55%, #090b17 100%);
        color: #e7ecf3;
      }
      body.theme-light {
        background: radial-gradient(circle at top, #eef3ff, #e7f0ff 45%, #f7f9ff 100%);
        color: #111827;
      }

      /* Topbar */
      .topbar {
        backdrop-filter: blur(16px);
        background: rgba(12, 18, 36, 0.65);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.75rem 0;
      }
      body.theme-light .topbar {
        background: rgba(247, 249, 255, 0.85);
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
      }
      .topbar .container-fluid {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .topbar .navbar-brand {
        font-weight: 700;
        font-size: 1.25rem;
        margin-right: auto;
      }
      .topbar-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .topbar-actions form {
        display: contents;
      }
      @media (max-width: 991px) {
        .topbar-actions {
          flex-basis: 100%;
          order: 3;
          gap: 0.3rem;
        }
      }
      .topbar .mobile-only {
        display: none;
      }
      @media (max-width: 991px) {
        .topbar .desktop-only {
          display: none !important;
        }
        .topbar .mobile-only {
          display: inline-flex !important;
        }
      }

      /* Glass card base */
      .glass {
        position: relative;
        isolation: isolate;
        overflow: clip;
        background-clip: padding-box;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(14px);
        border-radius: var(--card-radius);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
      }
      body.theme-light .glass {
        background: rgba(255, 255, 255, 0.75);
        border-color: rgba(15, 23, 42, 0.08);
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
      }

      /* Typography */
      .hero-title {
        font-size: clamp(1.8rem, 2.8vw, 2.8rem);
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      .hero-sub {
        font-size: 0.95rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
      }
      body.theme-light .hero-sub {
        color: rgba(15, 23, 42, 0.65);
      }

      .card-heading {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: inherit;
      }

      /* Main layout */
      main {
        padding: 2rem 1rem;
      }
      @media (min-width: 768px) {
        main {
          padding: 2.5rem 2rem;
        }
      }

      .header-card {
        padding: 1.5rem !important;
      }
      @media (max-width: 576px) {
        .header-card {
          padding: 1.2rem !important;
        }
      }

      .header-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      @media (min-width: 768px) {
        .header-content {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          gap: 1.5rem;
        }
      }

      /* Grid layout */
      .myday-grid {
        display: grid;
        gap: var(--card-gap);
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        margin-top: 2rem;
      }
      @media (min-width: 1400px) {
        .myday-grid {
          grid-template-columns: repeat(4, 1fr);
        }
        .myday-grid > :nth-child(5) {
          grid-column: 1 / -1;
        }
      }
      @media (min-width: 768px) and (max-width: 1399px) {
        .myday-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .myday-grid > :nth-child(5) {
          grid-column: 1 / -1;
        }
      }

      .myday-card {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        min-height: 320px;
      }
      @media (max-width: 576px) {
        .myday-card {
          padding: 1.2rem;
          min-height: 280px;
        }
      }

      /* Empty states */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
        text-align: center;
        min-height: 200px;
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .empty-state {
        color: rgba(15, 23, 42, 0.6);
      }
      .empty-state-emoji {
        font-size: 3rem;
        margin-bottom: 0.75rem;
        opacity: 0.6;
      }
      .empty-state-text {
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 0.5rem;
      }
      .empty-state-hint {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 0.5rem;
      }

      /* Stat pill */
      .stat-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.12);
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
      }
      body.theme-light .stat-pill {
        background: rgba(15, 23, 42, 0.08);
      }

      /* Item components */
      .deadline-item,
      .reminder-item {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        padding: 0.75rem 1rem;
        border-radius: var(--input-radius);
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 200ms ease;
      }
      .deadline-item:hover,
      .reminder-item:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.14);
      }
      body.theme-light .deadline-item,
      body.theme-light .reminder-item {
        background: rgba(15, 23, 42, 0.04);
        border-color: rgba(15, 23, 42, 0.1);
      }
      body.theme-light .deadline-item:hover,
      body.theme-light .reminder-item:hover {
        background: rgba(15, 23, 42, 0.08);
        border-color: rgba(15, 23, 42, 0.15);
      }

      .item-content {
        flex: 1;
        min-width: 0;
      }
      .item-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .item-meta {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.65);
      }
      body.theme-light .item-meta {
        color: rgba(15, 23, 42, 0.6);
      }

      .item-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }

      /* Form controls */
      .reminder-form {
        display: grid;
        gap: 0.8rem;
        padding: 1rem 0;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .reminder-form {
        border-top-color: rgba(15, 23, 42, 0.08);
      }

      .form-group {
        display: grid;
        gap: 0.4rem;
      }
      .form-label {
        font-size: 0.85rem;
        font-weight: 600;
        display: none;
      }

      .reminder-input,
      .reminder-input:focus {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.16);
        color: inherit;
        border-radius: var(--input-radius);
        padding: 0.6rem 0.85rem;
        font-size: 0.95rem;
        font-family: inherit;
        transition: all 200ms ease;
      }
      .reminder-input:focus {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.24);
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
      }
      body.theme-light .reminder-input,
      body.theme-light .reminder-input:focus {
        background: rgba(15, 23, 42, 0.05);
        border-color: rgba(15, 23, 42, 0.14);
      }
      body.theme-light .reminder-input:focus {
        background: rgba(15, 23, 42, 0.08);
        border-color: rgba(15, 23, 42, 0.2);
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.03);
      }

      .reminder-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      body.theme-light .reminder-input::placeholder {
        color: rgba(15, 23, 42, 0.45);
      }

      .reminder-input-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.8rem;
      }
      @media (max-width: 576px) {
        .reminder-input-row {
          grid-template-columns: 1fr;
        }
      }

      .reminder-form-actions {
        display: flex;
        gap: 0.6rem;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .btn-form {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 200ms ease;
        min-height: 44px;
      }
      .btn-form:hover {
        transform: translateY(-1px);
      }

      .btn-form-primary {
        background: rgba(59, 130, 246, 0.9);
        color: white;
        border: 1px solid rgba(59, 130, 246, 1);
      }
      .btn-form-primary:hover {
        background: rgba(59, 130, 246, 1);
      }

      .btn-form-secondary {
        background: rgba(255, 255, 255, 0.12);
        color: inherit;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .btn-form-secondary:hover {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(255, 255, 255, 0.24);
      }
      body.theme-light .btn-form-secondary {
        background: rgba(15, 23, 42, 0.08);
        border-color: rgba(15, 23, 42, 0.12);
      }
      body.theme-light .btn-form-secondary:hover {
        background: rgba(15, 23, 42, 0.12);
        border-color: rgba(15, 23, 42, 0.16);
      }

      /* Reminder toggle button */
      .btn-add-reminder {
        background: rgba(59, 130, 246, 0.15);
        color: rgba(59, 130, 246, 1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 0.5rem 0.9rem;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 200ms ease;
        white-space: nowrap;
      }
      .btn-add-reminder:hover {
        background: rgba(59, 130, 246, 0.25);
        border-color: rgba(59, 130, 246, 0.5);
      }

      .action-buttons {
        display: inline-flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .btn-sm-action {
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
        color: inherit;
        cursor: pointer;
        transition: all 200ms ease;
        min-height: auto;
      }
      .btn-sm-action:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .reminder-title.done {
        text-decoration: line-through;
        opacity: 0.6;
      }

      /* Items list */
      .items-list {
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        flex: 1;
      }

      .muted {
        color: rgba(255, 255, 255, 0.6);
      }
      body.theme-light .muted {
        color: rgba(15, 23, 42, 0.6);
      }

      /* Mobile menu bottom sheet */
      .modal-dialog-bottom-sheet {
        margin: 0;
        height: 100vh;
      }
      .modal-dialog-bottom-sheet .modal-content {
        margin-top: auto;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
      }
      .modal-dialog-bottom-sheet .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      body.theme-light .modal-dialog-bottom-sheet .modal-header {
        border-bottom-color: rgba(15, 23, 42, 0.08);
      }

      @media (max-width: 576px) {
        .modal-dialog-bottom-sheet .modal-body {
          max-height: 60vh;
          overflow-y: auto;
        }
      }
      /* balanced dark glass: no blur, but translucent */
      body.theme-dark .glass {
        -webkit-backdrop-filter: none !important;
        backdrop-filter: none !important;
        background: linear-gradient(180deg, rgba(24, 32, 54, 0.72) 0%, rgba(18, 24, 40, 0.78) 100%) !important;
        border: 1px solid rgba(255, 255, 255, 0.08) !important;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45), inset 0 0 0 1px rgba(255, 255, 255, 0.03) !important;
      }
</style>
  </head>
  <body class="theme-dark">
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg topbar">
      <div class="container-fluid px-3 px-lg-4">
        <span class="navbar-brand text-white me-auto">Studerria</span>
        <div class="d-flex align-items-center gap-2 topbar-actions flex-wrap justify-content-end">
          <span class="me-2 muted desktop-only text-nowrap">
            <% if (role === 'admin') { %>
              <%= t('role.admin') %>: <%= username %>
            <% } else if (role === 'starosta') { %>
              <%= t('role.starosta') %>: <%= username %>
            <% } else if (role === 'deanery') { %>
              <%= t('role.deanery') %>: <%= username %>
            <% } else { %>
              <%= t('role.student') %>: <%= username %>
            <% } %>
          </span>
          <% if (role === 'admin') { %>
            <form method="POST" action="/admin/switch-to-admin" class="me-1 desktop-only">
              <button class="btn btn-outline-primary btn-sm" type="submit"><%= t('schedule.backToAdmin') %></button>
            </form>
          <% } %>
          <% if (role === 'starosta') { %>
            <a class="btn btn-outline-primary btn-sm me-1 desktop-only" href="/starosta"><%= t('menu.starosta') %></a>
          <% } %>
          <% if (role === 'deanery') { %>
            <a class="btn btn-outline-primary btn-sm me-1 desktop-only" href="/deanery"><%= t('menu.deanery') %></a>
          <% } %>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/schedule">–†–æ–∑–∫–ª–∞–¥</a>
          <a class="btn btn-glass btn-sm me-1 desktop-only" href="/my-day">–ú—ñ–π –¥–µ–Ω—å</a>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/teamwork"><%= t('menu.teamwork') %></a>
          <button
            class="btn btn-outline-light btn-sm me-1 theme-toggle desktop-only"
            type="button"
            id="themeToggle"
            data-light-label="<%= t('theme.light') %>"
            data-dark-label="<%= t('theme.dark') %>"
          >
            <%= t('theme.light') %>
          </button>
          <a class="btn btn-outline-light btn-sm me-1 desktop-only" href="/profile"><%= t('schedule.profile') %></a>
          <form method="POST" action="/logout" class="desktop-only">
            <button class="btn btn-outline-light btn-sm" type="submit"><%= t('schedule.logout') %></button>
          </form>
          <!-- Mobile menu button -->
          <button
            class="btn btn-outline-light btn-sm mobile-only"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#mobileMenuModal"
            aria-label="Menu"
          >
            ‚ò∞
          </button>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <main>
      <!-- Page header -->
      <div class="glass header-card mb-4">
        <div class="header-content">
          <div>
            <h1 class="hero-title">–ú—ñ–π –¥–µ–Ω—å</h1>
            <p class="hero-sub">–§–æ–∫—É—Å –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—ñ—Ö –ø–∞—Ä–∞—Ö —ñ –¥–µ–¥–ª–∞–π–Ω–∞—Ö.</p>
          </div>
          <div class="stat-pill">
            <span>–°—å–æ–≥–æ–¥–Ω—ñ:</span>
            <strong><%= myDay.today ? new Date(myDay.today).toLocaleDateString('uk-UA') : '-' %></strong>
          </div>
        </div>
      </div>

      <!-- Cards grid -->
      <div class="container-fluid">
        <div class="myday-grid">
          
          <!-- Card 1: Now/Next -->
          <div class="glass myday-card">
            <h3 class="card-heading">–ó–∞—Ä–∞–∑ / –î–∞–ª—ñ</h3>
            <div id="currentBlock" class="mb-2"></div>
            <div id="nextBlock" class="muted flex-grow-1"></div>
          </div>

          <!-- Card 2: Today's classes -->
          <div class="glass myday-card">
            <h3 class="card-heading">–ü–∞—Ä–∏ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>
            <div id="classesContainer"></div>
          </div>

          <!-- Card 3: Deadlines -->
          <div class="glass myday-card">
            <h3 class="card-heading">–î–µ–¥–ª–∞–π–Ω–∏ —Å—å–æ–≥–æ–¥–Ω—ñ/–∑–∞–≤—Ç—Ä–∞</h3>
            <div id="deadlinesContainer"></div>
          </div>

          <!-- Card 4: Reminders -->
          <div class="glass myday-card">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
              <h3 class="card-heading mb-0">–ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è</h3>
              <button class="btn-add-reminder" type="button" id="toggleReminderForm">+ –î–æ–¥–∞—Ç–∏</button>
            </div>
            
            <!-- Reminder form (hidden by default) -->
            <form id="reminderForm" class="reminder-form d-none">
              <div class="form-group">
                <input class="reminder-input" type="text" id="reminderTitle" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫" required />
              </div>
              <div class="form-group">
                <textarea class="reminder-input" id="reminderNote" rows="2" placeholder="–ù–æ—Ç–∞—Ç–∫–∞ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)"></textarea>
              </div>
              <div class="reminder-input-row">
                <div class="form-group">
                  <input class="reminder-input" type="date" id="reminderDate" required />
                </div>
                <div class="form-group">
                  <input class="reminder-input" type="time" id="reminderTime" />
                </div>
              </div>
              <div class="reminder-form-actions">
                <button class="btn-form btn-form-primary" type="submit" id="reminderSubmit">–î–æ–¥–∞—Ç–∏</button>
                <button class="btn-form btn-form-secondary" type="button" id="reminderCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
              </div>
              <input type="hidden" id="reminderEditId" />
            </form>

            <!-- Reminders list -->
            <div id="reminderList" class="items-list flex-grow-1"></div>
          </div>

          <!-- Card 5: Top priorities (full width on 2-col+) -->
          <div class="glass myday-card">
            <h3 class="card-heading">–¢–æ–ø –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏</h3>
            <div id="prioritiesContainer"></div>
          </div>

        </div>
      </div>
    </main>

    <!-- Mobile menu modal -->
    <div class="modal fade" id="mobileMenuModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-bottom-sheet">
        <div class="modal-content glass">
          <div class="modal-header border-0">
            <h5 class="modal-title">–ú–µ–Ω—é</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <% if (role === 'admin') { %>
                <form method="POST" action="/admin/switch-to-admin">
                  <button class="btn w-100 btn-glass" type="submit"><%= t('schedule.backToAdmin') %></button>
                </form>
              <% } %>
              <% if (role === 'starosta') { %>
                <a class="btn w-100 btn-glass" href="/starosta"><%= t('menu.starosta') %></a>
              <% } %>
              <% if (role === 'deanery') { %>
                <a class="btn w-100 btn-glass" href="/deanery"><%= t('menu.deanery') %></a>
              <% } %>
              <a class="btn w-100 btn-glass" href="/schedule">–†–æ–∑–∫–ª–∞–¥</a>
              <a class="btn w-100 btn-glass" href="/my-day">–ú—ñ–π –¥–µ–Ω—å</a>
              <a class="btn w-100 btn-glass" href="/teamwork"><%= t('menu.teamwork') %></a>
              <button
                class="btn w-100 btn-glass theme-toggle"
                type="button"
                data-light-label="<%= t('theme.light') %>"
                data-dark-label="<%= t('theme.dark') %>"
              >
                <%= t('theme.light') %>
              </button>
              <a class="btn w-100 btn-glass" href="/profile"><%= t('schedule.profile') %></a>
              <form method="POST" action="/logout">
                <button class="btn w-100 btn-glass" type="submit"><%= t('schedule.logout') %></button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      // ============ THEME ============
      const themeToggles = document.querySelectorAll('.theme-toggle');
      const storedTheme = localStorage.getItem('ui-theme') || 'theme-light';
      document.body.classList.remove('theme-dark', 'theme-light');
      document.body.classList.add(storedTheme);
      themeToggles.forEach((btn) => {
        btn.textContent = storedTheme === 'theme-dark' ? btn.dataset.lightLabel : btn.dataset.darkLabel;
        btn.addEventListener('click', () => {
          const isDark = document.body.classList.contains('theme-dark');
          const next = isDark ? 'theme-light' : 'theme-dark';
          document.body.classList.remove('theme-dark', 'theme-light');
          document.body.classList.add(next);
          localStorage.setItem('ui-theme', next);
          themeToggles.forEach((b) => {
            b.textContent = next === 'theme-dark' ? b.dataset.lightLabel : b.dataset.darkLabel;
          });
        });
      });

      // ============ DATA ============
      const myDay = <%- JSON.stringify(myDay || {}) %>;
      const mobileMenuModal = document.getElementById('mobileMenuModal');
      const reminderForm = document.getElementById('reminderForm');
      const toggleReminderForm = document.getElementById('toggleReminderForm');
      const reminderTitle = document.getElementById('reminderTitle');
      const reminderNote = document.getElementById('reminderNote');
      const reminderDate = document.getElementById('reminderDate');
      const reminderTime = document.getElementById('reminderTime');
      const reminderEditId = document.getElementById('reminderEditId');
      const reminderSubmit = document.getElementById('reminderSubmit');
      const reminderCancel = document.getElementById('reminderCancel');
      const reminderList = document.getElementById('reminderList');

      let reminders = Array.isArray(myDay.reminders) ? myDay.reminders : [];
      if (reminderDate && myDay.today) {
        reminderDate.value = myDay.today;
      }

      // ============ UTILITY FUNCTIONS ============
      function escapeHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function formatDate(value) {
        if (!value) return '-';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleDateString('uk-UA');
      }

      // ============ RENDER: NOW/NEXT ============
      function renderNowNext() {
        const currentBlock = document.getElementById('currentBlock');
        const nextBlock = document.getElementById('nextBlock');
        if (!currentBlock || !nextBlock) return;

        if (myDay.current_class) {
          currentBlock.innerHTML = `
            <div class="item-title">üéØ –ô–¥–µ –∑–∞—Ä–∞–∑</div>
            <div class="item-meta">${escapeHtml(myDay.current_class.subject_name)} ¬∑ ${myDay.current_class.start}‚Äì${myDay.current_class.end}</div>
          `;
        } else {
          currentBlock.innerHTML = '<div class="empty-state" style="min-height: auto; padding: 1rem 0;"><div class="empty-state-text">–ó–∞—Ä–∞–∑ –Ω–µ–º–∞—î –ø–∞—Ä</div></div>';
        }

        if (myDay.next_class) {
          nextBlock.textContent = `–î–∞–ª—ñ: ${escapeHtml(myDay.next_class.subject_name)} –æ ${myDay.next_class.start}`;
        } else {
          nextBlock.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∏—Ö –ø–∞—Ä —Å—å–æ–≥–æ–¥–Ω—ñ –Ω–µ–º–∞—î.';
        }
      }

      function updateCountdown() {
        if (!myDay.next_class || !myDay.next_class.startAt) return;
        const startAt = new Date(myDay.next_class.startAt);
        const diff = startAt.getTime() - Date.now();
        if (diff <= 0) return;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        const nextBlock = document.getElementById('nextBlock');
        if (nextBlock) {
          nextBlock.textContent = `–î–∞–ª—ñ: ${escapeHtml(myDay.next_class.subject_name)} —á–µ—Ä–µ–∑ ${minutes} —Ö–≤ ${seconds} —Å–µ–∫`;
        }
      }

      renderNowNext();
      setInterval(updateCountdown, 1000);

      // ============ RENDER: CLASSES ============
      function renderClasses() {
        const container = document.getElementById('classesContainer');
        if (!container) return;

        if (!myDay.classes_today || !myDay.classes_today.length) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-emoji">üìö</div>
              <div class="empty-state-text">–°—å–æ–≥–æ–¥–Ω—ñ –ø–∞—Ä –Ω–µ–º–∞—î</div>
              <div class="empty-state-hint">–ß—É–¥–æ–≤–∏–π –¥–µ–Ω—å –¥–ª—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É!</div>
            </div>
          `;
          return;
        }

        const html = myDay.classes_today
          .map((cls) => `
            <div class="deadline-item">
              <div class="item-content">
                <div class="item-title">${escapeHtml(cls.subject_name)}</div>
                <div class="item-meta">–ü–∞—Ä–∞ #${cls.class_number} ¬∑ ${cls.start}‚Äì${cls.end}</div>
              </div>
              <span class="stat-pill">–ì—Ä—É–ø–∞ ${cls.group_number}</span>
            </div>
          `)
          .join('');
        container.innerHTML = `<div class="items-list">${html}</div>`;
      }

      // ============ RENDER: DEADLINES ============
      function renderDeadlines() {
        const container = document.getElementById('deadlinesContainer');
        if (!container) return;

        if (!myDay.deadlines || !myDay.deadlines.length) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-emoji">‚úÖ</div>
              <div class="empty-state-text">–ù–µ–º–∞—î –¥–µ–¥–ª–∞–π–Ω—ñ–≤</div>
              <div class="empty-state-hint">–Ω–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ 2 –¥–Ω—ñ</div>
            </div>
          `;
          return;
        }

        const html = myDay.deadlines
          .map((item) => {
            const btn = item.type === 'homework'
              ? `<button class="btn-sm-action complete-btn" data-homework-id="${item.id}" style="margin-left: auto;">${item.completed ? '‚úì –ì–æ—Ç–æ–≤–æ' : '–ó—Ä–æ–±–∏—Ç–∏'}</button>`
              : '';
            return `
              <div class="deadline-item">
                <div class="item-content">
                  <div class="item-title">${escapeHtml(item.description)}</div>
                  <div class="item-meta">${escapeHtml(item.subject_name)} ¬∑ ${item.deadline_date}${item.type === 'teamwork' ? ' ¬∑ ü§ù –¢–∏–º–≤–æ—Ä–∫' : ''}</div>
                </div>
                ${btn}
              </div>
            `;
          })
          .join('');
        container.innerHTML = `<div class="items-list">${html}</div>`;

        // Re-attach complete button handlers
        container.querySelectorAll('.complete-btn').forEach((btn) => {
          btn.addEventListener('click', completeHomework);
        });
      }

      async function completeHomework(e) {
        const btn = e.target.closest('.complete-btn');
        if (!btn) return;
        const id = btn.dataset.homeworkId;
        if (!id) return;
        btn.disabled = true;
        try {
          const res = await fetch(`/api/homework/${id}/complete`, { method: 'POST' });
          if (!res.ok) return;
          const data = await res.json();
          btn.classList.toggle('completed', data.completed);
          btn.textContent = data.completed ? '‚úì –ì–æ—Ç–æ–≤–æ' : '–ó—Ä–æ–±–∏—Ç–∏';
        } catch (err) {
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      }

      // ============ RENDER: PRIORITIES ============
      function renderPriorities() {
        const container = document.getElementById('prioritiesContainer');
        if (!container) return;

        if (!myDay.top_priorities || !myDay.top_priorities.length) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-emoji">‚ú®</div>
              <div class="empty-state-text">–ù–∞—Ä–∞–∑—ñ –≤—Å–µ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º</div>
            </div>
          `;
          return;
        }

        const html = myDay.top_priorities
          .map((item) => `
            <div class="deadline-item">
              <div class="item-content">
                <div class="item-title">${escapeHtml(item.subject_name)}</div>
                <div class="item-meta">${escapeHtml(item.description)} ¬∑ ${item.deadline_date}</div>
              </div>
              <span class="stat-pill">${item.type === 'workload' ? '‚ö° –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è' : 'üìå –ù–∞–π–±–ª–∏–∂—á–µ'}</span>
            </div>
          `)
          .join('');
        container.innerHTML = `<div class="items-list">${html}</div>`;
      }

      // ============ RENDER: REMINDERS ============
      function resetReminderForm() {
        reminderTitle.value = '';
        reminderNote.value = '';
        reminderDate.value = myDay.today || '';
        reminderTime.value = '';
        reminderEditId.value = '';
        reminderSubmit.textContent = '–î–æ–¥–∞—Ç–∏';
      }

      function renderReminders(list) {
        if (!list.length) {
          reminderList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-emoji">üîî</div>
              <div class="empty-state-text">–ù–µ–º–∞—î –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å</div>
              <div class="empty-state-hint">–Ω–∞ –Ω–∞–π–±–ª–∏–∂—á—ñ 7 –¥–Ω—ñ–≤</div>
            </div>
          `;
          return;
        }

        const html = list
          .map((reminder) => {
            const dateLabel = formatDate(reminder.remind_date);
            const timeLabel = reminder.remind_time ? ` ¬∑ ${escapeHtml(reminder.remind_time)}` : '';
            const dayLabel = reminder.remind_date === myDay.today ? ' ¬∑ —Å—å–æ–≥–æ–¥–Ω—ñ' : reminder.remind_date === myDay.tomorrow ? ' ¬∑ –∑–∞–≤—Ç—Ä–∞' : '';
            const noteHtml = reminder.note ? `<div class="item-meta">${escapeHtml(reminder.note)}</div>` : '';
            const doneClass = reminder.is_done ? 'done' : '';
            const toggleLabel = reminder.is_done ? '‚Ü©Ô∏è –í—ñ–¥–Ω–æ–≤–∏—Ç–∏' : '‚úì –ì–æ—Ç–æ–≤–æ';
            return `
              <div class="reminder-item" data-reminder-id="${reminder.id}">
                <div class="item-content">
                  <div class="item-title reminder-title ${doneClass}">${escapeHtml(reminder.title)}</div>
                  ${noteHtml}
                  <div class="item-meta">${escapeHtml(dateLabel)}${timeLabel}${dayLabel}</div>
                </div>
                <div class="action-buttons">
                  <button class="btn-sm-action reminder-toggle" type="button" data-id="${reminder.id}" data-done="${reminder.is_done ? '1' : '0'}">${toggleLabel}</button>
                  <button class="btn-sm-action reminder-edit" type="button" data-id="${reminder.id}">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                  <button class="btn-sm-action reminder-delete" type="button" data-id="${reminder.id}">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                </div>
              </div>
            `;
          })
          .join('');
        reminderList.innerHTML = html;

        // Re-attach event handlers
        reminderList.querySelectorAll('.reminder-toggle').forEach((btn) => {
          btn.addEventListener('click', toggleReminder);
        });
        reminderList.querySelectorAll('.reminder-edit').forEach((btn) => {
          btn.addEventListener('click', editReminder);
        });
        reminderList.querySelectorAll('.reminder-delete').forEach((btn) => {
          btn.addEventListener('click', deleteReminder);
        });
      }

      async function loadReminders() {
        if (!myDay.today || !myDay.reminders_window_end) return;
        try {
          const params = new URLSearchParams({
            from: myDay.today,
            to: myDay.reminders_window_end,
            status: 'all',
          });
          const res = await fetch(`/api/reminders?${params.toString()}`);
          if (!res.ok) return;
          const data = await res.json();
          reminders = Array.isArray(data.reminders) ? data.reminders : [];
          renderReminders(reminders);
        } catch (err) {
          console.error(err);
        }
      }

      async function toggleReminder(e) {
        const btn = e.target.closest('.reminder-toggle');
        if (!btn) return;
        const id = btn.dataset.id;
        const newDone = btn.dataset.done !== '1';
        btn.disabled = true;
        try {
          const res = await fetch(`/api/reminders/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_done: newDone }),
          });
          if (!res.ok) return;
          await loadReminders();
        } catch (err) {
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      }

      function editReminder(e) {
        const btn = e.target.closest('.reminder-edit');
        if (!btn) return;
        const id = btn.dataset.id;
        const reminder = reminders.find((item) => String(item.id) === String(id));
        if (!reminder) return;
        reminderForm.classList.remove('d-none');
        reminderTitle.value = reminder.title || '';
        reminderNote.value = reminder.note || '';
        reminderDate.value = reminder.remind_date || myDay.today || '';
        reminderTime.value = reminder.remind_time || '';
        reminderEditId.value = reminder.id;
        reminderSubmit.textContent = '–û–Ω–æ–≤–∏—Ç–∏';
        reminderTitle.focus();
      }

      async function deleteReminder(e) {
        const btn = e.target.closest('.reminder-delete');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è?')) return;
        btn.disabled = true;
        try {
          const res = await fetch(`/api/reminders/${id}`, { method: 'DELETE' });
          if (!res.ok) return;
          await loadReminders();
        } catch (err) {
          console.error(err);
        } finally {
          btn.disabled = false;
        }
      }

      // ============ REMINDER FORM HANDLERS ============
      if (toggleReminderForm && reminderForm) {
        toggleReminderForm.addEventListener('click', () => {
          reminderForm.classList.toggle('d-none');
          if (!reminderForm.classList.contains('d-none')) {
            reminderTitle.focus();
          }
        });
      }

      if (reminderCancel && reminderForm) {
        reminderCancel.addEventListener('click', () => {
          resetReminderForm();
          reminderForm.classList.add('d-none');
        });
      }

      if (reminderForm) {
        reminderForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!reminderTitle.value.trim() || !reminderDate.value) return;
          reminderSubmit.disabled = true;
          try {
            const payload = {
              title: reminderTitle.value.trim(),
              note: reminderNote.value.trim(),
              remind_date: reminderDate.value,
              remind_time: reminderTime.value,
            };
            const editId = reminderEditId.value;
            const res = await fetch(editId ? `/api/reminders/${editId}` : '/api/reminders', {
              method: editId ? 'PATCH' : 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            if (!res.ok) return;
            await loadReminders();
            resetReminderForm();
            reminderForm.classList.add('d-none');
          } catch (err) {
            console.error(err);
          } finally {
            reminderSubmit.disabled = false;
          }
        });
      }

      // ============ KEYBOARD HANDLERS ============
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close mobile menu if open
          const modalElement = mobileMenuModal;
          if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();
          }
          // Collapse reminder form if open
          if (reminderForm && !reminderForm.classList.contains('d-none')) {
            resetReminderForm();
            reminderForm.classList.add('d-none');
          }
        }
      });

      // ============ INITIAL RENDER ============
      renderClasses();
      renderDeadlines();
      renderPriorities();
      renderReminders(reminders);
    </script>
  </body>
</html>